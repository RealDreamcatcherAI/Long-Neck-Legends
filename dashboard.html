<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/jpGdtHJ.jpeg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LNL Holder Dashboard | Profile</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Orbitron:wght@400;700;900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Keep banner links (like X) white */
a.plink,
a.plink:visited,
a.plink:hover,
a.plink:active {
  color: #e0e0ff;          /* your ‚Äúwhite‚Äù */
  text-decoration: none;
}
a.plink:hover{
  text-decoration: underline; /* optional */
}
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a1a;
      color: #e0e0ff;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    body.loaded { opacity: 1; }

    /* ---- TOP NAV (SITE) ---- */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 1rem 0;
      background: rgba(10,10,26,0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    nav a {
      color: #e0e0ff;
      margin: 0 1.5rem;
      text-decoration: none;
      font-weight: 600;
      position: relative;
      font-size: 0.9rem;
    }
    nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #00d4ff;
      transition: 0.3s;
    }
    nav a:hover::after { width: 100%; }

    /* ---- HERO ---- */
    .hero {
      margin-top: 60px;
      padding: 4rem 2rem 2.2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: 'HOLDER';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(120px, 20vw, 400px);
      color: rgba(0,212,255,0.03);
      pointer-events: none;
      white-space: nowrap;
      letter-spacing: 20px;
    }
    .hero h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.6rem, 4vw, 2.8rem);
      font-weight: 900;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .hero h1 span { color: #00d4ff; text-shadow: 0 0 30px rgba(0,212,255,0.4); }
    .hero-sub {
      color: #888;
      font-size: 0.95rem;
    }

    /* ---- DASH NAV (DASHBOARD-ONLY) ---- */
    .dash-nav-wrap{
      position: sticky;
      top: 60px; /* below site nav */
      z-index: 900;
      background: rgba(10,10,26,0.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: none;
    }
    .dash-nav-wrap.show { display: block; }

    .dash-nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.9rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .dash-tabs{
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .dash-tab{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: #bfc2ff;
      padding: 8px 14px;
      font-size: 0.78rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }
    .dash-tab:hover{
      border-color: rgba(0,212,255,0.45);
      color: #e0e0ff;
      box-shadow: 0 0 18px rgba(0,212,255,0.12);
      transform: translateY(-1px);
    }
    .dash-tab.active{
      border-color: rgba(0,212,255,0.65);
      color: #00d4ff;
      box-shadow: 0 0 22px rgba(0,212,255,0.16);
    }

    .dash-right{
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.7rem;
      flex-wrap: wrap;
    }

    /* --- DASH NAV mobile-safe polish (max width like cards) --- */
    .dash-nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.9rem 2rem;
    }

    .dash-tabs{ flex: 1 1 auto; min-width: 0; }
    .dash-right{ flex: 0 0 auto; }

    .wallet-chip{ max-width: 240px; }
    .wallet-addr{ overflow: hidden; text-overflow: ellipsis; }

    @media (max-width: 800px){
      .dash-nav{ padding: 0.8rem 1rem; }
      .dash-right{ gap: 0.5rem; }
      .wallet-chip{ max-width: 170px; }
    }

    @media (max-width: 420px){
      .dash-nav{ flex-wrap: wrap; row-gap: 0.6rem; }
      .dash-right{ width: 100%; justify-content: flex-end; }
      .wallet-chip{ max-width: 100%; }
    }

    .wallet-chip{
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(17,17,37,0.55);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .wallet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 8px rgba(0,255,136,0.6);
      flex: 0 0 auto;
    }
    .wallet-addr {
      color: #888;
      font-size: 0.78rem;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .wallet-addr strong { color: #e0e0ff; }

    .disconnect-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.10);
      color: #7a7aa6;
      padding: 8px 12px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.8px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 8px;
      font-weight: 700;
    }
    .disconnect-btn:hover { border-color: #ff3c5c; color: #ff3c5c; box-shadow: 0 0 18px rgba(255,60,92,0.14); }

    @media (max-width: 700px){
      .dash-nav{ padding: 0.8rem 1rem; }
      nav a { margin: 0 0.8rem; font-size: 0.75rem; }
      .wallet-chip{ max-width: 100%; }
    }

    /* ---- CONNECT SECTION ---- */
    .connect-section {
      text-align: center;
      padding: 4rem 2rem;
    }
    .connect-btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7b68ee 100%);
      color: #000;
      border: none;
      padding: 16px 48px;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      border-radius: 4px;
      transition: all 0.3s;
      box-shadow: 0 4px 30px rgba(0,212,255,0.3);
    }
    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 40px rgba(0,212,255,0.5);
    }
    .connect-prompt {
      color: #555;
      margin-top: 1rem;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    /* ---- DASHBOARD GRID / VIEWS ---- */
    .dashboard {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.8rem 2rem 4rem;
      gap: 1.5rem;
    }
    .dashboard.show { display: block; }

    .view{ display: none; }
    .view.show{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    #view-chat.show {
      display: flex;
      flex-direction: column;
      grid-template-columns: unset;
    }
    @media (max-width: 800px) {
      .view.show { grid-template-columns: 1fr; }
      .dashboard{ padding: 1.4rem 1rem 3rem; }
    }

    /* ---- TIER CARD ---- */
    .tier-card {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid #1e1e3a;
      border-radius: 16px;
      padding: 2.3rem;
      display: flex;
      align-items: center;
      gap: 2.2rem;
      position: relative;
      overflow: hidden;
      min-height: 180px;
    }
    .tier-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      opacity: 0.08;
      pointer-events: none;
    }
    .tier-card.tier-neck::before { background: radial-gradient(circle, #00d4ff, transparent); }
    .tier-card.tier-longneck::before { background: radial-gradient(circle, #7b68ee, transparent); }
    .tier-card.tier-legend::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-og::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-sardine::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-barracuda::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-shark::before { background: radial-gradient(circle, #00ffcc, transparent); }
    .tier-card.tier-whale::before { background: radial-gradient(circle, #00ffcc, transparent); }

    @media (max-width: 600px) {
      .tier-card { flex-direction: column; text-align: center; padding: 2rem 1.5rem; }
    }

    .tier-badge {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: 1.8rem;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .tier-badge::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 2px solid;
      animation: tierPulse 2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes tierPulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .tier-badge img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.05) contrast(1.05);
    }

    .tier-neck .tier-badge { color: #00d4ff; }
    .tier-neck .tier-badge::after { border-color: #00d4ff; }
    .tier-longneck .tier-badge { color: #7b68ee; }
    .tier-longneck .tier-badge::after { border-color: #7b68ee; }
    .tier-legend .tier-badge { color: #ffd700; }
    .tier-legend .tier-badge::after { border-color: #ffd700; }
    .tier-og .tier-badge { color: #ffd700; }
    .tier-og .tier-badge::after { border-color: #ffd700; }
    .tier-sardine .tier-badge { color: #ff3c5c; }
    .tier-sardine .tier-badge::after { border-color: #ff3c5c; }
    .tier-barracuda .tier-badge { color: #ff3c5c; }
    .tier-barracuda .tier-badge::after { border-color: #ff3c5c; }
    .tier-shark .tier-badge { color: #00ffcc; }
    .tier-shark .tier-badge::after { border-color: #00ffcc; }
    .tier-whale .tier-badge { color: #00ffcc; }
    .tier-whale .tier-badge::after { border-color: #00ffcc; }

    .tier-info { flex: 1; min-width: 240px; }
    .tier-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 0.3rem;
    }
    .tier-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.8rem;
      letter-spacing: 4px;
      line-height: 1;
      margin-bottom: 0.3rem;
    }
    .tier-neck .tier-name { color: #00d4ff; }
    .tier-longneck .tier-name { color: #7b68ee; }
    .tier-legend .tier-name { color: #ffd700; }
    .tier-og .tier-name { color: #ffd700; }
    .tier-sardine .tier-name { color: #ff3c5c; }
    .tier-barracuda .tier-name { color: #ff3c5c; }
    .tier-shark .tier-name { color: #00ffcc; }
    .tier-whale .tier-name { color: #00ffcc; }

    .tier-nfts-held {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .tier-nfts-held strong { color: #e0e0ff; font-weight: 700; }

    .tier-progress-wrap { max-width: 320px; }
    .tier-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
      gap: 12px;
    }
    .tier-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      overflow: hidden;
    }
    .tier-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .tier-neck .tier-progress-fill { background: #00d4ff; box-shadow: 0 0 10px rgba(0,212,255,0.5); }
    .tier-longneck .tier-progress-fill { background: #7b68ee; box-shadow: 0 0 10px rgba(123,104,238,0.5); }
    .tier-legend .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-og .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-sardine .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-barracuda .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-shark .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }
    .tier-whale .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }

/* ---- Username + Social Box (right side of tier card) ---- */
.profile-name-box{
  flex: 0 0 320px;
  max-width: 360px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;     /* right align */
  justify-content: center;
  text-align: right;
  gap: 0.5rem;
}

.profile-username{
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.4rem;
  letter-spacing: 4px;
  line-height: 1;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* username color mimics tier-name color */
.tier-neck .profile-username { color: #00d4ff; }
.tier-longneck .profile-username { color: #7b68ee; }
.tier-legend .profile-username { color: #ffd700; }
.tier-og .profile-username { color: #ffd700; }
.tier-sardine .profile-username { color: #ff3c5c; }
.tier-barracuda .profile-username { color: #ff3c5c; }
.tier-shark .profile-username { color: #00ffcc; }
.tier-whale .profile-username { color: #00ffcc; }

.profile-name-inner{
  width: 100%;
  padding: 0.7rem 0.8rem;
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.06);
}

.profile-links{
  display: flex;
  justify-content: flex-end; /* keep right aligned */
  gap: 8px;
  flex-wrap: wrap;
}

/* responsive: center it on smaller widths */
@media (max-width: 900px){
  .profile-name-box{
    flex: 1 1 auto;
    max-width: 100%;
    align-items: center;
    text-align: center;
  }
  .profile-links{ justify-content: center; }
}

    /* ---- STATS CARD ---- */
    .stats-card {
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .stats-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 1.2rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.7rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: #888; font-size: 0.8rem; }
    .stat-value { font-weight: 700; font-size: 1.1rem; }
    .stat-value.cyan { color: #00d4ff; }
    .stat-value.purple { color: #7b68ee; }
    .stat-value.gold { color: #ffd700; }
    .stat-value.green { color: #00ff88; }

    /* ---- POINTS DISPLAY ---- */
    .points-display { text-align: center; padding: 1.5rem 0; }
    .points-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .points-label {
      font-size: 0.7rem;
      letter-spacing: 3px;
      color: #555;
      text-transform: uppercase;
      margin-top: 0.3rem;
    }

    /* ---- PROFILE ACTIONS ---- */
    .profile-actions{
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 1.6rem 2rem;
    }
    .profile-actions.is-hidden { display: none; }
    .actions-grid{
      display: grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap: 0.8rem;
      margin-top: 0.9rem;
    }
    @media (max-width: 1100px){
      .actions-grid{ grid-template-columns: repeat(3, minmax(140px, 1fr)); }
    }
    @media (max-width: 600px){
      .actions-grid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .points-number { font-size: 2.5rem; }
    }
    .action-btn{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      color: #cfd2ff;
      padding: 12px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 800;
      font-size: 0.74rem;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      font-family: 'Space Grotesk', sans-serif;
      text-align: center;
    }
    .action-btn:hover{
      border-color: rgba(0,212,255,0.45);
      box-shadow: 0 0 22px rgba(0,212,255,0.12);
      transform: translateY(-1px);
      color: #e0e0ff;
    }
    .action-btn.danger:hover{
      border-color: rgba(255,60,92,0.6);
      box-shadow: 0 0 22px rgba(255,60,92,0.10);
      color: #ff7a90;
    }

    /* ---- PERKS CARD ---- */
    .perks-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .perks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .perk {
      background: rgba(0,0,0,0.3);
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      padding: 1.2rem;
      position: relative;
      transition: all 0.3s;
    }
    .perk.unlocked { border-color: rgba(0,212,255,0.3); background: rgba(0,212,255,0.04); }
    .perk.locked { opacity: 0.4; }
    .perk-icon { font-size: 1.8rem; margin-bottom: 0.6rem; }
    .perk-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 0.3rem; letter-spacing: 0.5px; }
    .perk-desc { color: #666; font-size: 0.72rem; line-height: 1.5; }
    .perk-req { font-size: 0.65rem; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.6rem; }
    .perk-req.met { color: #00ff88; }
    .perk-status {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .perk-status.on { background: #00ff88; box-shadow: 0 0 8px rgba(0,255,136,0.6); }
    .perk-status.off { background: #333; }

    /* ---- NFT GALLERY ---- */
    .gallery-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .nft-tile {
      background: #0a0a1a;
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
    }
    .nft-tile:hover {
      transform: translateY(-4px);
      border-color: rgba(0,212,255,0.4);
      box-shadow: 0 8px 30px rgba(0,212,255,0.15);
    }
    .nft-tile img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .nft-tile-info { padding: 0.7rem; }
    .nft-tile-name {
      font-weight: 700;
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nft-tile-id { color: #555; font-size: 0.65rem; margin-top: 2px; }

    /* ---- SHARE CARD ---- */
    .share-section { grid-column: 1 / -1; text-align: center; padding: 1rem 0; }
    .share-btn {
      background: transparent;
      border: 1px solid #1e1e3a;
      color: #888;
      padding: 10px 28px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 4px;
    }
    .share-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
      box-shadow: 0 0 20px rgba(0,212,255,0.15);
    }

    /* ---- NO NFTS STATE ---- */
    .no-nfts {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem 2rem;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
    }
    .no-nfts h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .no-nfts p { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .no-nfts a {
      display: inline-block;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      color: #000;
      text-decoration: none;
      padding: 12px 36px;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .no-nfts a:hover { box-shadow: 0 4px 30px rgba(0,212,255,0.4); transform: translateY(-2px); }

    /* ---- LOADING ---- */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0,212,255,0.15);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      color: #555;
      font-size: 0.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* ---- MODALS ---- */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1.2rem;
    }
    .modal-backdrop.show{ display: flex; }

    .modal{
      width: min(920px, 100%);
      max-height: 85vh; 
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
    }
    .modal-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.18);
    }
    .modal-title{
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      letter-spacing: 2px;
      font-size: 0.95rem;
      color: #e0e0ff;
      text-transform: uppercase;
    }
    .modal-close{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      color: #9a9abd;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      transition: all 0.2s;
    }
    .modal-close:hover{
      border-color: rgba(255,60,92,0.55);
      color: #ff3c5c;
      box-shadow: 0 0 16px rgba(255,60,92,0.12);
    }
    .modal-body{
      padding: 1.2rem;
      max-height: min(70vh, 640px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .pfp-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.9rem;
    }
    .pfp-tile{
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.22);
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .pfp-tile:hover{
      border-color: rgba(0,212,255,0.45);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,212,255,0.10);
    }
    .pfp-tile img{
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .pfp-tile .pfp-name{
      padding: 0.6rem 0.7rem;
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.4px;
      color: #e0e0ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pfp-selected{
      position: absolute;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.55);
      display: none;
    }
    .pfp-tile.selected .pfp-selected{ display: block; }

    .modal-note{
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 0.9rem;
      letter-spacing: 0.4px;
    }

    /* ---- FOOTER ---- */
    footer {
      text-align: center;
      padding: 3rem 2rem;
      border-top: 1px solid #1e1e3a;
      color: #333;
      font-size: 0.7rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* ---- SCROLLBAR ---- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a1a; }
    ::-webkit-scrollbar-thumb { background: #1e1e3a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #00d4ff; }

    @media (max-width: 600px) {
      .perks-grid { grid-template-columns: 1fr 1fr; }
      .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    }
  
    /* ---- TRAITS / SUBDAO ---- */
    .subdao-divider{
      margin-top: 1.2rem;
      padding-top: 1.2rem;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .subdao-grid{
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 900px){
      .subdao-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px){
      .subdao-grid{ grid-template-columns: 1fr; }
    }
    .trait-pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 0.6rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color:#bfc2ff;
      font-size:0.7rem;
      letter-spacing:0.6px;
      text-transform: uppercase;
      cursor: default;
      user-select:none;
    }
    .pill.on{
      border-color: rgba(0,255,136,0.35);
      background: rgba(0,255,136,0.06);
      color: #00ff88;
      box-shadow: 0 0 18px rgba(0,255,136,0.08);
    }
    .pill.off{ opacity: 0.45; }
    .trait-table{
      width:100%;
      border-collapse: collapse;
      margin-top: 0.8rem;
      font-size: 0.8rem;
    }
    .trait-table th, .trait-table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: left;
      vertical-align: top;
    }
    .trait-table th{
      font-family: 'Bebas Neue', sans-serif;
      letter-spacing: 2px;
      color:#777;
      font-size: 0.95rem;
    }
    .trait-muted{ color:#666; font-size:0.78rem; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>

<body>
  <nav>
    <a href="https://longnecklegends.xyz/">Home</a>
    <a href="/starternecks.html">Starter Necks</a>
    <a href="/music.html">Music</a>
    <a href="/hotsaucemint.html">Hot Sauce</a>
    <a href="/store.html">Store</a>
  </nav>

  <section class="hero">
    <h1>HOLDER <span>DASHBOARD</span></h1>
    <p class="hero-sub">Customize your profile, connect your wallets and socials to see your tier, points, and perks</p>
  </section>

  <!-- DASHBOARD-ONLY NAV BAR -->
  <div class="dash-nav-wrap" id="dashNavWrap">
    <div class="dash-nav">
      <div class="dash-tabs">
        <button class="dash-tab" id="tabProfile" onclick="toggleProfilePanel()">Profile</button>
        <button class="dash-tab" id="tabChat" onclick="switchView('chat')">üí¨ Chat</button>
      </div>

      <div class="dash-right">
        <div class="wallet-chip" id="walletChip" style="display:none;">
          <div class="wallet-dot"></div>
          <span class="wallet-addr"><strong id="walletDisplay">‚Äî</strong></span>
        </div>
        <button class="disconnect-btn" id="disconnectBtn" style="display:none;" onclick="disconnectWallet()">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- CONNECT PROMPT -->
  <div class="connect-section" id="connectSection">
    <button class="connect-btn" onclick="connectWallet()">CONNECT WALLET</button>
    <p class="connect-prompt">Phantom &bull; Solflare &bull; Magic Eden</p>
  </div>

  <!-- LOADING -->
  <div class="connect-section" id="loadingSection" style="display:none;">
    <div class="loading-spinner"></div>
    <p class="loading-text">Scanning your wallet...</p>
  </div>

  <!-- DASHBOARD WRAP -->
  <div class="dashboard" id="dashboard">
    <div class="view show" id="view-profile"></div>
    <div class="view" id="view-chat"></div>
  </div>

  <!-- PFP MODAL -->
  <div class="modal-backdrop" id="pfpModalBackdrop" onclick="closePfpModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Select Your LNL PFP</div>
        <button class="modal-close" onclick="hidePfpModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="modal-note">Pick one of your Long Neck Legends. This sets your Profile PFP for this wallet on this device.</div>
        <div class="pfp-grid" id="pfpGrid"></div>
      </div>
    </div>
  </div>

  <!-- SECOND WALLET MODAL -->
  <div class="modal-backdrop" id="secondWalletModalBackdrop" onclick="closeSecondWalletModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Link 2nd Wallet</div>
        <button class="modal-close" onclick="hideSecondWalletModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="modal-note">
          Connect a second wallet to combine your LNL holdings across wallets. (Main wallet stays connected.)
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('phantom')">Phantom</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('solflare')">Solflare</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('magiceden')">Magic Eden</button>
        </div>

        <div id="secondWalletStatus" style="color:#666; font-size:0.82rem; line-height:1.5;">
          No second wallet linked yet.
        </div>

        <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
          <button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="unlinkSecondWallet()">Unlink</button>
          <button class="disconnect-btn" onclick="hideSecondWalletModal()">Close</button>
        </div>
      </div>
    </div>
  </div>


  <!-- TRAITS MODAL -->
  <div class="modal-backdrop" id="traitsModalBackdrop" onclick="closeTraitsModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Trait Data</div>
        <button class="modal-close" onclick="hideTraitsModal()">‚úï</button>
      </div>
      <div class="modal-body" id="traitsModalBody">
        <div class="modal-note">This is pulled live from your NFTs metadata. SubDAO unlocks are based on holding at least 1 matching trait.</div>
        <div id="subdaoPills" class="trait-pills"></div>
        <table class="trait-table" id="traitsTable">
          <thead>
            <tr><th>Trait</th><th>Count</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="trait-muted">Tip: If something looks missing, it usually means the NFT metadata doesn‚Äôt include that attribute field.</div>
      </div>
    </div>
  </div>



  <!-- USERNAME MODAL (mobile-safe, replaces prompt) -->
  <div class="modal-backdrop" id="usernameModalBackdrop" onclick="closeUsernameModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Set Profile Username</div>
        <button class="modal-close" onclick="hideUsernameModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="modal-note">This username is saved to this wallet on this device. Max 24 characters.</div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;">
          <input id="usernameInput" type="text" inputmode="text" autocomplete="off" autocapitalize="words" spellcheck="false"
                 placeholder="Your name..." maxlength="24"
                 style="flex:1; min-width:200px; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.22); color:#e0e0ff; outline:none; font-family:'Space Grotesk',sans-serif;">
          <button class="action-btn" style="min-width:160px;" onclick="saveUsernameFromModal()">Save</button>
        </div>

        <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
          <button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="clearUsername()">Clear</button>
          <button class="disconnect-btn" onclick="hideUsernameModal()">Close</button>
        </div>
      </div>
    </div>
  </div>


  <footer>
    <p>&copy; 2026 Long Neck Legends &bull; Diamond Hands Only</p>
  </footer>

  <script>
    window.addEventListener('load', function() { document.body.classList.add('loaded'); applyAuthFromUrl(); });

    var CONFIG = {
      COLLECTION_MINT: "8Rt3Ayqth4DAiPnW9MDFi63TiQJHmohfTWLMQFHi4KZH",
      RPC_URL: "https://mainnet.helius-rpc.com/?api-key=44cfd082-9089-430d-8de3-cd310c478b1c",
      MAGIC_EDEN_LINK: "https://magiceden.us/marketplace/long_neck_legends"
    };

    var TIERS = [
      { id: "civilian", name: "CIVILIAN", min: 0, icon: "\u{1F464}", pointsMultiplier: 0, discount: 0, raffleMultiplier: 0, cssClass: "" },
      { id: "neck", name: "NECK", min: 1, icon: "\u{1F995}", pointsMultiplier: 1, discount: 10, raffleMultiplier: 1, cssClass: "tier-neck" },
      { id: "longneck", name: "LONG NECK", min: 5, icon: "\u{1F525}", pointsMultiplier: 1.5, discount: 15, raffleMultiplier: 2, cssClass: "tier-longneck" },
      { id: "legend", name: "LEGEND", min: 10, icon: "\u{2B50}", pointsMultiplier: 2.5, discount: 20, raffleMultiplier: 3, cssClass: "tier-legend" },
      { id: "og", name: "OG LEGEND", min: 20, icon: "\u{1F451}", pointsMultiplier: 4, discount: 25, raffleMultiplier: 5, cssClass: "tier-og" },
      { id: "sardine", name: "SARDINE", min: 30, icon: "\u{1F41F}", pointsMultiplier: 6, discount: 30, raffleMultiplier: 6, cssClass: "tier-sardine" },
      { id: "barracuda", name: "BARRACUDA", min: 50, icon: "\u{1F52A}", pointsMultiplier: 7, discount: 35, raffleMultiplier: 7, cssClass: "tier-barracuda" },
      { id: "shark", name: "SHARK", min: 75, icon: "\u{1F988}", pointsMultiplier: 8, discount: 35, raffleMultiplier: 8, cssClass: "tier-shark" },
      { id: "whale", name: "WHALE", min: 100, icon: "\u{1F40B}", pointsMultiplier: 10, discount: 40, raffleMultiplier: 10, cssClass: "tier-whale" }
    ];

    var PERKS = [
      { icon: "\u{1F995}", name: "Store Discount", desc: "Get a discount on all LNL Store purchases paid in SOL.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "Raffle Entries", desc: "Earn entries into exclusive drops, giveaways, and raffles.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "IRL Access", desc: "Entry to LNL events, listening parties, and tastings.", reqTier: "neck" },
      { icon: "\u{1F525}", name: "Exclusive Merch", desc: "Unlock holder-only merch that never hits the public store.", reqTier: "longneck" },
      { icon: "\u{2B50}", name: "Exclusive Merch", desc: "Vote on the next apparel drop. Your neck, your choice.", reqTier: "legend" },
      { icon: "\u{2B50}", name: "Flavor Voting", desc: "Vote on the next hot sauce flavor. Your taste, your choice.", reqTier: "legend" },
      { icon: "\u{1F451}", name: "Early Access", desc: "Get first dibs on new sauce flavors, merch drops, and collections.", reqTier: "og" },
      { icon: "\u{1F451}", name: "VIP IRL Access", desc: "VIP entry to LNL events, listening parties, and tastings.", reqTier: "og" },
      { icon: "\u{1F41F}", name: "Diamond Hands Club", desc: "Private group with alpha, airdrops, and direct team access.", reqTier: "sardine" },
      { icon: "\u{1F52A}", name: "Monthly Airdrop", desc: "Free products, NFTs, and surprises delivered monthly.", reqTier: "barracuda" },
      { icon: "\u{1F988}", name: "Shark Council", desc: "Direct input on project direction, partnerships, and roadmap decisions.", reqTier: "shark" },
      { icon: "\u{1F40B}", name: "Lifetime Perks", desc: "Permanent max discount, first priority on all future drops, and custom merch.", reqTier: "whale" }
    ];


    // ---- SUBDAO (Trait-based) ----
    var SUBDAOS = [
      { id:"talltoker",  name:"Tall Toker",     icon:"üö¨", reqValues:["Gold Pipe Beak","Blunt Beak"], desc:"Hold at least 1 LNL with Gold Pipe Beak or Blunt Beak." },
      { id:"jeeterbeater", name:"Jeeter Beater", icon:"ü•ä", reqValues:["Boxing Gloves"], desc:"Hold at least 1 LNL with Boxing Gloves." },
      { id:"hoodiegang", name:"Hoodie Gang",    icon:"üß•", reqValues:["Hoodie"], desc:"Hold at least 1 LNL with Hoodie." },
      { id:"headphones", name:"HeadPhones",     icon:"üéß", reqValues:["Headphones"], desc:"Hold at least 1 LNL with Headphones." },
      { id:"royalty",    name:"Royalty",        icon:"üëë", reqValues:["Golden Crown","Hippie Crown","Gold Grill Beak"], desc:"Hold at least 1 LNL with Golden Crown, Hippie Crown, or Gold Grill Beak." },
      { id:"wizzy",      name:"Wizzy",          icon:"üßô", reqValues:["Wizard Hat"], desc:"Hold at least 1 LNL with Wizard Hat." },
      { id:"bob",        name:"BoB",            icon:"üß¢", reqValues:["Beanie"], desc:"Hold at least 1 LNL with Beanie." },
      { id:"frobros",    name:"Fro Bros",       icon:"ü¶±", reqValues:["Afro"], desc:"Hold at least 1 LNL with Afro." },
      { id:"goldenticket", name:"Golden Ticket", icon:"üéüÔ∏è", reqValues:["Golden Ticket"], desc:"Hold at least 1 LNL with Golden Ticket." }
    ];

    function normStr(s){
      return String(s || "").trim().toLowerCase();
    }

    function buildTraitValueSet(nfts){
      var set = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          set[normStr(v)] = true;
        });
      });
      return set;
    }

    function getSubdaoMatches(nfts){
      var values = buildTraitValueSet(nfts);
      return SUBDAOS.map(function(d){
        var hit = "";
        for (var i=0;i<d.reqValues.length;i++){
          if (values[normStr(d.reqValues[i])]) { hit = d.reqValues[i]; break; }
        }
        return { id:d.id, name:d.name, icon:d.icon, unlocked: !!hit, hit: hit, reqValues: d.reqValues, desc: d.desc };
      });
    }

    function buildTraitCounts(nfts){
      var counts = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          var key = v.trim();
          counts[key] = (counts[key] || 0) + 1;
        });
      });
      return counts;
    }


    var walletProvider = null;
    var walletPublicKey = null;

    var session = {
      loadedNFTs: [],
      profile: {
        username: "",
        pfpMint: "",
        pfpImage: "",
        x: "",
        discord: "",
        ledger: ""
      },
      secondWallet: { address: "" },
      currentView: "profile",
      profilePanelOpen: false
    };

    function getTier(count) {
      for (var i = TIERS.length - 1; i >= 0; i--) {
        if (count >= TIERS[i].min) return TIERS[i];
      }
      return TIERS[0];
    }
    function getNextTier(tier) {
      var idx = TIERS.findIndex(function(t) { return t.id === tier.id; });
      return idx < TIERS.length - 1 ? TIERS[idx + 1] : null;
    }
    function calcPoints(count, tier) {
      return Math.floor(count * 100 * tier.pointsMultiplier);
    }

    function getProviderByName(name){
      if (name === "phantom") {
        if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
        if (window.solana && window.solana.isPhantom) return window.solana;
      }
      if (name === "solflare") {
        if (window.solflare && window.solflare.isSolflare) return window.solflare;
        if (window.solflare && window.solflare.solana) return window.solflare.solana;
      }
      if (name === "magiceden") {
        if (window.magicEden && window.magicEden.solana) return window.magicEden.solana;
        if (window.solana && window.solana.isMagicEden) return window.solana;
        if (window.solana && window.solana.isMagicEdenWallet) return window.solana;
      }
      return null;
    }

    function detectWalletProvider() {
      if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
      if (window.backpack && window.backpack.solana) return window.backpack.solana;
      if (window.solflare && window.solflare.isSolflare) return window.solflare;
      if (window.solflare && window.solflare.solana) return window.solflare.solana;
      if (window.solana && window.solana.isPhantom) return window.solana;
      if (window.solana) return window.solana;
      return null;
    }

    function storageKey() {
      var addr = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_profile_" + addr;
    }

    function loadProfileFromStorage() {
      try {
        var raw = localStorage.getItem(storageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && typeof data === "object") {
          session.profile.username = data.username || "";
          session.profile.pfpMint = data.pfpMint || "";
          session.profile.pfpImage = data.pfpImage || "";
          session.profile.x = data.x || "";
          session.profile.discord = data.discord || "";
          session.profile.ledger = data.ledger || "";
        }
      } catch (e) {}
    }

    function saveProfileToStorage() {
      try { localStorage.setItem(storageKey(), JSON.stringify(session.profile)); } catch (e) {}
    }

    function secondWalletStorageKey(){
      var primary = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_second_wallet_for_" + primary;
    }

    function loadSecondWalletFromStorage(){
      try{
        var raw = localStorage.getItem(secondWalletStorageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && data.address) session.secondWallet.address = data.address;
      }catch(e){}
    }

    function saveSecondWalletToStorage(){
      try{
        localStorage.setItem(secondWalletStorageKey(), JSON.stringify({ address: session.secondWallet.address || "" }));
      }catch(e){}
    }

    function shortAddr(addr){
      if (!addr) return "‚Äî";
      return addr.slice(0,4) + "..." + addr.slice(-4);
    }

    function sanitizeName(input){
      var s = (input || "").trim();
      s = s.replace(/\s+/g, " ");
      if (s.length > 24) s = s.slice(0, 24);
      return s;
    }

    function normalizeHandle(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/^@+/, "");
      if (s.length > 30) s = s.slice(0, 30);
      return s;
    }

    function normalizeDiscord(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/\s+/g, "");
      if (s.length > 32) s = s.slice(0, 32);
      return s;
    }

    function buildXUrl(handle){
      var h = normalizeHandle(handle);
      if (!h) return "";
      return "https://x.com/" + encodeURIComponent(h);
    }

    async function fetchAssetsByOwner(ownerAddress){
      var res = await fetch(CONFIG.RPC_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          jsonrpc: "2.0",
          id: "lnl",
          method: "getAssetsByOwner",
          params: {
            ownerAddress: ownerAddress,
            page: 1,
            limit: 1000,
            displayOptions: { showCollectionMetadata: true }
          }
        })
      });

      var json = await res.json();
      var items = (json && json.result && json.result.items) ? json.result.items : [];

      var lnlAssets = items.filter(function(a) {
        var groups = a.grouping || [];
        var g = groups.find(function(x) { return x.group_key === "collection"; });
        return g && g.group_value === CONFIG.COLLECTION_MINT;
      });

      var picked = (lnlAssets.length > 0) ? lnlAssets : items.filter(function(a) {
        var sym = (a.content && a.content.metadata && a.content.metadata.symbol) ||
                  (a.content && a.content.json && a.content.json.symbol) || "";
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "";
        var lname = String(name || "").toLowerCase();
        return (sym === "LNL") || (lname.indexOf("long neck") !== -1);
      });

      
      return picked.map(function(a) {
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "LNL";
        var image = (a.content && a.content.links && a.content.links.image) ||
                    (a.content && a.content.files && a.content.files[0] && a.content.files[0].uri) ||
                    (a.content && a.content.json && a.content.json.image) || "";
        var mint = a.id || "";

        // traits/attributes can appear in a few places depending on indexer
        var attrs =
          (a.content && a.content.metadata && a.content.metadata.attributes) ||
          (a.content && a.content.json && a.content.json.attributes) ||
          (a.content && a.content.metadata && a.content.metadata.traits) ||
          [];

        // normalize to [{trait_type, value}]
        var norm = [];
        if (Array.isArray(attrs)) {
          norm = attrs.map(function(x){
            if (!x) return null;
            if (typeof x === "string") return { trait_type: "Trait", value: x };
            var tt = x.trait_type || x.traitType || x.type || x.name || "Trait";
            var vv = x.value != null ? x.value : (x.val != null ? x.val : "");
            return { trait_type: String(tt || "Trait"), value: String(vv || "") };
          }).filter(Boolean);
        } else if (attrs && typeof attrs === "object") {
          // some formats are {trait_type: value, ...}
          Object.keys(attrs).forEach(function(k){
            norm.push({ trait_type: String(k), value: String(attrs[k]) });
          });
        }

        return { name: name, image: image, mint: mint, owner: ownerAddress, attributes: norm };
      });

    }

    function applyProfilePanelUI(){
      var btn = document.getElementById("tabProfile");
      var panel = document.getElementById("profilePanel");

      if (btn) btn.classList.toggle("active", !!session.profilePanelOpen);
      if (panel) panel.classList.toggle("is-hidden", !session.profilePanelOpen);
    }

    function toggleProfilePanel(){
      session.profilePanelOpen = !session.profilePanelOpen;
      applyProfilePanelUI();
    }

    async function connectWallet() {
      var provider = detectWalletProvider();
      if (!provider || typeof provider.connect !== "function") {
        alert("No Solana wallet found.\n\nInstall Phantom, Solflare, or Backpack and refresh the page.");
        return;
      }
      try {
        var resp = await provider.connect({ onlyIfTrusted: false });
        walletProvider = provider;
        walletPublicKey = resp.publicKey || provider.publicKey;
        if (!walletPublicKey) throw new Error("Wallet connected but no public key returned. Try unlocking your wallet first.");

        var addr = walletPublicKey.toBase58();
        document.getElementById("walletDisplay").textContent = shortAddr(addr);

        document.getElementById("dashNavWrap").classList.add("show");
        document.getElementById("walletChip").style.display = "flex";
        document.getElementById("disconnectBtn").style.display = "inline-block";

        document.getElementById("connectSection").style.display = "none";
        document.getElementById("loadingSection").style.display = "block";

        loadProfileFromStorage();
        loadSecondWalletFromStorage();

        session.profilePanelOpen = false;
        applyProfilePanelUI();

        await loadDashboard();
      } catch (err) {
        console.error("Connect error:", err);
        if (err.code === 4001 || (err.message && err.message.toLowerCase().includes("user rejected"))) {
          // User cancelled ‚Äî no alert needed
        } else {
          alert("Connection failed: " + (err.message || err));
        }
      }
    }

    function disconnectWallet() {
      stopChatPoll();
      try { if (walletProvider && walletProvider.disconnect) walletProvider.disconnect(); } catch (e) {}
      walletProvider = null;
      walletPublicKey = null;

      document.getElementById("dashNavWrap").classList.remove("show");
      document.getElementById("walletChip").style.display = "none";
      document.getElementById("disconnectBtn").style.display = "none";

      document.getElementById("connectSection").style.display = "block";
      document.getElementById("loadingSection").style.display = "none";
      document.getElementById("dashboard").classList.remove("show");
      document.getElementById("view-profile").classList.remove("show");
      document.getElementById("view-chat").classList.remove("show");

      session.profilePanelOpen = false;
      var tabProfile = document.getElementById("tabProfile");
      if (tabProfile) tabProfile.classList.remove("active");
      var tabChat = document.getElementById("tabChat");
      if (tabChat) tabChat.classList.remove("active");

      session.currentView = "profile";
    }

    function switchView(viewName){
      session.currentView = viewName;

      // Hide all views
      var vp = document.getElementById("view-profile");
      var vc = document.getElementById("view-chat");
      if (vp) vp.classList.remove("show");
      if (vc) vc.classList.remove("show");

      // Deactivate all tabs
      var tabProfile = document.getElementById("tabProfile");
      var tabChat    = document.getElementById("tabChat");
      if (tabProfile) tabProfile.classList.remove("active");
      if (tabChat)    tabChat.classList.remove("active");

      if (viewName === "profile") {
        stopChatPoll();
        if (vp) vp.classList.add("show");
        if (tabProfile) tabProfile.classList.toggle("active", !!session.profilePanelOpen);
      }

      if (viewName === "chat") {
        if (vc) vc.classList.add("show");
        if (tabChat) tabChat.classList.add("active");
        renderChatUI();
      }
    }

    async function loadDashboard() {
      try {
        var primary = walletPublicKey.toBase58();
        var owners = [primary];

        if (session.secondWallet.address) owners.push(session.secondWallet.address);

        var all = [];
        for (var i=0; i<owners.length; i++){
          var arr = await fetchAssetsByOwner(owners[i]);
          all = all.concat(arr);
        }

        var seen = {};
        var merged = [];
        for (var j=0; j<all.length; j++){
          var m = all[j].mint;
          if (!m) continue;
          if (seen[m]) continue;
          seen[m] = true;
          merged.push(all[j]);
        }

        session.loadedNFTs = merged;

        if (!session.profile.pfpMint && merged.length > 0) {
          session.profile.pfpMint = merged[0].mint;
          session.profile.pfpImage = merged[0].image || "";
          saveProfileToStorage();
        } else if (session.profile.pfpMint) {
          var found = merged.find(function(n){ return n.mint === session.profile.pfpMint; });
          if (found && found.image) {
            session.profile.pfpImage = found.image;
            saveProfileToStorage();
          }
        }

        document.getElementById("loadingSection").style.display = "none";
        renderProfileView(merged);

        document.getElementById("dashboard").classList.add("show");
        switchView("profile");

      } catch (err) {
        console.error("Dashboard error:", err);
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("connectSection").style.display = "block";
        alert("Error loading NFTs: " + (err.message || err));
      }
    }

    function renderProfileView(nfts) {
      var view = document.getElementById("view-profile");
      view.innerHTML = "";

      var count = nfts.length;

      if (count === 0) {
        view.innerHTML = `
          <div class="no-nfts">
            <h2>NO LONG NECK LEGENDS FOUND</h2>
            <p>You don't hold any LNL NFTs in this wallet. Cop one to unlock holder perks.</p>
            <a href="${CONFIG.MAGIC_EDEN_LINK}" target="_blank">BUY ON MAGIC EDEN</a>
          </div>
        `;
        applyProfilePanelUI();
        return;
      }

      var tier = getTier(count);
      var nextTier = getNextTier(tier);
      var points = calcPoints(count, tier);

      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
      var disc = session.profile.discord ? session.profile.discord : "";

      var progressHTML = "";
      if (nextTier) {
        var progress = ((count - tier.min) / (nextTier.min - tier.min)) * 100;
        progressHTML =
          '<div class="tier-progress-wrap">' +
            '<div class="tier-progress-label"><span>' + tier.name + '</span><span>' + nextTier.name + ' (' + nextTier.min + ' NFTs)</span></div>' +
            '<div class="tier-progress-bar"><div class="tier-progress-fill" style="width:' + Math.min(progress,100) + '%"></div></div>' +
          '</div>';
      } else {
        progressHTML = '<div style="color:#555;font-size:0.75rem;letter-spacing:2px;text-transform:uppercase;">MAX TIER REACHED \u{1F451}</div>';
      }

      var badgeInner = "";
      if (session.profile.pfpImage) {
        badgeInner = '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">';
      } else {
        badgeInner = tier.icon;
      }

      var linksHTML = '';
      if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
      if (disc) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + disc + '</span>';
      if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';

      view.innerHTML +=
      '<div class="tier-card ' + tier.cssClass + '">' +
        '<div class="tier-badge" id="pfpBadge">' + badgeInner + '</div>' +
        '<div class="tier-info">' +
          '<div class="tier-label">YOUR TIER</div>' +
          '<div class="tier-name">' + tier.name + '</div>' +
          '<div class="tier-nfts-held">Holding <strong>' + count + '</strong> Long Neck Legend' + (count !== 1 ? "s" : "") + '</div>' +
          progressHTML +
        '</div>' +
        '<div class="profile-name-box">' +
          '<div class="profile-username" id="bannerUsername">' + escapeHtml(displayName) + '</div>' +
          '<div class="profile-name-inner">' +
            '<div class="profile-links" id="bannerLinks">' + linksHTML + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

      view.innerHTML +=
        '<div class="profile-actions" id="profilePanel">' +
          '<div class="stats-title">PROFILE</div>' +
          '<div class="actions-grid">' +
            '<button class="action-btn" onclick="openPfpModal()">Edit PFP</button>' +
            '<button class="action-btn" onclick="openUsernameModal()">Edit Username</button>' +
            '<button class="action-btn" onclick="connectX()">Connect X</button>' +
            '<button class="action-btn" onclick="connectDiscord()">Connect Discord</button>' +
            '<button class="action-btn" onclick="openSecondWalletModal()">Link 2nd Wallet</button>' +
          '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">LEGEND POINTS</div>' +
          '<div class="points-display">' +
            '<div class="points-number">' + points.toLocaleString() + '</div>' +
            '<div class="points-label">Total Points</div>' +
          '</div>' +
          '<div class="stat-row"><span class="stat-label">Base (' + count + ' \u00D7 100)</span><span class="stat-value">' + (count*100) + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Tier Multiplier</span><span class="stat-value cyan">' + tier.pointsMultiplier + 'x</span></div>' +
          '<div class="stat-row"><span class="stat-label">Raffle Entries</span><span class="stat-value purple">' + (count * tier.raffleMultiplier) + '</span></div>' +
        '</div>';

      var nextTierRow = nextTier
        ? '<div class="stat-row"><span class="stat-label">Next Tier At</span><span class="stat-value gold">' + nextTier.min + ' NFTs</span></div>'
        : '<div class="stat-row"><span class="stat-label">Status</span><span class="stat-value gold">MAXED \u{1F451}</span></div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">HOLDER STATS</div>' +
          '<div class="stat-row"><span class="stat-label">NFTs Held</span><span class="stat-value cyan">' + count + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Current Tier</span><span class="stat-value">' + tier.name + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Store Discount</span><span class="stat-value green">' + tier.discount + '%</span></div>' +
          '<div class="stat-row"><span class="stat-label">Raffle Multiplier</span><span class="stat-value purple">' + tier.raffleMultiplier + 'x</span></div>' +
          nextTierRow +
        '</div>';

      // ---- SUBDAO STATUS (Trait-based) ----
      var subdao = getSubdaoMatches(nfts);
      var subdaoRows = subdao.map(function(s){
        var req = s.reqValues.join(' / ');
        return '<div class="stat-row">'
             + '<span class="stat-label">' + s.icon + ' ' + s.name + '</span>'
             + '<span class="stat-value ' + (s.unlocked ? 'green' : '') + '">' + (s.unlocked ? 'UNLOCKED' : 'LOCKED') + '</span>'
             + '</div>'
             + (s.unlocked ? '' : '<div style="color:#555;font-size:0.7rem;letter-spacing:1px;margin-top:-6px;margin-bottom:10px;">Requires: ' + escapeHtml(req) + '</div>');
      }).join('');

      var tierOrder = TIERS.map(function(t) { return t.id; });
      var currentTierIdx = tierOrder.indexOf(tier.id);

      var perksHTML = PERKS.map(function(perk) {
        var reqIdx = tierOrder.indexOf(perk.reqTier);
        var unlocked = currentTierIdx >= reqIdx;
        var reqTierObj = TIERS.find(function(t) { return t.id === perk.reqTier; });
        var desc = perk.desc;

        if (perk.dynamic && perk.name === "Store Discount" && unlocked) desc = tier.discount + "% off all LNL Store purchases paid in SOL";
        if (perk.dynamic && perk.name === "Raffle Entries" && unlocked) desc = tier.raffleMultiplier + "x entries into every raffle and giveaway";

        return '' +
          '<div class="perk ' + (unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + perk.icon + '</div>' +
            '<div class="perk-name">' + perk.name + '</div>' +
            '<div class="perk-desc">' + desc + '</div>' +
            '<div class="perk-req ' + (unlocked ? "met" : "") + '">' + (unlocked ? "\u2713 UNLOCKED" : "REQUIRES " + reqTierObj.name) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">HOLDER PERKS</div>' +
          '<div class="perks-grid">' + perksHTML + '</div>' +
        '</div>';


      var subdaoPerksHTML = getSubdaoMatches(nfts).map(function(s){
        var req = s.reqValues.join(" / ");
        var reqLine = s.unlocked ? ("Unlocked via: " + s.hit) : ("Requires: " + req);
        return '' +
          '<div class="perk ' + (s.unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (s.unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + s.icon + '</div>' +
            '<div class="perk-name">' + escapeHtml(s.name) + '</div>' +
            '<div class="perk-desc">' + escapeHtml(s.desc) + '</div>' +
            '<div class="perk-req ' + (s.unlocked ? "met" : "") + '">' + (s.unlocked ? "\u2713 UNLOCKED" : escapeHtml(reqLine)) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">SUBDAOs</div>' +
          '<div class="perks-grid subdao-grid">' + subdaoPerksHTML + '</div>' +
        '</div>';

      var galleryHTML = nfts.map(function(nft) {
        var img = nft.image
          ? '<img src="' + nft.image + '" alt="' + escapeHtml(nft.name) + '" loading="lazy">'
          : '<div style="aspect-ratio:1;background:#1e1e3a;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.8rem;">No Image</div>';
        var mintShort = nft.mint ? nft.mint.slice(0,4) + "..." + nft.mint.slice(-4) : "";
        return '' +
          '<div class="nft-tile" onclick="window.open(\'https://magiceden.us/item-details/' + nft.mint + '\', \'_blank\')">' +
            img +
            '<div class="nft-tile-info">' +
              '<div class="nft-tile-name">' + escapeHtml(nft.name) + '</div>' +
              '<div class="nft-tile-id">' + mintShort + '</div>' +
            '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="gallery-card">' +
          '<div class="stats-title">YOUR COLLECTION</div>' +
          '<div class="gallery-grid">' + galleryHTML + '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="share-section">' +
          '<button class="share-btn" onclick="window.open(\'' + CONFIG.MAGIC_EDEN_LINK + '\', \'_blank\')">MAGIC EDEN</button>' +
        '</div>';

      // ‚úÖ always re-apply toggle state after rendering the panel
      applyProfilePanelUI();
    }

    function editUsername(){
      var current = session.profile.username || "";
      var input = prompt("Set your Profile Username (max 24 chars):", current);
      if (input === null) return;
      session.profile.username = sanitizeName(input);
      saveProfileToStorage();
      refreshBanner();
    }


    function openUsernameModal(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var input = document.getElementById("usernameInput");
      if (input){
        input.value = session.profile.username || "";
        // focus for mobile keyboard
        setTimeout(function(){ try{ input.focus(); input.setSelectionRange(input.value.length, input.value.length);}catch(e){} }, 50);
      }
      document.getElementById("usernameModalBackdrop").classList.add("show");
    }

    function hideUsernameModal(){
      document.getElementById("usernameModalBackdrop").classList.remove("show");
    }

    function closeUsernameModal(e){
      if (e && e.target && e.target.id === "usernameModalBackdrop") hideUsernameModal();
    }

    function saveUsernameFromModal(){
      var input = document.getElementById("usernameInput");
      var val = input ? input.value : "";
      session.profile.username = sanitizeName(val);
      saveProfileToStorage();
      refreshBanner();
      hideUsernameModal();
    }

    function clearUsername(){
      session.profile.username = "";
      saveProfileToStorage();
      refreshBanner();
      var input = document.getElementById("usernameInput");
      if (input) input.value = "";
    }


    function linkLedger(){
      var current = session.profile.ledger || "";
      var input = prompt("Paste your Ledger public key / label (optional):", current);
      if (input === null) return;
      session.profile.ledger = (input || "").trim().slice(0, 42);
      saveProfileToStorage();
      refreshBanner();
    }

    function refreshBanner(){
      var bn = document.getElementById("bannerUsername");
    if (bn) {
      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      bn.textContent = displayName;
    }

      var bl = document.getElementById("bannerLinks");
      if (bl) {
        var linksHTML = "";
        var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
        if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
        if (session.profile.discord) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + session.profile.discord + '</span>';
        if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';
        bl.innerHTML = linksHTML;
      }
    }

    function openPfpModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return;

      var grid = document.getElementById("pfpGrid");
      grid.innerHTML = "";

      session.loadedNFTs.forEach(function(nft){
        var selected = (session.profile.pfpMint && nft.mint === session.profile.pfpMint);

        var tile = document.createElement("div");
        tile.className = "pfp-tile" + (selected ? " selected" : "");
        tile.addEventListener("click", function(){ selectPfp(nft.mint); });

        var dot = document.createElement("div");
        dot.className = "pfp-selected";
        tile.appendChild(dot);

        if (nft.image) {
          var img = document.createElement("img");
          img.src = nft.image;
          img.alt = nft.name || "LNL";
          img.loading = "lazy";
          tile.appendChild(img);
        } else {
          var ph = document.createElement("div");
          ph.style.aspectRatio = "1";
          ph.style.background = "#1e1e3a";
          tile.appendChild(ph);
        }

        var name = document.createElement("div");
        name.className = "pfp-name";
        name.textContent = nft.name || "LNL";
        tile.appendChild(name);

        grid.appendChild(tile);
      });

      document.getElementById("pfpModalBackdrop").classList.add("show");
    }

    function hidePfpModal(){
      document.getElementById("pfpModalBackdrop").classList.remove("show");
    }

    function closePfpModal(e){
      if (e && e.target && e.target.id === "pfpModalBackdrop") hidePfpModal();
    }

    function selectPfp(mint){
      var found = session.loadedNFTs.find(function(n){ return n.mint === mint; });
      if (!found) return;

      session.profile.pfpMint = mint;
      session.profile.pfpImage = found.image || "";
      saveProfileToStorage();

      var badge = document.getElementById("pfpBadge");
      if (badge) {
        badge.innerHTML = session.profile.pfpImage
          ? '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">'
          : badge.innerHTML;
      }

      hidePfpModal();
    }

    function escapeHtml(str){
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function openSecondWalletModal(){
      if (!walletPublicKey) return alert("Connect main wallet first.");
      var el = document.getElementById("secondWalletStatus");
      if (el) {
        el.textContent = session.secondWallet.address
          ? ("Linked: " + shortAddr(session.secondWallet.address))
          : "No second wallet linked yet.";
      }
      document.getElementById("secondWalletModalBackdrop").classList.add("show");
    }

    function hideSecondWalletModal(){
      document.getElementById("secondWalletModalBackdrop").classList.remove("show");
    }

    function closeSecondWalletModal(e){
      if (e && e.target && e.target.id === "secondWalletModalBackdrop") hideSecondWalletModal();
    }

    async function connectSecondWallet(which){
      try{
        var provider = getProviderByName(which);
        if (!provider || typeof provider.connect !== "function") {
          return alert("Wallet provider not found. Make sure " + which + " is installed & enabled.");
        }

        var resp = await provider.connect({ onlyIfTrusted: false });
        var pk = resp && resp.publicKey ? resp.publicKey : provider.publicKey;
        if (!pk) throw new Error("Connected but no publicKey returned.");

        var addr = (typeof pk.toBase58 === "function") ? pk.toBase58() : String(pk);

        if (walletPublicKey && addr === walletPublicKey.toBase58()){
          return alert("That‚Äôs your main wallet already. Pick a different wallet for the 2nd slot.");
        }

        session.secondWallet.address = addr;
        saveSecondWalletToStorage();

        var el = document.getElementById("secondWalletStatus");
        if (el) el.textContent = "Linked: " + shortAddr(addr) + " ‚Äî rescanning‚Ä¶";

        document.getElementById("loadingSection").style.display = "block";
        document.getElementById("dashboard").classList.remove("show");
        await loadDashboard();

        hideSecondWalletModal();
        alert("2nd wallet linked: " + shortAddr(addr));
      } catch (err) {
        console.error("Second wallet connect error:", err);
        alert("Failed to link 2nd wallet: " + (err.message || err));
      }
    }

    function unlinkSecondWallet(){
      session.secondWallet.address = "";
      saveSecondWalletToStorage();

      var el = document.getElementById("secondWalletStatus");
      if (el) el.textContent = "Second wallet unlinked. Rescanning‚Ä¶";

      document.getElementById("loadingSection").style.display = "block";
      document.getElementById("dashboard").classList.remove("show");
      loadDashboard();
    }


    function isMobileDevice(){
      // Conservative check: treat small screens OR mobile UA as mobile
      try{
        var ua = (navigator.userAgent || "").toLowerCase();
        var small = window.matchMedia && window.matchMedia("(max-width: 820px)").matches;
        var touch = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
        var mobileUA = /iphone|ipad|ipod|android|mobile|silk|kindle|webos|blackberry|opera mini/.test(ua);
        return mobileUA || (small && touch);
      }catch(e){
        return false;
      }
    }

    function startAuthFlow(url, title){
      // Mobile browsers commonly block popups and postMessage callbacks.
      // On mobile we navigate in the same tab so it always works.
      if (isMobileDevice()){
        window.location.href = url;
        return null;
      }
      return openAuthPopup(url, title);
    }

    function applyAuthFromUrl(){
      // Support mobile callbacks that redirect back with query params.
      // We accept a few common shapes: ?x=handle, ?x_username=handle, ?discord=username, ?discord_username=u&discord_discriminator=1234
      try{
        var p = new URLSearchParams(window.location.search || "");
        var xh = p.get("x") || p.get("x_username") || p.get("xHandle") || p.get("xhandle");
        var du = p.get("discord") || p.get("discord_username") || p.get("discordUser") || p.get("discorduser");
        var dd = p.get("discord_discriminator") || p.get("discordDiscriminator") || p.get("disc");
        var didSomething = false;

        if (xh){
          session.profile.x = normalizeHandle(xh);
          didSomething = true;
        }
        if (du){
          var full = du;
          if (dd && dd !== "0") full = du + "#" + dd;
          session.profile.discord = full;
          didSomething = true;
        }

        if (didSomething){
          saveProfileToStorage();
          refreshBanner();

          // Clean the URL so refresh doesn't re-apply
          if (window.history && window.history.replaceState){
            var clean = window.location.pathname + window.location.hash;
            window.history.replaceState({}, document.title, clean);
          }
        }
      }catch(e){}
    }

    function openAuthPopup(url, title){
      var w = 520, h = 720;
      var y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
      var x = window.top.outerWidth  / 2 + window.top.screenX - (w / 2);
      var popup = window.open(
        url,
        title,
        'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width=' + w + ', height=' + h + ', top=' + y + ', left=' + x
      );
      if (!popup) alert("Popup blocked. Please allow popups for this site.");
      return popup;
    }

    function connectX(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/x/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      startAuthFlow(url, "Connect X");
    }

    function connectDiscord(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/discord/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      startAuthFlow(url, "Connect Discord");
    }

    window.addEventListener("message", function(ev){
      if (ev.origin !== window.location.origin) return;

      var data = ev.data || {};
      if (!data || !data.type) return;

      if (data.type === "x_connected") {
        session.profile.x = data.username || "";
        saveProfileToStorage();
        refreshBanner();
        alert("X connected: @" + (data.username || "unknown"));
      }

      if (data.type === "discord_connected") {
        session.profile.discord = data.username
          ? (data.username + (data.discriminator ? ("#" + data.discriminator) : ""))
          : "";
        saveProfileToStorage();
        refreshBanner();
        alert("Discord connected: " + (session.profile.discord || "connected"));
      }

      if (data.type === "x_error" || data.type === "discord_error") {
        alert("Auth failed. Please try again.");
      }
    });
  
    function openTraitsModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return alert("No NFTs loaded yet.");
      var sub = getSubdaoMatches(session.loadedNFTs);

      var pills = document.getElementById("subdaoPills");
      if (pills){
        pills.innerHTML = sub.map(function(s){
          return '<span class="pill ' + (s.unlocked ? 'on' : 'off') + '">'
               + (s.unlocked ? '‚úì' : '‚Ä¢') + ' ' + s.icon + ' ' + escapeHtml(s.name)
               + '</span>';
        }).join("");
      }

      var counts = buildTraitCounts(session.loadedNFTs);
      var rows = Object.keys(counts).sort(function(a,b){ return counts[b]-counts[a]; }).slice(0, 80);
      var tbody = document.querySelector("#traitsTable tbody");
      if (tbody){
        tbody.innerHTML = rows.map(function(k){
          return '<tr><td>' + escapeHtml(k) + '</td><td>' + counts[k] + '</td></tr>';
        }).join("");
        if (rows.length === 0) tbody.innerHTML = '<tr><td colspan="2" class="trait-muted">No trait data found in metadata.</td></tr>';
      }

      document.getElementById("traitsModalBackdrop").classList.add("show");
    }

    function hideTraitsModal(){
      document.getElementById("traitsModalBackdrop").classList.remove("show");
    }

    function closeTraitsModal(e){
      if (e && e.target && e.target.id === "traitsModalBackdrop") hideTraitsModal();
    }

    /* ================================================================
       CHAT ‚Äî Supabase real-time
       Table: chat_messages (id, wallet, username, text, created_at)
       Messages are shared live across all connected wallets.
    ================================================================ */

    var SUPA_URL = 'https://hypqndasopdkrqvkllvc.supabase.co';
    var SUPA_KEY = 'sb_publishable_DwaaLS_hFJAOZ6M9VmYKYA_AQvyfgv1';
    var supaClient  = null;
    var chatChannel = null;   // real-time subscription
    var chatMsgs    = [];     // [{id, wallet, username, text, created_at}]

    // Auto-refresh fallback (in case real-time misses / tab sleeps)
    var chatRefreshTimer = null;
    var CHAT_REFRESH_MS  = 8000; // 8s feels "live" without spamming

    function getSupaClient() {
      if (!supaClient) {
        supaClient = supabase.createClient(SUPA_URL, SUPA_KEY);
      }
      return supaClient;
    }

    // Deterministic color per wallet so each user always looks the same
    function walletColor(addr) {
      var palette = ['#00d4ff','#7b68ee','#00ff88','#f5a623','#ff6b9d','#4ecdc4','#ffd93d','#ff8c42'];
      var hash = 0;
      for (var i = 0; i < (addr || '').length; i++) {
        hash = ((hash << 5) - hash) + addr.charCodeAt(i);
        hash |= 0;
      }
      return palette[Math.abs(hash) % palette.length];
    }

    // Called when leaving chat tab or disconnecting
    function stopChatPoll() {
      // stop fallback refresh timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // stop real-time subscription
      if (chatChannel) {
        try { getSupaClient().removeChannel(chatChannel); } catch(e) {}
        chatChannel = null;
      }
    }
    function renderChatUI() {
      var view = document.getElementById('view-chat');
      if (!view) return;

      view.innerHTML =
        // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">ü¶í HOLDER CHAT</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">Live ¬∑ Open to all connected wallets</div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:0.7rem;">' +
            '<div id="chatLiveDot" style="display:flex;align-items:center;gap:5px;font-size:0.7rem;color:#555;">' +
              '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶' +
            '</div>' +
            '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Messages ‚îÄ‚îÄ
        '<div id="chatBox" style="height:440px;overflow-y:auto;background:#06060f;border:1px solid #161628;border-radius:12px;padding:16px;margin-bottom:12px;scroll-behavior:smooth;">' +
          '<div id="chatInner"></div>' +
        '</div>' +

        // ‚îÄ‚îÄ Input ‚îÄ‚îÄ
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<div id="chatInputWrap" style="flex:1;display:flex;align-items:center;gap:8px;background:#0d0d1e;border:1px solid #1a1a30;border-radius:10px;padding:0 12px;transition:border-color 0.2s;">' +
            '<span id="chatWalletTag" style="font-size:0.78rem;font-weight:700;flex-shrink:0;white-space:nowrap;"></span>' +
            '<input id="chatInput" style="flex:1;background:transparent;border:none;outline:none;color:#e0e0ff;font-family:\'Space Grotesk\',sans-serif;font-size:0.88rem;padding:12px 0;" placeholder="Say something legend‚Ä¶" maxlength="400" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendChatMessage();}" />' +
            '<span id="chatCount" style="font-size:0.62rem;color:#252540;flex-shrink:0;min-width:28px;text-align:right;"></span>' +
          '</div>' +
          '<button id="chatSendBtn" onclick="sendChatMessage()" style="background:linear-gradient(135deg,rgba(0,212,255,0.18),rgba(123,104,238,0.18));border:1px solid rgba(0,212,255,0.35);color:#00d4ff;padding:12px 22px;border-radius:10px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.8rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;white-space:nowrap;">Send</button>' +
        '</div>';

      // Wallet tag
      if (walletPublicKey) {
        var addr = walletPublicKey.toBase58();
        var tag  = document.getElementById('chatWalletTag');
        tag.textContent = addr.slice(0,4) + '‚Ä¶' + addr.slice(-4);
        tag.style.color = walletColor(addr);
      }

      // Focus ring
      var wrap = document.getElementById('chatInputWrap');
      var inp  = document.getElementById('chatInput');
      inp.addEventListener('focus', function(){ wrap.style.borderColor = 'rgba(0,212,255,0.45)'; });
      inp.addEventListener('blur',  function(){ wrap.style.borderColor = '#1a1a30'; });
      inp.addEventListener('input', function(){
        var left = 400 - inp.value.length;
        var c = document.getElementById('chatCount');
        c.textContent = left < 80 ? left : '';
        c.style.color = left < 30 ? '#ff3c5c' : '#252540';
      });

      // Load history then subscribe
      chatMsgs = [];
      loadChatHistory();
    }

    
    // Pull any new messages since the newest one we have.
    // This runs on an interval as a safety net (real-time should still do the heavy lifting).
    async function refreshChatFromServer() {
      try {
        // only refresh if we're actually on the chat tab and the UI exists
        if (!session || session.currentView !== 'chat') return;
        if (!document.getElementById('chatInner')) return;

        var sb = getSupaClient();

        var last = (chatMsgs && chatMsgs.length) ? chatMsgs[chatMsgs.length - 1] : null;
        var q = sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        // Incremental fetch: only grab messages newer than what we have.
        if (last && last.created_at) {
          q = q.gt('created_at', last.created_at);
        }

        var res = await q;
        if (res.error) throw res.error;

        var incoming = res.data || [];
        if (!incoming.length) return;

        // Merge de-duped by id
        var existing = {};
        for (var i = 0; i < chatMsgs.length; i++) existing[chatMsgs[i].id] = true;

        for (var j = 0; j < incoming.length; j++) {
          if (!existing[incoming[j].id]) chatMsgs.push(incoming[j]);
        }

        // Keep sorted (in case clocks are funky)
        chatMsgs.sort(function(a,b){
          return new Date(a.created_at) - new Date(b.created_at);
        });

        paintMessages();
        scrollToBottom(false);
      } catch(e) {
        // quiet failure ‚Äî this is just a fallback
        console.warn('Chat auto-refresh error:', e && (e.message || e));
      }
    }

    function startChatAutoRefresh() {
      // reset any existing timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // immediate refresh in case we missed messages while tab was inactive
      refreshChatFromServer();

      chatRefreshTimer = setInterval(function(){
        refreshChatFromServer();
      }, CHAT_REFRESH_MS);

      // when user comes back to the tab, refresh immediately
      try {
        if (!window.__lnlChatVisHooked) {
          window.__lnlChatVisHooked = true;
          document.addEventListener('visibilitychange', function(){
            if (!document.hidden) refreshChatFromServer();
          });
          window.addEventListener('focus', function(){ refreshChatFromServer(); });
        }
      } catch(e) {}
    }

    async function loadChatHistory() {
      setLiveDot(false);
      try {
        var sb = getSupaClient();
        var res = await sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        if (res.error) throw res.error;
        chatMsgs = res.data || [];
        paintMessages();
        scrollToBottom(true);
      } catch(e) {
        console.error('Chat history error:', e);
        document.getElementById('chatInner').innerHTML =
          '<div style="color:#ff3c5c;font-size:0.78rem;text-align:center;padding:2rem;">Could not load messages. Check Supabase config.</div>';
      }
      subscribeLive();
    }

    function subscribeLive() {
      // Tear down any existing subscription first
      stopChatPoll();

      var sb = getSupaClient();
      chatChannel = sb
        .channel('chat_messages_live')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'chat_messages'
        }, function(payload) {
          var row = payload.new;
          // Avoid duplicates (our own optimistic message already added)
          var exists = chatMsgs.some(function(m){ return m.id === row.id; });
          if (!exists) {
            chatMsgs.push(row);
            paintMessages();
            scrollToBottom(false);
          }
        })
        .subscribe(function(status) {
          setLiveDot(status === 'SUBSCRIBED');
        });

      // Safety-net refresh (keeps chat updated even if real-time drops)
      startChatAutoRefresh();
    }

    function setLiveDot(live) {
      var el = document.getElementById('chatLiveDot');
      if (!el) return;
      if (live) {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 6px rgba(0,255,136,0.7);"></div>Live';
        el.style.color = '#555';
      } else {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶';
      }
    }

    function paintMessages() {
      var inner = document.getElementById('chatInner');
      if (!inner) return;

      if (chatMsgs.length === 0) {
        inner.innerHTML =
          '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:340px;gap:0.7rem;">' +
            '<div style="font-size:2.5rem;">ü¶í</div>' +
            '<div style="color:#252540;font-size:0.78rem;letter-spacing:2px;text-transform:uppercase;">No messages yet</div>' +
            '<div style="color:#1a1a30;font-size:0.7rem;">Be the first legend</div>' +
          '</div>';
        return;
      }

      var myWallet  = walletPublicKey ? walletPublicKey.toBase58() : null;
      var prevWallet = null;
      var html = '';

      chatMsgs.forEach(function(m, i) {
        var isMe  = m.wallet === myWallet;
        var color = walletColor(m.wallet);

        // Display name: use stored username if present, else shorten wallet
        var name = m.username
          ? m.username
          : (m.wallet.slice(0,4) + '‚Ä¶' + m.wallet.slice(-4));

        var newSender = m.wallet !== prevWallet;
        prevWallet = m.wallet;

        var t = new Date(m.created_at);
        var timeStr = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        if (newSender) {
          if (i > 0) html += '<div style="height:12px;"></div>';
          html +=
            '<div style="display:flex;align-items:baseline;gap:7px;margin-bottom:3px;">' +
              '<span style="font-weight:700;font-size:0.8rem;color:' + color + ';">' + escapeHtml(name) + '</span>' +
              '<span style="font-size:0.6rem;color:#252540;">' + timeStr + '</span>' +
              (isMe ? '<span style="font-size:0.55rem;letter-spacing:1px;color:#1e1e3a;text-transform:uppercase;">you</span>' : '') +
            '</div>';
        }

        html += '<div style="font-size:0.87rem;color:#c8c8e8;line-height:1.6;word-break:break-word;padding:1px 0;">' + escapeHtml(m.text) + '</div>';
      });

      inner.innerHTML = html;
    }

    function scrollToBottom(force) {
      var box = document.getElementById('chatBox');
      if (!box) return;
      var nearBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 120;
      if (force || nearBottom) box.scrollTop = box.scrollHeight;
    }

    async function sendChatMessage() {
      if (!walletPublicKey) { alert('Connect your wallet first.'); return; }
      var inp = document.getElementById('chatInput');
      var btn = document.getElementById('chatSendBtn');
      if (!inp) return;

      var text = inp.value.trim();
      if (!text) return;

      inp.value = '';
      inp.dispatchEvent(new Event('input'));
      btn.disabled = true;
      btn.textContent = '‚Ä¶';

      var wallet   = walletPublicKey.toBase58();
      var username = session.profile.username || null;

      try {
        var sb  = getSupaClient();
        var res = await sb.from('chat_messages').insert({
          wallet:   wallet,
          username: username,
          text:     text
        }).select().single();

        if (res.error) throw res.error;

        // Optimistic: add immediately so sender doesn't wait for real-time echo
        var exists = chatMsgs.some(function(m){ return m.id === res.data.id; });
        if (!exists) {
          chatMsgs.push(res.data);
          paintMessages();
          scrollToBottom(true);
        }
      } catch(e) {
        console.error('Send error:', e);
        alert('Failed to send: ' + (e.message || e));
      }

      btn.disabled = false;
      btn.textContent = 'Send';
      inp.focus();
    }

  </script>
</body>
</html>
