<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/jpGdtHJ.jpeg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LNL Holder Dashboard | Profile</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Orbitron:wght@400;700;900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Keep banner links (like X) white */
a.plink,
a.plink:visited,
a.plink:hover,
a.plink:active {
  color: #e0e0ff;          /* your ‚Äúwhite‚Äù */
  text-decoration: none;
}
a.plink:hover{
  text-decoration: underline; /* optional */
}
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a1a;
      color: #e0e0ff;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    body.loaded { opacity: 1; }

    /* ---- TOP NAV (SITE) ---- */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 1rem 0;
      background: rgba(10,10,26,0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    nav a {
      color: #e0e0ff;
      margin: 0 1.5rem;
      text-decoration: none;
      font-weight: 600;
      position: relative;
      font-size: 0.9rem;
    }
    nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #00d4ff;
      transition: 0.3s;
    }
    nav a:hover::after { width: 100%; }

    /* ---- HERO ---- */
    .hero {
      margin-top: 60px;
      padding: 4rem 2rem 2.2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: 'HOLDER';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(120px, 20vw, 400px);
      color: rgba(0,212,255,0.03);
      pointer-events: none;
      white-space: nowrap;
      letter-spacing: 20px;
    }
    .hero h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.6rem, 4vw, 2.8rem);
      font-weight: 900;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .hero h1 span { color: #00d4ff; text-shadow: 0 0 30px rgba(0,212,255,0.4); }
    .hero-sub {
      color: #888;
      font-size: 0.95rem;
    }

    /* ---- DASH NAV (DASHBOARD-ONLY) ---- */
    .dash-nav-wrap{
      position: sticky;
      top: 60px; /* below site nav */
      z-index: 900;
      background: rgba(10,10,26,0.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: none;
    }
    .dash-nav-wrap.show { display: block; }

    .dash-nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.9rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .dash-tabs{
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .dash-tab{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: #bfc2ff;
      padding: 8px 14px;
      font-size: 0.78rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }
    .dash-tab:hover{
      border-color: rgba(0,212,255,0.45);
      color: #e0e0ff;
      box-shadow: 0 0 18px rgba(0,212,255,0.12);
      transform: translateY(-1px);
    }
    .dash-tab.active{
      border-color: rgba(0,212,255,0.65);
      color: #00d4ff;
      box-shadow: 0 0 22px rgba(0,212,255,0.16);
    }

    .dash-right{
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.7rem;
      flex-wrap: wrap;
    }

    /* --- DASH NAV mobile-safe polish (max width like cards) --- */
    .dash-nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.9rem 2rem;
    }

    .dash-tabs{ flex: 1 1 auto; min-width: 0; }
    .dash-right{ flex: 0 0 auto; }

    .wallet-chip{ max-width: 240px; }
    .wallet-addr{ overflow: hidden; text-overflow: ellipsis; }

    @media (max-width: 800px){
      .dash-nav{ padding: 0.8rem 1rem; }
      .dash-right{ gap: 0.5rem; }
      .wallet-chip{ max-width: 170px; }
    }

    @media (max-width: 420px){
      .dash-nav{ flex-wrap: wrap; row-gap: 0.6rem; }
      .dash-right{ width: 100%; justify-content: flex-end; }
      .wallet-chip{ max-width: 100%; }
    }

    .wallet-chip{
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(17,17,37,0.55);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .wallet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 8px rgba(0,255,136,0.6);
      flex: 0 0 auto;
    }
    .wallet-addr {
      color: #888;
      font-size: 0.78rem;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .wallet-addr strong { color: #e0e0ff; }

    .disconnect-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.10);
      color: #7a7aa6;
      padding: 8px 12px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.8px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 8px;
      font-weight: 700;
    }
    .disconnect-btn:hover { border-color: #ff3c5c; color: #ff3c5c; box-shadow: 0 0 18px rgba(255,60,92,0.14); }

    @media (max-width: 700px){
      .dash-nav{ padding: 0.8rem 1rem; }
      nav a { margin: 0 0.8rem; font-size: 0.75rem; }
      .wallet-chip{ max-width: 100%; }
    }

    /* ---- CONNECT SECTION ---- */
    .connect-section {
      text-align: center;
      padding: 4rem 2rem;
    }
    .connect-btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7b68ee 100%);
      color: #000;
      border: none;
      padding: 16px 48px;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      border-radius: 4px;
      transition: all 0.3s;
      box-shadow: 0 4px 30px rgba(0,212,255,0.3);
    }
    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 40px rgba(0,212,255,0.5);
    }
    .connect-prompt {
      color: #555;
      margin-top: 1rem;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    /* ---- DASHBOARD GRID / VIEWS ---- */
    .dashboard {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.8rem 2rem 4rem;
      gap: 1.5rem;
    }
    .dashboard.show { display: block; }

    .view{ display: none; }
    .view.show{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    #view-chat.show {
      display: flex;
      flex-direction: column;
      grid-template-columns: unset;
    }
    @media (max-width: 800px) {
      .view.show { grid-template-columns: 1fr; }
      .dashboard{ padding: 1.4rem 1rem 3rem; }
    }

    /* ---- TIER CARD ---- */
    .tier-card {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid #1e1e3a;
      border-radius: 16px;
      padding: 2.3rem;
      display: flex;
      align-items: center;
      gap: 2.2rem;
      position: relative;
      overflow: hidden;
      min-height: 180px;
    }
    .tier-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      opacity: 0.08;
      pointer-events: none;
    }
    .tier-card.tier-neck::before { background: radial-gradient(circle, #00d4ff, transparent); }
    .tier-card.tier-longneck::before { background: radial-gradient(circle, #7b68ee, transparent); }
    .tier-card.tier-legend::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-og::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-sardine::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-barracuda::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-shark::before { background: radial-gradient(circle, #00ffcc, transparent); }
    .tier-card.tier-whale::before { background: radial-gradient(circle, #00ffcc, transparent); }

    @media (max-width: 600px) {
      .tier-card { flex-direction: column; text-align: center; padding: 2rem 1.5rem; }
    }

    .tier-badge {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: 1.8rem;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .tier-badge::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 2px solid;
      animation: tierPulse 2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes tierPulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .tier-badge img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.05) contrast(1.05);
    }

    .tier-neck .tier-badge { color: #00d4ff; }
    .tier-neck .tier-badge::after { border-color: #00d4ff; }
    .tier-longneck .tier-badge { color: #7b68ee; }
    .tier-longneck .tier-badge::after { border-color: #7b68ee; }
    .tier-legend .tier-badge { color: #ffd700; }
    .tier-legend .tier-badge::after { border-color: #ffd700; }
    .tier-og .tier-badge { color: #ffd700; }
    .tier-og .tier-badge::after { border-color: #ffd700; }
    .tier-sardine .tier-badge { color: #ff3c5c; }
    .tier-sardine .tier-badge::after { border-color: #ff3c5c; }
    .tier-barracuda .tier-badge { color: #ff3c5c; }
    .tier-barracuda .tier-badge::after { border-color: #ff3c5c; }
    .tier-shark .tier-badge { color: #00ffcc; }
    .tier-shark .tier-badge::after { border-color: #00ffcc; }
    .tier-whale .tier-badge { color: #00ffcc; }
    .tier-whale .tier-badge::after { border-color: #00ffcc; }

    .tier-info { flex: 1; min-width: 240px; }
    .tier-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 0.3rem;
    }
    .tier-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.8rem;
      letter-spacing: 4px;
      line-height: 1;
      margin-bottom: 0.3rem;
    }
    .tier-neck .tier-name { color: #00d4ff; }
    .tier-longneck .tier-name { color: #7b68ee; }
    .tier-legend .tier-name { color: #ffd700; }
    .tier-og .tier-name { color: #ffd700; }
    .tier-sardine .tier-name { color: #ff3c5c; }
    .tier-barracuda .tier-name { color: #ff3c5c; }
    .tier-shark .tier-name { color: #00ffcc; }
    .tier-whale .tier-name { color: #00ffcc; }

    .tier-nfts-held {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .tier-nfts-held strong { color: #e0e0ff; font-weight: 700; }

    .tier-progress-wrap { max-width: 320px; }
    .tier-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
      gap: 12px;
    }
    .tier-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      overflow: hidden;
    }
    .tier-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .tier-neck .tier-progress-fill { background: #00d4ff; box-shadow: 0 0 10px rgba(0,212,255,0.5); }
    .tier-longneck .tier-progress-fill { background: #7b68ee; box-shadow: 0 0 10px rgba(123,104,238,0.5); }
    .tier-legend .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-og .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-sardine .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-barracuda .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-shark .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }
    .tier-whale .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }

/* ---- Username + Social Box (right side of tier card) ---- */
.profile-name-box{
  flex: 0 0 320px;
  max-width: 360px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;     /* right align */
  justify-content: center;
  text-align: right;
  gap: 0.5rem;
}

.profile-username{
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.4rem;
  letter-spacing: 4px;
  line-height: 1;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* username color mimics tier-name color */
.tier-neck .profile-username { color: #00d4ff; }
.tier-longneck .profile-username { color: #7b68ee; }
.tier-legend .profile-username { color: #ffd700; }
.tier-og .profile-username { color: #ffd700; }
.tier-sardine .profile-username { color: #ff3c5c; }
.tier-barracuda .profile-username { color: #ff3c5c; }
.tier-shark .profile-username { color: #00ffcc; }
.tier-whale .profile-username { color: #00ffcc; }

.profile-name-inner{
  width: 100%;
  padding: 0.7rem 0.8rem;
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.06);
}

.profile-links{
  display: flex;
  justify-content: flex-end; /* keep right aligned */
  gap: 8px;
  flex-wrap: wrap;
}

/* responsive: center it on smaller widths */
@media (max-width: 900px){
  .profile-name-box{
    flex: 1 1 auto;
    max-width: 100%;
    align-items: center;
    text-align: center;
  }
  .profile-links{ justify-content: center; }
}

    /* ---- STATS CARD ---- */
    .stats-card {
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .stats-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 1.2rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.7rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: #888; font-size: 0.8rem; }
    .stat-value { font-weight: 700; font-size: 1.1rem; }
    .stat-value.cyan { color: #00d4ff; }
    .stat-value.purple { color: #7b68ee; }
    .stat-value.gold { color: #ffd700; }
    .stat-value.green { color: #00ff88; }

    /* ---- POINTS DISPLAY ---- */
    .points-display { text-align: center; padding: 1.5rem 0; }
    .points-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .points-label {
      font-size: 0.7rem;
      letter-spacing: 3px;
      color: #555;
      text-transform: uppercase;
      margin-top: 0.3rem;
    }

    /* ---- PROFILE ACTIONS ---- */
    .profile-actions{
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 1.6rem 2rem;
    }
    .profile-actions.is-hidden { display: none; }
    .actions-grid{
      display: grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap: 0.8rem;
      margin-top: 0.9rem;
    }
    @media (max-width: 1100px){
      .actions-grid{ grid-template-columns: repeat(3, minmax(140px, 1fr)); }
    }
    @media (max-width: 600px){
      .actions-grid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .points-number { font-size: 2.5rem; }
    }
    .action-btn{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      color: #cfd2ff;
      padding: 12px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 800;
      font-size: 0.74rem;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      font-family: 'Space Grotesk', sans-serif;
      text-align: center;
    }
    .action-btn:hover{
      border-color: rgba(0,212,255,0.45);
      box-shadow: 0 0 22px rgba(0,212,255,0.12);
      transform: translateY(-1px);
      color: #e0e0ff;
    }
    .action-btn.danger:hover{
      border-color: rgba(255,60,92,0.6);
      box-shadow: 0 0 22px rgba(255,60,92,0.10);
      color: #ff7a90;
    }

    /* ---- PERKS CARD ---- */
    .perks-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .perks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .perk {
      background: rgba(0,0,0,0.3);
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      padding: 1.2rem;
      position: relative;
      transition: all 0.3s;
    }
    .perk.unlocked { border-color: rgba(0,212,255,0.3); background: rgba(0,212,255,0.04); }
    .perk.locked { opacity: 0.4; }
    .perk-icon { font-size: 1.8rem; margin-bottom: 0.6rem; }
    .perk-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 0.3rem; letter-spacing: 0.5px; }
    .perk-desc { color: #666; font-size: 0.72rem; line-height: 1.5; }
    .perk-req { font-size: 0.65rem; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.6rem; }
    .perk-req.met { color: #00ff88; }
    .perk-status {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .perk-status.on { background: #00ff88; box-shadow: 0 0 8px rgba(0,255,136,0.6); }
    .perk-status.off { background: #333; }

    /* ---- NFT GALLERY ---- */
    .gallery-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .nft-tile {
      background: #0a0a1a;
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
    }
    .nft-tile:hover {
      transform: translateY(-4px);
      border-color: rgba(0,212,255,0.4);
      box-shadow: 0 8px 30px rgba(0,212,255,0.15);
    }
    .nft-tile img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .nft-tile-info { padding: 0.7rem; }
    .nft-tile-name {
      font-weight: 700;
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nft-tile-id { color: #555; font-size: 0.65rem; margin-top: 2px; }

    /* ---- SHARE CARD ---- */
    .share-section { grid-column: 1 / -1; text-align: center; padding: 1rem 0; }
    .share-btn {
      background: transparent;
      border: 1px solid #1e1e3a;
      color: #888;
      padding: 10px 28px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 4px;
    }
    .share-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
      box-shadow: 0 0 20px rgba(0,212,255,0.15);
    }

    /* ---- NO NFTS STATE ---- */
    .no-nfts {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem 2rem;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
    }
    .no-nfts h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .no-nfts p { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .no-nfts a {
      display: inline-block;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      color: #000;
      text-decoration: none;
      padding: 12px 36px;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .no-nfts a:hover { box-shadow: 0 4px 30px rgba(0,212,255,0.4); transform: translateY(-2px); }

    /* ---- LOADING ---- */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0,212,255,0.15);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      color: #555;
      font-size: 0.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* ---- MODALS ---- */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1.2rem;
    }
    .modal-backdrop.show{ display: flex; }

    .modal{
      width: min(920px, 100%);
      max-height: 85vh; 
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
    }
    .modal-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.18);
    }
    .modal-title{
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      letter-spacing: 2px;
      font-size: 0.95rem;
      color: #e0e0ff;
      text-transform: uppercase;
    }
    .modal-close{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      color: #9a9abd;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      transition: all 0.2s;
    }
    .modal-close:hover{
      border-color: rgba(255,60,92,0.55);
      color: #ff3c5c;
      box-shadow: 0 0 16px rgba(255,60,92,0.12);
    }
    .modal-body{
      padding: 1.2rem;
      max-height: min(70vh, 640px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .pfp-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.9rem;
    }
    .pfp-tile{
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.22);
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .pfp-tile:hover{
      border-color: rgba(0,212,255,0.45);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,212,255,0.10);
    }
    .pfp-tile img{
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .pfp-tile .pfp-name{
      padding: 0.6rem 0.7rem;
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.4px;
      color: #e0e0ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pfp-selected{
      position: absolute;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.55);
      display: none;
    }
    .pfp-tile.selected .pfp-selected{ display: block; }

    .modal-note{
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 0.9rem;
      letter-spacing: 0.4px;
    }

    /* ---- FOOTER ---- */
    footer {
      text-align: center;
      padding: 3rem 2rem;
      border-top: 1px solid #1e1e3a;
      color: #333;
      font-size: 0.7rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* ---- SCROLLBAR ---- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a1a; }
    ::-webkit-scrollbar-thumb { background: #1e1e3a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #00d4ff; }

    @media (max-width: 600px) {
      .perks-grid { grid-template-columns: 1fr 1fr; }
      .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    }
  
    /* ---- TRAITS / SUBDAO ---- */
    .subdao-divider{
      margin-top: 1.2rem;
      padding-top: 1.2rem;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .subdao-grid{
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 900px){
      .subdao-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px){
      .subdao-grid{ grid-template-columns: 1fr; }
    }
    .trait-pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 0.6rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color:#bfc2ff;
      font-size:0.7rem;
      letter-spacing:0.6px;
      text-transform: uppercase;
      cursor: default;
      user-select:none;
    }
    .pill.on{
      border-color: rgba(0,255,136,0.35);
      background: rgba(0,255,136,0.06);
      color: #00ff88;
      box-shadow: 0 0 18px rgba(0,255,136,0.08);
    }
    .pill.off{ opacity: 0.45; }
    .trait-table{
      width:100%;
      border-collapse: collapse;
      margin-top: 0.8rem;
      font-size: 0.8rem;
    }
    .trait-table th, .trait-table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: left;
      vertical-align: top;
    }
    .trait-table th{
      font-family: 'Bebas Neue', sans-serif;
      letter-spacing: 2px;
      color:#777;
      font-size: 0.95rem;
    }
    .trait-muted{ color:#666; font-size:0.78rem; }

    /* ---- GAMES VIEW ---- */
    #view-games.show {
      display: flex !important;
      flex-direction: column;
      gap: 1.5rem;
      grid-template-columns: unset;
    }

    .games-header {
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid #1e1e3a;
      border-radius: 16px;
      padding: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1.2rem;
      position: relative;
      overflow: hidden;
    }
    .games-header::before {
      content: 'üé∞';
      position: absolute;
      right: 2rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 6rem;
      opacity: 0.06;
      pointer-events: none;
    }
    .games-header-left h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.2rem;
      letter-spacing: 4px;
      color: #00d4ff;
      text-shadow: 0 0 20px rgba(0,212,255,0.3);
    }
    .games-header-left p {
      color: #666;
      font-size: 0.82rem;
      margin-top: 0.3rem;
    }
    .games-balance-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .game-balance-chip {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 0.8rem 1.2rem;
      text-align: center;
      min-width: 130px;
    }
    .game-balance-chip .gbc-label {
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 0.2rem;
    }
    .game-balance-chip .gbc-val {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.3rem;
      font-weight: 900;
    }
    .gbc-val.cabbage { color: #00ff88; }
    .gbc-val.sol { color: #9945ff; }

    .games-currency-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 5px;
    }
    .currency-opt {
      padding: 7px 16px;
      border-radius: 7px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #666;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
    }
    .currency-opt.active {
      background: rgba(0,212,255,0.12);
      color: #00d4ff;
      border: 1px solid rgba(0,212,255,0.3);
    }
    .currency-opt:not(.active):hover { color: #aaa; }

    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }
    @media (max-width: 700px) { .games-grid { grid-template-columns: 1fr; } }

    .game-card {
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 16px;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      transition: border-color 0.2s;
      position: relative;
      overflow: hidden;
    }
    .game-card:hover { border-color: rgba(0,212,255,0.25); }
    .game-card-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem;
      letter-spacing: 3px;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .game-card-desc {
      color: #666;
      font-size: 0.78rem;
      line-height: 1.5;
    }

    /* Coin Flip */
    .coin-wrap {
      text-align: center;
      perspective: 600px;
    }
    .coin {
      width: 90px;
      height: 90px;
      margin: 0 auto 0.8rem;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.05s linear;
      cursor: default;
    }
    .coin-face {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.4rem;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
    .coin-heads {
      background: radial-gradient(circle at 35% 35%, #ffe066, #c8a600);
      border: 3px solid rgba(255,215,0,0.4);
      box-shadow: 0 0 20px rgba(255,215,0,0.25);
    }
    .coin-tails {
      background: radial-gradient(circle at 35% 35%, #a0a0c0, #505068);
      border: 3px solid rgba(180,180,220,0.4);
      transform: rotateY(180deg);
    }
    @keyframes coinSpin {
      0%   { transform: rotateY(0deg); }
      100% { transform: rotateY(1800deg); }
    }
    .coin.spinning { animation: coinSpin 1.4s cubic-bezier(0.3,0,0.7,1) forwards; }

    .coin-result-label {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      min-height: 22px;
    }
    .coin-result-label.win { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.5); }
    .coin-result-label.lose { color: #ff3c5c; }
    .coin-result-label.neutral { color: #555; }

    .coin-pick-row {
      display: flex;
      gap: 0.6rem;
      justify-content: center;
    }
    .coin-pick-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
      color: #bfc2ff;
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
    }
    .coin-pick-btn:hover, .coin-pick-btn.selected {
      border-color: rgba(0,212,255,0.5);
      color: #00d4ff;
      box-shadow: 0 0 14px rgba(0,212,255,0.12);
    }

    /* Dice Roll */
    .dice-display {
      text-align: center;
    }
    .dice {
      font-size: 5rem;
      line-height: 1;
      display: inline-block;
      transition: transform 0.1s;
    }
    .dice.rolling {
      animation: diceShake 0.6s ease-in-out;
    }
    @keyframes diceShake {
      0%,100% { transform: rotate(0deg) scale(1); }
      15%      { transform: rotate(-15deg) scale(1.1); }
      30%      { transform: rotate(15deg) scale(0.95); }
      45%      { transform: rotate(-12deg) scale(1.08); }
      60%      { transform: rotate(12deg) scale(0.97); }
      75%      { transform: rotate(-8deg) scale(1.04); }
    }
    .dice-prediction-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
    }
    .dice-opt {
      padding: 10px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.2);
      color: #888;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      text-align: center;
    }
    .dice-opt:hover, .dice-opt.selected {
      border-color: rgba(0,212,255,0.45);
      color: #00d4ff;
    }

    /* Slots */
    .slots-machine {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 1.2rem;
      text-align: center;
    }
    .slots-reels {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }
    .reel {
      width: 70px;
      height: 70px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      overflow: hidden;
      position: relative;
    }
    .reel.spinning-reel {
      animation: reelSpin 0.1s linear infinite;
    }
    @keyframes reelSpin {
      0%   { filter: blur(0px); }
      50%  { filter: blur(2px); }
      100% { filter: blur(0px); }
    }
    .slots-result-msg {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.78rem;
      letter-spacing: 2px;
      font-weight: 700;
      min-height: 20px;
    }
    .slots-result-msg.jackpot { color: #ffd700; text-shadow: 0 0 14px rgba(255,215,0,0.6); }
    .slots-result-msg.win2    { color: #00ff88; }
    .slots-result-msg.lose    { color: #ff3c5c; }
    .slots-result-msg.neutral { color: #444; }

    /* Shared bet row */
    .bet-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .bet-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #555;
      flex: 0 0 auto;
    }
    .bet-input {
      flex: 1;
      min-width: 80px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e0e0ff;
      padding: 9px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: 'Space Grotesk', sans-serif;
      outline: none;
      transition: border-color 0.2s;
    }
    .bet-input:focus { border-color: rgba(0,212,255,0.4); }
    .bet-presets {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .bet-preset {
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.08);
      background: transparent;
      color: #666;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.15s;
    }
    .bet-preset:hover { border-color: rgba(0,212,255,0.4); color: #00d4ff; }

    .game-play-btn {
      width: 100%;
      padding: 13px;
      background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(123,104,238,0.15));
      border: 1px solid rgba(0,212,255,0.3);
      color: #00d4ff;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 800;
      font-size: 0.82rem;
      letter-spacing: 2.5px;
      text-transform: uppercase;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .game-play-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0,212,255,0.25), rgba(123,104,238,0.25));
      box-shadow: 0 0 28px rgba(0,212,255,0.2);
      transform: translateY(-1px);
    }
    .game-play-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .game-odds-note {
      font-size: 0.65rem;
      color: #333;
      text-align: center;
      letter-spacing: 1px;
    }

    /* Win flash */
    @keyframes winFlash {
      0%, 100% { box-shadow: none; }
      50%       { box-shadow: 0 0 40px rgba(0,255,136,0.4); }
    }
    .game-card.win-flash { animation: winFlash 0.5s ease-in-out 2; }

    /* Confetti fall animation */
    @keyframes confettiFall {
      0%   { transform: translateY(-10px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* NFT Winner pulse */
    @keyframes nftPulse {
      0%   { transform: scale(1) rotate(-5deg); }
      100% { transform: scale(1.15) rotate(5deg); }
    }

    /* NFT Pot progress glow */
    @keyframes potGlow {
      0%, 100% { box-shadow: 0 0 8px rgba(255,215,0,0.2); }
      50%       { box-shadow: 0 0 20px rgba(255,215,0,0.5); }
    }

    /* LNL NFT bonus banner */
    .lnl-bonus-bar {
      background: linear-gradient(135deg, rgba(255,215,0,0.06), rgba(255,215,0,0.02));
      border: 1px solid rgba(255,215,0,0.18);
      border-radius: 10px;
      padding: 0.8rem 1.1rem;
      font-size: 0.74rem;
      color: #aaa;
      line-height: 1.5;
    }
    .lnl-bonus-bar strong { color: #ffd700; }

    /* History table */
    .game-history-card {
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 16px;
      padding: 2rem;
    }
    .game-history-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 1rem;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 220px;
      overflow-y: auto;
    }
    .history-list::-webkit-scrollbar { width: 4px; }
    .history-list::-webkit-scrollbar-thumb { background: #1e1e3a; border-radius: 2px; }
    .history-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.55rem 0.8rem;
      border-radius: 8px;
      background: rgba(0,0,0,0.2);
      font-size: 0.75rem;
      gap: 0.5rem;
    }
    .history-game { color: #888; flex: 0 0 auto; }
    .history-bet  { color: #555; flex: 1; text-align: center; }
    .history-outcome { font-weight: 700; flex: 0 0 auto; }
    .history-outcome.win  { color: #00ff88; }
    .history-outcome.lose { color: #ff3c5c; }
    .history-empty { color: #333; font-size: 0.75rem; text-align: center; padding: 1.5rem 0; letter-spacing: 1.5px; text-transform: uppercase; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>

<body>
  <nav>
    <a href="https://longnecklegends.xyz/">Home</a>
    <a href="/starternecks.html">Starter Necks</a>
    <a href="/music.html">Music</a>
    <a href="/hotsaucemint.html">Hot Sauce</a>
    <a href="/store.html">Store</a>
  </nav>

  <section class="hero">
    <h1>HOLDER <span>DASHBOARD</span></h1>
    <p class="hero-sub">Customize your profile, connect your wallet, and manage your Cabbage staking</p>
  </section>

  <!-- DASHBOARD-ONLY NAV BAR -->
  <div class="dash-nav-wrap" id="dashNavWrap">
    <div class="dash-nav">
      <div class="dash-tabs">
        <button class="dash-tab" id="tabProfile" onclick="toggleProfilePanel()">Profile</button>
        <button class="dash-tab" id="tabChat" onclick="switchView('chat')">üí¨ Chat</button>
        <button class="dash-tab" id="tabGames" onclick="switchView('games')">üé∞ Games</button>
      </div>

      <div class="dash-right">
        <div class="wallet-chip" id="walletChip" style="display:none;">
          <div class="wallet-dot"></div>
          <span class="wallet-addr"><strong id="walletDisplay">‚Äî</strong></span>
        </div>
        <button class="disconnect-btn" id="disconnectBtn" style="display:none;" onclick="disconnectWallet()">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- CONNECT PROMPT -->
  <div class="connect-section" id="connectSection">
    <button class="connect-btn" onclick="connectWallet()">CONNECT WALLET</button>
    <p class="connect-prompt">Phantom &bull; Solflare &bull; Magic Eden</p>
  </div>

  <!-- LOADING -->
  <div class="connect-section" id="loadingSection" style="display:none;">
    <div class="loading-spinner"></div>
    <p class="loading-text">Scanning your wallet...</p>
  </div>

  <!-- DASHBOARD WRAP -->
  <div class="dashboard" id="dashboard">
    <div class="view show" id="view-profile"></div>
    <div class="view" id="view-chat"></div>
    <div class="view" id="view-games"></div>
  </div>

  <!-- PFP MODAL -->
  <div class="modal-backdrop" id="pfpModalBackdrop" onclick="closePfpModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Select Your LNL PFP</div>
        <button class="modal-close" onclick="hidePfpModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="modal-note">Pick one of your Long Neck Legends. This sets your Profile PFP for this wallet on this device.</div>
        <div class="pfp-grid" id="pfpGrid"></div>
      </div>
    </div>
  </div>

  <!-- SECOND WALLET MODAL -->
  <div class="modal-backdrop" id="secondWalletModalBackdrop" onclick="closeSecondWalletModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Link 2nd Wallet</div>
        <button class="modal-close" onclick="hideSecondWalletModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="modal-note">
          Connect a second wallet to combine your LNL holdings across wallets. (Main wallet stays connected.)
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('phantom')">Phantom</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('solflare')">Solflare</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('magiceden')">Magic Eden</button>
        </div>

        <div id="secondWalletStatus" style="color:#666; font-size:0.82rem; line-height:1.5;">
          No second wallet linked yet.
        </div>

        <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
          <button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="unlinkSecondWallet()">Unlink</button>
          <button class="disconnect-btn" onclick="hideSecondWalletModal()">Close</button>
        </div>
      </div>
    </div>
  </div>


  <!-- TRAITS MODAL -->
  <div class="modal-backdrop" id="traitsModalBackdrop" onclick="closeTraitsModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Trait Data</div>
        <button class="modal-close" onclick="hideTraitsModal()">‚úï</button>
      </div>
      <div class="modal-body" id="traitsModalBody">
        <div class="modal-note">This is pulled live from your NFTs metadata. SubDAO unlocks are based on holding at least 1 matching trait.</div>
        <div id="subdaoPills" class="trait-pills"></div>
        <table class="trait-table" id="traitsTable">
          <thead>
            <tr><th>Trait</th><th>Count</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="trait-muted">Tip: If something looks missing, it usually means the NFT metadata doesn‚Äôt include that attribute field.</div>
      </div>
    </div>
  </div>


  <footer>
    <p>&copy; 2026 Long Neck Legends &bull; Diamond Hands Only</p>
  </footer>

  <script>
    window.addEventListener('load', function() { document.body.classList.add('loaded'); });

    var CONFIG = {
      COLLECTION_MINT: "8Rt3Ayqth4DAiPnW9MDFi63TiQJHmohfTWLMQFHi4KZH",
      RPC_URL: "https://mainnet.helius-rpc.com/?api-key=44cfd082-9089-430d-8de3-cd310c478b1c",
      MAGIC_EDEN_LINK: "https://magiceden.us/marketplace/long_neck_legends",
      TREASURY_WALLET: "ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc"
    };

    var TIERS = [
      { id: "civilian", name: "CIVILIAN", min: 0, icon: "\u{1F464}", pointsMultiplier: 0, discount: 0, raffleMultiplier: 0, cssClass: "" },
      { id: "neck", name: "NECK", min: 1, icon: "\u{1F995}", pointsMultiplier: 1, discount: 10, raffleMultiplier: 1, cssClass: "tier-neck" },
      { id: "longneck", name: "LONG NECK", min: 5, icon: "\u{1F525}", pointsMultiplier: 1.5, discount: 15, raffleMultiplier: 2, cssClass: "tier-longneck" },
      { id: "legend", name: "LEGEND", min: 10, icon: "\u{2B50}", pointsMultiplier: 2.5, discount: 20, raffleMultiplier: 3, cssClass: "tier-legend" },
      { id: "og", name: "OG LEGEND", min: 20, icon: "\u{1F451}", pointsMultiplier: 4, discount: 25, raffleMultiplier: 5, cssClass: "tier-og" },
      { id: "sardine", name: "SARDINE", min: 30, icon: "\u{1F41F}", pointsMultiplier: 6, discount: 30, raffleMultiplier: 6, cssClass: "tier-sardine" },
      { id: "barracuda", name: "BARRACUDA", min: 50, icon: "\u{1F52A}", pointsMultiplier: 7, discount: 35, raffleMultiplier: 7, cssClass: "tier-barracuda" },
      { id: "shark", name: "SHARK", min: 75, icon: "\u{1F988}", pointsMultiplier: 8, discount: 35, raffleMultiplier: 8, cssClass: "tier-shark" },
      { id: "whale", name: "WHALE", min: 100, icon: "\u{1F40B}", pointsMultiplier: 10, discount: 40, raffleMultiplier: 10, cssClass: "tier-whale" }
    ];

    var PERKS = [
      { icon: "\u{1F995}", name: "Store Discount", desc: "Get a discount on all LNL Store purchases paid in SOL.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "Raffle Entries", desc: "Earn entries into exclusive drops, giveaways, and raffles.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "IRL Access", desc: "Entry to LNL events, listening parties, and tastings.", reqTier: "neck" },
      { icon: "\u{1F525}", name: "Exclusive Merch", desc: "Unlock holder-only merch that never hits the public store.", reqTier: "longneck" },
      { icon: "\u{2B50}", name: "Exclusive Merch", desc: "Vote on the next apparel drop. Your neck, your choice.", reqTier: "legend" },
      { icon: "\u{2B50}", name: "Flavor Voting", desc: "Vote on the next hot sauce flavor. Your taste, your choice.", reqTier: "legend" },
      { icon: "\u{1F451}", name: "Early Access", desc: "Get first dibs on new sauce flavors, merch drops, and collections.", reqTier: "og" },
      { icon: "\u{1F451}", name: "VIP IRL Access", desc: "VIP entry to LNL events, listening parties, and tastings.", reqTier: "og" },
      { icon: "\u{1F41F}", name: "Diamond Hands Club", desc: "Private group with alpha, airdrops, and direct team access.", reqTier: "sardine" },
      { icon: "\u{1F52A}", name: "Monthly Airdrop", desc: "Free products, NFTs, and surprises delivered monthly.", reqTier: "barracuda" },
      { icon: "\u{1F988}", name: "Shark Council", desc: "Direct input on project direction, partnerships, and roadmap decisions.", reqTier: "shark" },
      { icon: "\u{1F40B}", name: "Lifetime Perks", desc: "Permanent max discount, first priority on all future drops, and custom merch.", reqTier: "whale" }
    ];


    // ---- SUBDAO (Trait-based) ----
    var SUBDAOS = [
      { id:"talltoker",  name:"Tall Toker",     icon:"üö¨", reqValues:["Gold Pipe Beak","Blunt Beak"], desc:"Hold at least 1 LNL with Gold Pipe Beak or Blunt Beak." },
      { id:"jeeterbeater", name:"Jeeter Beater", icon:"ü•ä", reqValues:["Boxing Gloves"], desc:"Hold at least 1 LNL with Boxing Gloves." },
      { id:"hoodiegang", name:"Hoodie Gang",    icon:"üß•", reqValues:["Hoodie"], desc:"Hold at least 1 LNL with Hoodie." },
      { id:"headphones", name:"HeadPhones",     icon:"üéß", reqValues:["Headphones"], desc:"Hold at least 1 LNL with Headphones." },
      { id:"royalty",    name:"Royalty",        icon:"üëë", reqValues:["Golden Crown","Hippie Crown","Gold Grill Beak"], desc:"Hold at least 1 LNL with Golden Crown, Hippie Crown, or Gold Grill Beak." },
      { id:"wizzy",      name:"Wizzy",          icon:"üßô", reqValues:["Wizard Hat"], desc:"Hold at least 1 LNL with Wizard Hat." },
      { id:"bob",        name:"BoB",            icon:"üß¢", reqValues:["Beanie"], desc:"Hold at least 1 LNL with Beanie." },
      { id:"frobros",    name:"Fro Bros",       icon:"ü¶±", reqValues:["Afro"], desc:"Hold at least 1 LNL with Afro." },
      { id:"goldenticket", name:"Golden Ticket", icon:"üéüÔ∏è", reqValues:["Golden Ticket"], desc:"Hold at least 1 LNL with Golden Ticket." }
    ];

    function normStr(s){
      return String(s || "").trim().toLowerCase();
    }

    function buildTraitValueSet(nfts){
      var set = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          set[normStr(v)] = true;
        });
      });
      return set;
    }

    function getSubdaoMatches(nfts){
      var values = buildTraitValueSet(nfts);
      return SUBDAOS.map(function(d){
        var hit = "";
        for (var i=0;i<d.reqValues.length;i++){
          if (values[normStr(d.reqValues[i])]) { hit = d.reqValues[i]; break; }
        }
        return { id:d.id, name:d.name, icon:d.icon, unlocked: !!hit, hit: hit, reqValues: d.reqValues, desc: d.desc };
      });
    }

    function buildTraitCounts(nfts){
      var counts = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          var key = v.trim();
          counts[key] = (counts[key] || 0) + 1;
        });
      });
      return counts;
    }


    var walletProvider = null;
    var walletPublicKey = null;

    var session = {
      loadedNFTs: [],
      profile: {
        username: "",
        pfpMint: "",
        pfpImage: "",
        x: "",
        discord: "",
        ledger: ""
      },
      secondWallet: { address: "" },
      currentView: "profile",
      profilePanelOpen: false
    };

    function getTier(count) {
      for (var i = TIERS.length - 1; i >= 0; i--) {
        if (count >= TIERS[i].min) return TIERS[i];
      }
      return TIERS[0];
    }
    function getNextTier(tier) {
      var idx = TIERS.findIndex(function(t) { return t.id === tier.id; });
      return idx < TIERS.length - 1 ? TIERS[idx + 1] : null;
    }
    function getProviderByName(name){
      if (name === "phantom") {
        if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
        if (window.solana && window.solana.isPhantom) return window.solana;
      }
      if (name === "solflare") {
        if (window.solflare && window.solflare.isSolflare) return window.solflare;
        if (window.solflare && window.solflare.solana) return window.solflare.solana;
      }
      if (name === "magiceden") {
        if (window.magicEden && window.magicEden.solana) return window.magicEden.solana;
        if (window.solana && window.solana.isMagicEden) return window.solana;
        if (window.solana && window.solana.isMagicEdenWallet) return window.solana;
      }
      return null;
    }

    function detectWalletProvider() {
      if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
      if (window.backpack && window.backpack.solana) return window.backpack.solana;
      if (window.solflare && window.solflare.isSolflare) return window.solflare;
      if (window.solflare && window.solflare.solana) return window.solflare.solana;
      if (window.solana && window.solana.isPhantom) return window.solana;
      if (window.solana) return window.solana;
      return null;
    }

    function storageKey() {
      var addr = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_profile_" + addr;
    }

    function loadProfileFromStorage() {
      try {
        var raw = localStorage.getItem(storageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && typeof data === "object") {
          session.profile.username = data.username || "";
          session.profile.pfpMint = data.pfpMint || "";
          session.profile.pfpImage = data.pfpImage || "";
          session.profile.x = data.x || "";
          session.profile.discord = data.discord || "";
          session.profile.ledger = data.ledger || "";
        }
      } catch (e) {}
    }

    function saveProfileToStorage() {
      try { localStorage.setItem(storageKey(), JSON.stringify(session.profile)); } catch (e) {}
    }

    function secondWalletStorageKey(){
      var primary = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_second_wallet_for_" + primary;
    }

    function loadSecondWalletFromStorage(){
      try{
        var raw = localStorage.getItem(secondWalletStorageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && data.address) session.secondWallet.address = data.address;
      }catch(e){}
    }

    function saveSecondWalletToStorage(){
      try{
        localStorage.setItem(secondWalletStorageKey(), JSON.stringify({ address: session.secondWallet.address || "" }));
      }catch(e){}
    }

    function shortAddr(addr){
      if (!addr) return "‚Äî";
      return addr.slice(0,4) + "..." + addr.slice(-4);
    }

    function sanitizeName(input){
      var s = (input || "").trim();
      s = s.replace(/\s+/g, " ");
      if (s.length > 24) s = s.slice(0, 24);
      return s;
    }

    function normalizeHandle(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/^@+/, "");
      if (s.length > 30) s = s.slice(0, 30);
      return s;
    }

    function normalizeDiscord(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/\s+/g, "");
      if (s.length > 32) s = s.slice(0, 32);
      return s;
    }

    function buildXUrl(handle){
      var h = normalizeHandle(handle);
      if (!h) return "";
      return "https://x.com/" + encodeURIComponent(h);
    }

    async function fetchAssetsByOwner(ownerAddress){
      var res = await fetch(CONFIG.RPC_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          jsonrpc: "2.0",
          id: "lnl",
          method: "getAssetsByOwner",
          params: {
            ownerAddress: ownerAddress,
            page: 1,
            limit: 1000,
            displayOptions: { showCollectionMetadata: true }
          }
        })
      });

      var json = await res.json();
      var items = (json && json.result && json.result.items) ? json.result.items : [];

      var lnlAssets = items.filter(function(a) {
        var groups = a.grouping || [];
        var g = groups.find(function(x) { return x.group_key === "collection"; });
        return g && g.group_value === CONFIG.COLLECTION_MINT;
      });

      var picked = (lnlAssets.length > 0) ? lnlAssets : items.filter(function(a) {
        var sym = (a.content && a.content.metadata && a.content.metadata.symbol) ||
                  (a.content && a.content.json && a.content.json.symbol) || "";
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "";
        var lname = String(name || "").toLowerCase();
        return (sym === "LNL") || (lname.indexOf("long neck") !== -1);
      });

      
      return picked.map(function(a) {
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "LNL";
        var image = (a.content && a.content.links && a.content.links.image) ||
                    (a.content && a.content.files && a.content.files[0] && a.content.files[0].uri) ||
                    (a.content && a.content.json && a.content.json.image) || "";
        var mint = a.id || "";

        // traits/attributes can appear in a few places depending on indexer
        var attrs =
          (a.content && a.content.metadata && a.content.metadata.attributes) ||
          (a.content && a.content.json && a.content.json.attributes) ||
          (a.content && a.content.metadata && a.content.metadata.traits) ||
          [];

        // normalize to [{trait_type, value}]
        var norm = [];
        if (Array.isArray(attrs)) {
          norm = attrs.map(function(x){
            if (!x) return null;
            if (typeof x === "string") return { trait_type: "Trait", value: x };
            var tt = x.trait_type || x.traitType || x.type || x.name || "Trait";
            var vv = x.value != null ? x.value : (x.val != null ? x.val : "");
            return { trait_type: String(tt || "Trait"), value: String(vv || "") };
          }).filter(Boolean);
        } else if (attrs && typeof attrs === "object") {
          // some formats are {trait_type: value, ...}
          Object.keys(attrs).forEach(function(k){
            norm.push({ trait_type: String(k), value: String(attrs[k]) });
          });
        }

        return { name: name, image: image, mint: mint, owner: ownerAddress, attributes: norm };
      });

    }

    function applyProfilePanelUI(){
      var btn = document.getElementById("tabProfile");
      var panel = document.getElementById("profilePanel");

      if (btn) btn.classList.toggle("active", !!session.profilePanelOpen);
      if (panel) panel.classList.toggle("is-hidden", !session.profilePanelOpen);
    }

    function toggleProfilePanel(){
      session.profilePanelOpen = !session.profilePanelOpen;
      applyProfilePanelUI();
    }

    async function connectWallet() {
      var provider = detectWalletProvider();
      if (!provider || typeof provider.connect !== "function") {
        alert("No Solana wallet found.\n\nInstall Phantom, Solflare, or Backpack and refresh the page.");
        return;
      }
      try {
        var resp = await provider.connect({ onlyIfTrusted: false });
        walletProvider = provider;
        walletPublicKey = resp.publicKey || provider.publicKey;
        if (!walletPublicKey) throw new Error("Wallet connected but no public key returned. Try unlocking your wallet first.");

        var addr = walletPublicKey.toBase58();
        document.getElementById("walletDisplay").textContent = shortAddr(addr);

        document.getElementById("dashNavWrap").classList.add("show");
        document.getElementById("walletChip").style.display = "flex";
        document.getElementById("disconnectBtn").style.display = "inline-block";

        document.getElementById("connectSection").style.display = "none";
        document.getElementById("loadingSection").style.display = "block";

        loadProfileFromStorage();
        loadSecondWalletFromStorage();

        session.profilePanelOpen = false;
        applyProfilePanelUI();

        await loadDashboard();
      } catch (err) {
        console.error("Connect error:", err);
        if (err.code === 4001 || (err.message && err.message.toLowerCase().includes("user rejected"))) {
          // User cancelled ‚Äî no alert needed
        } else {
          alert("Connection failed: " + (err.message || err));
        }
      }
    }

    function disconnectWallet() {
      stopChatPoll();
      try { if (walletProvider && walletProvider.disconnect) walletProvider.disconnect(); } catch (e) {}
      walletProvider = null;
      walletPublicKey = null;

      document.getElementById("dashNavWrap").classList.remove("show");
      document.getElementById("walletChip").style.display = "none";
      document.getElementById("disconnectBtn").style.display = "none";

      document.getElementById("connectSection").style.display = "block";
      document.getElementById("loadingSection").style.display = "none";
      document.getElementById("dashboard").classList.remove("show");
      document.getElementById("view-profile").classList.remove("show");
      document.getElementById("view-chat").classList.remove("show");
      var vg = document.getElementById("view-games");
      if (vg) vg.classList.remove("show");

      session.profilePanelOpen = false;
      var tabProfile = document.getElementById("tabProfile");
      if (tabProfile) tabProfile.classList.remove("active");
      var tabChat = document.getElementById("tabChat");
      if (tabChat) tabChat.classList.remove("active");
      var tabGames = document.getElementById("tabGames");
      if (tabGames) tabGames.classList.remove("active");

      session.currentView = "profile";
    }

    function switchView(viewName){
      session.currentView = viewName;

      // Hide all views
      var vp = document.getElementById("view-profile");
      var vc = document.getElementById("view-chat");
      var vg = document.getElementById("view-games");
      if (vp) vp.classList.remove("show");
      if (vc) vc.classList.remove("show");
      if (vg) vg.classList.remove("show");

      // Deactivate all tabs
      var tabProfile = document.getElementById("tabProfile");
      var tabChat    = document.getElementById("tabChat");
      var tabGames   = document.getElementById("tabGames");
      if (tabProfile) tabProfile.classList.remove("active");
      if (tabChat)    tabChat.classList.remove("active");
      if (tabGames)   tabGames.classList.remove("active");

      if (viewName === "profile") {
        stopChatPoll();
        if (vp) vp.classList.add("show");
        if (tabProfile) tabProfile.classList.toggle("active", !!session.profilePanelOpen);
      }

      if (viewName === "chat") {
        if (vc) vc.classList.add("show");
        if (tabChat) tabChat.classList.add("active");
        renderChatUI();
      }

      if (viewName === "games") {
        stopChatPoll();
        if (vg) vg.classList.add("show");
        if (tabGames) tabGames.classList.add("active");
        renderGamesUI();
      }
    }

    async function loadDashboard() {
      try {
        var primary = walletPublicKey.toBase58();
        var owners = [primary];

        if (session.secondWallet.address) owners.push(session.secondWallet.address);

        var all = [];
        for (var i=0; i<owners.length; i++){
          var arr = await fetchAssetsByOwner(owners[i]);
          all = all.concat(arr);
        }

        var seen = {};
        var merged = [];
        for (var j=0; j<all.length; j++){
          var m = all[j].mint;
          if (!m) continue;
          if (seen[m]) continue;
          seen[m] = true;
          merged.push(all[j]);
        }

        session.loadedNFTs = merged;

        if (!session.profile.pfpMint && merged.length > 0) {
          session.profile.pfpMint = merged[0].mint;
          session.profile.pfpImage = merged[0].image || "";
          saveProfileToStorage();
        } else if (session.profile.pfpMint) {
          var found = merged.find(function(n){ return n.mint === session.profile.pfpMint; });
          if (found && found.image) {
            session.profile.pfpImage = found.image;
            saveProfileToStorage();
          }
        }

        document.getElementById("loadingSection").style.display = "none";
        renderProfileView(merged);

        document.getElementById("dashboard").classList.add("show");
        switchView("profile");

      } catch (err) {
        console.error("Dashboard error:", err);
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("connectSection").style.display = "block";
        alert("Error loading NFTs: " + (err.message || err));
      }
    }

    function renderProfileView(nfts) {
      var view = document.getElementById("view-profile");
      view.innerHTML = "";

      var count = nfts.length;

      if (count === 0) {
        view.innerHTML = `
          <div class="no-nfts">
            <h2>NO LONG NECK LEGENDS FOUND</h2>
            <p>You don't hold any LNL NFTs in this wallet. Cop one to unlock holder perks.</p>
            <a href="${CONFIG.MAGIC_EDEN_LINK}" target="_blank">BUY ON MAGIC EDEN</a>
          </div>
        `;
        applyProfilePanelUI();
        return;
      }

      var tier = getTier(count);
      var nextTier = getNextTier(tier);
      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
      var disc = session.profile.discord ? session.profile.discord : "";

      var progressHTML = "";
      if (nextTier) {
        var progress = ((count - tier.min) / (nextTier.min - tier.min)) * 100;
        progressHTML =
          '<div class="tier-progress-wrap">' +
            '<div class="tier-progress-label"><span>' + tier.name + '</span><span>' + nextTier.name + ' (' + nextTier.min + ' NFTs)</span></div>' +
            '<div class="tier-progress-bar"><div class="tier-progress-fill" style="width:' + Math.min(progress,100) + '%"></div></div>' +
          '</div>';
      } else {
        progressHTML = '<div style="color:#555;font-size:0.75rem;letter-spacing:2px;text-transform:uppercase;">MAX TIER REACHED \u{1F451}</div>';
      }

      var badgeInner = "";
      if (session.profile.pfpImage) {
        badgeInner = '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">';
      } else {
        badgeInner = tier.icon;
      }

      var linksHTML = '';
      if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
      if (disc) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + disc + '</span>';
      if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';

      view.innerHTML +=
      '<div class="tier-card ' + tier.cssClass + '">' +
        '<div class="tier-badge" id="pfpBadge">' + badgeInner + '</div>' +
        '<div class="tier-info">' +
          '<div class="tier-label">YOUR TIER</div>' +
          '<div class="tier-name">' + tier.name + '</div>' +
          '<div class="tier-nfts-held">Holding <strong>' + count + '</strong> Long Neck Legend' + (count !== 1 ? "s" : "") + '</div>' +
          progressHTML +
        '</div>' +
        '<div class="profile-name-box">' +
          '<div class="profile-username" id="bannerUsername">' + escapeHtml(displayName) + '</div>' +
          '<div class="profile-name-inner">' +
            '<div class="profile-links" id="bannerLinks">' + linksHTML + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

      view.innerHTML +=
        '<div class="profile-actions" id="profilePanel">' +
          '<div class="stats-title">PROFILE</div>' +
          '<div class="actions-grid">' +
            '<button class="action-btn" onclick="openPfpModal()">Edit PFP</button>' +
            '<button class="action-btn" onclick="editUsername()">Edit Username</button>' +
            '<button class="action-btn" onclick="connectX()">Connect X</button>' +
            '<button class="action-btn" onclick="connectDiscord()">Connect Discord</button>' +
            '<button class="action-btn" onclick="openSecondWalletModal()">Link 2nd Wallet</button>' +
          '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">CABBAGE STAKING</div>' +
          '<div class="points-display">' +
            '<div class="points-number" id="cabbageBalance">‚Äî</div>' +
            '<div class="points-label">Cabbage Balance</div>' +
          '</div>' +
          '<div class="stat-row"><span class="stat-label">Earn Rate</span><span class="stat-value green" id="cabbageRate">‚Äî</span></div>' +
          '<div class="stat-row"><span class="stat-label">Pending</span><span class="stat-value cyan" id="cabbagePending">‚Äî</span></div>' +
          '<div class="stat-row"><span class="stat-label">Started</span><span class="stat-value" id="cabbageStarted">‚Äî</span></div>' +
          '<div class="stat-row"><span class="stat-label">Last Claim</span><span class="stat-value" id="cabbageLast">‚Äî</span></div>' +
          '<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;flex-wrap:wrap;">' +
            '<button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="refreshCabbageUI()">Refresh</button>' +
            '<button class="disconnect-btn" id="cabbageStartBtn" style="border-color:rgba(0,255,136,0.35);color:#00ff88;" onclick="startCabbage()">Start</button>' +
            '<button class="disconnect-btn" id="cabbageClaimBtn" style="border-color:rgba(0,212,255,0.35);color:#00d4ff;" onclick="claimCabbage()">Claim</button>' +
          '</div>' +
          '<div style="margin-top:10px;color:#555;font-size:0.72rem;letter-spacing:1px;line-height:1.45;">' +
            'Soft staking: click <strong>Start</strong> once to begin earning. You earn <strong>1 cabbage per week per NFT</strong>. Claim anytime.' +
          '</div>' +
        '</div>';

      // Populate cabbage values after DOM updates
      setTimeout(function(){ try { refreshCabbageUI(); } catch(e){} }, 50);

var nextTierRow = nextTier
        ? '<div class="stat-row"><span class="stat-label">Next Tier At</span><span class="stat-value gold">' + nextTier.min + ' NFTs</span></div>'
        : '<div class="stat-row"><span class="stat-label">Status</span><span class="stat-value gold">MAXED \u{1F451}</span></div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">HOLDER STATS</div>' +
          '<div class="stat-row"><span class="stat-label">NFTs Held</span><span class="stat-value cyan">' + count + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Current Tier</span><span class="stat-value">' + tier.name + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Store Discount</span><span class="stat-value green">' + tier.discount + '%</span></div>' +
          '<div class="stat-row"><span class="stat-label">Raffle Multiplier</span><span class="stat-value purple">' + tier.raffleMultiplier + 'x</span></div>' +
          nextTierRow +
        '</div>';

      // ---- SUBDAO STATUS (Trait-based) ----
      var subdao = getSubdaoMatches(nfts);
      var subdaoRows = subdao.map(function(s){
        var req = s.reqValues.join(' / ');
        return '<div class="stat-row">'
             + '<span class="stat-label">' + s.icon + ' ' + s.name + '</span>'
             + '<span class="stat-value ' + (s.unlocked ? 'green' : '') + '">' + (s.unlocked ? 'UNLOCKED' : 'LOCKED') + '</span>'
             + '</div>'
             + (s.unlocked ? '' : '<div style="color:#555;font-size:0.7rem;letter-spacing:1px;margin-top:-6px;margin-bottom:10px;">Requires: ' + escapeHtml(req) + '</div>');
      }).join('');

      var tierOrder = TIERS.map(function(t) { return t.id; });
      var currentTierIdx = tierOrder.indexOf(tier.id);

      var perksHTML = PERKS.map(function(perk) {
        var reqIdx = tierOrder.indexOf(perk.reqTier);
        var unlocked = currentTierIdx >= reqIdx;
        var reqTierObj = TIERS.find(function(t) { return t.id === perk.reqTier; });
        var desc = perk.desc;

        if (perk.dynamic && perk.name === "Store Discount" && unlocked) desc = tier.discount + "% off all LNL Store purchases paid in SOL";
        if (perk.dynamic && perk.name === "Raffle Entries" && unlocked) desc = tier.raffleMultiplier + "x entries into every raffle and giveaway";

        return '' +
          '<div class="perk ' + (unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + perk.icon + '</div>' +
            '<div class="perk-name">' + perk.name + '</div>' +
            '<div class="perk-desc">' + desc + '</div>' +
            '<div class="perk-req ' + (unlocked ? "met" : "") + '">' + (unlocked ? "\u2713 UNLOCKED" : "REQUIRES " + reqTierObj.name) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">HOLDER PERKS</div>' +
          '<div class="perks-grid">' + perksHTML + '</div>' +
        '</div>';


      var subdaoPerksHTML = getSubdaoMatches(nfts).map(function(s){
        var req = s.reqValues.join(" / ");
        var reqLine = s.unlocked ? ("Unlocked via: " + s.hit) : ("Requires: " + req);
        return '' +
          '<div class="perk ' + (s.unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (s.unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + s.icon + '</div>' +
            '<div class="perk-name">' + escapeHtml(s.name) + '</div>' +
            '<div class="perk-desc">' + escapeHtml(s.desc) + '</div>' +
            '<div class="perk-req ' + (s.unlocked ? "met" : "") + '">' + (s.unlocked ? "\u2713 UNLOCKED" : escapeHtml(reqLine)) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">SUBDAOs</div>' +
          '<div class="perks-grid subdao-grid">' + subdaoPerksHTML + '</div>' +
        '</div>';

      var galleryHTML = nfts.map(function(nft) {
        var img = nft.image
          ? '<img src="' + nft.image + '" alt="' + escapeHtml(nft.name) + '" loading="lazy">'
          : '<div style="aspect-ratio:1;background:#1e1e3a;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.8rem;">No Image</div>';
        var mintShort = nft.mint ? nft.mint.slice(0,4) + "..." + nft.mint.slice(-4) : "";
        return '' +
          '<div class="nft-tile" onclick="window.open(\'https://magiceden.us/item-details/' + nft.mint + '\', \'_blank\')">' +
            img +
            '<div class="nft-tile-info">' +
              '<div class="nft-tile-name">' + escapeHtml(nft.name) + '</div>' +
              '<div class="nft-tile-id">' + mintShort + '</div>' +
            '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="gallery-card">' +
          '<div class="stats-title">YOUR COLLECTION</div>' +
          '<div class="gallery-grid">' + galleryHTML + '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="share-section">' +
          '<button class="share-btn" onclick="window.open(\'' + CONFIG.MAGIC_EDEN_LINK + '\', \'_blank\')">MAGIC EDEN</button>' +
        '</div>';

      // ‚úÖ always re-apply toggle state after rendering the panel
      applyProfilePanelUI();
    }

    function editUsername(){
      var current = session.profile.username || "";
      var input = prompt("Set your Profile Username (max 24 chars):", current);
      if (input === null) return;
      session.profile.username = sanitizeName(input);
      saveProfileToStorage();
      refreshBanner();
    }

    function linkLedger(){
      var current = session.profile.ledger || "";
      var input = prompt("Paste your Ledger public key / label (optional):", current);
      if (input === null) return;
      session.profile.ledger = (input || "").trim().slice(0, 42);
      saveProfileToStorage();
      refreshBanner();
    }

    function refreshBanner(){
      var bn = document.getElementById("bannerUsername");
    if (bn) {
      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      bn.textContent = displayName;
    }

      var bl = document.getElementById("bannerLinks");
      if (bl) {
        var linksHTML = "";
        var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
        if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
        if (session.profile.discord) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + session.profile.discord + '</span>';
        if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';
        bl.innerHTML = linksHTML;
      }
    }

    function openPfpModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return;

      var grid = document.getElementById("pfpGrid");
      grid.innerHTML = "";

      session.loadedNFTs.forEach(function(nft){
        var selected = (session.profile.pfpMint && nft.mint === session.profile.pfpMint);

        var tile = document.createElement("div");
        tile.className = "pfp-tile" + (selected ? " selected" : "");
        tile.addEventListener("click", function(){ selectPfp(nft.mint); });

        var dot = document.createElement("div");
        dot.className = "pfp-selected";
        tile.appendChild(dot);

        if (nft.image) {
          var img = document.createElement("img");
          img.src = nft.image;
          img.alt = nft.name || "LNL";
          img.loading = "lazy";
          tile.appendChild(img);
        } else {
          var ph = document.createElement("div");
          ph.style.aspectRatio = "1";
          ph.style.background = "#1e1e3a";
          tile.appendChild(ph);
        }

        var name = document.createElement("div");
        name.className = "pfp-name";
        name.textContent = nft.name || "LNL";
        tile.appendChild(name);

        grid.appendChild(tile);
      });

      document.getElementById("pfpModalBackdrop").classList.add("show");
    }

    function hidePfpModal(){
      document.getElementById("pfpModalBackdrop").classList.remove("show");
    }

    function closePfpModal(e){
      if (e && e.target && e.target.id === "pfpModalBackdrop") hidePfpModal();
    }

    function selectPfp(mint){
      var found = session.loadedNFTs.find(function(n){ return n.mint === mint; });
      if (!found) return;

      session.profile.pfpMint = mint;
      session.profile.pfpImage = found.image || "";
      saveProfileToStorage();

      var badge = document.getElementById("pfpBadge");
      if (badge) {
        badge.innerHTML = session.profile.pfpImage
          ? '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">'
          : badge.innerHTML;
      }

      hidePfpModal();
    }

    function escapeHtml(str){
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function openSecondWalletModal(){
      if (!walletPublicKey) return alert("Connect main wallet first.");
      var el = document.getElementById("secondWalletStatus");
      if (el) {
        el.textContent = session.secondWallet.address
          ? ("Linked: " + shortAddr(session.secondWallet.address))
          : "No second wallet linked yet.";
      }
      document.getElementById("secondWalletModalBackdrop").classList.add("show");
    }

    function hideSecondWalletModal(){
      document.getElementById("secondWalletModalBackdrop").classList.remove("show");
    }

    function closeSecondWalletModal(e){
      if (e && e.target && e.target.id === "secondWalletModalBackdrop") hideSecondWalletModal();
    }

    async function connectSecondWallet(which){
      try{
        var provider = getProviderByName(which);
        if (!provider || typeof provider.connect !== "function") {
          return alert("Wallet provider not found. Make sure " + which + " is installed & enabled.");
        }

        var resp = await provider.connect({ onlyIfTrusted: false });
        var pk = resp && resp.publicKey ? resp.publicKey : provider.publicKey;
        if (!pk) throw new Error("Connected but no publicKey returned.");

        var addr = (typeof pk.toBase58 === "function") ? pk.toBase58() : String(pk);

        if (walletPublicKey && addr === walletPublicKey.toBase58()){
          return alert("That‚Äôs your main wallet already. Pick a different wallet for the 2nd slot.");
        }

        session.secondWallet.address = addr;
        saveSecondWalletToStorage();

        var el = document.getElementById("secondWalletStatus");
        if (el) el.textContent = "Linked: " + shortAddr(addr) + " ‚Äî rescanning‚Ä¶";

        document.getElementById("loadingSection").style.display = "block";
        document.getElementById("dashboard").classList.remove("show");
        await loadDashboard();

        hideSecondWalletModal();
        alert("2nd wallet linked: " + shortAddr(addr));
      } catch (err) {
        console.error("Second wallet connect error:", err);
        alert("Failed to link 2nd wallet: " + (err.message || err));
      }
    }

    function unlinkSecondWallet(){
      session.secondWallet.address = "";
      saveSecondWalletToStorage();

      var el = document.getElementById("secondWalletStatus");
      if (el) el.textContent = "Second wallet unlinked. Rescanning‚Ä¶";

      document.getElementById("loadingSection").style.display = "block";
      document.getElementById("dashboard").classList.remove("show");
      loadDashboard();
    }

    function openAuthPopup(url, title){
      var w = 520, h = 720;
      var y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
      var x = window.top.outerWidth  / 2 + window.top.screenX - (w / 2);
      var popup = window.open(
        url,
        title,
        'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width=' + w + ', height=' + h + ', top=' + y + ', left=' + x
      );
      if (!popup) alert("Popup blocked. Please allow popups for this site.");
      return popup;
    }

    function connectX(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/x/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      openAuthPopup(url, "Connect X");
    }

    function connectDiscord(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/discord/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      openAuthPopup(url, "Connect Discord");
    }

    window.addEventListener("message", function(ev){
      if (ev.origin !== window.location.origin) return;

      var data = ev.data || {};
      if (!data || !data.type) return;

      if (data.type === "x_connected") {
        session.profile.x = data.username || "";
        saveProfileToStorage();
        refreshBanner();
        alert("X connected: @" + (data.username || "unknown"));
      }

      if (data.type === "discord_connected") {
        session.profile.discord = data.username
          ? (data.username + (data.discriminator ? ("#" + data.discriminator) : ""))
          : "";
        saveProfileToStorage();
        refreshBanner();
        alert("Discord connected: " + (session.profile.discord || "connected"));
      }

      if (data.type === "x_error" || data.type === "discord_error") {
        alert("Auth failed. Please try again.");
      }
    });
  
    function openTraitsModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return alert("No NFTs loaded yet.");
      var sub = getSubdaoMatches(session.loadedNFTs);

      var pills = document.getElementById("subdaoPills");
      if (pills){
        pills.innerHTML = sub.map(function(s){
          return '<span class="pill ' + (s.unlocked ? 'on' : 'off') + '">'
               + (s.unlocked ? '‚úì' : '‚Ä¢') + ' ' + s.icon + ' ' + escapeHtml(s.name)
               + '</span>';
        }).join("");
      }

      var counts = buildTraitCounts(session.loadedNFTs);
      var rows = Object.keys(counts).sort(function(a,b){ return counts[b]-counts[a]; }).slice(0, 80);
      var tbody = document.querySelector("#traitsTable tbody");
      if (tbody){
        tbody.innerHTML = rows.map(function(k){
          return '<tr><td>' + escapeHtml(k) + '</td><td>' + counts[k] + '</td></tr>';
        }).join("");
        if (rows.length === 0) tbody.innerHTML = '<tr><td colspan="2" class="trait-muted">No trait data found in metadata.</td></tr>';
      }

      document.getElementById("traitsModalBackdrop").classList.add("show");
    }

    function hideTraitsModal(){
      document.getElementById("traitsModalBackdrop").classList.remove("show");
    }

    function closeTraitsModal(e){
      if (e && e.target && e.target.id === "traitsModalBackdrop") hideTraitsModal();
    }

    /* ================================================================
       CHAT ‚Äî Supabase real-time
       Table: chat_messages (id, wallet, username, text, created_at)
       Messages are shared live across all connected wallets.
    ================================================================ */

    var SUPA_URL = 'https://hypqndasopdkrqvkllvc.supabase.co';
    var SUPA_KEY = 'sb_publishable_DwaaLS_hFJAOZ6M9VmYKYA_AQvyfgv1';
    var supaClient  = null;
    var chatChannel = null;   // real-time subscription
    var chatMsgs    = [];     // [{id, wallet, username, text, created_at}]

    // Auto-refresh fallback (in case real-time misses / tab sleeps)
    var chatRefreshTimer = null;
    var CHAT_REFRESH_MS  = 8000; // 8s feels "live" without spamming

    function getSupaClient() {
      if (!supaClient) {
        supaClient = supabase.createClient(SUPA_URL, SUPA_KEY);
      }
      return supaClient;
    }


    /* ===============================
       CABBAGE SOFT STAKING (OFF-CHAIN)
       - Start button: sets first-time staking timestamp (one-time).
       - Claim button: credits earned cabbage since last claim.
       Requires Supabase Edge Function: /functions/v1/cabbage
       =============================== */

    function cabbageEndpoint() {
      return SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage';
    }

    function cabbageAuthHeaders() {
      // Supabase expects apikey + Authorization for Edge Functions when auth is enabled.
      return {
        'Content-Type': 'application/json',
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY
      };
    }

    function setBtnState(id, disabled, text) {
      var b = document.getElementById(id);
      if (!b) return;
      b.disabled = !!disabled;
      b.style.opacity = disabled ? '0.45' : '1';
      b.style.cursor = disabled ? 'not-allowed' : 'pointer';
      if (text != null) b.textContent = text;
    }

    function fmtDT(iso) {
      if (!iso) return '‚Äî';
      try {
        var d = new Date(iso);
        if (isNaN(d.getTime())) return '‚Äî';
        return d.toLocaleString();
      } catch (e) { return '‚Äî'; }
    }

    async function signCabbageMessage(action) {
      if (!walletProvider || !walletPublicKey) throw new Error('Wallet not connected');
      if (!walletProvider.signMessage) throw new Error('Wallet does not support message signing');
      var wallet = walletPublicKey.toBase58();
      var ts = new Date().toISOString();
      var msg = 'LNL Cabbage ' + action.toUpperCase() + '\nWallet: ' + wallet + '\nTime: ' + ts;
      var msgBytes = new TextEncoder().encode(msg);
      var sigBytes = await walletProvider.signMessage(msgBytes, 'utf8');
      // Phantom returns {signature: Uint8Array}; others may return Uint8Array directly.
      var raw = sigBytes && sigBytes.signature ? sigBytes.signature : sigBytes;
      var b64 = btoa(String.fromCharCode.apply(null, Array.from(raw)));
      return { wallet: wallet, message: msg, signature: b64 };
    }

    async function refreshCabbageUI() {
      try {
        if (!walletPublicKey) return;
        var wallet = walletPublicKey.toBase58();

        var balEl = document.getElementById('cabbageBalance');
        var rateEl = document.getElementById('cabbageRate');
        var pendEl = document.getElementById('cabbagePending');
        var lastEl = document.getElementById('cabbageLast');
        var startedEl = document.getElementById('cabbageStarted');

        if (balEl) balEl.textContent = '‚Ä¶';
        if (rateEl) rateEl.textContent = '‚Ä¶';
        if (pendEl) pendEl.textContent = '‚Ä¶';
        if (lastEl) lastEl.textContent = '‚Ä¶';
        if (startedEl) startedEl.textContent = '‚Ä¶';

        // Default UI state while loading
        setBtnState('cabbageStartBtn', true, 'Start');
        setBtnState('cabbageClaimBtn', true, 'Claim');

        var res = await fetch(cabbageEndpoint() + '?wallet=' + encodeURIComponent(wallet), {
          method: 'GET',
          headers: cabbageAuthHeaders()
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) {
          throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));
        }

        var balance = Number(data.balance || 0);
        var pending = Number(data.pending || 0);
        var rate = Number(data.rate_per_week || 0);

        var startedAt = data.started_at || null;
        var lastClaim = data.last_claim_at || null;

        if (balEl) balEl.textContent = (Math.floor(balance * 100) / 100).toLocaleString();
        if (rateEl) rateEl.textContent = rate.toLocaleString() + ' / week';
        if (pendEl) pendEl.textContent = (Math.floor(pending * 100) / 100).toLocaleString();
        if (startedEl) startedEl.textContent = startedAt ? fmtDT(startedAt) : 'Not started';
        if (lastEl) lastEl.textContent = lastClaim ? fmtDT(lastClaim) : '‚Äî';

        // Button rules:
        // - If NOT started: enable Start, disable Claim
        // - If started: disable Start, enable Claim
        var started = !!startedAt;
        setBtnState('cabbageStartBtn', started, started ? 'Started' : 'Start');
        setBtnState('cabbageClaimBtn', !started, 'Claim');

      } catch (e) {
        console.error('refreshCabbageUI error:', e);
        // Leave buttons usable for retry
        setBtnState('cabbageStartBtn', false, 'Start');
        setBtnState('cabbageClaimBtn', false, 'Claim');
      }
    }

    async function startCabbage() {
      try {
        setBtnState('cabbageStartBtn', true, 'Starting‚Ä¶');
        setBtnState('cabbageClaimBtn', true, 'Claim');
        var payload = await signCabbageMessage('start');

        var res = await fetch(cabbageEndpoint(), {
          method: 'POST',
          headers: cabbageAuthHeaders(),
          body: JSON.stringify({ action: 'start', wallet: payload.wallet, message: payload.message, signature: payload.signature })
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));

        await refreshCabbageUI();
      } catch (e) {
        console.error('startCabbage error:', e);
        alert('Start failed: ' + (e.message || e));
        setBtnState('cabbageStartBtn', false, 'Start');
      }
    }

    async function claimCabbage() {
      try {
        setBtnState('cabbageClaimBtn', true, 'Claiming‚Ä¶');
        var payload = await signCabbageMessage('claim');

        var res = await fetch(cabbageEndpoint(), {
          method: 'POST',
          headers: cabbageAuthHeaders(),
          body: JSON.stringify({ action: 'claim', wallet: payload.wallet, message: payload.message, signature: payload.signature })
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));

        await refreshCabbageUI();
      } catch (e) {
        console.error('claimCabbage error:', e);
        alert('Claim failed: ' + (e.message || e));
        setBtnState('cabbageClaimBtn', false, 'Claim');
      }
    }


    // Deterministic color per wallet so each user always looks the same
    function walletColor(addr) {
      var palette = ['#00d4ff','#7b68ee','#00ff88','#f5a623','#ff6b9d','#4ecdc4','#ffd93d','#ff8c42'];
      var hash = 0;
      for (var i = 0; i < (addr || '').length; i++) {
        hash = ((hash << 5) - hash) + addr.charCodeAt(i);
        hash |= 0;
      }
      return palette[Math.abs(hash) % palette.length];
    }

    // Called when leaving chat tab or disconnecting
    function stopChatPoll() {
      // stop fallback refresh timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // stop real-time subscription
      if (chatChannel) {
        try { getSupaClient().removeChannel(chatChannel); } catch(e) {}
        chatChannel = null;
      }
    }
    function renderChatUI() {
      var view = document.getElementById('view-chat');
      if (!view) return;

      view.innerHTML =
        // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">ü¶í HOLDER CHAT</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">Live ¬∑ Open to all connected wallets</div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:0.7rem;">' +
            '<div id="chatLiveDot" style="display:flex;align-items:center;gap:5px;font-size:0.7rem;color:#555;">' +
              '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶' +
            '</div>' +
            '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Messages ‚îÄ‚îÄ
        '<div id="chatBox" style="height:440px;overflow-y:auto;background:#06060f;border:1px solid #161628;border-radius:12px;padding:16px;margin-bottom:12px;scroll-behavior:smooth;">' +
          '<div id="chatInner"></div>' +
        '</div>' +

        // ‚îÄ‚îÄ Input ‚îÄ‚îÄ
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<div id="chatInputWrap" style="flex:1;display:flex;align-items:center;gap:8px;background:#0d0d1e;border:1px solid #1a1a30;border-radius:10px;padding:0 12px;transition:border-color 0.2s;">' +
            '<span id="chatWalletTag" style="font-size:0.78rem;font-weight:700;flex-shrink:0;white-space:nowrap;"></span>' +
            '<input id="chatInput" style="flex:1;background:transparent;border:none;outline:none;color:#e0e0ff;font-family:\'Space Grotesk\',sans-serif;font-size:0.88rem;padding:12px 0;" placeholder="Say something legend‚Ä¶" maxlength="400" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendChatMessage();}" />' +
            '<span id="chatCount" style="font-size:0.62rem;color:#252540;flex-shrink:0;min-width:28px;text-align:right;"></span>' +
          '</div>' +
          '<button id="chatSendBtn" onclick="sendChatMessage()" style="background:linear-gradient(135deg,rgba(0,212,255,0.18),rgba(123,104,238,0.18));border:1px solid rgba(0,212,255,0.35);color:#00d4ff;padding:12px 22px;border-radius:10px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.8rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;white-space:nowrap;">Send</button>' +
        '</div>';

      // Wallet tag
      if (walletPublicKey) {
        var addr = walletPublicKey.toBase58();
        var tag  = document.getElementById('chatWalletTag');
        tag.textContent = addr.slice(0,4) + '‚Ä¶' + addr.slice(-4);
        tag.style.color = walletColor(addr);
      }

      // Focus ring
      var wrap = document.getElementById('chatInputWrap');
      var inp  = document.getElementById('chatInput');
      inp.addEventListener('focus', function(){ wrap.style.borderColor = 'rgba(0,212,255,0.45)'; });
      inp.addEventListener('blur',  function(){ wrap.style.borderColor = '#1a1a30'; });
      inp.addEventListener('input', function(){
        var left = 400 - inp.value.length;
        var c = document.getElementById('chatCount');
        c.textContent = left < 80 ? left : '';
        c.style.color = left < 30 ? '#ff3c5c' : '#252540';
      });
    }

    
    // Pull any new messages since the newest one we have.
    // This runs on an interval as a safety net (real-time should still do the heavy lifting).
    async function refreshChatFromServer() {
      try {
        // only refresh if we're actually on the chat tab and the UI exists
        if (!session || session.currentView !== 'chat') return;
        if (!document.getElementById('chatInner')) return;

        var sb = getSupaClient();

        var last = (chatMsgs && chatMsgs.length) ? chatMsgs[chatMsgs.length - 1] : null;
        var q = sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        // Incremental fetch: only grab messages newer than what we have.
        if (last && last.created_at) {
          q = q.gt('created_at', last.created_at);
        }

        var res = await q;
        if (res.error) throw res.error;

        var incoming = res.data || [];
        if (!incoming.length) return;

        // Merge de-duped by id
        var existing = {};
        for (var i = 0; i < chatMsgs.length; i++) existing[chatMsgs[i].id] = true;

        for (var j = 0; j < incoming.length; j++) {
          if (!existing[incoming[j].id]) chatMsgs.push(incoming[j]);
        }

        // Keep sorted (in case clocks are funky)
        chatMsgs.sort(function(a,b){
          return new Date(a.created_at) - new Date(b.created_at);
        });

        paintMessages();
        scrollToBottom(false);
      } catch(e) {
        // quiet failure ‚Äî this is just a fallback
        console.warn('Chat auto-refresh error:', e && (e.message || e));
      }
    }

    function startChatAutoRefresh() {
      // reset any existing timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // immediate refresh in case we missed messages while tab was inactive
      refreshChatFromServer();

      chatRefreshTimer = setInterval(function(){
        refreshChatFromServer();
      }, CHAT_REFRESH_MS);

      // when user comes back to the tab, refresh immediately
      try {
        if (!window.__lnlChatVisHooked) {
          window.__lnlChatVisHooked = true;
          document.addEventListener('visibilitychange', function(){
            if (!document.hidden) refreshChatFromServer();
          });
          window.addEventListener('focus', function(){ refreshChatFromServer(); });
        }
      } catch(e) {}
    }

    async function loadChatHistory() {
      setLiveDot(false);
      try {
        var sb = getSupaClient();
        var res = await sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        if (res.error) throw res.error;
        chatMsgs = res.data || [];
        paintMessages();
        scrollToBottom(true);
      } catch(e) {
        console.error('Chat history error:', e);
        document.getElementById('chatInner').innerHTML =
          '<div style="color:#ff3c5c;font-size:0.78rem;text-align:center;padding:2rem;">Could not load messages. Check Supabase config.</div>';
      }
      subscribeLive();
    }

    function subscribeLive() {
      // Tear down any existing subscription first
      stopChatPoll();

      var sb = getSupaClient();
      chatChannel = sb
        .channel('chat_messages_live')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'chat_messages'
        }, function(payload) {
          var row = payload.new;
          // Avoid duplicates (our own optimistic message already added)
          var exists = chatMsgs.some(function(m){ return m.id === row.id; });
          if (!exists) {
            chatMsgs.push(row);
            paintMessages();
            scrollToBottom(false);
          }
        })
        .subscribe(function(status) {
          setLiveDot(status === 'SUBSCRIBED');
        });

      // Safety-net refresh (keeps chat updated even if real-time drops)
      startChatAutoRefresh();
    }

    function setLiveDot(live) {
      var el = document.getElementById('chatLiveDot');
      if (!el) return;
      if (live) {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 6px rgba(0,255,136,0.7);"></div>Live';
        el.style.color = '#555';
      } else {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶';
      }
    }

    function paintMessages() {
      var inner = document.getElementById('chatInner');
      if (!inner) return;

      if (chatMsgs.length === 0) {
        inner.innerHTML =
          '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:340px;gap:0.7rem;">' +
            '<div style="font-size:2.5rem;">ü¶í</div>' +
            '<div style="color:#252540;font-size:0.78rem;letter-spacing:2px;text-transform:uppercase;">No messages yet</div>' +
            '<div style="color:#1a1a30;font-size:0.7rem;">Be the first legend</div>' +
          '</div>';
        return;
      }

      var myWallet  = walletPublicKey ? walletPublicKey.toBase58() : null;
      var prevWallet = null;
      var html = '';

      chatMsgs.forEach(function(m, i) {
        var isMe  = m.wallet === myWallet;
        var color = walletColor(m.wallet);

        // Display name: use stored username if present, else shorten wallet
        var name = m.username
          ? m.username
          : (m.wallet.slice(0,4) + '‚Ä¶' + m.wallet.slice(-4));

        var newSender = m.wallet !== prevWallet;
        prevWallet = m.wallet;

        var t = new Date(m.created_at);
        var timeStr = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        if (newSender) {
          if (i > 0) html += '<div style="height:12px;"></div>';
          html +=
            '<div style="display:flex;align-items:baseline;gap:7px;margin-bottom:3px;">' +
              '<span style="font-weight:700;font-size:0.8rem;color:' + color + ';">' + escapeHtml(name) + '</span>' +
              '<span style="font-size:0.6rem;color:#252540;">' + timeStr + '</span>' +
              (isMe ? '<span style="font-size:0.55rem;letter-spacing:1px;color:#1e1e3a;text-transform:uppercase;">you</span>' : '') +
            '</div>';
        }

        html += '<div style="font-size:0.87rem;color:#c8c8e8;line-height:1.6;word-break:break-word;padding:1px 0;">' + escapeHtml(m.text) + '</div>';
      });

      inner.innerHTML = html;
    }

    function scrollToBottom(force) {
      var box = document.getElementById('chatBox');
      if (!box) return;
      var nearBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 120;
      if (force || nearBottom) box.scrollTop = box.scrollHeight;
    }

    async function sendChatMessage() {
      if (!walletPublicKey) { alert('Connect your wallet first.'); return; }
      var inp = document.getElementById('chatInput');
      var btn = document.getElementById('chatSendBtn');
      if (!inp) return;

      var text = inp.value.trim();
      if (!text) return;

      inp.value = '';
      inp.dispatchEvent(new Event('input'));
      btn.disabled = true;
      btn.textContent = '‚Ä¶';

      var wallet   = walletPublicKey.toBase58();
      var username = session.profile.username || null;

      try {
        var sb  = getSupaClient();
        var res = await sb.from('chat_messages').insert({
          wallet:   wallet,
          username: username,
          text:     text
        }).select().single();

        if (res.error) throw res.error;

        // Optimistic: add immediately so sender doesn't wait for real-time echo
        var exists = chatMsgs.some(function(m){ return m.id === res.data.id; });
        if (!exists) {
          chatMsgs.push(res.data);
          paintMessages();
          scrollToBottom(true);
        }
      } catch(e) {
        console.error('Send error:', e);
        alert('Failed to send: ' + (e.message || e));
      }

      btn.disabled = false;
      btn.textContent = 'Send';
      inp.focus();
    }


    /* ================================================================
       GAMES TAB v3
       Treasury: ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc
       
       HOUSE EDGE DESIGN (house wins more than player):
         Coin Flip  ‚Äî 43% win chance, 1.80x payout  ‚Üí ~22.6% house edge
         Dice High/Low ‚Äî 45% win chance, 1.75x      ‚Üí ~21.25% house edge  
         Dice Even/Odd ‚Äî 45% win chance, 1.75x      ‚Üí ~21.25% house edge
         Slots Two Match ‚Äî ~28% chance, 1.8x        ‚Üí ~50% house edge on that outcome
         Slots Three Match ‚Äî ~4% chance, 7x         ‚Üí house edge positive EV overall
         Slots Jackpot (ü¶íü¶íü¶í) ‚Äî ~1% chance, 15x  ‚Üí rare but thrilling
       
       Overall EV: House keeps ~20-25% of every bet ‚Üí funds NFT prizes.
       
       NFT PRIZE SYSTEM:
         - Every bet tracked in Supabase (game_bets table)  
         - NFT_POT_THRESHOLD_SOL (50 SOL) or NFT_POT_THRESHOLD_CAB (10000 Cabbage)
         - When pot fills ‚Üí random winner draw from recent players
         - Winner gets big modal + Supabase alert (nft_winners table) for admin to airdrop
         - Prize pot progress bar shown in Games header
    ================================================================ */

    var NFT_POT_THRESHOLD_SOL = 50;    // SOL house profit to trigger an NFT prize
    var NFT_POT_THRESHOLD_CAB = 10000; // Cabbage house profit to trigger an NFT prize

    var gameState = {
      currency: 'cabbage',
      cabbageBalance: 0,
      solBalance: 0,
      history: [],
      coinPick: 'heads',
      dicePick: 'high',
      slotsSpinning: false,
      coinSpinning: false,
      diceRolling: false,
      _stakedCount: 0,
      // Prize pot tracking (fetched from Supabase)
      houseProfitSol: 0,
      houseProfitCab: 0,
      nftPrizePending: false
    };

    var SLOT_SYMBOLS = ['ü¶í','üå∂Ô∏è','üíé','‚≠ê','üçÄ','7Ô∏è‚É£','üî•','üëë'];
    // Weights biased toward commons, giraffe is rarest
    var SLOT_WEIGHTS  = [ 8,   18,  14,   16,  18,  10,   12,   4];  // total=100
    var LAMPORTS_PER_SOL = 1000000000;

    // ---- HOUSE EDGE CONFIG ----
    // These are the TRUE win probabilities (lower than 50% so house profits)
    var HOUSE = {
      COIN_WIN_CHANCE:    0.43,   // 43% ‚Üí house keeps 22%+ per flip
      COIN_PAYOUT:        1.80,   // win 1.80x bet
      DICE_HL_CHANCE:     0.45,   // high/low 45%
      DICE_HL_PAYOUT:     1.75,
      DICE_EO_CHANCE:     0.45,   // even/odd 45%
      DICE_EO_PAYOUT:     1.75,
      SLOTS_TWO_CHANCE:   0.28,   // ~28% two-match
      SLOTS_TWO_PAYOUT:   1.80,
      SLOTS_THREE_CHANCE: 0.04,   // ~4% three-match
      SLOTS_THREE_PAYOUT: 7.0,
      SLOTS_JACKPOT_CHANCE: 0.008, // ~0.8% jackpot (ü¶íü¶íü¶í)
      SLOTS_JACKPOT_PAYOUT: 15.0
    };

    function weightedRandom(symbols, weights) {
      var total = weights.reduce(function(a,b){ return a+b; }, 0);
      var r = Math.random() * total;
      for (var i = 0; i < symbols.length; i++) { r -= weights[i]; if (r <= 0) return symbols[i]; }
      return symbols[symbols.length - 1];
    }

    // LNL bonus slightly improves win chance (small boost, house still wins overall)
    function getLNLBonus() {
      var count = (session.loadedNFTs ? session.loadedNFTs.length : 0) + (gameState._stakedCount || 0);
      if (count >= 20) return 0.04;   // capped lower so house edge stays intact
      if (count >= 10) return 0.03;
      if (count >= 5)  return 0.02;
      if (count >= 1)  return 0.01;
      return 0;
    }

    // ================================================================
    // SUPABASE GAME LOGGING + NFT PRIZE POT
    // ================================================================

    async function logGameBet(game, betAmount, currency, houseProfit) {
      try {
        var sb = getSupaClient();
        var wallet = walletPublicKey ? walletPublicKey.toBase58() : 'unknown';
        await sb.from('game_bets').insert({
          wallet:       wallet,
          game:         game,
          bet_amount:   betAmount,
          currency:     currency,
          house_profit: houseProfit,
          played_at:    new Date().toISOString()
        });
      } catch(e) {
        console.warn('game_bets log error (non-fatal):', e);
      }
    }

    async function fetchNFTPotProgress() {
      try {
        var sb = getSupaClient();
        // Sum house profit since last NFT prize per currency
        var solRes = await sb.from('game_bets')
          .select('house_profit')
          .eq('currency', 'sol')
          .gt('house_profit', 0);
        var cabRes = await sb.from('game_bets')
          .select('house_profit')
          .eq('currency', 'cabbage')
          .gt('house_profit', 0);

        var solTotal = 0, cabTotal = 0;
        if (solRes.data) solRes.data.forEach(function(r){ solTotal += Number(r.house_profit||0); });
        if (cabRes.data) cabRes.data.forEach(function(r){ cabTotal += Number(r.house_profit||0); });

        gameState.houseProfitSol = parseFloat(solTotal.toFixed(4));
        gameState.houseProfitCab = Math.floor(cabTotal);
        updateNFTPotUI();
      } catch(e) {
        console.warn('NFT pot fetch error:', e);
      }
    }

    async function triggerNFTWinner() {
      try {
        var sb = getSupaClient();
        var wallet = walletPublicKey ? walletPublicKey.toBase58() : 'unknown';
        var username = (session.profile && session.profile.username) ? session.profile.username : null;

        // Log the winner to nft_winners table for admin to action
        await sb.from('nft_winners').insert({
          wallet:    wallet,
          username:  username,
          currency:  gameState.currency,
          won_at:    new Date().toISOString(),
          status:    'pending_airdrop'
        });

        // Show winner modal
        showNFTWinnerModal(wallet);

      } catch(e) {
        console.warn('NFT winner log error:', e);
        // Still show the modal even if DB write fails
        showNFTWinnerModal(walletPublicKey ? walletPublicKey.toBase58() : 'unknown');
      }
    }

    function updateNFTPotUI() {
      // SOL pot bar
      var solBar = document.getElementById('solPotFill');
      var solTxt = document.getElementById('solPotTxt');
      var cabBar = document.getElementById('cabPotFill');
      var cabTxt = document.getElementById('cabPotTxt');

      var solPct = Math.min(100, (gameState.houseProfitSol / NFT_POT_THRESHOLD_SOL) * 100);
      var cabPct = Math.min(100, (gameState.houseProfitCab / NFT_POT_THRESHOLD_CAB) * 100);

      if (solBar) solBar.style.width = solPct + '%';
      if (solTxt) solTxt.textContent = gameState.houseProfitSol.toFixed(2) + ' / ' + NFT_POT_THRESHOLD_SOL + ' ‚óé';
      if (cabBar) cabBar.style.width = cabPct + '%';
      if (cabTxt) cabTxt.textContent = gameState.houseProfitCab.toLocaleString() + ' / ' + NFT_POT_THRESHOLD_CAB.toLocaleString() + ' ü•¨';
    }

    // ================================================================
    // NFT WINNER MODAL
    // ================================================================

    function showNFTWinnerModal(wallet) {
      var existing = document.getElementById('nftWinnerModal');
      if (existing) existing.remove();

      var short = wallet.slice(0,4) + '‚Ä¶' + wallet.slice(-4);
      var modal = document.createElement('div');
      modal.id = 'nftWinnerModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;padding:1.5rem;';
      modal.innerHTML =
        '<div style="max-width:480px;width:100%;background:linear-gradient(135deg,#0d0d20,#111125);border:2px solid #ffd700;border-radius:20px;padding:2.5rem 2rem;text-align:center;position:relative;box-shadow:0 0 60px rgba(255,215,0,0.3),0 0 120px rgba(255,215,0,0.1);">' +
          '<div style="font-size:5rem;margin-bottom:0.5rem;animation:nftPulse 0.8s ease-in-out infinite alternate;">ü¶í</div>' +
          '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:2.8rem;letter-spacing:5px;color:#ffd700;text-shadow:0 0 30px rgba(255,215,0,0.6);margin-bottom:0.5rem;">YOU WON AN NFT!</div>' +
          '<div style="color:#e0e0ff;font-size:0.95rem;margin-bottom:1.2rem;line-height:1.6;">The prize pot filled up and you\'re the lucky legend!<br>A <strong style="color:#ffd700;">Long Neck Legends NFT</strong> is being sent to your wallet.</div>' +
          '<div style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.25);border-radius:10px;padding:1rem;margin-bottom:1.5rem;">' +
            '<div style="font-size:0.65rem;letter-spacing:2px;color:#888;text-transform:uppercase;margin-bottom:0.3rem;">Winner Wallet</div>' +
            '<div style="font-family:monospace;color:#ffd700;font-size:0.9rem;">'+wallet+'</div>' +
          '</div>' +
          '<div style="background:rgba(0,255,136,0.06);border:1px solid rgba(0,255,136,0.2);border-radius:10px;padding:0.9rem;margin-bottom:1.5rem;font-size:0.8rem;color:#00ff88;line-height:1.6;">' +
            '‚úÖ Your wallet has been flagged for the airdrop.<br>The LNL team will send your NFT within <strong>24 hours</strong>.<br>Keep an eye on your wallet at <strong style="color:#00d4ff;">'+short+'</strong>' +
          '</div>' +
          '<button onclick="document.getElementById(\'nftWinnerModal\').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:10px;color:#000;font-family:\'Space Grotesk\',sans-serif;font-weight:900;font-size:1rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;">LFG! CLAIM MY WIN ü¶í</button>' +
          '<div style="margin-top:0.8rem;font-size:0.65rem;color:#444;letter-spacing:1px;">Questions? Reach the team in Discord or DM @LongNeckLegends on X</div>' +
        '</div>';

      document.body.appendChild(modal);

      // Confetti burst
      launchConfetti();
    }

    function launchConfetti() {
      var colors = ['#ffd700','#00d4ff','#7b68ee','#00ff88','#ff3c5c'];
      for (var i = 0; i < 80; i++) {
        (function(idx) {
          setTimeout(function() {
            var el = document.createElement('div');
            el.style.cssText = [
              'position:fixed',
              'top:-10px',
              'left:' + Math.random() * 100 + 'vw',
              'width:' + (6 + Math.random()*8) + 'px',
              'height:' + (6 + Math.random()*8) + 'px',
              'background:' + colors[Math.floor(Math.random()*colors.length)],
              'border-radius:' + (Math.random()>0.5?'50%':'2px'),
              'pointer-events:none',
              'z-index:10000',
              'animation:confettiFall ' + (1.5+Math.random()*2) + 's linear forwards'
            ].join(';');
            document.body.appendChild(el);
            setTimeout(function(){ el.remove(); }, 3500);
          }, idx * 30);
        })(i);
      }
    }

    // ================================================================
    // BALANCE / RPC HELPERS
    // ================================================================

    async function fetchSolBalanceFromRPC(address) {
      try {
        var res = await fetch(CONFIG.RPC_URL, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ jsonrpc:'2.0', id:1, method:'getBalance', params:[address,{commitment:'confirmed'}] })
        });
        var json = await res.json();
        return (json && json.result && json.result.value != null ? json.result.value : 0) / LAMPORTS_PER_SOL;
      } catch(e) { return 0; }
    }

    async function fetchCabbageBalanceForGames() {
      try {
        if (!walletPublicKey) return 0;
        var res = await fetch(cabbageEndpoint() + '?wallet=' + encodeURIComponent(walletPublicKey.toBase58()), {
          method:'GET', headers: cabbageAuthHeaders()
        });
        var data = await res.json().catch(function(){ return {}; });
        return res.ok ? Number(data.balance || 0) : 0;
      } catch(e) { return 0; }
    }

    async function fetchStakedNFTsInTreasury() {
      try {
        var res = await fetch(CONFIG.RPC_URL, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ jsonrpc:'2.0', id:'treasury', method:'getAssetsByOwner',
            params:{ ownerAddress: CONFIG.TREASURY_WALLET, page:1, limit:1000, displayOptions:{showCollectionMetadata:true} } })
        });
        var json = await res.json();
        var items = json && json.result && json.result.items ? json.result.items : [];
        return items.filter(function(a){
          var g = (a.grouping||[]).find(function(x){ return x.group_key==='collection'; });
          return g && g.group_value === CONFIG.COLLECTION_MINT;
        }).length;
      } catch(e) { return 0; }
    }

    async function loadGameBalances() {
      var addr = walletPublicKey ? walletPublicKey.toBase58() : null;
      if (!addr) return;
      var results = await Promise.allSettled([
        fetchCabbageBalanceForGames(),
        fetchSolBalanceFromRPC(addr),
        fetchStakedNFTsInTreasury(),
        fetchNFTPotProgress()
      ]);
      gameState.cabbageBalance = Math.floor(results[0].status==='fulfilled' ? results[0].value : 0);
      gameState.solBalance     = parseFloat((results[1].status==='fulfilled' ? results[1].value : 0).toFixed(4));
      gameState._stakedCount   = results[2].status==='fulfilled' ? results[2].value : 0;
      refreshBalanceUI();
    }

    // ================================================================
    // UI HELPERS
    // ================================================================

    function getBalance() {
      return gameState.currency==='cabbage' ? gameState.cabbageBalance : gameState.solBalance;
    }

    function adjustBalance(delta) {
      if (gameState.currency==='cabbage') {
        gameState.cabbageBalance = Math.max(0, Math.floor(gameState.cabbageBalance + delta));
      } else {
        gameState.solBalance = Math.max(0, parseFloat((gameState.solBalance + delta).toFixed(4)));
      }
    }

    function setBetPreset(gameId, mult) {
      var bal = getBalance();
      var v = mult==='max' ? bal : parseFloat((bal*mult).toFixed(gameState.currency==='sol'?4:0));
      var inp = document.getElementById(gameId+'BetInput');
      if (inp) inp.value = v;
    }

    function selectCoin(side) {
      gameState.coinPick = side;
      document.querySelectorAll('.coin-pick-btn').forEach(function(b){ b.classList.toggle('selected', b.dataset.side===side); });
    }

    function selectDice(pick) {
      gameState.dicePick = pick;
      document.querySelectorAll('.dice-opt').forEach(function(b){ b.classList.toggle('selected', b.dataset.pick===pick); });
    }

    function selectCurrency(cur) {
      gameState.currency = cur;
      document.querySelectorAll('.currency-opt').forEach(function(b){ b.classList.toggle('active', b.dataset.cur===cur); });
      refreshBalanceUI();
    }

    function refreshBalanceUI() {
      var el=document.getElementById('gCabbageVal'), sel=document.getElementById('gSolVal');
      if (el)  el.textContent  = Math.floor(gameState.cabbageBalance).toLocaleString();
      if (sel) sel.textContent = gameState.solBalance.toFixed(4);
    }

    function pushHistory(game, bet, outcome, delta) {
      gameState.history.unshift({game:game,bet:bet,outcome:outcome,delta:delta,cur:gameState.currency});
      if (gameState.history.length>30) gameState.history.length=30;
      refreshHistoryUI();
    }

    function refreshHistoryUI() {
      var list=document.getElementById('gameHistoryList');
      if (!list) return;
      if (!gameState.history.length) { list.innerHTML='<div class="history-empty">No games played yet</div>'; return; }
      list.innerHTML = gameState.history.map(function(h){
        var sign=h.delta>=0?'+':'', cls=h.delta>=0?'win':'lose', sym=h.cur==='cabbage'?'ü•¨ ':'‚óé ';
        return '<div class="history-row"><span class="history-game">'+h.game+'</span><span class="history-bet">'+sym+h.bet+'</span><span class="history-outcome '+cls+'">'+sign+h.delta+'</span></div>';
      }).join('');
    }

    function flashCard(id) {
      var card=document.getElementById(id); if(!card)return;
      card.classList.remove('win-flash'); void card.offsetWidth; card.classList.add('win-flash');
      setTimeout(function(){ card.classList.remove('win-flash'); },1100);
    }

    // After every game resolve, check if NFT pot triggered
    async function checkNFTPotTrigger(betAmount, playerWon) {
      var profit = playerWon ? 0 : betAmount; // house profit = lost bet only (simplified)
      // More accurate: profit = bet - payout_if_won; but we track losses as house profit
      // Log the bet to Supabase
      await logGameBet(
        gameState._lastGame || 'unknown',
        betAmount,
        gameState.currency,
        profit
      );

      // Re-fetch pot progress
      await fetchNFTPotProgress();

      // Check if threshold crossed
      var triggered = false;
      if (gameState.currency === 'sol'     && gameState.houseProfitSol >= NFT_POT_THRESHOLD_SOL) triggered = true;
      if (gameState.currency === 'cabbage' && gameState.houseProfitCab >= NFT_POT_THRESHOLD_CAB) triggered = true;

      if (triggered && !gameState.nftPrizePending) {
        gameState.nftPrizePending = true;
        await triggerNFTWinner();
      }
    }

    // ================================================================
    // SOL TRANSFER TO TREASURY
    // ================================================================

    function b58Decode(s) {
      var ALPHA='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      var num=BigInt(0);
      for (var i=0;i<s.length;i++) num=num*BigInt(58)+BigInt(ALPHA.indexOf(s[i]));
      var hex=num.toString(16).padStart(64,'0');
      var r=new Uint8Array(32);
      for (var j=0;j<32;j++) r[j]=parseInt(hex.substr(j*2,2),16);
      return r;
    }

    function buildSolTransferMsg(fromB58, toB58, lamports, blockhash) {
      var from=b58Decode(fromB58), to=b58Decode(toB58), bh=b58Decode(blockhash), sys=new Uint8Array(32);
      var ix=new Uint8Array(12); ix[0]=2;
      var lam=BigInt(lamports);
      for (var b=0;b<8;b++){ix[4+b]=Number(lam&BigInt(0xFF));lam>>=BigInt(8);}
      var msg=[];
      msg.push(1,0,1,3);
      for(var k=0;k<32;k++) msg.push(from[k]);
      for(var k=0;k<32;k++) msg.push(to[k]);
      for(var k=0;k<32;k++) msg.push(sys[k]);
      for(var k=0;k<32;k++) msg.push(bh[k]);
      msg.push(1,2,2,0,1,ix.length);
      for(var k=0;k<ix.length;k++) msg.push(ix[k]);
      return new Uint8Array(msg);
    }

    async function sendSolToTreasury(amountSol) {
      if (!walletProvider||!walletPublicKey) throw new Error('Wallet not connected');
      var lamports=Math.round(amountSol*LAMPORTS_PER_SOL);
      var bhRes=await fetch(CONFIG.RPC_URL,{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({jsonrpc:'2.0',id:1,method:'getLatestBlockhash',params:[{commitment:'confirmed'}]})});
      var bhJson=await bhRes.json();
      var blockhash=bhJson.result.value.blockhash;
      var msg=buildSolTransferMsg(walletPublicKey.toBase58(), CONFIG.TREASURY_WALLET, lamports, blockhash);
      if (walletProvider.signAndSendTransaction) {
        var r=await walletProvider.signAndSendTransaction({message:{serialize:function(){return msg;}}});
        return !!(r && (r.signature||r));
      }
      throw new Error('Your wallet does not support this transaction type. Please use Phantom or Solflare, or switch to Cabbage currency.');
    }

    async function spendCabbage(amount) {
      try {
        var payload=await signCabbageMessage('spend');
        var res=await fetch(cabbageEndpoint(),{
          method:'POST', headers:cabbageAuthHeaders(),
          body:JSON.stringify({action:'spend',wallet:payload.wallet,message:payload.message,signature:payload.signature,amount:amount})
        });
        var data=await res.json().catch(function(){return{};});
        if(!res.ok) throw new Error(data&&data.error?data.error:('HTTP '+res.status));
        gameState.cabbageBalance=Math.floor(Number(data.balance||0));
        refreshBalanceUI();
        return true;
      } catch(e) {
        console.warn('Cabbage spend error (local fallback):', e);
        return null;
      }
    }

    async function deductBet(bet) {
      if (gameState.currency==='sol') {
        try {
          await sendSolToTreasury(bet);
          gameState.solBalance=Math.max(0,parseFloat((gameState.solBalance-bet).toFixed(4)));
          refreshBalanceUI();
          return true;
        } catch(e) {
          alert('SOL transfer failed: '+(e.message||e)+'\n\nMake sure your wallet is unlocked and you have enough SOL for the bet + fees (~0.000005 ‚óé).');
          return false;
        }
      } else {
        var result=await spendCabbage(bet);
        if (result===false) { alert('Failed to deduct Cabbage. Try again.'); return false; }
        if (result===null) { gameState.cabbageBalance=Math.max(0,gameState.cabbageBalance-bet); refreshBalanceUI(); }
        return true;
      }
    }

    // ================================================================
    // COIN FLIP  (43% win, 1.80x payout ‚Üí ~22% house edge)
    // ================================================================
    async function playCoinFlip() {
      if (gameState.coinSpinning) return;
      var bet=parseFloat(document.getElementById('coinBetInput').value);
      if (!bet||bet<=0){alert('Enter a valid bet amount.');return;}
      if (bet>getBalance()){alert('Insufficient balance!');return;}
      if (gameState.currency==='sol'&&bet<0.001){alert('Minimum SOL bet: 0.001 ‚óé');return;}

      gameState.coinSpinning=true; gameState._lastGame='ü™ô Coin Flip';
      var playBtn=document.getElementById('coinPlayBtn'),resultEl=document.getElementById('coinResultLabel'),coinEl=document.getElementById('theCoin');
      playBtn.disabled=true;
      resultEl.textContent=gameState.currency==='sol'?'‚è≥ Sending ‚óé to treasury‚Ä¶':'‚è≥ Deducting Cabbage‚Ä¶';
      resultEl.className='coin-result-label neutral';

      var ok=await deductBet(bet);
      if(!ok){gameState.coinSpinning=false;playBtn.disabled=false;resultEl.textContent='Pick a side and flip!';return;}

      resultEl.textContent='üé≤ Flipping‚Ä¶';
      coinEl.classList.add('spinning');

      setTimeout(async function(){
        coinEl.classList.remove('spinning');
        var bonus=getLNLBonus();
        var win=Math.random() < (HOUSE.COIN_WIN_CHANCE + bonus);
        var result;
        if (win) {
          result=gameState.coinPick; // they guessed right
        } else {
          result=gameState.coinPick==='heads'?'tails':'heads';
        }
        coinEl.style.transform=result==='heads'?'rotateY(0deg)':'rotateY(180deg)';

        var playerWon=win;
        if(playerWon){
          var payout=parseFloat((bet*HOUSE.COIN_PAYOUT).toFixed(gameState.currency==='sol'?4:0));
          adjustBalance(payout); refreshBalanceUI();
          resultEl.textContent='üéâ '+result.toUpperCase()+' ‚Äî WIN! +'+(gameState.currency==='sol'?payout+' ‚óé':payout+' ü•¨');
          resultEl.className='coin-result-label win';
          pushHistory('ü™ô Coin',bet,'WIN',+(payout-bet).toFixed(4)); flashCard('coinCard');
        } else {
          resultEl.textContent='üíÄ '+result.toUpperCase()+' ‚Äî HOUSE WINS';
          resultEl.className='coin-result-label lose';
          pushHistory('ü™ô Coin',bet,'LOSE',-bet);
        }
        playBtn.disabled=false; gameState.coinSpinning=false;
        await checkNFTPotTrigger(bet, playerWon);
      },1450);
    }

    // ================================================================
    // DICE ROLL  (45% win, 1.75x payout ‚Üí ~21% house edge)
    // ================================================================
    async function playDiceRoll() {
      if (gameState.diceRolling) return;
      var bet=parseFloat(document.getElementById('diceBetInput').value);
      if (!bet||bet<=0){alert('Enter a valid bet amount.');return;}
      if (bet>getBalance()){alert('Insufficient balance!');return;}
      if (gameState.currency==='sol'&&bet<0.001){alert('Minimum SOL bet: 0.001 ‚óé');return;}

      gameState.diceRolling=true; gameState._lastGame='üé≤ Dice Roll';
      var playBtn=document.getElementById('dicePlayBtn'),resEl=document.getElementById('diceResultLabel'),diceEl=document.getElementById('theDice');
      playBtn.disabled=true;
      resEl.textContent=gameState.currency==='sol'?'‚è≥ Sending ‚óé to treasury‚Ä¶':'‚è≥ Deducting Cabbage‚Ä¶';
      resEl.className='coin-result-label neutral';

      var ok=await deductBet(bet);
      if(!ok){gameState.diceRolling=false;playBtn.disabled=false;resEl.textContent='Choose your prediction!';return;}

      resEl.textContent='üé≤ Rolling‚Ä¶';
      var FACES=['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
      diceEl.classList.add('rolling');
      var fi=setInterval(function(){diceEl.textContent=FACES[Math.floor(Math.random()*6)];},80);

      setTimeout(async function(){
        clearInterval(fi); diceEl.classList.remove('rolling');
        var bonus=getLNLBonus();
        var winChance = (gameState.dicePick==='high'||gameState.dicePick==='low') ? HOUSE.DICE_HL_CHANCE : HOUSE.DICE_EO_CHANCE;
        var payout_mult = (gameState.dicePick==='high'||gameState.dicePick==='low') ? HOUSE.DICE_HL_PAYOUT : HOUSE.DICE_EO_PAYOUT;
        var playerWon = Math.random() < (winChance + bonus);

        // Show a realistic dice face that matches outcome
        var validRolls;
        if(gameState.dicePick==='high') validRolls=playerWon?[4,5,6]:[1,2,3];
        else if(gameState.dicePick==='low') validRolls=playerWon?[1,2,3]:[4,5,6];
        else if(gameState.dicePick==='even') validRolls=playerWon?[2,4,6]:[1,3,5];
        else validRolls=playerWon?[1,3,5]:[2,4,6];
        var roll=validRolls[Math.floor(Math.random()*validRolls.length)];
        diceEl.textContent=FACES[roll-1];

        if(playerWon){
          var payout=parseFloat((bet*payout_mult).toFixed(gameState.currency==='sol'?4:0));
          adjustBalance(payout); refreshBalanceUI();
          resEl.textContent='üéâ Rolled '+roll+' ‚Äî WIN! +'+(gameState.currency==='sol'?payout+' ‚óé':payout+' ü•¨');
          resEl.className='coin-result-label win';
          pushHistory('üé≤ Dice',bet,'WIN',+(payout-bet).toFixed(4)); flashCard('diceCard');
        } else {
          resEl.textContent='üíÄ Rolled '+roll+' ‚Äî HOUSE WINS';
          resEl.className='coin-result-label lose';
          pushHistory('üé≤ Dice',bet,'LOSE',-bet);
        }
        playBtn.disabled=false; gameState.diceRolling=false;
        await checkNFTPotTrigger(bet, playerWon);
      },800);
    }

    // ================================================================
    // SLOTS  (house-positive EV overall)
    // ================================================================
    async function playSlots() {
      if (gameState.slotsSpinning) return;
      var bet=parseFloat(document.getElementById('slotsBetInput').value);
      if (!bet||bet<=0){alert('Enter a valid bet amount.');return;}
      if (bet>getBalance()){alert('Insufficient balance!');return;}
      if (gameState.currency==='sol'&&bet<0.001){alert('Minimum SOL bet: 0.001 ‚óé');return;}

      gameState.slotsSpinning=true; gameState._lastGame='üé∞ Slots';
      var playBtn=document.getElementById('slotsPlayBtn'),resEl=document.getElementById('slotsResultMsg');
      playBtn.disabled=true;
      resEl.textContent=gameState.currency==='sol'?'‚è≥ Sending ‚óé to treasury‚Ä¶':'‚è≥ Deducting Cabbage‚Ä¶';
      resEl.className='slots-result-msg neutral';

      var ok=await deductBet(bet);
      if(!ok){gameState.slotsSpinning=false;playBtn.disabled=false;resEl.textContent='Spin to win!';return;}

      var reels=[document.getElementById('reel1'),document.getElementById('reel2'),document.getElementById('reel3')];
      reels.forEach(function(r){r.classList.add('spinning-reel');});
      resEl.textContent='üé∞ Spinning‚Ä¶';
      var ti=setInterval(function(){reels.forEach(function(r){r.textContent=SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)];});},80);

      setTimeout(async function(){
        clearInterval(ti); reels.forEach(function(r){r.classList.remove('spinning-reel');});

        var bonus=getLNLBonus();
        // Determine outcome using house odds (not pure slot randomness)
        var rand=Math.random()-bonus;
        var payout=0, label='', playerWon=false;

        if(rand < HOUSE.SLOTS_JACKPOT_CHANCE) {
          // Jackpot ‚Äî show ü¶íü¶íü¶í
          reels.forEach(function(r){r.textContent='ü¶í';});
          payout=parseFloat((bet*HOUSE.SLOTS_JACKPOT_PAYOUT).toFixed(gameState.currency==='sol'?4:0));
          label='üö® LONG NECK JACKPOT! '+HOUSE.SLOTS_JACKPOT_PAYOUT+'x'; resEl.className='slots-result-msg jackpot';
          adjustBalance(payout); refreshBalanceUI();
          pushHistory('üé∞ Slots',bet,'JACKPOT',+(payout-bet).toFixed(4)); flashCard('slotsCard');
          playerWon=true;
        } else if(rand < HOUSE.SLOTS_JACKPOT_CHANCE + HOUSE.SLOTS_THREE_CHANCE) {
          // Three of a kind (non-jackpot)
          var sym=SLOT_SYMBOLS[1+Math.floor(Math.random()*(SLOT_SYMBOLS.length-1))]; // not giraffe
          reels.forEach(function(r){r.textContent=sym;});
          payout=parseFloat((bet*HOUSE.SLOTS_THREE_PAYOUT).toFixed(gameState.currency==='sol'?4:0));
          label='üéâ THREE OF A KIND! '+HOUSE.SLOTS_THREE_PAYOUT+'x'; resEl.className='slots-result-msg jackpot';
          adjustBalance(payout); refreshBalanceUI();
          pushHistory('üé∞ Slots',bet,'WIN 3x',+(payout-bet).toFixed(4)); flashCard('slotsCard');
          playerWon=true;
        } else if(rand < HOUSE.SLOTS_JACKPOT_CHANCE + HOUSE.SLOTS_THREE_CHANCE + HOUSE.SLOTS_TWO_CHANCE) {
          // Two match
          var s1=weightedRandom(SLOT_SYMBOLS,SLOT_WEIGHTS), s2=s1, s3;
          do { s3=weightedRandom(SLOT_SYMBOLS,SLOT_WEIGHTS); } while(s3===s1);
          var pos=Math.floor(Math.random()*3);
          var final_=[s1,s2,s3]; if(pos===0){final_=[s3,s1,s2];} else if(pos===1){final_=[s1,s3,s2];}
          reels.forEach(function(r,i){r.textContent=final_[i];});
          payout=parseFloat((bet*HOUSE.SLOTS_TWO_PAYOUT).toFixed(gameState.currency==='sol'?4:0));
          label='‚úÖ TWO MATCH! '+HOUSE.SLOTS_TWO_PAYOUT+'x'; resEl.className='slots-result-msg win2';
          adjustBalance(payout); refreshBalanceUI();
          pushHistory('üé∞ Slots',bet,'WIN 2x',+(payout-bet).toFixed(4));
          playerWon=true;
        } else {
          // No match ‚Äî make sure all three are different
          var pool=SLOT_SYMBOLS.slice(); var drawn=[];
          while(drawn.length<3){ var s=pool[Math.floor(Math.random()*pool.length)]; if(drawn.indexOf(s)===-1) drawn.push(s); }
          reels.forEach(function(r,i){r.textContent=drawn[i];});
          label='üíÄ NO MATCH ‚Äî HOUSE WINS'; resEl.className='slots-result-msg lose';
          pushHistory('üé∞ Slots',bet,'LOSE',-bet);
          playerWon=false;
        }

        resEl.textContent=label; playBtn.disabled=false; gameState.slotsSpinning=false;
        await checkNFTPotTrigger(bet, playerWon);
      },1600);
    }

    // ================================================================
    // RENDER GAMES UI
    // ================================================================
    function renderGamesUI() {
      var vg=document.getElementById('view-games'); if(!vg)return;

      var nfts=(session.loadedNFTs?session.loadedNFTs.length:0)+(gameState._stakedCount||0);
      var bonus=getLNLBonus();
      var bonusTxt=bonus>0
        ?'<strong>+'+(bonus*100).toFixed(0)+'% LNL Win Boost</strong> active ‚Äî '+nfts+' Long Neck Legend'+(nfts!==1?'s':'')+' detected (wallet + staked in treasury). Your odds are tilted in your favor.'
        :'Hold or stake <strong>Long Neck Legends NFTs</strong> to nudge your win chances. Staked NFTs in the treasury also count!';

      var solPct=Math.min(100,(gameState.houseProfitSol/NFT_POT_THRESHOLD_SOL)*100);
      var cabPct=Math.min(100,(gameState.houseProfitCab/NFT_POT_THRESHOLD_CAB)*100);

      vg.innerHTML=
        '<div class="games-header">'+
          '<div class="games-header-left">'+
            '<h2>üé∞ Long Neck Casino</h2>'+
            '<p>Bet ü•¨ Cabbage or ‚óé SOL. SOL goes on-chain to the treasury. Win big ‚Äî or help fill the NFT prize pot!</p>'+
          '</div>'+
          '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.8rem;">'+
            '<div class="games-balance-row">'+
              '<div class="game-balance-chip"><div class="gbc-label">ü•¨ Cabbage</div><div class="gbc-val cabbage" id="gCabbageVal">‚Ä¶</div></div>'+
              '<div class="game-balance-chip"><div class="gbc-label">‚óé SOL</div><div class="gbc-val sol" id="gSolVal">‚Ä¶</div></div>'+
            '</div>'+
            '<div class="games-currency-toggle">'+
              '<button class="currency-opt'+(gameState.currency==='cabbage'?' active':'')+'" data-cur="cabbage" onclick="selectCurrency(\'cabbage\')">ü•¨ Cabbage</button>'+
              '<button class="currency-opt'+(gameState.currency==='sol'?' active':'')+'" data-cur="sol" onclick="selectCurrency(\'sol\')">‚óé SOL</button>'+
            '</div>'+
          '</div>'+
        '</div>'+

        // NFT Prize Pot
        '<div style="background:linear-gradient(135deg,rgba(255,215,0,0.06),rgba(255,215,0,0.02));border:1px solid rgba(255,215,0,0.2);border-radius:14px;padding:1.3rem 1.5rem;">'+
          '<div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.9rem;">'+
            '<span style="font-size:1.4rem;">üèÜ</span>'+
            '<div>'+
              '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.1rem;letter-spacing:3px;color:#ffd700;">NFT PRIZE POT</div>'+
              '<div style="font-size:0.7rem;color:#666;letter-spacing:1px;">House profit funds the next LNL NFT prize. When the pot fills ‚Äî a player wins a free NFT airdropped to their wallet!</div>'+
            '</div>'+
          '</div>'+
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">'+
            '<div>'+
              '<div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#666;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">'+
                '<span>‚óé SOL Pot</span><span id="solPotTxt">‚Ä¶</span>'+
              '</div>'+
              '<div style="height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;">'+
                '<div id="solPotFill" style="height:100%;width:'+solPct+'%;background:linear-gradient(90deg,#9945ff,#00d4ff);border-radius:4px;transition:width 1s ease;box-shadow:0 0 10px rgba(153,69,255,0.5);"></div>'+
              '</div>'+
            '</div>'+
            '<div>'+
              '<div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#666;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;">'+
                '<span>ü•¨ Cabbage Pot</span><span id="cabPotTxt">‚Ä¶</span>'+
              '</div>'+
              '<div style="height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;">'+
                '<div id="cabPotFill" style="height:100%;width:'+cabPct+'%;background:linear-gradient(90deg,#00ff88,#00d4ff);border-radius:4px;transition:width 1s ease;box-shadow:0 0 10px rgba(0,255,136,0.4);"></div>'+
              '</div>'+
            '</div>'+
          '</div>'+
        '</div>'+

        '<div class="lnl-bonus-bar">'+bonusTxt+'</div>'+

        '<div class="games-grid">'+

          // COIN FLIP
          '<div class="game-card" id="coinCard">'+
            '<div class="game-card-title">ü™ô Coin Flip</div>'+
            '<div class="game-card-desc">Pick Heads (ü¶í) or Tails (üå∂Ô∏è). Win '+HOUSE.COIN_PAYOUT+'x your bet. Every flip funds the NFT prize pot.</div>'+
            '<div class="coin-wrap">'+
              '<div class="coin" id="theCoin"><div class="coin-face coin-heads">ü¶í</div><div class="coin-face coin-tails">üå∂Ô∏è</div></div>'+
              '<div class="coin-result-label neutral" id="coinResultLabel">Pick a side and flip!</div>'+
            '</div>'+
            '<div class="coin-pick-row">'+
              '<button class="coin-pick-btn'+(gameState.coinPick==='heads'?' selected':'')+'" data-side="heads" onclick="selectCoin(\'heads\')">ü¶í Heads</button>'+
              '<button class="coin-pick-btn'+(gameState.coinPick==='tails'?' selected':'')+'" data-side="tails" onclick="selectCoin(\'tails\')">üå∂Ô∏è Tails</button>'+
            '</div>'+
            '<div class="bet-row"><span class="bet-label">Bet</span>'+
              '<input class="bet-input" id="coinBetInput" type="number" min="0.001" step="any" placeholder="Amount" />'+
              '<div class="bet-presets">'+
                '<button class="bet-preset" onclick="setBetPreset(\'coin\',0.1)">10%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'coin\',0.25)">25%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'coin\',0.5)">50%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'coin\',\'max\')">MAX</button>'+
              '</div></div>'+
            '<button class="game-play-btn" id="coinPlayBtn" onclick="playCoinFlip()">FLIP THE COIN</button>'+
            '<div class="game-odds-note">Win chance: ~43% &bull; Payout: '+HOUSE.COIN_PAYOUT+'x &bull; House edge: ~22%</div>'+
          '</div>'+

          // DICE ROLL
          '<div class="game-card" id="diceCard">'+
            '<div class="game-card-title">üé≤ Dice Roll</div>'+
            '<div class="game-card-desc">Predict High, Low, Even, or Odd. Losses build the NFT prize pot faster.</div>'+
            '<div class="dice-display">'+
              '<div class="dice" id="theDice">‚öÑ</div>'+
              '<div class="coin-result-label neutral" id="diceResultLabel" style="margin-top:0.5rem;">Choose your prediction!</div>'+
            '</div>'+
            '<div class="dice-prediction-row">'+
              '<button class="dice-opt'+(gameState.dicePick==='high'?' selected':'')+'" data-pick="high" onclick="selectDice(\'high\')">‚¨ÜÔ∏è High (4-6)<br><small style="color:#555;">'+HOUSE.DICE_HL_PAYOUT+'x</small></button>'+
              '<button class="dice-opt'+(gameState.dicePick==='low'?' selected':'')+'" data-pick="low" onclick="selectDice(\'low\')">‚¨áÔ∏è Low (1-3)<br><small style="color:#555;">'+HOUSE.DICE_HL_PAYOUT+'x</small></button>'+
              '<button class="dice-opt'+(gameState.dicePick==='even'?' selected':'')+'" data-pick="even" onclick="selectDice(\'even\')">2Ô∏è‚É£ Even<br><small style="color:#555;">'+HOUSE.DICE_EO_PAYOUT+'x</small></button>'+
              '<button class="dice-opt'+(gameState.dicePick==='odd'?' selected':'')+'" data-pick="odd" onclick="selectDice(\'odd\')">1Ô∏è‚É£ Odd<br><small style="color:#555;">'+HOUSE.DICE_EO_PAYOUT+'x</small></button>'+
            '</div>'+
            '<div class="bet-row"><span class="bet-label">Bet</span>'+
              '<input class="bet-input" id="diceBetInput" type="number" min="0.001" step="any" placeholder="Amount" />'+
              '<div class="bet-presets">'+
                '<button class="bet-preset" onclick="setBetPreset(\'dice\',0.1)">10%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'dice\',0.25)">25%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'dice\',0.5)">50%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'dice\',\'max\')">MAX</button>'+
              '</div></div>'+
            '<button class="game-play-btn" id="dicePlayBtn" onclick="playDiceRoll()">ROLL THE DICE</button>'+
            '<div class="game-odds-note">Win chance: ~45% &bull; Payout: '+HOUSE.DICE_HL_PAYOUT+'x &bull; House edge: ~21%</div>'+
          '</div>'+

          // SLOTS
          '<div class="game-card" id="slotsCard">'+
            '<div class="game-card-title">üé∞ LNL Slots</div>'+
            '<div class="game-card-desc">ü¶íü¶íü¶í = '+HOUSE.SLOTS_JACKPOT_PAYOUT+'x JACKPOT. 3-of-a-kind = '+HOUSE.SLOTS_THREE_PAYOUT+'x. Two match = '+HOUSE.SLOTS_TWO_PAYOUT+'x. Every spin builds the NFT pot.</div>'+
            '<div class="slots-machine">'+
              '<div class="slots-reels"><div class="reel" id="reel1">ü¶í</div><div class="reel" id="reel2">üå∂Ô∏è</div><div class="reel" id="reel3">üíé</div></div>'+
              '<div class="slots-result-msg neutral" id="slotsResultMsg">Spin to win!</div>'+
            '</div>'+
            '<div class="bet-row"><span class="bet-label">Bet</span>'+
              '<input class="bet-input" id="slotsBetInput" type="number" min="0.001" step="any" placeholder="Amount" />'+
              '<div class="bet-presets">'+
                '<button class="bet-preset" onclick="setBetPreset(\'slots\',0.1)">10%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'slots\',0.25)">25%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'slots\',0.5)">50%</button>'+
                '<button class="bet-preset" onclick="setBetPreset(\'slots\',\'max\')">MAX</button>'+
              '</div></div>'+
            '<button class="game-play-btn" id="slotsPlayBtn" onclick="playSlots()">PULL THE LEVER</button>'+
            '<div class="game-odds-note">ü¶íü¶íü¶í = '+HOUSE.SLOTS_JACKPOT_PAYOUT+'x &bull; 3-of-a-kind = '+HOUSE.SLOTS_THREE_PAYOUT+'x &bull; 2-of-a-kind = '+HOUSE.SLOTS_TWO_PAYOUT+'x</div>'+
          '</div>'+

        '</div>'+

        '<div class="game-history-card">'+
          '<div class="game-history-title">RECENT BETS</div>'+
          '<div class="history-list" id="gameHistoryList"><div class="history-empty">No games played yet</div></div>'+
        '</div>'+

        '<div style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:0.8rem 1.2rem;font-size:0.64rem;color:#2a2a44;letter-spacing:1px;text-align:center;line-height:1.9;text-transform:uppercase;">'+
          'Treasury: <span style="font-family:monospace;letter-spacing:0.5px;">'+CONFIG.TREASURY_WALLET+'</span><br>'+
          'SOL bets sent on-chain before each game. All house profit contributes to the NFT prize pot. For entertainment only. Play responsibly.'+
        '</div>';

      refreshHistoryUI();
      loadGameBalances();
    }

  </script>
</body>
</html>
