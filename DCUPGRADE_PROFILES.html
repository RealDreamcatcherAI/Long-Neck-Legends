<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/jpGdtHJ.jpeg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LNL Holder Dashboard | Profile</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Orbitron:wght@400;700;900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Keep banner links (like X) white */
a.plink,
a.plink:visited,
a.plink:hover,
a.plink:active {
  color: #e0e0ff;          /* your ‚Äúwhite‚Äù */
  text-decoration: none;
}
a.plink:hover{
  text-decoration: underline; /* optional */
}
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a1a;
      color: #e0e0ff;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    body.loaded { opacity: 1; }

    /* ---- TOP NAV (SITE) ---- */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 1rem 0;
      background: rgba(10,10,26,0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    nav a {
      color: #e0e0ff;
      margin: 0 1.5rem;
      text-decoration: none;
      font-weight: 600;
      position: relative;
      font-size: 0.9rem;
    }
    nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #00d4ff;
      transition: 0.3s;
    }
    nav a:hover::after { width: 100%; }

    /* ---- HERO ---- */
    .hero {
      margin-top: 60px;
      padding: 4rem 2rem 2.2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: 'HOLDER';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(120px, 20vw, 400px);
      color: rgba(0,212,255,0.03);
      pointer-events: none;
      white-space: nowrap;
      letter-spacing: 20px;
    }
    .hero h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.6rem, 4vw, 2.8rem);
      font-weight: 900;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .hero h1 span { color: #00d4ff; text-shadow: 0 0 30px rgba(0,212,255,0.4); }
    .hero-sub {
      color: #888;
      font-size: 0.95rem;
    }

    /* ---- DASH NAV (DASHBOARD-ONLY) ---- */
    .dash-nav-wrap{
      position: sticky;
      top: 60px;
      z-index: 900;
      background: rgba(10,10,26,0.96);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: none;
    }
    .dash-nav-wrap.show { display: block; }

    /* ‚îÄ‚îÄ Desktop nav ‚îÄ‚îÄ */
    .dash-nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.9rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .dash-tabs{
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .dash-right{ flex: 0 0 auto; }

    .dash-tab{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: #bfc2ff;
      padding: 8px 14px;
      font-size: 0.78rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .dash-tab:hover{
      border-color: rgba(0,212,255,0.45);
      color: #e0e0ff;
      box-shadow: 0 0 18px rgba(0,212,255,0.12);
      transform: translateY(-1px);
    }
    .dash-tab.active{
      border-color: rgba(0,212,255,0.65);
      color: #00d4ff;
      box-shadow: 0 0 22px rgba(0,212,255,0.16);
    }

    .dash-right{
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.7rem;
      flex-wrap: wrap;
    }
    .wallet-chip{ max-width: 240px; }
    .wallet-addr{ overflow: hidden; text-overflow: ellipsis; }

    /* ‚îÄ‚îÄ Tablet ‚îÄ‚îÄ */
    @media (max-width: 800px){
      .dash-nav{ padding: 0.7rem 1rem; gap: 0.6rem; }
      .dash-right{ gap: 0.4rem; }
      .wallet-chip{ max-width: 160px; }
      .dash-tab{ padding: 7px 11px; font-size: 0.72rem; letter-spacing: 1px; }
    }

    /* ‚îÄ‚îÄ Mobile ‚Äî single scrollable row, no wrapping ‚îÄ‚îÄ */
    @media (max-width: 600px){
      .dash-nav{
        flex-direction: column;
        align-items: stretch;
        padding: 0;
        gap: 0;
      }
      /* Top row: wallet chip + disconnect */
      .dash-right{
        order: 1;
        width: 100%;
        padding: 6px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.04);
        justify-content: space-between;
        flex-wrap: nowrap;
        gap: 6px;
      }
      .wallet-chip{ max-width: none; flex: 1; min-width: 0; }
      /* Bottom row: tabs scroll horizontally */
      .dash-tabs{
        order: 2;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x proximity;
        padding: 6px 10px 8px;
        gap: 6px;
        /* hide scrollbar on mobile */
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .dash-tabs::-webkit-scrollbar { display: none; }
      .dash-tab{
        scroll-snap-align: start;
        padding: 6px 11px;
        font-size: 0.65rem;
        letter-spacing: 0.8px;
        border-radius: 6px;
        flex-shrink: 0;
      }
    }

    .wallet-chip{
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(17,17,37,0.55);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .wallet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 8px rgba(0,255,136,0.6);
      flex: 0 0 auto;
    }
    .wallet-addr {
      color: #888;
      font-size: 0.78rem;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .wallet-addr strong { color: #e0e0ff; }

    .disconnect-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.10);
      color: #7a7aa6;
      padding: 8px 12px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.8px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 8px;
      font-weight: 700;
    }
    .disconnect-btn:hover { border-color: #ff3c5c; color: #ff3c5c; box-shadow: 0 0 18px rgba(255,60,92,0.14); }

    /* ---- CONNECT SECTION ---- */
    .connect-section {
      text-align: center;
      padding: 4rem 2rem;
    }
    .connect-btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7b68ee 100%);
      color: #000;
      border: none;
      padding: 16px 48px;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      border-radius: 4px;
      transition: all 0.3s;
      box-shadow: 0 4px 30px rgba(0,212,255,0.3);
    }
    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 40px rgba(0,212,255,0.5);
    }
    .connect-prompt {
      color: #555;
      margin-top: 1rem;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    /* ---- DASHBOARD GRID / VIEWS ---- */
    .dashboard {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.8rem 2rem 4rem;
      gap: 1.5rem;
    }
    .dashboard.show { display: block; }

    .view{ display: none; }
    .view.show{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    #view-chat.show {
      display: flex;
      flex-direction: column;
      grid-template-columns: unset;
    }
    #view-games.show {
      display: block;
      grid-template-columns: unset;
    }
    @media (max-width: 800px) {
      .view.show { grid-template-columns: 1fr; }
      .dashboard{ padding: 1.4rem 1rem 3rem; }
    }

    /* ---- TIER CARD ---- */
    .tier-card {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid #1e1e3a;
      border-radius: 16px;
      padding: 2.3rem;
      display: flex;
      align-items: center;
      gap: 2.2rem;
      position: relative;
      overflow: hidden;
      min-height: 180px;
    }
    .tier-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      opacity: 0.08;
      pointer-events: none;
    }
    .tier-card.tier-neck::before { background: radial-gradient(circle, #00d4ff, transparent); }
    .tier-card.tier-longneck::before { background: radial-gradient(circle, #7b68ee, transparent); }
    .tier-card.tier-legend::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-og::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-sardine::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-barracuda::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-shark::before { background: radial-gradient(circle, #00ffcc, transparent); }
    .tier-card.tier-whale::before { background: radial-gradient(circle, #00ffcc, transparent); }

    @media (max-width: 600px) {
      .tier-card { flex-direction: column; text-align: center; padding: 2rem 1.5rem; }
    }

    .tier-badge {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: 1.8rem;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .tier-badge::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 2px solid;
      animation: tierPulse 2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes tierPulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .tier-badge img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.05) contrast(1.05);
    }

    .tier-neck .tier-badge { color: #00d4ff; }
    .tier-neck .tier-badge::after { border-color: #00d4ff; }
    .tier-longneck .tier-badge { color: #7b68ee; }
    .tier-longneck .tier-badge::after { border-color: #7b68ee; }
    .tier-legend .tier-badge { color: #ffd700; }
    .tier-legend .tier-badge::after { border-color: #ffd700; }
    .tier-og .tier-badge { color: #ffd700; }
    .tier-og .tier-badge::after { border-color: #ffd700; }
    .tier-sardine .tier-badge { color: #ff3c5c; }
    .tier-sardine .tier-badge::after { border-color: #ff3c5c; }
    .tier-barracuda .tier-badge { color: #ff3c5c; }
    .tier-barracuda .tier-badge::after { border-color: #ff3c5c; }
    .tier-shark .tier-badge { color: #00ffcc; }
    .tier-shark .tier-badge::after { border-color: #00ffcc; }
    .tier-whale .tier-badge { color: #00ffcc; }
    .tier-whale .tier-badge::after { border-color: #00ffcc; }

    .tier-info { flex: 1; min-width: 240px; }
    .tier-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 0.3rem;
    }
    .tier-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.8rem;
      letter-spacing: 4px;
      line-height: 1;
      margin-bottom: 0.3rem;
    }
    .tier-neck .tier-name { color: #00d4ff; }
    .tier-longneck .tier-name { color: #7b68ee; }
    .tier-legend .tier-name { color: #ffd700; }
    .tier-og .tier-name { color: #ffd700; }
    .tier-sardine .tier-name { color: #ff3c5c; }
    .tier-barracuda .tier-name { color: #ff3c5c; }
    .tier-shark .tier-name { color: #00ffcc; }
    .tier-whale .tier-name { color: #00ffcc; }

    .tier-nfts-held {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .tier-nfts-held strong { color: #e0e0ff; font-weight: 700; }

    .tier-progress-wrap { max-width: 320px; }
    .tier-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
      gap: 12px;
    }
    .tier-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      overflow: hidden;
    }
    .tier-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .tier-neck .tier-progress-fill { background: #00d4ff; box-shadow: 0 0 10px rgba(0,212,255,0.5); }
    .tier-longneck .tier-progress-fill { background: #7b68ee; box-shadow: 0 0 10px rgba(123,104,238,0.5); }
    .tier-legend .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-og .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-sardine .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-barracuda .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-shark .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }
    .tier-whale .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }

/* ---- Username + Social Box (right side of tier card) ---- */
.profile-name-box{
  flex: 0 0 320px;
  max-width: 360px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;     /* right align */
  justify-content: center;
  text-align: right;
  gap: 0.5rem;
}

.profile-username{
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.4rem;
  letter-spacing: 4px;
  line-height: 1;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* username color mimics tier-name color */
.tier-neck .profile-username { color: #00d4ff; }
.tier-longneck .profile-username { color: #7b68ee; }
.tier-legend .profile-username { color: #ffd700; }
.tier-og .profile-username { color: #ffd700; }
.tier-sardine .profile-username { color: #ff3c5c; }
.tier-barracuda .profile-username { color: #ff3c5c; }
.tier-shark .profile-username { color: #00ffcc; }
.tier-whale .profile-username { color: #00ffcc; }

.profile-name-inner{
  width: 100%;
  padding: 0.7rem 0.8rem;
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.06);
}

.profile-links{
  display: flex;
  justify-content: flex-end; /* keep right aligned */
  gap: 8px;
  flex-wrap: wrap;
}

/* responsive: center it on smaller widths */
@media (max-width: 900px){
  .profile-name-box{
    flex: 1 1 auto;
    max-width: 100%;
    align-items: center;
    text-align: center;
  }
  .profile-links{ justify-content: center; }
}

    /* ---- STATS CARD ---- */
    .stats-card {
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .stats-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 1.2rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.7rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: #888; font-size: 0.8rem; }
    .stat-value { font-weight: 700; font-size: 1.1rem; }
    .stat-value.cyan { color: #00d4ff; }
    .stat-value.purple { color: #7b68ee; }
    .stat-value.gold { color: #ffd700; }
    .stat-value.green { color: #00ff88; }

    /* ---- POINTS DISPLAY ---- */
    .points-display { text-align: center; padding: 1.5rem 0; }
    .points-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .points-label {
      font-size: 0.7rem;
      letter-spacing: 3px;
      color: #555;
      text-transform: uppercase;
      margin-top: 0.3rem;
    }

    /* ---- PROFILE ACTIONS ---- */
    .profile-actions{
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 1.6rem 2rem;
    }
    .profile-actions.is-hidden { display: none; }
    .actions-grid{
      display: grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap: 0.8rem;
      margin-top: 0.9rem;
    }
    @media (max-width: 1100px){
      .actions-grid{ grid-template-columns: repeat(3, minmax(140px, 1fr)); }
    }
    @media (max-width: 600px){
      .actions-grid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .points-number { font-size: 2.5rem; }
    }
    .action-btn{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      color: #cfd2ff;
      padding: 12px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 800;
      font-size: 0.74rem;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      font-family: 'Space Grotesk', sans-serif;
      text-align: center;
    }
    .action-btn:hover{
      border-color: rgba(0,212,255,0.45);
      box-shadow: 0 0 22px rgba(0,212,255,0.12);
      transform: translateY(-1px);
      color: #e0e0ff;
    }
    .action-btn.danger:hover{
      border-color: rgba(255,60,92,0.6);
      box-shadow: 0 0 22px rgba(255,60,92,0.10);
      color: #ff7a90;
    }

    /* ---- PERKS CARD ---- */
    .perks-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .perks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .perk {
      background: rgba(0,0,0,0.3);
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      padding: 1.2rem;
      position: relative;
      transition: all 0.3s;
    }
    .perk.unlocked { border-color: rgba(0,212,255,0.3); background: rgba(0,212,255,0.04); }
    .perk.locked { opacity: 0.4; }
    .perk-icon { font-size: 1.8rem; margin-bottom: 0.6rem; }
    .perk-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 0.3rem; letter-spacing: 0.5px; }
    .perk-desc { color: #666; font-size: 0.72rem; line-height: 1.5; }
    .perk-req { font-size: 0.65rem; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.6rem; }
    .perk-req.met { color: #00ff88; }
    .perk-status {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .perk-status.on { background: #00ff88; box-shadow: 0 0 8px rgba(0,255,136,0.6); }
    .perk-status.off { background: #333; }

    /* ---- NFT GALLERY ---- */
    .gallery-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .nft-tile {
      background: #0a0a1a;
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
    }
    .nft-tile:hover {
      transform: translateY(-4px);
      border-color: rgba(0,212,255,0.4);
      box-shadow: 0 8px 30px rgba(0,212,255,0.15);
    }
    .nft-tile img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .nft-tile-info { padding: 0.7rem; }
    .nft-tile-name {
      font-weight: 700;
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nft-tile-id { color: #555; font-size: 0.65rem; margin-top: 2px; }

    /* ---- SHARE CARD ---- */
    .share-section { grid-column: 1 / -1; text-align: center; padding: 1rem 0; }
    .share-btn {
      background: transparent;
      border: 1px solid #1e1e3a;
      color: #888;
      padding: 10px 28px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 4px;
    }
    .share-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
      box-shadow: 0 0 20px rgba(0,212,255,0.15);
    }

    /* ---- NO NFTS STATE ---- */
    .no-nfts {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem 2rem;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
    }
    .no-nfts h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .no-nfts p { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .no-nfts a {
      display: inline-block;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      color: #000;
      text-decoration: none;
      padding: 12px 36px;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .no-nfts a:hover { box-shadow: 0 4px 30px rgba(0,212,255,0.4); transform: translateY(-2px); }

    /* ---- LOADING ---- */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0,212,255,0.15);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      color: #555;
      font-size: 0.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* ---- MODALS ---- */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1.2rem;
    }
    .modal-backdrop.show{ display: flex; }

    .modal{
      width: min(920px, 100%);
      max-height: 85vh; 
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
    }
    .modal-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.18);
    }
    .modal-title{
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      letter-spacing: 2px;
      font-size: 0.95rem;
      color: #e0e0ff;
      text-transform: uppercase;
    }
    .modal-close{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      color: #9a9abd;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      transition: all 0.2s;
    }
    .modal-close:hover{
      border-color: rgba(255,60,92,0.55);
      color: #ff3c5c;
      box-shadow: 0 0 16px rgba(255,60,92,0.12);
    }
    .modal-body{
      padding: 1.2rem;
      max-height: min(70vh, 640px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .pfp-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.9rem;
    }
    .pfp-tile{
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.22);
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .pfp-tile:hover{
      border-color: rgba(0,212,255,0.45);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,212,255,0.10);
    }
    .pfp-tile img{
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .pfp-tile .pfp-name{
      padding: 0.6rem 0.7rem;
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.4px;
      color: #e0e0ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pfp-selected{
      position: absolute;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.55);
      display: none;
    }
    .pfp-tile.selected .pfp-selected{ display: block; }

    .modal-note{
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 0.9rem;
      letter-spacing: 0.4px;
    }

    /* ---- FOOTER ---- */
    footer {
      text-align: center;
      padding: 3rem 2rem;
      border-top: 1px solid #1e1e3a;
      color: #333;
      font-size: 0.7rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* ---- SCROLLBAR ---- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a1a; }
    ::-webkit-scrollbar-thumb { background: #1e1e3a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #00d4ff; }

    @media (max-width: 600px) {
      .perks-grid { grid-template-columns: 1fr 1fr; }
      .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    }
  
    /* ---- TRAITS / SUBDAO ---- */
    .subdao-divider{
      margin-top: 1.2rem;
      padding-top: 1.2rem;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .subdao-grid{
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 900px){
      .subdao-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px){
      .subdao-grid{ grid-template-columns: 1fr; }
    }
    .trait-pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 0.6rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color:#bfc2ff;
      font-size:0.7rem;
      letter-spacing:0.6px;
      text-transform: uppercase;
      cursor: default;
      user-select:none;
    }
    .pill.on{
      border-color: rgba(0,255,136,0.35);
      background: rgba(0,255,136,0.06);
      color: #00ff88;
      box-shadow: 0 0 18px rgba(0,255,136,0.08);
    }
    .pill.off{ opacity: 0.45; }
    .trait-table{
      width:100%;
      border-collapse: collapse;
      margin-top: 0.8rem;
      font-size: 0.8rem;
    }
    .trait-table th, .trait-table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: left;
      vertical-align: top;
    }
    .trait-table th{
      font-family: 'Bebas Neue', sans-serif;
      letter-spacing: 2px;
      color:#777;
      font-size: 0.95rem;
    }
    .trait-muted{ color:#666; font-size:0.78rem; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@1.95.8/lib/index.iife.min.js" async></script>
</head>

<body>
  <nav>
    <a href="https://longnecklegends.xyz/">Home</a>
    <a href="/starternecks.html">Starter Necks</a>
    <a href="/music.html">Music</a>
    <a href="/hotsaucemint.html">Hot Sauce</a>
    <a href="/store.html">Store</a>
  </nav>

  <section class="hero">
    <h1>HOLDER <span>DASHBOARD</span></h1>
    <p class="hero-sub">Customize your profile, connect your wallet, and manage your Cabbage staking</p>
  </section>

  <!-- DASHBOARD-ONLY NAV BAR -->
  <div class="dash-nav-wrap" id="dashNavWrap">
    <div class="dash-nav">
      <div class="dash-tabs">
        <button class="dash-tab" id="tabProfile" onclick="toggleProfilePanel()">Profile</button>
        <button class="dash-tab" id="tabChat" onclick="switchView('chat')">üí¨ Chat</button>
        <button class="dash-tab" id="tabGames" onclick="switchView('games')">üé∞ Casino</button>
        <button class="dash-tab" id="tabMissions" onclick="switchView('missions')">üéØ Missions</button>
        <button class="dash-tab" id="tabStore" onclick="switchView('store')">üõí Store</button>
        <button class="dash-tab" id="tabLeaderboard" onclick="switchView('leaderboard')">üèÜ</button>
      </div>

      <div class="dash-right">
        <div class="wallet-chip" id="walletChip" style="display:none;">
          <div class="wallet-dot"></div>
          <span class="wallet-addr"><strong id="walletDisplay">‚Äî</strong></span>
        </div>
        <button class="disconnect-btn" id="disconnectBtn" style="display:none;" onclick="disconnectWallet()">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- CONNECT PROMPT -->
  <div class="connect-section" id="connectSection">
    <button class="connect-btn" onclick="connectWallet()">CONNECT WALLET</button>
    <p class="connect-prompt">Phantom &bull; Solflare &bull; Magic Eden</p>
  </div>

  <!-- LOADING -->
  <div class="connect-section" id="loadingSection" style="display:none;">
    <div class="loading-spinner"></div>
    <p class="loading-text">Scanning your wallet...</p>
  </div>

  <!-- DASHBOARD WRAP -->
  <div class="dashboard" id="dashboard">
    <div class="view show" id="view-profile"></div>
    <div class="view" id="view-chat"></div>
    <div class="view" id="view-games"></div>
    <div class="view" id="view-missions"></div>
    <div class="view" id="view-leaderboard"></div>
    <div class="view" id="view-store"></div>
  </div>

  <!-- PFP MODAL -->
  <div class="modal-backdrop" id="pfpModalBackdrop" onclick="closePfpModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Select Your LNL PFP</div>
        <button class="modal-close" onclick="hidePfpModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="modal-note">Pick one of your Long Neck Legends. This sets your Profile PFP for this wallet on this device.</div>
        <div class="pfp-grid" id="pfpGrid"></div>
      </div>
    </div>
  </div>

  <!-- SECOND WALLET MODAL -->
  <div class="modal-backdrop" id="secondWalletModalBackdrop" onclick="closeSecondWalletModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Link 2nd Wallet</div>
        <button class="modal-close" onclick="hideSecondWalletModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="modal-note">
          Connect a second wallet to combine your LNL holdings across wallets. (Main wallet stays connected.)
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('phantom')">Phantom</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('solflare')">Solflare</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('magiceden')">Magic Eden</button>
        </div>

        <div id="secondWalletStatus" style="color:#666; font-size:0.82rem; line-height:1.5;">
          No second wallet linked yet.
        </div>

        <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
          <button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="unlinkSecondWallet()">Unlink</button>
          <button class="disconnect-btn" onclick="hideSecondWalletModal()">Close</button>
        </div>
      </div>
    </div>
  </div>


  <!-- TRAITS MODAL -->
  <div class="modal-backdrop" id="traitsModalBackdrop" onclick="closeTraitsModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Trait Data</div>
        <button class="modal-close" onclick="hideTraitsModal()">‚úï</button>
      </div>
      <div class="modal-body" id="traitsModalBody">
        <div class="modal-note">This is pulled live from your NFTs metadata. SubDAO unlocks are based on holding at least 1 matching trait.</div>
        <div id="subdaoPills" class="trait-pills"></div>
        <table class="trait-table" id="traitsTable">
          <thead>
            <tr><th>Trait</th><th>Count</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="trait-muted">Tip: If something looks missing, it usually means the NFT metadata doesn‚Äôt include that attribute field.</div>
      </div>
    </div>
  </div>


  <footer>
    <p>&copy; 2026 Long Neck Legends &bull; Diamond Hands Only</p>
  </footer>

  <script>
    window.addEventListener('load', function() { document.body.classList.add('loaded'); });

    var CONFIG = {
      COLLECTION_MINT: "8Rt3Ayqth4DAiPnW9MDFi63TiQJHmohfTWLMQFHi4KZH",
      RPC_URL: "https://mainnet.helius-rpc.com/?api-key=44cfd082-9089-430d-8de3-cd310c478b1c",
      MAGIC_EDEN_LINK: "https://magiceden.us/marketplace/long_neck_legends"
    };

    var TIERS = [
      { id: "civilian", name: "CIVILIAN", min: 0, icon: "\u{1F464}", pointsMultiplier: 0, discount: 0, raffleMultiplier: 0, cssClass: "" },
      { id: "neck", name: "NECK", min: 1, icon: "\u{1F995}", pointsMultiplier: 1, discount: 10, raffleMultiplier: 1, cssClass: "tier-neck" },
      { id: "longneck", name: "LONG NECK", min: 5, icon: "\u{1F525}", pointsMultiplier: 1.5, discount: 15, raffleMultiplier: 2, cssClass: "tier-longneck" },
      { id: "legend", name: "LEGEND", min: 10, icon: "\u{2B50}", pointsMultiplier: 2.5, discount: 20, raffleMultiplier: 3, cssClass: "tier-legend" },
      { id: "og", name: "OG LEGEND", min: 20, icon: "\u{1F451}", pointsMultiplier: 4, discount: 25, raffleMultiplier: 5, cssClass: "tier-og" },
      { id: "sardine", name: "SARDINE", min: 30, icon: "\u{1F41F}", pointsMultiplier: 6, discount: 30, raffleMultiplier: 6, cssClass: "tier-sardine" },
      { id: "barracuda", name: "BARRACUDA", min: 50, icon: "\u{1F52A}", pointsMultiplier: 7, discount: 35, raffleMultiplier: 7, cssClass: "tier-barracuda" },
      { id: "shark", name: "SHARK", min: 75, icon: "\u{1F988}", pointsMultiplier: 8, discount: 35, raffleMultiplier: 8, cssClass: "tier-shark" },
      { id: "whale", name: "WHALE", min: 100, icon: "\u{1F40B}", pointsMultiplier: 10, discount: 40, raffleMultiplier: 10, cssClass: "tier-whale" }
    ];

    var PERKS = [
      { icon: "\u{1F995}", name: "Store Discount", desc: "Get a discount on all LNL Store purchases paid in SOL.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "Raffle Entries", desc: "Earn entries into exclusive drops, giveaways, and raffles.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "IRL Access", desc: "Entry to LNL events, listening parties, and tastings.", reqTier: "neck" },
      { icon: "\u{1F525}", name: "Exclusive Merch", desc: "Unlock holder-only merch that never hits the public store.", reqTier: "longneck" },
      { icon: "\u{2B50}", name: "Exclusive Merch", desc: "Vote on the next apparel drop. Your neck, your choice.", reqTier: "legend" },
      { icon: "\u{2B50}", name: "Flavor Voting", desc: "Vote on the next hot sauce flavor. Your taste, your choice.", reqTier: "legend" },
      { icon: "\u{1F451}", name: "Early Access", desc: "Get first dibs on new sauce flavors, merch drops, and collections.", reqTier: "og" },
      { icon: "\u{1F451}", name: "VIP IRL Access", desc: "VIP entry to LNL events, listening parties, and tastings.", reqTier: "og" },
      { icon: "\u{1F41F}", name: "Diamond Hands Club", desc: "Private group with alpha, airdrops, and direct team access.", reqTier: "sardine" },
      { icon: "\u{1F52A}", name: "Monthly Airdrop", desc: "Free products, NFTs, and surprises delivered monthly.", reqTier: "barracuda" },
      { icon: "\u{1F988}", name: "Shark Council", desc: "Direct input on project direction, partnerships, and roadmap decisions.", reqTier: "shark" },
      { icon: "\u{1F40B}", name: "Lifetime Perks", desc: "Permanent max discount, first priority on all future drops, and custom merch.", reqTier: "whale" }
    ];


    // ---- SUBDAO (Trait-based) ----
    var SUBDAOS = [
      { id:"talltoker",  name:"Tall Toker",     icon:"üö¨", reqValues:["Gold Pipe Beak","Blunt Beak"], desc:"Hold at least 1 LNL with Gold Pipe Beak or Blunt Beak." },
      { id:"jeeterbeater", name:"Jeeter Beater", icon:"ü•ä", reqValues:["Boxing Gloves"], desc:"Hold at least 1 LNL with Boxing Gloves." },
      { id:"hoodiegang", name:"Hoodie Gang",    icon:"üß•", reqValues:["Hoodie"], desc:"Hold at least 1 LNL with Hoodie." },
      { id:"headphones", name:"HeadPhones",     icon:"üéß", reqValues:["Headphones"], desc:"Hold at least 1 LNL with Headphones." },
      { id:"royalty",    name:"Royalty",        icon:"üëë", reqValues:["Golden Crown","Hippie Crown","Gold Grill Beak"], desc:"Hold at least 1 LNL with Golden Crown, Hippie Crown, or Gold Grill Beak." },
      { id:"wizzy",      name:"Wizzy",          icon:"üßô", reqValues:["Wizard Hat"], desc:"Hold at least 1 LNL with Wizard Hat." },
      { id:"bob",        name:"BoB",            icon:"üß¢", reqValues:["Beanie"], desc:"Hold at least 1 LNL with Beanie." },
      { id:"frobros",    name:"Fro Bros",       icon:"ü¶±", reqValues:["Afro"], desc:"Hold at least 1 LNL with Afro." },
      { id:"goldenticket", name:"Golden Ticket", icon:"üéüÔ∏è", reqValues:["Golden Ticket"], desc:"Hold at least 1 LNL with Golden Ticket." }
    ];

    function normStr(s){
      return String(s || "").trim().toLowerCase();
    }

    function buildTraitValueSet(nfts){
      var set = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          set[normStr(v)] = true;
        });
      });
      return set;
    }

    function getSubdaoMatches(nfts){
      var values = buildTraitValueSet(nfts);
      return SUBDAOS.map(function(d){
        var hit = "";
        for (var i=0;i<d.reqValues.length;i++){
          if (values[normStr(d.reqValues[i])]) { hit = d.reqValues[i]; break; }
        }
        return { id:d.id, name:d.name, icon:d.icon, unlocked: !!hit, hit: hit, reqValues: d.reqValues, desc: d.desc };
      });
    }

    function buildTraitCounts(nfts){
      var counts = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          var key = v.trim();
          counts[key] = (counts[key] || 0) + 1;
        });
      });
      return counts;
    }


    var walletProvider = null;
    var walletPublicKey = null;

    var session = {
      loadedNFTs: [],
      profileId: null,
      profile: {
        username: "",
        pfpMint: "",
        pfpImage: "",
        x: "",
        discord: "",
        ledger: ""
      },
      secondWallet: { address: "" },
      currentView: "profile",
      profilePanelOpen: false
    };

    function getTier(count) {
      for (var i = TIERS.length - 1; i >= 0; i--) {
        if (count >= TIERS[i].min) return TIERS[i];
      }
      return TIERS[0];
    }
    function getNextTier(tier) {
      var idx = TIERS.findIndex(function(t) { return t.id === tier.id; });
      return idx < TIERS.length - 1 ? TIERS[idx + 1] : null;
    }
    function getProviderByName(name){
      if (name === "phantom") {
        if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
        if (window.solana && window.solana.isPhantom) return window.solana;
      }
      if (name === "solflare") {
        if (window.solflare && window.solflare.isSolflare) return window.solflare;
        if (window.solflare && window.solflare.solana) return window.solflare.solana;
      }
      if (name === "magiceden") {
        if (window.magicEden && window.magicEden.solana) return window.magicEden.solana;
        if (window.solana && window.solana.isMagicEden) return window.solana;
        if (window.solana && window.solana.isMagicEdenWallet) return window.solana;
      }
      return null;
    }

    function detectWalletProvider() {
      if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
      if (window.backpack && window.backpack.solana) return window.backpack.solana;
      if (window.solflare && window.solflare.isSolflare) return window.solflare;
      if (window.solflare && window.solflare.solana) return window.solflare.solana;
      if (window.solana && window.solana.isPhantom) return window.solana;
      if (window.solana) return window.solana;
      return null;
    }

    function storageKey() {
      var addr = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_profile_" + addr;
    }

    function loadProfileFromStorage() {
      try {
        var raw = localStorage.getItem(storageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && typeof data === "object") {
          session.profile.username = data.username || "";
          session.profile.pfpMint = data.pfpMint || "";
          session.profile.pfpImage = data.pfpImage || "";
          session.profile.x = data.x || "";
          session.profile.discord = data.discord || "";
          session.profile.ledger = data.ledger || "";
        }
      } catch (e) {}
    }

    function saveProfileToStorage() {
      try { localStorage.setItem(storageKey(), JSON.stringify(session.profile)); } catch (e) {}
      // Also persist to Supabase (debounced) if we have a resolved profileId
      try { queueSaveProfileToSupabase(); } catch (e) {}
    }

    function secondWalletStorageKey(){
      var primary = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_second_wallet_for_" + primary;
    }

    function loadSecondWalletFromStorage(){
      try{
        var raw = localStorage.getItem(secondWalletStorageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && data.address) session.secondWallet.address = data.address;
      }catch(e){}
    }

    function saveSecondWalletToStorage(){
      try{
        localStorage.setItem(secondWalletStorageKey(), JSON.stringify({ address: session.secondWallet.address || "" }));
      }catch(e){}
    }

    function shortAddr(addr){
      if (!addr) return "‚Äî";
      return addr.slice(0,4) + "..." + addr.slice(-4);
    }

    function sanitizeName(input){
      var s = (input || "").trim();
      s = s.replace(/\s+/g, " ");
      if (s.length > 24) s = s.slice(0, 24);
      return s;
    }

    function normalizeHandle(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/^@+/, "");
      if (s.length > 30) s = s.slice(0, 30);
      return s;
    }

    function normalizeDiscord(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/\s+/g, "");
      if (s.length > 32) s = s.slice(0, 32);
      return s;
    }

    function buildXUrl(handle){
      var h = normalizeHandle(handle);
      if (!h) return "";
      return "https://x.com/" + encodeURIComponent(h);
    }

    async function fetchAssetsByOwner(ownerAddress){
      var res = await fetch(CONFIG.RPC_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          jsonrpc: "2.0",
          id: "lnl",
          method: "getAssetsByOwner",
          params: {
            ownerAddress: ownerAddress,
            page: 1,
            limit: 1000,
            displayOptions: { showCollectionMetadata: true }
          }
        })
      });

      var json = await res.json();
      var items = (json && json.result && json.result.items) ? json.result.items : [];

      var lnlAssets = items.filter(function(a) {
        var groups = a.grouping || [];
        var g = groups.find(function(x) { return x.group_key === "collection"; });
        return g && g.group_value === CONFIG.COLLECTION_MINT;
      });

      var picked = (lnlAssets.length > 0) ? lnlAssets : items.filter(function(a) {
        var sym = (a.content && a.content.metadata && a.content.metadata.symbol) ||
                  (a.content && a.content.json && a.content.json.symbol) || "";
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "";
        var lname = String(name || "").toLowerCase();
        return (sym === "LNL") || (lname.indexOf("long neck") !== -1);
      });

      
      return picked.map(function(a) {
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "LNL";
        var image = (a.content && a.content.links && a.content.links.image) ||
                    (a.content && a.content.files && a.content.files[0] && a.content.files[0].uri) ||
                    (a.content && a.content.json && a.content.json.image) || "";
        var mint = a.id || "";

        // traits/attributes can appear in a few places depending on indexer
        var attrs =
          (a.content && a.content.metadata && a.content.metadata.attributes) ||
          (a.content && a.content.json && a.content.json.attributes) ||
          (a.content && a.content.metadata && a.content.metadata.traits) ||
          [];

        // normalize to [{trait_type, value}]
        var norm = [];
        if (Array.isArray(attrs)) {
          norm = attrs.map(function(x){
            if (!x) return null;
            if (typeof x === "string") return { trait_type: "Trait", value: x };
            var tt = x.trait_type || x.traitType || x.type || x.name || "Trait";
            var vv = x.value != null ? x.value : (x.val != null ? x.val : "");
            return { trait_type: String(tt || "Trait"), value: String(vv || "") };
          }).filter(Boolean);
        } else if (attrs && typeof attrs === "object") {
          // some formats are {trait_type: value, ...}
          Object.keys(attrs).forEach(function(k){
            norm.push({ trait_type: String(k), value: String(attrs[k]) });
          });
        }

        return { name: name, image: image, mint: mint, owner: ownerAddress, attributes: norm };
      });

    }

    function applyProfilePanelUI(){
      var btn = document.getElementById("tabProfile");
      var panel = document.getElementById("profilePanel");

      if (btn) btn.classList.toggle("active", !!session.profilePanelOpen);
      if (panel) panel.classList.toggle("is-hidden", !session.profilePanelOpen);
    }

    function toggleProfilePanel(){
      session.profilePanelOpen = !session.profilePanelOpen;
      applyProfilePanelUI();
    }

    async function connectWallet() {
      var provider = detectWalletProvider();
      if (!provider || typeof provider.connect !== "function") {
        alert("No Solana wallet found.\n\nInstall Phantom, Solflare, or Backpack and refresh the page.");
        return;
      }
      try {
        var resp = await provider.connect({ onlyIfTrusted: false });
        walletProvider = provider;
        walletPublicKey = resp.publicKey || provider.publicKey;
        if (!walletPublicKey) throw new Error("Wallet connected but no public key returned. Try unlocking your wallet first.");

        var addr = walletPublicKey.toBase58();
        document.getElementById("walletDisplay").textContent = shortAddr(addr);

        document.getElementById("dashNavWrap").classList.add("show");
        document.getElementById("walletChip").style.display = "flex";
        document.getElementById("disconnectBtn").style.display = "inline-block";

        document.getElementById("connectSection").style.display = "none";
        document.getElementById("loadingSection").style.display = "block";

        loadProfileFromStorage();
        loadSecondWalletFromStorage();

        await hydrateProfileAndWalletsFromSupabase(addr);

        session.profilePanelOpen = false;
        applyProfilePanelUI();

        await loadDashboard();
      } catch (err) {
        console.error("Connect error:", err);
        if (err.code === 4001 || (err.message && err.message.toLowerCase().includes("user rejected"))) {
          // User cancelled ‚Äî no alert needed
        } else {
          alert("Connection failed: " + (err.message || err));
        }
      }
    }

    function disconnectWallet() {
      stopChatPoll();
      try { if (walletProvider && walletProvider.disconnect) walletProvider.disconnect(); } catch (e) {}
      walletProvider = null;
      walletPublicKey = null;

      document.getElementById("dashNavWrap").classList.remove("show");
      document.getElementById("walletChip").style.display = "none";
      document.getElementById("disconnectBtn").style.display = "none";

      document.getElementById("connectSection").style.display = "block";
      document.getElementById("loadingSection").style.display = "none";
      document.getElementById("dashboard").classList.remove("show");
      document.getElementById("view-profile").classList.remove("show");
      document.getElementById("view-chat").classList.remove("show");
      document.getElementById("view-games").classList.remove("show");
      var vm = document.getElementById("view-missions"); if (vm) vm.classList.remove("show");
      var vl = document.getElementById("view-leaderboard"); if (vl) vl.classList.remove("show");
      var vs = document.getElementById("view-store"); if (vs) vs.classList.remove("show");

      session.profilePanelOpen = false;
      var tabProfile = document.getElementById("tabProfile");
      if (tabProfile) tabProfile.classList.remove("active");
      var tabChat = document.getElementById("tabChat");
      if (tabChat) tabChat.classList.remove("active");
      var tabGames = document.getElementById("tabGames");
      if (tabGames) tabGames.classList.remove("active");
      var tabMissions = document.getElementById("tabMissions");
      var tabLeaderboard = document.getElementById("tabLeaderboard");
      var tabStore = document.getElementById("tabStore");
      if (tabMissions) tabMissions.classList.remove("active");
      var tabLeaderboard = document.getElementById("tabLeaderboard");
      if (tabLeaderboard) tabLeaderboard.classList.remove("active");
      var tabStore = document.getElementById("tabStore");
      if (tabStore) tabStore.classList.remove("active");

      session.currentView = "profile";
    }

    function switchView(viewName){
      session.currentView = viewName;

      // Hide all views
      var vp = document.getElementById("view-profile");
      var vc = document.getElementById("view-chat");
      var vg = document.getElementById("view-games");
      var vq = document.getElementById("view-missions");
      var vl = document.getElementById("view-leaderboard");
      var vs = document.getElementById("view-store");
      if (vp) vp.classList.remove("show");
      if (vc) vc.classList.remove("show");
      if (vg) vg.classList.remove("show");
      if (vq) vq.classList.remove("show");
      if (vl) vl.classList.remove("show");
      if (vs) vs.classList.remove("show");

      // Deactivate all tabs
      var tabProfile = document.getElementById("tabProfile");
      var tabChat    = document.getElementById("tabChat");
      var tabGames   = document.getElementById("tabGames");
      var tabMissions = document.getElementById("tabMissions");
      if (tabProfile) tabProfile.classList.remove("active");
      if (tabChat)    tabChat.classList.remove("active");
      if (tabGames)   tabGames.classList.remove("active");
      if (tabMissions) tabMissions.classList.remove("active");
      if (tabLeaderboard) tabLeaderboard.classList.remove("active");
      if (tabStore) tabStore.classList.remove("active");

      if (viewName === "profile") {
        stopChatPoll();
        if (vp) vp.classList.add("show");
        if (tabProfile) tabProfile.classList.toggle("active", !!session.profilePanelOpen);
      }

      if (viewName === "chat") {
        if (vc) vc.classList.add("show");
        if (tabChat) tabChat.classList.add("active");
        renderChatUI();
      }

      if (viewName === "games") {
        stopChatPoll();
        if (vg) vg.classList.add("show");
        if (tabGames) tabGames.classList.add("active");
        renderGamesUI();
      }

      if (viewName === "missions") {
        stopChatPoll();
        if (vq) vq.classList.add("show");
        if (tabMissions) tabMissions.classList.add("active");
        renderMissionsUI();
      }

      if (viewName === "leaderboard") {
        stopChatPoll();
        if (vl) vl.classList.add("show");
        if (tabLeaderboard) tabLeaderboard.classList.add("active");
        renderLeaderboardUI();
      }

      if (viewName === "store") {
        stopChatPoll();
        if (vs) vs.classList.add("show");
        if (tabStore) tabStore.classList.add("active");
        renderStoreUI();
      }
    }

    async function loadDashboard() {
      try {
        var primary = walletPublicKey.toBase58();
        var owners = [primary];

        if (session.secondWallet.address) owners.push(session.secondWallet.address);

        var all = [];
        for (var i=0; i<owners.length; i++){
          var arr = await fetchAssetsByOwner(owners[i]);
          all = all.concat(arr);
        }

        var seen = {};
        var merged = [];
        for (var j=0; j<all.length; j++){
          var m = all[j].mint;
          if (!m) continue;
          if (seen[m]) continue;
          seen[m] = true;
          merged.push(all[j]);
        }

        session.loadedNFTs = merged;

        if (!session.profile.pfpMint && merged.length > 0) {
          session.profile.pfpMint = merged[0].mint;
          session.profile.pfpImage = merged[0].image || "";
          saveProfileToStorage();
        } else if (session.profile.pfpMint) {
          var found = merged.find(function(n){ return n.mint === session.profile.pfpMint; });
          if (found && found.image) {
            session.profile.pfpImage = found.image;
            saveProfileToStorage();
          }
        }

        document.getElementById("loadingSection").style.display = "none";
        shop_loadMyItems();
        await renderProfileView(merged);

        document.getElementById("dashboard").classList.add("show");
        switchView("profile");

      } catch (err) {
        console.error("Dashboard error:", err);
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("connectSection").style.display = "block";
        alert("Error loading NFTs: " + (err.message || err));
      }
    }

    async function renderProfileView(nfts) {
      var view = document.getElementById("view-profile");
      view.innerHTML = "";

      var count = nfts.length;

      if (count === 0) {
        view.innerHTML = `
          <div class="no-nfts">
            <h2>NO LONG NECK LEGENDS FOUND</h2>
            <p>You don't hold any LNL NFTs in this wallet. Cop one to unlock holder perks.</p>
            <a href="${CONFIG.MAGIC_EDEN_LINK}" target="_blank">BUY ON MAGIC EDEN</a>
          </div>
        `;
        applyProfilePanelUI();
        return;
      }

      // Fetch progression stats
      await pp_fetchStats();

      var tier = getTier(count);
      var nextTier = getNextTier(tier);
      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
      var disc = session.profile.discord ? session.profile.discord : "";

      var progressHTML = "";
      if (nextTier) {
        var progress = ((count - tier.min) / (nextTier.min - tier.min)) * 100;
        progressHTML =
          '<div class="tier-progress-wrap">' +
            '<div class="tier-progress-label"><span>' + tier.name + '</span><span>' + nextTier.name + ' (' + nextTier.min + ' NFTs)</span></div>' +
            '<div class="tier-progress-bar"><div class="tier-progress-fill" style="width:' + Math.min(progress,100) + '%"></div></div>' +
          '</div>';
      } else {
        progressHTML = '<div style="color:#555;font-size:0.75rem;letter-spacing:2px;text-transform:uppercase;">MAX TIER REACHED \u{1F451}</div>';
      }

      var badgeInner = "";
      if (session.profile.pfpImage) {
        badgeInner = '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">';
      } else {
        badgeInner = tier.icon;
      }

      // Store frames
      var frameStyle = '';
      if (shop_owns('frame_diamond')) {
        frameStyle = 'box-shadow:0 0 20px rgba(0,212,255,0.4),0 0 40px rgba(123,104,238,0.2);border:3px solid #00d4ff;animation:g_pulse 2s infinite;';
      } else if (shop_owns('frame_gold')) {
        frameStyle = 'box-shadow:0 0 15px rgba(255,215,0,0.3);border:3px solid #ffd700;';
      }

      var linksHTML = '';
      if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
      if (disc) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + disc + '</span>';
      if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';

      view.innerHTML +=
      '<div class="tier-card ' + tier.cssClass + '">' +
        '<div class="tier-badge" id="pfpBadge" style="' + frameStyle + '">' + badgeInner + '</div>' +
        '<div class="tier-info">' +
          '<div class="tier-label">YOUR TIER</div>' +
          '<div class="tier-name">' + tier.name + '</div>' +
          '<div class="tier-nfts-held">Holding <strong>' + count + '</strong> Long Neck Legend' + (count !== 1 ? "s" : "") + '</div>' +
          progressHTML +
        '</div>' +
        '<div class="profile-name-box">' +
          '<div class="profile-username" id="bannerUsername">' + escapeHtml(displayName) + '</div>' +
          '<div class="profile-name-inner">' +
            '<div class="profile-links" id="bannerLinks">' + linksHTML + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

      // Player Progression Card
      view.innerHTML += pp_renderPlayerCard(count, 0);

      // Achievement badges
      var xp = pp_computeXP(pp_stats);
      var level = pp_levelFromXP(xp);
      ach_myBadges = ach_check(pp_stats, count, level, pp_stats._gameWins);
      ach_save(ach_myBadges); // persist to DB (fire-and-forget)
      view.innerHTML += ach_renderSection(ach_myBadges);
      setTimeout(function() { ach_paintGrid(ach_myBadges); }, 20);

      view.innerHTML +=
        '<div class="profile-actions" id="profilePanel">' +
          '<div class="stats-title">PROFILE</div>' +
          '<div class="actions-grid">' +
            '<button class="action-btn" onclick="openPfpModal()">Edit PFP</button>' +
            '<button class="action-btn" onclick="editUsername()">Edit Username</button>' +
            '<button class="action-btn" onclick="connectX()">Connect X</button>' +
            '<button class="action-btn" onclick="connectDiscord()">Connect Discord</button>' +
            '<button class="action-btn" onclick="openSecondWalletModal()">Link 2nd Wallet</button>' +
          '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">CABBAGE STAKING</div>' +
          '<div class="points-display">' +
            '<div class="points-number" id="cabbageBalance">‚Äî</div>' +
            '<div class="points-label">Cabbage Balance</div>' +
          '</div>' +
          '<div style="background:rgba(0,255,136,0.04);border:1px solid rgba(0,255,136,0.12);border-radius:10px;padding:14px 16px;margin:10px 0 14px;">' +
            '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">' +
              '<span style="color:#888;font-size:0.78rem;">NFTs Earning</span>' +
              '<span style="font-weight:700;font-size:1.05rem;color:#00ff88;" id="cabbageNftCount">‚Äî</span>' +
            '</div>' +
            '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">' +
              '<span style="color:#888;font-size:0.78rem;">Rate Per NFT</span>' +
              '<span style="font-weight:700;font-size:1.05rem;color:#e0e0ff;">1 \uD83E\uDD6C / week</span>' +
            '</div>' +
            '<div style="display:flex;align-items:center;justify-content:space-between;border-top:1px solid rgba(0,255,136,0.1);padding-top:8px;">' +
              '<span style="color:#888;font-size:0.78rem;font-weight:600;">Total Weekly Earn</span>' +
              '<span style="font-weight:900;font-size:1.15rem;color:#00ff88;" id="cabbageRate">‚Äî</span>' +
            '</div>' +
          '</div>' +
          '<div class="stat-row"><span class="stat-label">Pending</span><span class="stat-value cyan" id="cabbagePending">‚Äî</span></div>' +
          '<div class="stat-row"><span class="stat-label">Started</span><span class="stat-value" id="cabbageStarted">‚Äî</span></div>' +
          '<div class="stat-row"><span class="stat-label">Last Claim</span><span class="stat-value" id="cabbageLast">‚Äî</span></div>' +
          '<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;flex-wrap:wrap;">' +
            '<button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="refreshCabbageUI()">Refresh</button>' +
            '<button class="disconnect-btn" id="cabbageStartBtn" style="border-color:rgba(0,255,136,0.35);color:#00ff88;" onclick="startCabbage()">Start</button>' +
            '<button class="disconnect-btn" id="cabbageClaimBtn" style="border-color:rgba(0,212,255,0.35);color:#00d4ff;" onclick="claimCabbage()">Claim</button>' +
          '</div>' +
          '<div style="margin-top:10px;color:#555;font-size:0.72rem;letter-spacing:1px;line-height:1.45;">' +
            'Soft staking: click <strong>Start</strong> once to begin earning. Each NFT in your wallet earns <strong>1 \uD83E\uDD6C cabbage per week</strong>. Claim anytime.' +
          '</div>' +
        '</div>';

      // Populate cabbage values after DOM updates
      setTimeout(function(){ try { refreshCabbageUI(); } catch(e){} }, 50);

var nextTierRow = nextTier
        ? '<div class="stat-row"><span class="stat-label">Next Tier At</span><span class="stat-value gold">' + nextTier.min + ' NFTs</span></div>'
        : '<div class="stat-row"><span class="stat-label">Status</span><span class="stat-value gold">MAXED \u{1F451}</span></div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">HOLDER STATS</div>' +
          '<div class="stat-row"><span class="stat-label">NFTs Held</span><span class="stat-value cyan">' + count + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Current Tier</span><span class="stat-value">' + tier.name + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Store Discount</span><span class="stat-value green">' + tier.discount + '%</span></div>' +
          '<div class="stat-row"><span class="stat-label">Raffle Multiplier</span><span class="stat-value purple">' + tier.raffleMultiplier + 'x</span></div>' +
          nextTierRow +
        '</div>';

      // ---- SUBDAO STATUS (Trait-based) ----
      var subdao = getSubdaoMatches(nfts);
      var subdaoRows = subdao.map(function(s){
        var req = s.reqValues.join(' / ');
        return '<div class="stat-row">'
             + '<span class="stat-label">' + s.icon + ' ' + s.name + '</span>'
             + '<span class="stat-value ' + (s.unlocked ? 'green' : '') + '">' + (s.unlocked ? 'UNLOCKED' : 'LOCKED') + '</span>'
             + '</div>'
             + (s.unlocked ? '' : '<div style="color:#555;font-size:0.7rem;letter-spacing:1px;margin-top:-6px;margin-bottom:10px;">Requires: ' + escapeHtml(req) + '</div>');
      }).join('');

      var tierOrder = TIERS.map(function(t) { return t.id; });
      var currentTierIdx = tierOrder.indexOf(tier.id);

      var perksHTML = PERKS.map(function(perk) {
        var reqIdx = tierOrder.indexOf(perk.reqTier);
        var unlocked = currentTierIdx >= reqIdx;
        var reqTierObj = TIERS.find(function(t) { return t.id === perk.reqTier; });
        var desc = perk.desc;

        if (perk.dynamic && perk.name === "Store Discount" && unlocked) desc = tier.discount + "% off all LNL Store purchases paid in SOL";
        if (perk.dynamic && perk.name === "Raffle Entries" && unlocked) desc = tier.raffleMultiplier + "x entries into every raffle and giveaway";

        return '' +
          '<div class="perk ' + (unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + perk.icon + '</div>' +
            '<div class="perk-name">' + perk.name + '</div>' +
            '<div class="perk-desc">' + desc + '</div>' +
            '<div class="perk-req ' + (unlocked ? "met" : "") + '">' + (unlocked ? "\u2713 UNLOCKED" : "REQUIRES " + reqTierObj.name) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">HOLDER PERKS</div>' +
          '<div class="perks-grid">' + perksHTML + '</div>' +
        '</div>';


      var subdaoPerksHTML = getSubdaoMatches(nfts).map(function(s){
        var req = s.reqValues.join(" / ");
        var reqLine = s.unlocked ? ("Unlocked via: " + s.hit) : ("Requires: " + req);
        return '' +
          '<div class="perk ' + (s.unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (s.unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + s.icon + '</div>' +
            '<div class="perk-name">' + escapeHtml(s.name) + '</div>' +
            '<div class="perk-desc">' + escapeHtml(s.desc) + '</div>' +
            '<div class="perk-req ' + (s.unlocked ? "met" : "") + '">' + (s.unlocked ? "\u2713 UNLOCKED" : escapeHtml(reqLine)) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">SUBDAOs</div>' +
          '<div class="perks-grid subdao-grid">' + subdaoPerksHTML + '</div>' +
        '</div>';

      var galleryHTML = nfts.map(function(nft) {
        var img = nft.image
          ? '<img src="' + nft.image + '" alt="' + escapeHtml(nft.name) + '" loading="lazy">'
          : '<div style="aspect-ratio:1;background:#1e1e3a;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.8rem;">No Image</div>';
        var mintShort = nft.mint ? nft.mint.slice(0,4) + "..." + nft.mint.slice(-4) : "";
        return '' +
          '<div class="nft-tile" onclick="window.open(\'https://magiceden.us/item-details/' + nft.mint + '\', \'_blank\')">' +
            img +
            '<div class="nft-tile-info">' +
              '<div class="nft-tile-name">' + escapeHtml(nft.name) + '</div>' +
              '<div class="nft-tile-id">' + mintShort + '</div>' +
            '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="gallery-card">' +
          '<div class="stats-title">YOUR COLLECTION</div>' +
          '<div class="gallery-grid">' + galleryHTML + '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="share-section">' +
          '<button class="share-btn" onclick="window.open(\'' + CONFIG.MAGIC_EDEN_LINK + '\', \'_blank\')">MAGIC EDEN</button>' +
        '</div>';

      // ‚úÖ always re-apply toggle state after rendering the panel
      applyProfilePanelUI();
    }

    function editUsername(){
      var current = session.profile.username || "";
      var input = prompt("Set your Profile Username (max 24 chars):", current);
      if (input === null) return;
      session.profile.username = sanitizeName(input);
      saveProfileToStorage();
      refreshBanner();
    }

    function linkLedger(){
      var current = session.profile.ledger || "";
      var input = prompt("Paste your Ledger public key / label (optional):", current);
      if (input === null) return;
      session.profile.ledger = (input || "").trim().slice(0, 42);
      saveProfileToStorage();
      refreshBanner();
    }

    function refreshBanner(){
      var bn = document.getElementById("bannerUsername");
    if (bn) {
      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      bn.textContent = displayName;
    }

      var bl = document.getElementById("bannerLinks");
      if (bl) {
        var linksHTML = "";
        var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
        if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
        if (session.profile.discord) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + session.profile.discord + '</span>';
        if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';
        bl.innerHTML = linksHTML;
      }
    }

    function openPfpModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return;

      var grid = document.getElementById("pfpGrid");
      grid.innerHTML = "";

      session.loadedNFTs.forEach(function(nft){
        var selected = (session.profile.pfpMint && nft.mint === session.profile.pfpMint);

        var tile = document.createElement("div");
        tile.className = "pfp-tile" + (selected ? " selected" : "");
        tile.addEventListener("click", function(){ selectPfp(nft.mint); });

        var dot = document.createElement("div");
        dot.className = "pfp-selected";
        tile.appendChild(dot);

        if (nft.image) {
          var img = document.createElement("img");
          img.src = nft.image;
          img.alt = nft.name || "LNL";
          img.loading = "lazy";
          tile.appendChild(img);
        } else {
          var ph = document.createElement("div");
          ph.style.aspectRatio = "1";
          ph.style.background = "#1e1e3a";
          tile.appendChild(ph);
        }

        var name = document.createElement("div");
        name.className = "pfp-name";
        name.textContent = nft.name || "LNL";
        tile.appendChild(name);

        grid.appendChild(tile);
      });

      document.getElementById("pfpModalBackdrop").classList.add("show");
    }

    function hidePfpModal(){
      document.getElementById("pfpModalBackdrop").classList.remove("show");
    }

    function closePfpModal(e){
      if (e && e.target && e.target.id === "pfpModalBackdrop") hidePfpModal();
    }

    function selectPfp(mint){
      var found = session.loadedNFTs.find(function(n){ return n.mint === mint; });
      if (!found) return;

      session.profile.pfpMint = mint;
      session.profile.pfpImage = found.image || "";
      saveProfileToStorage();

      var badge = document.getElementById("pfpBadge");
      if (badge) {
        badge.innerHTML = session.profile.pfpImage
          ? '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">'
          : badge.innerHTML;
      }

      hidePfpModal();
    }

    function escapeHtml(str){
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function openSecondWalletModal(){
      if (!walletPublicKey) return alert("Connect main wallet first.");
      var el = document.getElementById("secondWalletStatus");
      if (el) {
        el.textContent = session.secondWallet.address
          ? ("Linked: " + shortAddr(session.secondWallet.address))
          : "No second wallet linked yet.";
      }
      document.getElementById("secondWalletModalBackdrop").classList.add("show");
    }

    function hideSecondWalletModal(){
      document.getElementById("secondWalletModalBackdrop").classList.remove("show");
    }

    function closeSecondWalletModal(e){
      if (e && e.target && e.target.id === "secondWalletModalBackdrop") hideSecondWalletModal();
    }

    async function connectSecondWallet(which){
      try{
        if (!walletPublicKey) return alert("Connect main wallet first.");
        if (!session || !session.profileId) return alert("Profile not ready yet. Disconnect and reconnect your main wallet.");

        var provider = getProviderByName(which);
        if (!provider || typeof provider.connect !== "function") {
          return alert("Wallet provider not found. Make sure " + which + " is installed & enabled.");
        }

        // 1) connect the SECOND wallet
        var resp = await provider.connect({ onlyIfTrusted: false });
        var pk = resp && resp.publicKey ? resp.publicKey : provider.publicKey;
        if (!pk) throw new Error("Connected but no publicKey returned.");

        var addr = (typeof pk.toBase58 === "function") ? pk.toBase58() : String(pk);

        if (walletPublicKey && addr === walletPublicKey.toBase58()){
          return alert("That‚Äôs your main wallet already. Pick a different wallet for the 2nd slot.");
        }

        // 2) require proof-of-ownership (sign message) so nobody can type/link wallets they don't control
        if (typeof provider.signMessage !== "function") {
          return alert("This wallet does not support message signing. Use Phantom/Solflare/Magic Eden wallet with signMessage.");
        }

        var nonce = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));
        var msg =
          "LNL Link 2nd Wallet Proof\n" +
          "Profile: " + session.profileId + "\n" +
          "Primary: " + walletPublicKey.toBase58() + "\n" +
          "Second: " + addr + "\n" +
          "Nonce: " + nonce + "\n" +
          "Time: " + new Date().toISOString();

        var msgBytes = new TextEncoder().encode(msg);
        var signed = await provider.signMessage(msgBytes, "utf8");

        // Phantom returns { signature: Uint8Array, publicKey: PublicKey }
        var sigBytes = signed && signed.signature ? signed.signature : signed;
        if (!sigBytes) throw new Error("No signature returned from wallet.");

        // Verify signature with tweetnacl (loaded in <head>)
        if (!window.nacl || !window.nacl.sign || !window.nacl.sign.detached || !window.nacl.sign.detached.verify) {
          throw new Error("Missing tweetnacl. Refresh page (script failed to load).");
        }

        var pubBytes = null;
        if (signed && signed.publicKey) {
          if (typeof signed.publicKey.toBytes === "function") pubBytes = signed.publicKey.toBytes();
          else if (signed.publicKey instanceof Uint8Array) pubBytes = signed.publicKey;
        }
        if (!pubBytes && pk) {
          if (typeof pk.toBytes === "function") pubBytes = pk.toBytes();
          else if (pk instanceof Uint8Array) pubBytes = pk;
        }
        if (!pubBytes) throw new Error("Could not read wallet public key bytes for verification.");

        var ok = window.nacl.sign.detached.verify(msgBytes, sigBytes, pubBytes);
        if (!ok) throw new Error("Signature verification failed. Not linking wallet.");

        // 3) store as second wallet (local + Supabase)
        session.secondWallet.address = addr;
        saveSecondWalletToStorage();

        await linkWalletToProfile(addr, session.profileId, false);

        var el = document.getElementById("secondWalletStatus");
        if (el) el.textContent = "Linked: " + shortAddr(addr) + " ‚Äî rescanning‚Ä¶";

        document.getElementById("loadingSection").style.display = "block";
        document.getElementById("dashboard").classList.remove("show");
        await loadDashboard();

        hideSecondWalletModal();
        alert("2nd wallet linked: " + shortAddr(addr));
        } catch (err) {
        console.error("Second wallet connect error:", err);
        alert("Failed to link 2nd wallet: " + (err.message || err));
      }
    }

    function unlinkSecondWallet(){
      var prev = session.secondWallet.address || "";
      session.secondWallet.address = "";
      saveSecondWalletToStorage();

      // Remove from Supabase so it won't be remembered (requires DELETE policy on wallet_links)
      if (prev && session && session.profileId) {
        unlinkWallet(prev).catch(function(e){
          console.warn("Failed to unlink 2nd wallet in Supabase (maybe missing DELETE policy):", e);
        });
      }

      var el = document.getElementById("secondWalletStatus");
      if (el) el.textContent = "Second wallet unlinked. Rescanning‚Ä¶";

      document.getElementById("loadingSection").style.display = "block";
      document.getElementById("dashboard").classList.remove("show");
      loadDashboard();
    }

    function openAuthPopup(url, title){
      var w = 520, h = 720;
      var y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
      var x = window.top.outerWidth  / 2 + window.top.screenX - (w / 2);
      var popup = window.open(
        url,
        title,
        'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width=' + w + ', height=' + h + ', top=' + y + ', left=' + x
      );
      if (!popup) alert("Popup blocked. Please allow popups for this site.");
      return popup;
    }

    function connectX(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/x/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      openAuthPopup(url, "Connect X");
    }

    function connectDiscord(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/discord/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      openAuthPopup(url, "Connect Discord");
    }

    window.addEventListener("message", function(ev){
      if (ev.origin !== window.location.origin) return;

      var data = ev.data || {};
      if (!data || !data.type) return;

      if (data.type === "x_connected") {
        session.profile.x = data.username || "";
        saveProfileToStorage();
        refreshBanner();
        alert("X connected: @" + (data.username || "unknown"));
      }

      if (data.type === "discord_connected") {
        session.profile.discord = data.username
          ? (data.username + (data.discriminator ? ("#" + data.discriminator) : ""))
          : "";
        saveProfileToStorage();
        refreshBanner();
        alert("Discord connected: " + (session.profile.discord || "connected"));
      }

      if (data.type === "x_error" || data.type === "discord_error") {
        alert("Auth failed. Please try again.");
      }
    });
  
    function openTraitsModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return alert("No NFTs loaded yet.");
      var sub = getSubdaoMatches(session.loadedNFTs);

      var pills = document.getElementById("subdaoPills");
      if (pills){
        pills.innerHTML = sub.map(function(s){
          return '<span class="pill ' + (s.unlocked ? 'on' : 'off') + '">'
               + (s.unlocked ? '‚úì' : '‚Ä¢') + ' ' + s.icon + ' ' + escapeHtml(s.name)
               + '</span>';
        }).join("");
      }

      var counts = buildTraitCounts(session.loadedNFTs);
      var rows = Object.keys(counts).sort(function(a,b){ return counts[b]-counts[a]; }).slice(0, 80);
      var tbody = document.querySelector("#traitsTable tbody");
      if (tbody){
        tbody.innerHTML = rows.map(function(k){
          return '<tr><td>' + escapeHtml(k) + '</td><td>' + counts[k] + '</td></tr>';
        }).join("");
        if (rows.length === 0) tbody.innerHTML = '<tr><td colspan="2" class="trait-muted">No trait data found in metadata.</td></tr>';
      }

      document.getElementById("traitsModalBackdrop").classList.add("show");
    }

    function hideTraitsModal(){
      document.getElementById("traitsModalBackdrop").classList.remove("show");
    }

    function closeTraitsModal(e){
      if (e && e.target && e.target.id === "traitsModalBackdrop") hideTraitsModal();
    }

    /* ================================================================
       CHAT ‚Äî Supabase real-time
       Table: chat_messages (id, wallet, username, text, created_at)
       Messages are shared live across all connected wallets.
    ================================================================ */

    var SUPA_URL = 'https://hypqndasopdkrqvkllvc.supabase.co';
    var SUPA_KEY = 'sb_publishable_DwaaLS_hFJAOZ6M9VmYKYA_AQvyfgv1';
    var supaClient  = null;
    var chatChannel = null;   // real-time subscription
    var chatMsgs    = [];     // [{id, wallet, username, text, created_at}]

    // Auto-refresh fallback (in case real-time misses / tab sleeps)
    var chatRefreshTimer = null;
    var CHAT_REFRESH_MS  = 8000; // 8s feels "live" without spamming

    function getSupaClient() {
      if (!supaClient) {
        supaClient = supabase.createClient(SUPA_URL, SUPA_KEY);
      }
      return supaClient;
    }

    /* ===============================
       PROFILES + WALLET LINKING (Supabase)
       - Resolves a stable profile for a wallet (creates if missing)
       - Persists basic profile fields (username + avatar_url)
       - Remembers linked wallets via wallet_links
       =============================== */

    function getDb() { return getSupaClient(); }

    async function resolveProfileForWallet(wallet) {
      var db = getDb();

      // 1) check link
      var linkRes = await db
        .from("wallet_links")
        .select("profile_id")
        .eq("wallet", wallet)
        .maybeSingle();

      if (linkRes.error) throw linkRes.error;

      // 2) if link exists -> load profile
      if (linkRes.data && linkRes.data.profile_id) {
        var profRes = await db
          .from("profiles")
          .select("id, username, avatar_url, created_at")
          .eq("id", linkRes.data.profile_id)
          .single();
        if (profRes.error) throw profRes.error;
        return profRes.data;
      }

      // 3) create profile
      var newProfRes = await db
        .from("profiles")
        .insert({
          username: (session && session.profile && session.profile.username) ? session.profile.username : null,
          avatar_url: (session && session.profile && session.profile.pfpImage) ? session.profile.pfpImage : null
        })
        .select("id, username, avatar_url, created_at")
        .single();

      if (newProfRes.error) throw newProfRes.error;

      // 4) link wallet -> profile (wallet is unique)
      var upRes = await db
        .from("wallet_links")
        .upsert({ wallet: wallet, profile_id: newProfRes.data.id, is_primary: true }, { onConflict: "wallet" });

      if (upRes.error) throw upRes.error;

      // 5) re-read link (handles race)
      var finalLink = await db
        .from("wallet_links")
        .select("profile_id")
        .eq("wallet", wallet)
        .single();
      if (finalLink.error) throw finalLink.error;

      var finalProf = await db
        .from("profiles")
        .select("id, username, avatar_url, created_at")
        .eq("id", finalLink.data.profile_id)
        .single();
      if (finalProf.error) throw finalProf.error;

      return finalProf.data;
    }

    async function loadLinkedWallets(profileId) {
      var db = getDb();
      var res = await db
        .from("wallet_links")
        .select("wallet, is_primary, created_at")
        .eq("profile_id", profileId)
        .order("is_primary", { ascending: false });

      if (res.error) throw res.error;
      return res.data || [];
    }

    async function linkWalletToProfile(wallet, profileId, isPrimary) {
      var db = getDb();
      var res = await db
        .from("wallet_links")
        .upsert(
          { wallet: wallet, profile_id: profileId, is_primary: !!isPrimary },
          { onConflict: "wallet" }
        );
      if (res.error) throw res.error;
    }

    async function unlinkWallet(wallet) {
      var db = getDb();
      // If you don't have DELETE policy, this may fail ‚Äî we still clear local UI.
      var res = await db
        .from("wallet_links")
        .delete()
        .eq("wallet", wallet);
      if (res.error) throw res.error;
    }

    // Debounced profile saving (keeps your existing localStorage behavior)
    var _saveProfileTimer = null;
    function queueSaveProfileToSupabase() {
      if (!session || !session.profileId) return;
      if (_saveProfileTimer) clearTimeout(_saveProfileTimer);
      _saveProfileTimer = setTimeout(function(){
        saveProfileToSupabase().catch(function(e){ console.warn("Supabase profile save failed:", e); });
      }, 400);
    }

    async function saveProfileToSupabase() {
      if (!session || !session.profileId) return;
      var db = getDb();
      // Map existing dashboard profile fields -> DB columns that exist
      var payload = {
        username: (session.profile && session.profile.username) ? session.profile.username : null,
        avatar_url: (session.profile && session.profile.pfpImage) ? session.profile.pfpImage : null
      };
      var res = await db
        .from("profiles")
        .update(payload)
        .eq("id", session.profileId);
      if (res.error) throw res.error;
    }

    async function hydrateProfileAndWalletsFromSupabase(primaryWallet) {
      try {
        var profile = await resolveProfileForWallet(primaryWallet);
        session.profileId = profile.id;

        // Prefer Supabase values when present
        if (profile.username) session.profile.username = profile.username;
        if (profile.avatar_url) session.profile.pfpImage = profile.avatar_url;

        // Pull linked wallets and set 2nd wallet UI value (first non-primary wallet)
        var wallets = await loadLinkedWallets(profile.id);
        var second = "";
        for (var i = 0; i < wallets.length; i++) {
          if (wallets[i].wallet && wallets[i].wallet !== primaryWallet) { second = wallets[i].wallet; break; }
        }
        if (second) {
          session.secondWallet.address = second;
          saveSecondWalletToStorage(); // keep your existing local cache
        }
      } catch (e) {
        console.warn("Hydrate profile/wallets failed (Supabase):", e);
      }
    }


    /* ===============================
       CABBAGE SOFT STAKING (OFF-CHAIN)
       - Start button: sets first-time staking timestamp (one-time).
       - Claim button: credits earned cabbage since last claim.
       Requires Supabase Edge Function: /functions/v1/cabbage
       =============================== */

    function cabbageEndpoint() {
      return SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage';
    }

    function cabbageAuthHeaders() {
      // Supabase expects apikey + Authorization for Edge Functions when auth is enabled.
      return {
        'Content-Type': 'application/json',
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY
      };
    }

    function setBtnState(id, disabled, text) {
      var b = document.getElementById(id);
      if (!b) return;
      b.disabled = !!disabled;
      b.style.opacity = disabled ? '0.45' : '1';
      b.style.cursor = disabled ? 'not-allowed' : 'pointer';
      if (text != null) b.textContent = text;
    }

    function fmtDT(iso) {
      if (!iso) return '‚Äî';
      try {
        var d = new Date(iso);
        if (isNaN(d.getTime())) return '‚Äî';
        return d.toLocaleString();
      } catch (e) { return '‚Äî'; }
    }

    async function signCabbageMessage(action) {
      if (!walletProvider || !walletPublicKey) throw new Error('Wallet not connected');
      if (!walletProvider.signMessage) throw new Error('Wallet does not support message signing');
      var wallet = walletPublicKey.toBase58();
      var ts = new Date().toISOString();
      var msg = 'LNL Cabbage ' + action.toUpperCase() + '\nWallet: ' + wallet + '\nTime: ' + ts;
      var msgBytes = new TextEncoder().encode(msg);
      var sigBytes = await walletProvider.signMessage(msgBytes, 'utf8');
      // Phantom returns {signature: Uint8Array}; others may return Uint8Array directly.
      var raw = sigBytes && sigBytes.signature ? sigBytes.signature : sigBytes;
      var b64 = btoa(String.fromCharCode.apply(null, Array.from(raw)));
      return { wallet: wallet, message: msg, signature: b64 };
    }

    async function refreshCabbageUI() {
      try {
        if (!walletPublicKey) return;
        var wallet = walletPublicKey.toBase58();

        var balEl = document.getElementById('cabbageBalance');
        var rateEl = document.getElementById('cabbageRate');
        var pendEl = document.getElementById('cabbagePending');
        var lastEl = document.getElementById('cabbageLast');
        var startedEl = document.getElementById('cabbageStarted');
        var nftCountEl = document.getElementById('cabbageNftCount');

        if (balEl) balEl.textContent = '‚Ä¶';
        if (rateEl) rateEl.textContent = '‚Ä¶';
        if (pendEl) pendEl.textContent = '‚Ä¶';
        if (lastEl) lastEl.textContent = '‚Ä¶';
        if (startedEl) startedEl.textContent = '‚Ä¶';

        // Default UI state while loading
        setBtnState('cabbageStartBtn', true, 'Start');
        setBtnState('cabbageClaimBtn', true, 'Claim');

        var res = await fetch(cabbageEndpoint() + '?wallet=' + encodeURIComponent(wallet), {
          method: 'GET',
          headers: cabbageAuthHeaders()
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) {
          throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));
        }

        var balance = Number(data.balance || 0);
        var pending = Number(data.pending || 0);
        var rate = Number(data.rate_per_week || 0);
        var stakedCount = Number(data.staked_count || 0);

        var startedAt = data.started_at || null;
        var lastClaim = data.last_claim_at || null;

        if (balEl) balEl.textContent = (Math.floor(balance * 100) / 100).toLocaleString();
        if (rateEl) rateEl.textContent = rate.toLocaleString() + ' \uD83E\uDD6C / week';
        if (pendEl) pendEl.textContent = (Math.floor(pending * 100) / 100).toLocaleString();
        if (startedEl) startedEl.textContent = startedAt ? fmtDT(startedAt) : 'Not started';
        var claimIsReal = lastClaim && lastClaim.indexOf('1970') !== 0;
        if (lastEl) lastEl.textContent = claimIsReal ? fmtDT(lastClaim) : '‚Äî';
        if (nftCountEl) nftCountEl.textContent = stakedCount.toLocaleString();

        // Button rules:
        // - If NOT started: enable Start, disable Claim
        // - If started: disable Start, enable Claim
        var started = !!startedAt;
        setBtnState('cabbageStartBtn', started, started ? 'Started' : 'Start');
        setBtnState('cabbageClaimBtn', !started, 'Claim');

      } catch (e) {
        console.error('refreshCabbageUI error:', e);
        // Leave buttons usable for retry
        setBtnState('cabbageStartBtn', false, 'Start');
        setBtnState('cabbageClaimBtn', false, 'Claim');
      }
    }

    async function startCabbage() {
      try {
        setBtnState('cabbageStartBtn', true, 'Starting‚Ä¶');
        setBtnState('cabbageClaimBtn', true, 'Claim');
        var payload = await signCabbageMessage('start');

        var res = await fetch(cabbageEndpoint(), {
          method: 'POST',
          headers: cabbageAuthHeaders(),
          body: JSON.stringify({ action: 'start', wallet: payload.wallet, message: payload.message, signature: payload.signature })
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));

        await refreshCabbageUI();
      } catch (e) {
        console.error('startCabbage error:', e);
        alert('Start failed: ' + (e.message || e));
        setBtnState('cabbageStartBtn', false, 'Start');
      }
    }

    async function claimCabbage() {
      try {
        setBtnState('cabbageClaimBtn', true, 'Claiming‚Ä¶');
        var payload = await signCabbageMessage('claim');

        var res = await fetch(cabbageEndpoint(), {
          method: 'POST',
          headers: cabbageAuthHeaders(),
          body: JSON.stringify({ action: 'claim', wallet: payload.wallet, message: payload.message, signature: payload.signature })
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));

        await refreshCabbageUI();
        mq_track('claim_staking');
      } catch (e) {
        console.error('claimCabbage error:', e);
        alert('Claim failed: ' + (e.message || e));
        setBtnState('cabbageClaimBtn', false, 'Claim');
      }
    }


    // Deterministic color per wallet so each user always looks the same
    function walletColor(addr) {
      var palette = ['#00d4ff','#7b68ee','#00ff88','#f5a623','#ff6b9d','#4ecdc4','#ffd93d','#ff8c42'];
      var hash = 0;
      for (var i = 0; i < (addr || '').length; i++) {
        hash = ((hash << 5) - hash) + addr.charCodeAt(i);
        hash |= 0;
      }
      return palette[Math.abs(hash) % palette.length];
    }

    // Called when leaving chat tab or disconnecting
    function stopChatPoll() {
      // stop fallback refresh timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // stop real-time subscription
      if (chatChannel) {
        try { getSupaClient().removeChannel(chatChannel); } catch(e) {}
        chatChannel = null;
      }
    }
    function renderChatUI() {
      var view = document.getElementById('view-chat');
      if (!view) return;

      view.innerHTML =
        // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">ü™∂ HOLDER CHAT</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">Live ¬∑ Open to all connected wallets</div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:0.7rem;">' +
            '<div id="chatLiveDot" style="display:flex;align-items:center;gap:5px;font-size:0.7rem;color:#555;">' +
              '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶' +
            '</div>' +
            '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Messages ‚îÄ‚îÄ
        '<div id="chatBox" style="height:440px;overflow-y:auto;background:#06060f;border:1px solid #161628;border-radius:12px;padding:16px;margin-bottom:12px;scroll-behavior:smooth;">' +
          '<div id="chatInner"></div>' +
        '</div>' +

        // ‚îÄ‚îÄ Input ‚îÄ‚îÄ
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<div id="chatInputWrap" style="flex:1;display:flex;align-items:center;gap:8px;background:#0d0d1e;border:1px solid #1a1a30;border-radius:10px;padding:0 12px;transition:border-color 0.2s;">' +
            '<span id="chatWalletTag" style="font-size:0.78rem;font-weight:700;flex-shrink:0;white-space:nowrap;"></span>' +
            '<input id="chatInput" style="flex:1;background:transparent;border:none;outline:none;color:#e0e0ff;font-family:\'Space Grotesk\',sans-serif;font-size:0.88rem;padding:12px 0;" placeholder="Say something legend‚Ä¶" maxlength="400" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendChatMessage();}" />' +
            '<span id="chatCount" style="font-size:0.62rem;color:#252540;flex-shrink:0;min-width:28px;text-align:right;"></span>' +
          '</div>' +
          '<button id="chatSendBtn" onclick="sendChatMessage()" style="background:linear-gradient(135deg,rgba(0,212,255,0.18),rgba(123,104,238,0.18));border:1px solid rgba(0,212,255,0.35);color:#00d4ff;padding:12px 22px;border-radius:10px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.8rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;white-space:nowrap;">Send</button>' +
        '</div>';

      // Wallet tag
      if (walletPublicKey) {
        var addr = walletPublicKey.toBase58();
        var tag  = document.getElementById('chatWalletTag');
        tag.textContent = addr.slice(0,4) + '‚Ä¶' + addr.slice(-4);
        tag.style.color = walletColor(addr);
      }

      // Focus ring
      var wrap = document.getElementById('chatInputWrap');
      var inp  = document.getElementById('chatInput');
      inp.addEventListener('focus', function(){ wrap.style.borderColor = 'rgba(0,212,255,0.45)'; });
      inp.addEventListener('blur',  function(){ wrap.style.borderColor = '#1a1a30'; });
      inp.addEventListener('input', function(){
        var left = 400 - inp.value.length;
        var c = document.getElementById('chatCount');
        c.textContent = left < 80 ? left : '';
        c.style.color = left < 30 ? '#ff3c5c' : '#252540';
      });

      // Load history then subscribe
      chatMsgs = [];
      shop_loadAllChatItems();
      ach_loadAllUsers();
      loadChatHistory();
    }

    
    // Pull any new messages since the newest one we have.
    // This runs on an interval as a safety net (real-time should still do the heavy lifting).
    async function refreshChatFromServer() {
      try {
        // only refresh if we're actually on the chat tab and the UI exists
        if (!session || session.currentView !== 'chat') return;
        if (!document.getElementById('chatInner')) return;

        var sb = getSupaClient();

        var last = (chatMsgs && chatMsgs.length) ? chatMsgs[chatMsgs.length - 1] : null;
        var q = sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        // Incremental fetch: only grab messages newer than what we have.
        if (last && last.created_at) {
          q = q.gt('created_at', last.created_at);
        }

        var res = await q;
        if (res.error) throw res.error;

        var incoming = res.data || [];
        if (!incoming.length) return;

        // Merge de-duped by id
        var existing = {};
        for (var i = 0; i < chatMsgs.length; i++) existing[chatMsgs[i].id] = true;

        for (var j = 0; j < incoming.length; j++) {
          if (!existing[incoming[j].id]) chatMsgs.push(incoming[j]);
        }

        // Keep sorted (in case clocks are funky)
        chatMsgs.sort(function(a,b){
          return new Date(a.created_at) - new Date(b.created_at);
        });

        paintMessages();
        scrollToBottom(false);
      } catch(e) {
        // quiet failure ‚Äî this is just a fallback
        console.warn('Chat auto-refresh error:', e && (e.message || e));
      }
    }

    function startChatAutoRefresh() {
      // reset any existing timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // immediate refresh in case we missed messages while tab was inactive
      refreshChatFromServer();

      chatRefreshTimer = setInterval(function(){
        refreshChatFromServer();
      }, CHAT_REFRESH_MS);

      // when user comes back to the tab, refresh immediately
      try {
        if (!window.__lnlChatVisHooked) {
          window.__lnlChatVisHooked = true;
          document.addEventListener('visibilitychange', function(){
            if (!document.hidden) refreshChatFromServer();
          });
          window.addEventListener('focus', function(){ refreshChatFromServer(); });
        }
      } catch(e) {}
    }

    async function loadChatHistory() {
      setLiveDot(false);
      try {
        var sb = getSupaClient();
        var res = await sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        if (res.error) throw res.error;
        chatMsgs = res.data || [];
        paintMessages();
        scrollToBottom(true);
      } catch(e) {
        console.error('Chat history error:', e);
        document.getElementById('chatInner').innerHTML =
          '<div style="color:#ff3c5c;font-size:0.78rem;text-align:center;padding:2rem;">Could not load messages. Check Supabase config.</div>';
      }
      subscribeLive();
    }

    function subscribeLive() {
      // Tear down any existing subscription first
      stopChatPoll();

      var sb = getSupaClient();
      chatChannel = sb
        .channel('chat_messages_live')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'chat_messages'
        }, function(payload) {
          var row = payload.new;
          // Avoid duplicates (our own optimistic message already added)
          var exists = chatMsgs.some(function(m){ return m.id === row.id; });
          if (!exists) {
            chatMsgs.push(row);
            paintMessages();
            scrollToBottom(false);
          }
        })
        .subscribe(function(status) {
          setLiveDot(status === 'SUBSCRIBED');
        });

      // Safety-net refresh (keeps chat updated even if real-time drops)
      startChatAutoRefresh();
    }

    function setLiveDot(live) {
      var el = document.getElementById('chatLiveDot');
      if (!el) return;
      if (live) {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 6px rgba(0,255,136,0.7);"></div>Live';
        el.style.color = '#555';
      } else {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶';
      }
    }

    function paintMessages() {
      var inner = document.getElementById('chatInner');
      if (!inner) return;

      if (chatMsgs.length === 0) {
        inner.innerHTML =
          '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:340px;gap:0.7rem;">' +
            '<div style="font-size:2.5rem;">ü™∂</div>' +
            '<div style="color:#252540;font-size:0.78rem;letter-spacing:2px;text-transform:uppercase;">No messages yet</div>' +
            '<div style="color:#1a1a30;font-size:0.7rem;">Be the first legend</div>' +
          '</div>';
        return;
      }

      var myWallet  = walletPublicKey ? walletPublicKey.toBase58() : null;
      var prevWallet = null;
      var html = '';

      chatMsgs.forEach(function(m, i) {
        var isMe  = m.wallet === myWallet;
        var color = walletColor(m.wallet);

        // Store cosmetics
        var badge = shop_getBadge(m.wallet);
        var vip = shop_getVIP(m.wallet);
        var nameCol = shop_getNameColor(m.wallet);
        var glow = shop_hasGlow(m.wallet);
        var achBadge = ach_getTopBadge(m.wallet);
        var achCount = ach_getBadgeCount(m.wallet);
        if (nameCol) color = nameCol;

        // Display name: use stored username if present, else shorten wallet
        var name = m.username
          ? m.username
          : (m.wallet.slice(0,4) + '‚Ä¶' + m.wallet.slice(-4));

        var newSender = m.wallet !== prevWallet;
        prevWallet = m.wallet;

        var t = new Date(m.created_at);
        var timeStr = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        if (newSender) {
          if (i > 0) html += '<div style="height:12px;"></div>';
          html +=
            '<div style="display:flex;align-items:baseline;gap:7px;margin-bottom:3px;">' +
              (vip ? '<span style="font-size:0.6rem;background:linear-gradient(135deg,#ffd700,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900;">VIP</span>' : '') +
              '<span style="font-weight:700;font-size:0.8rem;color:' + color + ';">' + escapeHtml(name) + '</span>' +
              (badge ? '<span style="font-size:0.7rem;">' + badge + '</span>' : '') +
              (achBadge ? '<span style="font-size:0.65rem;">' + achBadge + '</span>' : '') +
              (achCount > 0 ? '<span style="font-size:0.48rem;color:#ffd700;font-weight:700;background:rgba(255,215,0,0.1);padding:1px 4px;border-radius:4px;">' + achCount + 'üèÖ</span>' : '') +
              '<span style="font-size:0.6rem;color:#252540;">' + timeStr + '</span>' +
              (isMe ? '<span style="font-size:0.55rem;letter-spacing:1px;color:#1e1e3a;text-transform:uppercase;">you</span>' : '') +
            '</div>';
        }

        var glowStyle = glow ? 'text-shadow:0 0 8px rgba(0,212,255,0.15);' : '';
        html += '<div style="font-size:0.87rem;color:#c8c8e8;line-height:1.6;word-break:break-word;padding:1px 0;' + glowStyle + '">' + escapeHtml(m.text) + '</div>';
      });

      inner.innerHTML = html;
    }

    function scrollToBottom(force) {
      var box = document.getElementById('chatBox');
      if (!box) return;
      var nearBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 120;
      if (force || nearBottom) box.scrollTop = box.scrollHeight;
    }

    async function sendChatMessage() {
      if (!walletPublicKey) { alert('Connect your wallet first.'); return; }
      var inp = document.getElementById('chatInput');
      var btn = document.getElementById('chatSendBtn');
      if (!inp) return;

      var text = inp.value.trim();
      if (!text) return;

      inp.value = '';
      inp.dispatchEvent(new Event('input'));
      btn.disabled = true;
      btn.textContent = '‚Ä¶';

      var wallet   = walletPublicKey.toBase58();
      var username = session.profile.username || null;

      try {
        var sb  = getSupaClient();
        var res = await sb.from('chat_messages').insert({
          wallet:   wallet,
          username: username,
          text:     text
        }).select().single();

        if (res.error) throw res.error;

        // Optimistic: add immediately so sender doesn't wait for real-time echo
        var exists = chatMsgs.some(function(m){ return m.id === res.data.id; });
        if (!exists) {
          chatMsgs.push(res.data);
          paintMessages();
          scrollToBottom(true);
          mq_track('chat_msg');
        }
      } catch(e) {
        console.error('Send error:', e);
        alert('Failed to send: ' + (e.message || e));
      }

      btn.disabled = false;
      btn.textContent = 'Send';
      inp.focus();
    }


    /* ================================================================
       CASINO GAMES ‚Äî fully self-contained, no shared state with chat
       or profile. All vars prefixed g_ to avoid any collisions.
       Wallets: SOL bets ‚Üí ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc
                NFT prizes ‚Üê 3HkAeqdaPJHK46TuTmchmK789CZgmKb9vMihoXjzQmth
    ================================================================ */

    var g_SOL_TREASURY = 'ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc';
    var g_NFT_TREASURY = '3HkAeqdaPJHK46TuTmchmK789CZgmKb9vMihoXjzQmth';
    var g_NFT_POT_THRESHOLD_SOL = 10;
    var g_NFT_POT_THRESHOLD_CAB = 100000;

    // House edges: coin flip 43% win/1.80x, dice 45%/1.75x, slots as below
    var g_GAMES = {
      coin:  { winChance: 0.43, payout: 1.80 },
      dice:  { winChance: 0.45, payout: 1.75 },
      slots: {
        jackpot:    { chance: 0.008, payout: 15 },
        threeKind:  { chance: 0.04,  payout: 7  },
        twoKind:    { chance: 0.28,  payout: 1.8 }
      }
    };

    // NFT bonus: +win% based on LNL held
    function g_nftBonus(count) {
      var bonus = 0;
      if (count >= 20) bonus = 0.04;
      else if (count >= 10) bonus = 0.03;
      else if (count >= 5)  bonus = 0.02;
      else if (count >= 1)  bonus = 0.01;
      // Lucky Boost from store
      if (shop_hasBoost()) bonus += 0.05;
      return bonus;
    }

    // Call after each casino bet to decrement boost uses
    function g_useBoost() {
      if (!shop_hasBoost()) return;
      var b = shop_items['lucky_boost'];
      if (b && b.data && b.data.uses_left > 0) {
        b.data.uses_left--;
        // Update server async (fire-and-forget)
        if (walletPublicKey) {
          getSupaClient().from('user_items').update({ data: b.data })
            .eq('wallet', walletPublicKey.toBase58()).eq('item_id', 'lucky_boost')
            .then(function(){}).catch(function(){});
        }
      }
    }

    var g_currency    = 'sol';  // 'sol' or 'cabbage'
    var g_betAmount   = 0.05;
    var g_betHistory  = [];
    var g_solBalance  = null;
    var g_cabBalance  = null;
    var g_isSpinning  = false;

    // ‚îÄ‚îÄ Supabase helpers (uses the same SUPA_URL/SUPA_KEY already defined above) ‚îÄ‚îÄ
    function g_getSb() { return getSupaClient(); }

    async function g_logBet(game, betAmt, currency, houseProft) {
      try {
        if (!walletPublicKey) return;
        // Get current pot round
        var sb = g_getSb();
        var stR = await sb.from('prize_state').select('sol_round,cab_round').eq('id', 1).maybeSingle();
        var round = 1;
        if (stR.data) round = currency === 'sol' ? stR.data.sol_round : stR.data.cab_round;
        await sb.from('game_bets').insert({
          wallet:       walletPublicKey.toBase58(),
          game:         game,
          bet_amount:   betAmt,
          currency:     currency,
          house_profit: houseProft,
          pot_round:    round,
          played_at:    new Date().toISOString()
        });
      } catch(e) { console.warn('g_logBet error:', e); }
    }

    async function g_fetchPotProgress() {
      try {
        var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
          body: JSON.stringify({ action: 'pot_status' })
        });
        var data = await res.json();
        return {
          sol: data.sol || 0,
          cabbage: data.cabbage || 0,
          sol_threshold: data.sol_threshold || g_NFT_POT_THRESHOLD_SOL,
          cab_threshold: data.cab_threshold || g_NFT_POT_THRESHOLD_CAB
        };
      } catch(e) { return { sol: 0, cabbage: 0, sol_threshold: g_NFT_POT_THRESHOLD_SOL, cab_threshold: g_NFT_POT_THRESHOLD_CAB }; }
    }

    async function g_checkAndTriggerPrize(currency, pot, threshold) {
      if (pot < threshold) return;
      if (!walletPublicKey) return;
      try {
        var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
          body: JSON.stringify({ action: 'trigger_prize', currency: currency })
        });
        var data = await res.json();
        if (data.ok && data.winner) {
          g_showWinnerModal(data.winner, data.nft_name || 'LNL NFT', data.tx_sig || '');
        }
      } catch(e) { console.warn('g_checkAndTriggerPrize error:', e); }
    }

    async function g_updatePotUI() {
      try {
        var pot = await g_fetchPotProgress();
        var solTh = pot.sol_threshold || g_NFT_POT_THRESHOLD_SOL;
        var cabTh = pot.cab_threshold || g_NFT_POT_THRESHOLD_CAB;
        var solPct = Math.min(100, (pot.sol / solTh) * 100);
        var cabPct = Math.min(100, (pot.cabbage / cabTh) * 100);
        var sb = document.getElementById('g_solPotBar');
        var cb = document.getElementById('g_cabPotBar');
        var sl = document.getElementById('g_solPotLabel');
        var cl = document.getElementById('g_cabPotLabel');
        if (sb) sb.style.width = solPct + '%';
        if (cb) cb.style.width = cabPct + '%';
        if (sl) sl.textContent = pot.sol.toFixed(2) + ' / ' + solTh + ' ‚óé';
        if (cl) cl.textContent = Math.floor(pot.cabbage).toLocaleString() + ' / ' + cabTh.toLocaleString() + ' ü•¨';
        // Check triggers
        await g_checkAndTriggerPrize('sol', pot.sol, solTh);
        await g_checkAndTriggerPrize('cabbage', pot.cabbage, cabTh);
      } catch(e) {}
    }

    function g_showWinnerModal(winnerAddr, nftName, txSig) {
      var modal = document.getElementById('g_winnerModal');
      if (!modal) return;
      var wa = document.getElementById('g_winnerWallet');
      if (wa) wa.textContent = winnerAddr || '‚Äî';
      var na = document.getElementById('g_winnerNFT');
      if (na) na.textContent = nftName || 'LNL NFT';
      var ta = document.getElementById('g_winnerTx');
      if (ta) {
        if (txSig && !txSig.startsWith('FAILED')) {
          ta.innerHTML = '<a href="https://solscan.io/tx/' + txSig + '" target="_blank" style="color:#00d4ff;text-decoration:underline;font-size:0.65rem;word-break:break-all;">View on Solscan ‚Üí</a>';
        } else {
          ta.textContent = 'Transfer processing‚Ä¶';
        }
      }
      modal.style.display = 'flex';
      g_launchConfetti();
    }

    function g_closeWinnerModal() {
      var modal = document.getElementById('g_winnerModal');
      if (modal) modal.style.display = 'none';
    }

    function g_launchConfetti() {
      var container = document.getElementById('g_confettiContainer');
      if (!container) return;
      container.innerHTML = '';
      var colors = ['#ffd700','#00d4ff','#7b68ee','#00ff88','#ff3c5c'];
      for (var i = 0; i < 80; i++) {
        var p = document.createElement('div');
        var size = 6 + Math.random() * 8;
        p.style.cssText = 'position:absolute;width:' + size + 'px;height:' + size + 'px;'
          + 'background:' + colors[Math.floor(Math.random() * colors.length)] + ';'
          + 'border-radius:' + (Math.random() > 0.5 ? '50%' : '2px') + ';'
          + 'left:' + Math.random() * 100 + '%;'
          + 'top:-20px;'
          + 'animation:g_fall ' + (1.5 + Math.random() * 2) + 's linear ' + (Math.random() * 0.8) + 's forwards;'
          + 'opacity:0.9;';
        container.appendChild(p);
      }
    }

    // ‚îÄ‚îÄ SOL balance ‚îÄ‚îÄ
    async function g_fetchSolBalance() {
      if (!walletPublicKey) return null;
      try {
        var res = await fetch(CONFIG.RPC_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getBalance', params: [walletPublicKey.toBase58()] })
        });
        var json = await res.json();
        return (json && json.result && json.result.value != null) ? json.result.value / 1e9 : null;
      } catch(e) { return null; }
    }

    async function g_fetchCabbageBalance() {
      if (!walletPublicKey) return null;
      try {
        var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage?wallet=' + encodeURIComponent(walletPublicKey.toBase58()), {
          headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
        });
        var data = await res.json();
        return Number(data.balance || 0);
      } catch(e) { return null; }
    }

    async function g_loadGameBalances() {
      var solEl = document.getElementById('g_solBal');
      var cabEl = document.getElementById('g_cabBal');
      if (solEl) solEl.textContent = '‚Ä¶';
      if (cabEl) cabEl.textContent = '‚Ä¶';
      var sol = await g_fetchSolBalance();
      var cab = await g_fetchCabbageBalance();
      g_solBalance = sol;
      g_cabBalance = cab;
      if (solEl) solEl.textContent = sol !== null ? sol.toFixed(3) + ' ‚óé' : '‚Äî';
      if (cabEl) cabEl.textContent = cab !== null ? Math.floor(cab).toLocaleString() + ' ü•¨' : '‚Äî';
    }

    // ‚îÄ‚îÄ On-chain SOL transfer ‚îÄ‚îÄ
    async function g_sendSolBet(lamports) {
      if (!walletPublicKey || !walletProvider) throw new Error('Wallet not connected');
      var res = await fetch(CONFIG.RPC_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getLatestBlockhash', params: [{ commitment: 'finalized' }] })
      });
      var bh = await res.json();
      var blockhash = bh.result.value.blockhash;
      var lastValidBlockHeight = bh.result.value.lastValidBlockHeight;

      // Build transfer instruction bytes manually
      var from = walletPublicKey.toBase58();
      var to   = g_SOL_TREASURY;

      // Use solanaWeb3 if available, else base64 raw tx approach
      if (window.solanaWeb3) {
        var tx = new solanaWeb3.Transaction();
        tx.recentBlockhash = blockhash;
        tx.feePayer = walletPublicKey;
        tx.add(solanaWeb3.SystemProgram.transfer({
          fromPubkey: walletPublicKey,
          toPubkey: new solanaWeb3.PublicKey(to),
          lamports: lamports
        }));
        var signed = await walletProvider.signTransaction(tx);
        var rawTx = signed.serialize();
        var sendRes = await fetch(CONFIG.RPC_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'sendTransaction', params: [btoa(String.fromCharCode(...rawTx)), { encoding: 'base64' }] })
        });
        var sendJson = await sendRes.json();
        if (sendJson.error) throw new Error(sendJson.error.message || 'TX failed');
        return sendJson.result;
      } else {
        // Fallback: build raw transaction bytes for system transfer
        var fromBytes = g_b58Decode(from);
        var toBytes   = g_b58Decode(to);
        var txBytes   = g_buildSystemTransferTx(fromBytes, toBytes, lamports, g_b58Decode(blockhash));
        var signed2   = await walletProvider.signTransaction({ serializeMessage: function(){ return txBytes; } });
        throw new Error('Please include @solana/web3.js for SOL transfers.');
      }
    }

    // b58 decode helper
    var g_B58_CHARS = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    function g_b58Decode(str) {
      var bytes = [0];
      for (var i = 0; i < str.length; i++) {
        var c = g_B58_CHARS.indexOf(str[i]);
        if (c < 0) throw new Error('Invalid base58');
        for (var j = 0; j < bytes.length; j++) bytes[j] *= 58;
        bytes[bytes.length - 1] += c;
        for (var k = bytes.length - 1; k > 0; k--) {
          if (bytes[k] > 255) { bytes[k-1] += Math.floor(bytes[k]/256); bytes[k] %= 256; }
        }
      }
      for (var z = 0; z < str.length && str[z] === '1'; z++) bytes.unshift(0);
      return new Uint8Array(bytes);
    }

    // ‚îÄ‚îÄ Cabbage spend ‚îÄ‚îÄ
    async function g_spendCabbage(amount) {
      if (!walletPublicKey) throw new Error('Wallet not connected');
      var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
        body: JSON.stringify({ action: 'spend', wallet: walletPublicKey.toBase58(), amount: amount })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Spend failed');
      return data;
    }

    // ‚îÄ‚îÄ SOL‚ÜíCabbage conversion: 1 SOL = 100 cabbage ‚îÄ‚îÄ
    var g_SOL_TO_CABBAGE = 100;

    async function g_creditCabbage(amount) {
      if (!walletPublicKey) throw new Error('Wallet not connected');
      var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
        body: JSON.stringify({ action: 'credit', wallet: walletPublicKey.toBase58(), amount: amount })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Credit failed');
      return data;
    }

    // ‚îÄ‚îÄ Game result helpers ‚îÄ‚îÄ
    function g_playCoin(nftCount) {
      var chance = g_GAMES.coin.winChance + g_nftBonus(nftCount);
      return Math.random() < chance;
    }

    function g_playDice(choice) {
      // choice: 'high' (4-6), 'low' (1-3), 'even', 'odd'
      var roll = Math.floor(Math.random() * 6) + 1;
      var won;
      if (choice === 'high') won = roll >= 4;
      else if (choice === 'low') won = roll <= 3;
      else if (choice === 'even') won = roll % 2 === 0;
      else won = roll % 2 !== 0;
      return { roll: roll, won: won };
    }

    function g_playSlots(nftCount) {
      var bonus = g_nftBonus(nftCount);
      var r = Math.random() - bonus * 0.5; // small bonus shifts result
      var symbols = ['ü™∂','üåø','üé≤','üíé','üî•','‚≠ê'];
      if (r < g_GAMES.slots.jackpot.chance) {
        return { reels: ['ü™∂','ü™∂','ü™∂'], result: 'jackpot', payout: g_GAMES.slots.jackpot.payout };
      }
      if (r < g_GAMES.slots.jackpot.chance + g_GAMES.slots.threeKind.chance) {
        var s = symbols[Math.floor(Math.random() * symbols.length)];
        return { reels: [s, s, s], result: 'three', payout: g_GAMES.slots.threeKind.payout };
      }
      if (r < g_GAMES.slots.jackpot.chance + g_GAMES.slots.threeKind.chance + g_GAMES.slots.twoKind.chance) {
        var s2 = symbols[Math.floor(Math.random() * symbols.length)];
        var other = symbols.filter(function(x){return x!==s2;})[Math.floor(Math.random()*5)];
        var reels = Math.random() > 0.5 ? [s2, s2, other] : [s2, other, s2];
        return { reels: reels, result: 'two', payout: g_GAMES.slots.twoKind.payout };
      }
      // Loss ‚Äî 3 different symbols
      var r1 = symbols[Math.floor(Math.random()*6)];
      var r2 = symbols.filter(function(x){return x!==r1;})[Math.floor(Math.random()*5)];
      var r3 = symbols.filter(function(x){return x!==r1&&x!==r2;})[Math.floor(Math.random()*4)];
      return { reels: [r1, r2, r3], result: 'loss', payout: 0 };
    }

    function g_addHistory(game, betAmt, currency, won, payout) {
      g_betHistory.unshift({ game: game, bet: betAmt, currency: currency, won: won, payout: payout, time: new Date() });
      if (g_betHistory.length > 20) g_betHistory.pop();
      g_renderHistory();
      // Mission tracking
      mq_track('casino_play');
      if (won) mq_track('casino_win');
      // Lucky Boost decrement
      g_useBoost();
    }

    function g_renderHistory() {
      var el = document.getElementById('g_historyList');
      if (!el) return;
      if (!g_betHistory.length) { el.innerHTML = '<div style="color:#252540;font-size:0.75rem;text-align:center;padding:1rem;letter-spacing:1px;">No games played yet</div>'; return; }
      el.innerHTML = g_betHistory.slice(0,8).map(function(h) {
        var betSym = h.currency === 'sol' ? '‚óé' : 'ü•¨';
        var pnl = h.won ? '+' + h.payout.toFixed(2) + ' ü•¨' : '-' + h.bet.toFixed(4) + ' ' + betSym;
        var col = h.won ? '#00ff88' : '#ff3c5c';
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.75rem;">'
          + '<span style="color:#555;">' + h.game + '</span>'
          + '<span>' + h.bet + ' ' + betSym + '</span>'
          + '<span style="color:' + col + ';font-weight:700;">' + pnl + '</span>'
          + '</div>';
      }).join('');
    }

    // ‚îÄ‚îÄ Main render function ‚îÄ‚îÄ
    function renderGamesUI() {
      var view = document.getElementById('view-games');
      if (!view) return;

      var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;
      var bonus = g_nftBonus(nftCount);

      view.innerHTML =
        '<style>' +
        '@keyframes g_fall{to{top:110%;opacity:0;transform:rotate(720deg) translateX(30px)}}' +
        '@keyframes g_spin{0%{transform:translateY(0)}100%{transform:translateY(-300px)}}' +
        '@keyframes g_pulse{0%,100%{opacity:1}50%{opacity:0.6}}' +
        '.g_card{background:#0f0f22;border:1px solid #1e1e3a;border-radius:14px;padding:1.4rem;margin-bottom:1.2rem;}' +
        '.g_title{font-family:"Bebas Neue",sans-serif;font-size:1rem;letter-spacing:3px;color:#555;margin-bottom:1rem;}' +
        '.g_btn{background:transparent;border:1px solid rgba(255,255,255,0.12);color:#aaa;padding:10px 18px;border-radius:8px;cursor:pointer;font-family:"Space Grotesk",sans-serif;font-weight:700;font-size:0.75rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;}' +
        '.g_btn:hover:not(:disabled){border-color:rgba(0,212,255,0.5);color:#00d4ff;transform:translateY(-1px);}' +
        '.g_btn:disabled{opacity:0.4;cursor:not-allowed;}' +
        '.g_btn-primary{border-color:rgba(0,212,255,0.45);color:#00d4ff;}' +
        '.g_btn-primary:hover:not(:disabled){background:rgba(0,212,255,0.08);box-shadow:0 0 20px rgba(0,212,255,0.15);}' +
        '.g_result{min-height:48px;text-align:center;padding:0.8rem;border-radius:8px;background:rgba(0,0,0,0.2);margin-top:0.8rem;font-weight:700;font-size:0.9rem;transition:all 0.3s;}' +
        '.g_reel{font-size:2.2rem;background:#06060f;border:1px solid #161628;border-radius:10px;width:60px;height:60px;display:inline-flex;align-items:center;justify-content:center;}' +
        '.g_pot-bar{height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;margin-top:5px;}' +
        '.g_pot-fill{height:100%;border-radius:4px;transition:width 1s ease;}' +
        '@keyframes g_coinFlip{0%{transform:rotateY(0)}100%{transform:rotateY(1800deg)}}' +
        '@keyframes g_coinLand{0%{transform:scale(1.15)}50%{transform:scale(0.95)}100%{transform:scale(1)}}' +
        '.g_coin{width:80px;height:80px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;perspective:600px;margin:0 auto;}' +
        '.g_coin-inner{width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:900;transition:transform 0.1s;}' +
        '.g_coin-inner.spinning{animation:g_coinFlip 1.2s ease-out forwards;}' +
        '.g_coin-inner.landed{animation:g_coinLand 0.3s ease-out;}' +
        '.g_coin-heads{background:linear-gradient(135deg,#ffd700,#f0c000);color:#6b4c00;border:3px solid #e6b800;text-shadow:0 1px 2px rgba(0,0,0,0.2);}' +
        '.g_coin-tails{background:linear-gradient(135deg,#c0c0c0,#a0a0a0);color:#333;border:3px solid #909090;text-shadow:0 1px 2px rgba(0,0,0,0.15);}' +
        '.bj_card{display:inline-flex;flex-direction:column;align-items:center;justify-content:center;width:62px;height:88px;border-radius:8px;font-weight:700;font-size:0.95rem;margin:3px;box-shadow:0 3px 12px rgba(0,0,0,0.4);}' +
        '.bj_front{background:linear-gradient(135deg,#fff,#f0f0f0);border:2px solid #ddd;}' +
        '.bj_back{background:linear-gradient(135deg,#1a3a6a,#0d2240);border:2px solid #2a4a7a;background-image:repeating-linear-gradient(45deg,transparent,transparent 5px,rgba(255,255,255,0.03) 5px,rgba(255,255,255,0.03) 10px);}' +
        '.bj_red{color:#cc0000;} .bj_blk{color:#111;}' +
        '.pk_seat{width:110px;padding:10px;border-radius:12px;text-align:center;font-size:0.68rem;transition:all 0.2s;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.3);}' +
        '.pk_seat.occ{border-color:rgba(0,255,136,0.3);background:rgba(0,255,136,0.04);}' +
        '.pk_seat.turn{border-color:rgba(255,215,0,0.6);box-shadow:0 0 15px rgba(255,215,0,0.15);}' +
        '.pk_seat.fold{opacity:0.4;}' +
        '.plinko_canvas{width:100%;border-radius:8px;background:#06060f;border:1px solid #161628;display:block;}' +
        '.crash_canvas{width:100%;height:200px;border-radius:8px;background:#06060f;border:1px solid #161628;display:block;}' +
        '.crash_multi{font-family:"Bebas Neue",sans-serif;font-size:2.8rem;letter-spacing:2px;text-align:center;margin:0.3rem 0;transition:color 0.15s;}' +
        '</style>' +

        // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">üé∞ LNL CASINO</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">All wins paid in \ud83e\udd6c Cabbage \u00b7 SOL bets fill the treasury</div>' +
          '</div>' +
          '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
        '</div>' +

        // ‚îÄ‚îÄ Balance bar ‚îÄ‚îÄ
        '<div class="g_card" style="display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.4rem;">' +
          '<div style="display:flex;gap:1.5rem;flex:1;flex-wrap:wrap;">' +
            '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;">SOL Balance</div><div style="font-weight:700;color:#00d4ff;font-size:1rem;" id="g_solBal">‚Ä¶</div></div>' +
            '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;">Cabbage Balance</div><div style="font-weight:700;color:#00ff88;font-size:1rem;" id="g_cabBal">‚Ä¶</div></div>' +
            '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;">LNL NFTs</div><div style="font-weight:700;color:#7b68ee;font-size:1rem;">' + nftCount + (bonus > 0 ? ' <span style="font-size:0.65rem;color:#ffd700;">+' + (bonus*100).toFixed(0) + '% boost</span>' : '') + '</div></div>' +
          '</div>' +
          '<div style="display:flex;gap:0.5rem;">' +
            '<button class="g_btn ' + (g_currency==='sol'?'g_btn-primary':'') + '" id="g_btnSol" onclick="g_setCurrency(\'sol\')">‚óé SOL</button>' +
            '<button class="g_btn ' + (g_currency==='cabbage'?'g_btn-primary':'') + '" id="g_btnCab" onclick="g_setCurrency(\'cabbage\')">ü•¨ Cabbage</button>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ NFT Prize Pot ‚îÄ‚îÄ
        '<div class="g_card">' +
          '<div class="g_title">üèÜ NFT PRIZE POT</div>' +
          '<div style="margin-bottom:0.9rem;">' +
            '<div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#555;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;"><span>‚óé SOL POT</span><span id="g_solPotLabel">Loading‚Ä¶</span></div>' +
            '<div class="g_pot-bar"><div class="g_pot-fill" id="g_solPotBar" style="width:0%;background:linear-gradient(90deg,#9945ff,#00d4ff);"></div></div>' +
          '</div>' +
          '<div>' +
            '<div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#555;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;"><span>ü•¨ CABBAGE POT</span><span id="g_cabPotLabel">Loading‚Ä¶</span></div>' +
            '<div class="g_pot-bar"><div class="g_pot-fill" id="g_cabPotBar" style="width:0%;background:linear-gradient(90deg,#00ff88,#00d4ff);"></div></div>' +
          '</div>' +
          '<div style="margin-top:0.8rem;font-size:0.65rem;color:#333;letter-spacing:0.5px;">When a pot fills, a random recent player wins an LNL NFT airdropped to their wallet automatically.</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Bet Amount ‚îÄ‚îÄ
        '<div class="g_card">' +
          '<div class="g_title">BET AMOUNT</div>' +
          '<div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">' +
            '<button class="g_btn" onclick="g_setBet(0.01)">0.01</button>' +
            '<button class="g_btn" onclick="g_setBet(0.05)">0.05</button>' +
            '<button class="g_btn" onclick="g_setBet(0.1)">0.1</button>' +
            '<button class="g_btn" onclick="g_setBet(0.25)">0.25</button>' +
            '<button class="g_btn" onclick="g_setBet(0.5)">0.5</button>' +
            '<button class="g_btn" onclick="g_setBet(1)">1</button>' +
            '<span style="color:#555;margin:0 4px;">|</span>' +
            '<input id="g_betInput" type="number" min="0.001" step="0.001" value="' + g_betAmount + '" onchange="g_betAmount=parseFloat(this.value)||0.05" style="width:80px;background:#06060f;border:1px solid #1e1e3a;color:#e0e0ff;padding:8px 10px;border-radius:8px;font-family:\'Space Grotesk\',sans-serif;font-size:0.85rem;text-align:center;" />' +
            '<span id="g_betCurrLabel" style="color:#555;font-size:0.78rem;">' + (g_currency==='sol'?'‚óé':'ü•¨') + '</span>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Games row ‚îÄ‚îÄ
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.2rem;margin-bottom:1.2rem;">' +

          // COIN FLIP
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">ü™ô COIN FLIP</div>' +
            '<div style="text-align:center;margin:0.6rem 0;">' +
              '<div class="g_coin"><div class="g_coin-inner g_coin-heads" id="g_coinInner">üëë</div></div>' +
              '<div style="color:#555;font-size:0.7rem;margin-top:6px;letter-spacing:1px;">43% WIN ¬∑ 1.80√ó PAYOUT</div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">' +
              '<button class="g_btn g_btn-primary" id="g_coinHeadsBtn" onclick="g_playCoinGame(\'heads\')">üëë HEADS</button>' +
              '<button class="g_btn g_btn-primary" id="g_coinTailsBtn" onclick="g_playCoinGame(\'tails\')">ü™∂ TAILS</button>' +
            '</div>' +
            '<div class="g_result" id="g_coinResult" style="display:none;"></div>' +
          '</div>' +

          // DICE ROLL
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">üé≤ DICE ROLL</div>' +
            '<div style="text-align:center;margin:0.6rem 0 0.8rem;">' +
              '<div id="g_diceFace" style="font-size:3.5rem;line-height:1;">üé≤</div>' +
              '<div style="color:#555;font-size:0.7rem;margin-top:6px;letter-spacing:1px;">45% WIN ¬∑ 1.75√ó PAYOUT</div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">' +
              '<button class="g_btn" onclick="g_playDiceGame(\'high\')">HIGH (4-6)</button>' +
              '<button class="g_btn" onclick="g_playDiceGame(\'low\')">LOW (1-3)</button>' +
              '<button class="g_btn" onclick="g_playDiceGame(\'even\')">EVEN</button>' +
              '<button class="g_btn" onclick="g_playDiceGame(\'odd\')">ODD</button>' +
            '</div>' +
            '<div class="g_result" id="g_diceResult" style="display:none;"></div>' +
          '</div>' +

          // SLOTS
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">üé∞ SLOTS</div>' +
            '<div style="text-align:center;margin:0.8rem 0;">' +
              '<div style="display:flex;gap:8px;justify-content:center;" id="g_slotReels">' +
                '<div class="g_reel" id="g_reel0">ü™∂</div>' +
                '<div class="g_reel" id="g_reel1">ü™∂</div>' +
                '<div class="g_reel" id="g_reel2">ü™∂</div>' +
              '</div>' +
              '<div style="color:#555;font-size:0.65rem;margin-top:8px;letter-spacing:0.5px;">ü™∂ü™∂ü™∂ = 15√ó ¬∑ 3-kind = 7√ó ¬∑ 2-kind = 1.8√ó</div>' +
            '</div>' +
            '<button class="g_btn g_btn-primary" style="width:100%;" id="g_slotsBtn" onclick="g_playSlotsGame()">SPIN</button>' +
            '<div class="g_result" id="g_slotsResult" style="display:none;"></div>' +
          '</div>' +

          // BLACKJACK
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">üÉè BLACKJACK</div>' +
            '<div id="bj_table" style="text-align:center;min-height:165px;">' +
              '<div style="font-size:0.6rem;color:#555;letter-spacing:1px;margin-bottom:4px;">DEALER</div>' +
              '<div id="bj_dealerCards" style="display:flex;justify-content:center;gap:3px;min-height:74px;align-items:center;"><span style="color:#252540;font-size:0.75rem;">Press Deal to play</span></div>' +
              '<div id="bj_dealerScore" style="font-size:0.7rem;color:#888;margin:3px 0;min-height:16px;"></div>' +
              '<div style="height:1px;background:rgba(255,255,255,0.04);margin:4px 0;"></div>' +
              '<div id="bj_playerScore" style="font-size:0.7rem;color:#888;margin:3px 0;min-height:16px;"></div>' +
              '<div id="bj_playerCards" style="display:flex;justify-content:center;gap:3px;min-height:74px;align-items:center;"></div>' +
              '<div style="font-size:0.6rem;color:#555;letter-spacing:1px;margin-top:4px;">YOU</div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.4rem;margin-top:0.5rem;">' +
              '<button class="g_btn g_btn-primary" id="bj_dealBtn" onclick="bj_deal()">DEAL</button>' +
              '<button class="g_btn" id="bj_hitBtn" onclick="bj_hit()" disabled>HIT</button>' +
              '<button class="g_btn" id="bj_standBtn" onclick="bj_stand()" disabled>STAND</button>' +
              '<button class="g_btn" id="bj_doubleBtn" onclick="bj_double()" disabled>2√ó</button>' +
            '</div>' +
            '<div class="g_result" id="bj_result" style="display:none;"></div>' +
          '</div>' +

          // CABBAGE DROP (PLINKO)
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">ü•¨ CABBAGE DROP</div>' +
            '<canvas id="plinko_cv" class="plinko_canvas" width="300" height="340"></canvas>' +
            '<div style="display:flex;justify-content:center;gap:2px;margin-top:4px;" id="plinko_slots"></div>' +
            '<button class="g_btn g_btn-primary" style="width:100%;margin-top:0.5rem;" id="plinko_btn" onclick="plinko_drop()">DROP</button>' +
            '<div class="g_result" id="plinko_result" style="display:none;"></div>' +
          '</div>' +

          // CRASH
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">üìà CRASH</div>' +
            '<canvas id="crash_cv" class="crash_canvas" width="300" height="200"></canvas>' +
            '<div class="crash_multi" id="crash_multi" style="color:#555;">1.00√ó</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;">' +
              '<button class="g_btn g_btn-primary" id="crash_startBtn" onclick="crash_start()">BET & WATCH</button>' +
              '<button class="g_btn" id="crash_cashBtn" onclick="crash_cashout()" disabled style="border-color:rgba(0,255,136,0.3);color:#00ff88;">CASH OUT</button>' +
            '</div>' +
            '<div style="display:flex;align-items:center;gap:6px;margin-top:6px;">' +
              '<span style="color:#555;font-size:0.65rem;">Auto cash:</span>' +
              '<input id="crash_auto" type="number" min="1.1" step="0.1" value="2" style="width:60px;background:#06060f;border:1px solid #1e1e3a;color:#e0e0ff;padding:5px 8px;border-radius:6px;font-family:\'Space Grotesk\',sans-serif;font-size:0.78rem;text-align:center;" />' +
              '<span style="color:#555;font-size:0.65rem;">√ó</span>' +
            '</div>' +
            '<div class="g_result" id="crash_result" style="display:none;"></div>' +
          '</div>' +

        '</div>' +

        // ‚îÄ‚îÄ History ‚îÄ‚îÄ
        '<div class="g_card">' +
          '<div class="g_title">BET HISTORY</div>' +
          '<div id="g_historyList"><div style="color:#252540;font-size:0.75rem;text-align:center;padding:1rem;letter-spacing:1px;">No games played yet</div></div>' +
        '</div>' +

        // ‚îÄ‚îÄ Texas Hold\'em Poker Lobby ‚îÄ‚îÄ
        '<div class="g_card">' +
          '<div class="g_title">üÉè TEXAS HOLD\'EM ‚Äî LIVE TABLES</div>' +
          '<div style="font-size:0.72rem;color:#444;margin-bottom:1rem;">Sit down with up to 5 players. Buy in with ü•¨. Winner takes the pot.</div>' +
          '<div id="pk_lobby"><div style="text-align:center;padding:1rem;color:#252540;font-size:0.78rem;">Loading tables‚Ä¶</div></div>' +
        '</div>' +

        // ‚îÄ‚îÄ Poker Game Area (hidden until seated) ‚îÄ‚îÄ
        '<div id="pk_gameWrap" style="display:none;">' +
          '<div class="g_card" style="position:relative;min-height:400px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.8rem;">' +
              '<div class="g_title" style="margin:0;" id="pk_tableName">TABLE</div>' +
              '<button class="g_btn" onclick="pk_leaveTable()">Leave Table</button>' +
            '</div>' +
            '<div id="pk_gameArea"></div>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Footer ‚îÄ‚îÄ
        '<div style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:0.9rem 1.2rem;font-size:0.63rem;color:#2a2a44;letter-spacing:0.8px;text-align:center;line-height:2.2;text-transform:uppercase;">' +
          '‚óé SOL Bets ‚Üí <span style="font-family:monospace;color:#333;">' + g_SOL_TREASURY + '</span><br>' +
          'üèÜ NFT Prizes From ‚Üí <span style="font-family:monospace;color:#333;">' + g_NFT_TREASURY + '</span><br>' +
          'SOL bets ‚Üí treasury ¬∑ All wins paid in ü•¨ (1 ‚óé = 100 ü•¨) ¬∑ House profit fills NFT prize pot ¬∑ Play responsibly' +
        '</div>' +

        // ‚îÄ‚îÄ Winner Modal ‚îÄ‚îÄ
        '<div id="g_winnerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;padding:2rem;">' +
          '<div id="g_confettiContainer" style="position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:10000;"></div>' +
          '<div style="position:relative;z-index:10001;background:linear-gradient(135deg,#111125,#0d0d20);border:2px solid #ffd700;box-shadow:0 0 60px rgba(255,215,0,0.3);border-radius:20px;padding:2.5rem;max-width:480px;width:100%;text-align:center;">' +
            '<div style="font-size:4rem;animation:g_pulse 1.5s infinite;">ü™∂</div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:2rem;letter-spacing:4px;color:#ffd700;margin:0.5rem 0;">üéâ NFT AIRDROP!</div>' +
            '<div style="color:#00ff88;font-size:1rem;font-weight:700;margin-bottom:0.5rem;" id="g_winnerNFT">LNL NFT</div>' +
            '<div style="color:#888;font-size:0.8rem;margin-bottom:1rem;">Airdropped to lucky winner:</div>' +
            '<div style="font-family:monospace;font-size:0.7rem;color:#555;word-break:break-all;background:rgba(0,0,0,0.3);padding:0.8rem;border-radius:8px;margin-bottom:0.8rem;" id="g_winnerWallet"></div>' +
            '<div style="margin-bottom:1.5rem;" id="g_winnerTx"></div>' +
            '<div style="color:#888;font-size:0.72rem;margin-bottom:1.5rem;">The pot has been reset. Keep playing for the next NFT drop!</div>' +
            '<button class="g_btn g_btn-primary" onclick="g_closeWinnerModal()">AWESOME!</button>' +
          '</div>' +
        '</div>';

      // Load balances and pot
      g_loadGameBalances();
      g_updatePotUI();
      g_renderHistory();
      pk_loadLobby();
      setTimeout(function(){ plinko_init(); crash_init(); }, 100);
    }

    function g_setCurrency(cur) {
      g_currency = cur;
      var bs = document.getElementById('g_btnSol');
      var bc = document.getElementById('g_btnCab');
      var bl = document.getElementById('g_betCurrLabel');
      if (bs) { bs.classList.toggle('g_btn-primary', cur==='sol'); bs.style.borderColor=cur==='sol'?'rgba(0,212,255,0.45)':''; bs.style.color=cur==='sol'?'#00d4ff':''; }
      if (bc) { bc.classList.toggle('g_btn-primary', cur==='cabbage'); bc.style.borderColor=cur==='cabbage'?'rgba(0,212,255,0.45)':''; bc.style.color=cur==='cabbage'?'#00d4ff':''; }
      if (bl) bl.textContent = cur==='sol' ? '‚óé' : 'ü•¨';
    }

    function g_setBet(amt) {
      g_betAmount = amt;
      var inp = document.getElementById('g_betInput');
      if (inp) inp.value = amt;
    }

    function g_setResult(id, msg, win) {
      var el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'block';
      el.textContent = msg;
      el.style.color = win ? '#00ff88' : '#ff3c5c';
      el.style.background = win ? 'rgba(0,255,136,0.06)' : 'rgba(255,60,92,0.06)';
      el.style.border = win ? '1px solid rgba(0,255,136,0.18)' : '1px solid rgba(255,60,92,0.18)';
    }

    function g_disableGameBtns(dis) {
      ['g_coinHeadsBtn','g_coinTailsBtn','g_slotsBtn','bj_dealBtn','plinko_btn','crash_startBtn'].forEach(function(id){
        var b = document.getElementById(id);
        if (b) b.disabled = dis;
      });
      document.querySelectorAll('[onclick^="g_playDiceGame"]').forEach(function(b){ b.disabled = dis; });
    }

    async function g_runBet(betAmt, currency) {
      // Validate
      if (currency === 'sol') {
        var solBal = await g_fetchSolBalance();
        if (solBal === null || solBal < betAmt + 0.002) throw new Error('Insufficient SOL (need ' + (betAmt+0.002).toFixed(3) + ' ‚óé incl. fee)');
        var lamports = Math.round(betAmt * 1e9);
        await g_sendSolBet(lamports);
      } else {
        var cabBal = await g_fetchCabbageBalance();
        if (cabBal === null || cabBal < betAmt) throw new Error('Insufficient Cabbage balance (' + Math.floor(cabBal||0) + ' ü•¨)');
        await g_spendCabbage(betAmt);
      }
    }

    async function g_playCoinGame(choice) {
      if (g_isSpinning) return;
      g_isSpinning = true;
      g_disableGameBtns(true);
      var coinEl = document.getElementById('g_coinInner');
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;
      try {
        await g_runBet(bet, g_currency);
        if (coinEl) { coinEl.className = 'g_coin-inner spinning'; coinEl.textContent = ''; }
        await new Promise(function(r){ setTimeout(r, 1200); });
        var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;
        var won = Math.random() < (g_GAMES.coin.winChance + g_nftBonus(nftCount));
        var flipResult = won ? choice : (choice === 'heads' ? 'tails' : 'heads');
        var isH = flipResult === 'heads';
        if (coinEl) { coinEl.className = 'g_coin-inner landed ' + (isH ? 'g_coin-heads' : 'g_coin-tails'); coinEl.textContent = isH ? 'üëë' : 'ü™∂'; }
        var multiplier = g_GAMES.coin.payout;
        var cabPay = 0;
        if (won) { cabPay = g_currency === 'sol' ? bet * multiplier * g_SOL_TO_CABBAGE : bet * multiplier; await g_creditCabbage(cabPay); }
        if (won) { g_setResult('g_coinResult', '‚úÖ ' + flipResult.toUpperCase() + '! Won ' + cabPay.toFixed(2) + ' ü•¨', true); }
        else { g_setResult('g_coinResult', 'üíÄ ' + flipResult.toUpperCase() + '! Lost ' + bet.toFixed(4) + (g_currency==='sol'?' ‚óé':' ü•¨'), false); }
        g_addHistory('ü™ô Coin', bet, g_currency, won, cabPay);
        await g_logBet('ü™ô Coin Flip', bet, g_currency, won ? 0 : bet);
        await g_updatePotUI(); await g_loadGameBalances();
      } catch(e) {
        g_setResult('g_coinResult', '‚ö† ' + (e.message || 'Error'), false);
        if (coinEl) { coinEl.className = 'g_coin-inner g_coin-heads'; coinEl.textContent = 'üëë'; }
      }
      g_isSpinning = false;
      g_disableGameBtns(false);
    }

    async function g_playDiceGame(choice) {
      if (g_isSpinning) return;
      g_isSpinning = true;
      g_disableGameBtns(true);
      var diceEl = document.getElementById('g_diceFace');
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;

      try {
        await g_runBet(bet, g_currency);

        if (diceEl) { var frames = ['1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£']; var fi = 0; var anim = setInterval(function(){ diceEl.textContent = frames[fi++ % 6]; }, 100); }
        await new Promise(function(r){ setTimeout(r, 700); });
        if (typeof anim !== 'undefined') clearInterval(anim);

        var result = g_playDice(choice);
        var diceNums = ['1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£'];
        if (diceEl) diceEl.textContent = diceNums[result.roll - 1];

        var cabPay = 0;
        if (result.won) { cabPay = g_currency === 'sol' ? bet * g_GAMES.dice.payout * g_SOL_TO_CABBAGE : bet * g_GAMES.dice.payout; await g_creditCabbage(cabPay); }
        if (result.won) {
          g_setResult('g_diceResult', '‚úÖ Rolled ' + result.roll + ' (' + choice.toUpperCase() + ')! Won ' + cabPay.toFixed(2) + ' ü•¨', true);
        } else {
          g_setResult('g_diceResult', '‚ùå Rolled ' + result.roll + ' (' + choice.toUpperCase() + '). Lost ' + bet.toFixed(4) + (g_currency==='sol'?' ‚óé':' ü•¨'), false);
        }

        g_addHistory('üé≤ Dice', bet, g_currency, result.won, cabPay);
        await g_logBet('üé≤ Dice Roll', bet, g_currency, result.won ? 0 : bet);
        await g_updatePotUI();
        await g_loadGameBalances();
      } catch(e) {
        g_setResult('g_diceResult', '‚ö† ' + (e.message || 'Error'), false);
        if (diceEl) diceEl.textContent = 'üé≤';
      }
      g_isSpinning = false;
      g_disableGameBtns(false);
    }

    async function g_playSlotsGame() {
      if (g_isSpinning) return;
      g_isSpinning = true;
      g_disableGameBtns(true);
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;

      try {
        await g_runBet(bet, g_currency);

        // Spin animation
        var spinSyms = ['ü™∂','üåø','üé≤','üíé','üî•','‚≠ê'];
        var si = 0;
        var spinAnim = setInterval(function(){
          for (var i = 0; i < 3; i++) {
            var el = document.getElementById('g_reel' + i);
            if (el) el.textContent = spinSyms[(si + i) % spinSyms.length];
          }
          si++;
        }, 80);
        await new Promise(function(r){ setTimeout(r, 800); });
        clearInterval(spinAnim);

        var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;
        var slotsResult = g_playSlots(nftCount);

        for (var i = 0; i < 3; i++) {
          var el = document.getElementById('g_reel' + i);
          if (el) el.textContent = slotsResult.reels[i];
        }

        var sWon = slotsResult.result !== 'loss';
        var cabPay = 0;
        if (sWon) { cabPay = g_currency === 'sol' ? bet * slotsResult.payout * g_SOL_TO_CABBAGE : bet * slotsResult.payout; await g_creditCabbage(cabPay); }

        var msg;
        if (slotsResult.result === 'jackpot') msg = 'üéâ JACKPOT! Won ' + cabPay.toFixed(2) + ' ü•¨';
        else if (slotsResult.result === 'three') msg = '‚úÖ THREE OF A KIND! Won ' + cabPay.toFixed(2) + ' ü•¨';
        else if (slotsResult.result === 'two') msg = '‚úÖ PAIR! Won ' + cabPay.toFixed(2) + ' ü•¨';
        else msg = '‚ùå No match. Lost ' + bet.toFixed(4) + (g_currency==='sol'?' ‚óé':' ü•¨');

        g_setResult('g_slotsResult', msg, sWon);
        g_addHistory('üé∞ Slots', bet, g_currency, sWon, cabPay);
        await g_logBet('üé∞ Slots', bet, g_currency, sWon ? 0 : bet);
        await g_updatePotUI();
        await g_loadGameBalances();
      } catch(e) {
        g_setResult('g_slotsResult', '‚ö† ' + (e.message || 'Error'), false);
      }
      g_isSpinning = false;
      g_disableGameBtns(false);
    }

    /* ================================================================
       BLACKJACK vs DEALER
    ================================================================ */
    var bj_deck=[],bj_pH=[],bj_dH=[],bj_state='idle',bj_bet=0;
    var BJ_S=['\u2660','\u2665','\u2666','\u2663'];
    var BJ_SC={'\u2660':'bj_blk','\u2665':'bj_red','\u2666':'bj_red','\u2663':'bj_blk'};
    var BJ_V=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];

    function bj_mkDeck(){var d=[];for(var s=0;s<4;s++)for(var v=0;v<13;v++)d.push({v:BJ_V[v],s:BJ_S[s]});for(var i=d.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=d[i];d[i]=d[j];d[j]=t;}return d;}
    function bj_cv(c){if(c.v==='A')return 11;if('KQJ'.indexOf(c.v)>=0)return 10;return parseInt(c.v);}
    function bj_hv(h){var t=0,a=0;for(var i=0;i<h.length;i++){t+=bj_cv(h[i]);if(h[i].v==='A')a++;}while(t>21&&a>0){t-=10;a--;}return t;}
    function bj_rc(c,hide){
      if(hide)return'<div class="bj_card bj_back"><div style="font-size:1.4rem;color:#2a4a7a;">üÇ†</div></div>';
      var cc=BJ_SC[c.s]||'bj_blk';
      return'<div class="bj_card bj_front '+cc+'"><div style="font-size:0.8rem;align-self:flex-start;margin:2px 0 0 4px;">'+c.v+'</div><div style="font-size:1.4rem;">'+c.s+'</div><div style="font-size:0.8rem;align-self:flex-end;margin:0 4px 2px 0;">'+c.v+'</div></div>';
    }
    function bj_paint(show){
      var dc=document.getElementById('bj_dealerCards'),pc=document.getElementById('bj_playerCards');
      var ds=document.getElementById('bj_dealerScore'),ps=document.getElementById('bj_playerScore');
      if(dc){var h='';for(var i=0;i<bj_dH.length;i++)h+=bj_rc(bj_dH[i],i===1&&!show);dc.innerHTML=h;}
      if(pc){var h2='';for(var j=0;j<bj_pH.length;j++)h2+=bj_rc(bj_pH[j],false);pc.innerHTML=h2;}
      if(ps)ps.textContent=bj_pH.length?'Hand: '+bj_hv(bj_pH):'';
      if(ds)ds.textContent=bj_dH.length?(show?'Hand: '+bj_hv(bj_dH):'Showing: '+bj_cv(bj_dH[0])):'';
    }
    function bj_btns(){
      var p=bj_state==='play';
      var d=document.getElementById('bj_dealBtn'),h=document.getElementById('bj_hitBtn'),s=document.getElementById('bj_standBtn'),db=document.getElementById('bj_doubleBtn');
      if(d)d.disabled=p;if(h)h.disabled=!p;if(s)s.disabled=!p;if(db)db.disabled=!p||bj_pH.length!==2;
    }
    async function bj_deal(){
      if(bj_state==='play')return;
      var bet=parseFloat(document.getElementById('g_betInput').value)||g_betAmount;g_betAmount=bet;bj_bet=bet;
      try{await g_runBet(bet,g_currency);}catch(e){g_setResult('bj_result','‚ö† '+(e.message||'Error'),false);return;}
      var r=document.getElementById('bj_result');if(r)r.style.display='none';
      bj_deck=bj_mkDeck();bj_pH=[bj_deck.pop(),bj_deck.pop()];bj_dH=[bj_deck.pop(),bj_deck.pop()];
      bj_state='play';bj_paint(false);bj_btns();
      if(bj_hv(bj_pH)===21)await bj_stand();
    }
    function bj_hit(){if(bj_state!=='play')return;bj_pH.push(bj_deck.pop());bj_paint(false);var db=document.getElementById('bj_doubleBtn');if(db)db.disabled=true;if(bj_hv(bj_pH)>21){bj_state='done';bj_paint(true);bj_end();}}
    async function bj_double(){
      if(bj_state!=='play'||bj_pH.length!==2)return;
      try{await g_runBet(bj_bet,g_currency);bj_bet*=2;}catch(e){g_setResult('bj_result','‚ö† '+(e.message||'Error'),false);return;}
      bj_pH.push(bj_deck.pop());bj_paint(false);
      if(bj_hv(bj_pH)>21){bj_state='done';bj_paint(true);bj_end();}else await bj_stand();
    }
    async function bj_stand(){
      if(bj_state!=='play')return;bj_state='dealer';bj_btns();bj_paint(true);
      while(bj_hv(bj_dH)<17){await new Promise(function(r){setTimeout(r,400);});bj_dH.push(bj_deck.pop());bj_paint(true);}
      bj_state='done';await bj_end();
    }
    async function bj_end(){
      var pV=bj_hv(bj_pH),dV=bj_hv(bj_dH);
      var pBJ=bj_pH.length===2&&pV===21,dBJ=bj_dH.length===2&&dV===21;
      var won=false,push=false,cab=0,msg='';
      if(pV>21){msg='üíÄ BUST! Lost '+bj_bet.toFixed(4)+(g_currency==='sol'?' ‚óé':' ü•¨');}
      else if(dV>21){won=true;msg='‚úÖ Dealer busts!';}
      else if(pBJ&&!dBJ){won=true;msg='üéâ BLACKJACK!';}
      else if(pBJ&&dBJ){push=true;msg='ü§ù Both Blackjack ‚Äî Push';}
      else if(dBJ){msg='üíÄ Dealer Blackjack!';}
      else if(pV>dV){won=true;msg='‚úÖ You win! '+pV+' vs '+dV;}
      else if(pV===dV){push=true;msg='ü§ù Push ‚Äî '+pV+' vs '+dV;}
      else{msg='üíÄ Dealer wins. '+dV+' vs '+pV;}
      if(won){var m=pBJ?2.5:2;cab=g_currency==='sol'?bj_bet*m*g_SOL_TO_CABBAGE:bj_bet*m;await g_creditCabbage(cab);msg+=' Won '+cab.toFixed(2)+' ü•¨';}
      else if(push){var ref=g_currency==='sol'?bj_bet*g_SOL_TO_CABBAGE:bj_bet;await g_creditCabbage(ref);msg+=' (refund '+ref.toFixed(2)+' ü•¨)';}
      g_setResult('bj_result',msg,won);
      g_addHistory('üÉè BJ',bj_bet,g_currency,won,cab);
      await g_logBet('üÉè Blackjack',bj_bet,g_currency,won?0:bj_bet);
      await g_updatePotUI();await g_loadGameBalances();
      bj_state='idle';bj_btns();bj_paint(true);
    }

    /* ================================================================
       TEXAS HOLD'EM ‚Äî MULTIPLAYER VIA SUPABASE REALTIME
    ================================================================ */
    var pk_tables=[],pk_tid=null,pk_tbl=null,pk_plrs=[],pk_mySeat=-1,pk_ch=null;
    var PK_SUITS={s:'‚ô†',h:'‚ô•',d:'‚ô¶',c:'‚ô£'};
    var PK_SCOL={s:'#999',h:'#e33',d:'#e33',c:'#999'};
    var PK_VALS=['2','3','4','5','6','7','8','9','T','J','Q','K','A'];

    function pk_rc(card,hide){
      if(hide||!card)return'<div class="bj_card bj_back" style="width:52px;height:74px;"><div style="font-size:1.2rem;color:#2a4a7a;">üÇ†</div></div>';
      var v=card[0],s=card[1];var dv={'T':'10'}[v]||v;var suit=PK_SUITS[s]||s;var col=PK_SCOL[s]||'#999';
      return'<div class="bj_card bj_front" style="width:52px;height:74px;color:'+col+';"><div style="font-size:0.72rem;align-self:flex-start;margin:2px 0 0 3px;">'+dv+'</div><div style="font-size:1.2rem;">'+suit+'</div><div style="font-size:0.72rem;align-self:flex-end;margin:0 3px 2px 0;">'+dv+'</div></div>';
    }
    function pk_fullDeck(){var d=[];'shdc'.split('').forEach(function(s){PK_VALS.forEach(function(v){d.push(v+s);});});return d;}
    function pk_shuffle(a){var r=a.slice();for(var i=r.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=r[i];r[i]=r[j];r[j]=t;}return r;}

    async function pk_loadLobby(){
      var el=document.getElementById('pk_lobby');if(!el)return;
      try{
        var sb=getSupaClient();
        var tR=await sb.from('poker_tables').select('*').order('buy_in',{ascending:true});
        if(tR.error)throw tR.error;pk_tables=tR.data||[];
        var ids=pk_tables.map(function(t){return t.id;});
        if(ids.length===0){el.innerHTML='<div style="color:#333;text-align:center;font-size:0.75rem;">No tables yet</div>';return;}
        var pR=await sb.from('poker_players').select('table_id,seat').in('table_id',ids).eq('is_active',true);
        var ps=pR.data||[];
        var html='';
        pk_tables.forEach(function(t){
          var cnt=ps.filter(function(p){return p.table_id===t.id;}).length;
          var isSol=t.currency==='sol';
          var sym=isSol?'‚óé':'ü•¨';
          var badge=isSol?'<span style="background:linear-gradient(90deg,#9945ff,#00d4ff);color:#fff;padding:2px 6px;border-radius:4px;font-size:0.55rem;font-weight:700;letter-spacing:1px;margin-left:6px;">SOL</span>':'';
          html+='<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(0,0,0,0.2);border:1px solid '+(isSol?'rgba(153,69,255,0.2)':'rgba(255,255,255,0.06)')+';border-radius:10px;margin-bottom:8px;flex-wrap:wrap;gap:8px;">'
            +'<div><div style="font-weight:700;color:#e0e0ff;font-size:0.85rem;">'+escapeHtml(t.name)+badge+'</div>'
            +'<div style="font-size:0.65rem;color:#555;margin-top:2px;">Buy-in: '+t.buy_in+' '+sym+' ¬∑ Blinds: '+t.small_blind+'/'+t.big_blind+'</div></div>'
            +'<div style="display:flex;align-items:center;gap:10px;">'
            +'<div style="font-size:0.72rem;color:'+(cnt>=5?'#ff3c5c':(cnt>=2?'#00ff88':'#555'))+';">'+cnt+'/5</div>'
            +'<button class="g_btn'+(cnt<5?' g_btn-primary':'')+'" onclick="pk_join('+t.id+')" '+(cnt>=5?'disabled':'')+'>'+( cnt>=5?'FULL':'SIT DOWN')+'</button>'
            +'</div></div>';
        });
        el.innerHTML=html;
      }catch(e){el.innerHTML='<div style="color:#ff3c5c;font-size:0.75rem;">Failed to load tables</div>';}
    }

    async function pk_join(tid){
      if(!walletPublicKey)return alert('Connect wallet first.');
      var tbl=pk_tables.find(function(t){return t.id===tid;});if(!tbl)return;
      var isSol=tbl.currency==='sol';
      if(isSol){
        var solBal=await g_fetchSolBalance();
        if(solBal===null||solBal<tbl.buy_in+0.002)return alert('Need '+(tbl.buy_in+0.002).toFixed(3)+' ‚óé (incl. fee). You have '+(solBal||0).toFixed(3)+' ‚óé.');
      }else{
        var cabBal=await g_fetchCabbageBalance();
        if(cabBal<tbl.buy_in)return alert('Need '+tbl.buy_in+' ü•¨ to sit. You have '+Math.floor(cabBal)+'.');
      }
      try{
        var sb=getSupaClient();var w=walletPublicKey.toBase58();
        var ex=await sb.from('poker_players').select('*').eq('table_id',tid).eq('wallet',w).eq('is_active',true).maybeSingle();
        if(ex.data){pk_tid=tid;pk_mySeat=ex.data.seat;pk_open();return;}
        await sb.from('poker_players').delete().eq('table_id',tid).eq('wallet',w);
        var sR=await sb.from('poker_players').select('seat').eq('table_id',tid).eq('is_active',true);
        var taken=(sR.data||[]).map(function(p){return p.seat;});
        var open=-1;for(var i=0;i<5;i++){if(taken.indexOf(i)===-1){open=i;break;}}
        if(open===-1)return alert('Table full.');
        if(isSol){await g_sendSolBet(Math.round(tbl.buy_in*1e9));}
        else{await g_spendCabbage(tbl.buy_in);}
        var un=(session&&session.profile&&session.profile.username)||null;
        await sb.from('poker_players').insert({table_id:tid,wallet:w,username:un,seat:open,chips:tbl.buy_in,is_active:true});
        pk_tid=tid;pk_mySeat=open;pk_open();
      }catch(e){alert('Join failed: '+(e.message||e));}
    }

    async function pk_open(){
      document.getElementById('pk_gameWrap').style.display='block';
      await pk_refresh();pk_sub();
    }

    async function pk_refresh(){
      if(!pk_tid)return;var sb=getSupaClient();
      var tR=await sb.from('poker_tables').select('*').eq('id',pk_tid).single();
      if(tR.error)return;pk_tbl=tR.data;
      var pR=await sb.from('poker_players').select('*').eq('table_id',pk_tid).eq('is_active',true).order('seat',{ascending:true});
      pk_plrs=pR.data||[];
      var tn=document.getElementById('pk_tableName');if(tn)tn.textContent='üÉè '+pk_tbl.name;
      pk_paint();
    }

    function pk_sub(){pk_unsub();var sb=getSupaClient();
      pk_ch=sb.channel('pk_'+pk_tid)
        .on('postgres_changes',{event:'*',schema:'public',table:'poker_tables',filter:'id=eq.'+pk_tid},function(){pk_refresh();})
        .on('postgres_changes',{event:'*',schema:'public',table:'poker_players',filter:'table_id=eq.'+pk_tid},function(){pk_refresh();})
        .subscribe();
    }
    function pk_unsub(){if(pk_ch){try{getSupaClient().removeChannel(pk_ch);}catch(e){}pk_ch=null;}}

    async function pk_leaveTable(){
      if(!pk_tid)return;var sb=getSupaClient();var w=walletPublicKey.toBase58();
      var me=pk_plrs.find(function(p){return p.wallet===w;});
      if(me&&me.chips>0){
        var isSol=pk_tbl&&pk_tbl.currency==='sol';
        if(isSol){
          var cabOut=me.chips*g_SOL_TO_CABBAGE;
          await g_creditCabbage(cabOut);
        }else{
          await g_creditCabbage(me.chips);
        }
      }
      await sb.from('poker_players').delete().eq('table_id',pk_tid).eq('wallet',w);
      pk_unsub();pk_tid=null;pk_tbl=null;pk_plrs=[];pk_mySeat=-1;
      document.getElementById('pk_gameWrap').style.display='none';pk_loadLobby();
    }

    function pk_paint(){
      var area=document.getElementById('pk_gameArea');if(!area||!pk_tbl)return;
      var t=pk_tbl;var myW=walletPublicKey?walletPublicKey.toBase58():'';
      var isSol=t.currency==='sol';var sym=isSol?'‚óé':'ü•¨';var chipCol=isSol?'#00d4ff':'#00ff88';
      var comm=[];try{comm=JSON.parse(t.community||'[]');}catch(e){}
      var isPlay=t.status==='playing';
      var me=pk_plrs.find(function(p){return p.wallet===myW;});if(me)pk_mySeat=me.seat;
      var isMyTurn=me&&t.action_seat===me.seat&&isPlay;
      var active=pk_plrs.filter(function(p){return p.is_active;});
      var html='';

      // Community cards
      html+='<div style="text-align:center;margin:0.5rem 0 1rem;"><div style="font-size:0.6rem;color:#555;letter-spacing:2px;margin-bottom:6px;">COMMUNITY</div><div style="display:flex;justify-content:center;gap:3px;min-height:58px;align-items:center;">';
      if(comm.length>0){comm.forEach(function(c){html+=pk_rc(c,false);});for(var p=comm.length;p<5;p++)html+='<div style="width:52px;height:74px;border:1px dashed rgba(255,255,255,0.06);border-radius:5px;"></div>';}
      else{for(var e=0;e<5;e++)html+='<div style="width:52px;height:74px;border:1px dashed rgba(255,255,255,0.06);border-radius:5px;"></div>';}
      html+='</div><div style="font-size:0.9rem;color:#ffd700;font-weight:700;margin-top:8px;">POT: '+(t.pot||0).toLocaleString()+' '+sym+'</div>';
      if(isSol)html+='<div style="font-size:0.55rem;color:#9945ff;margin-top:2px;">SOL TABLE ¬∑ Winnings paid as ü•¨ (1 ‚óé = '+g_SOL_TO_CABBAGE+' ü•¨)</div>';
      if(isPlay)html+='<div style="font-size:0.62rem;color:#555;margin-top:2px;">'+(t.phase||'').toUpperCase()+' ¬∑ Current bet: '+(t.current_bet||0)+' '+sym+'</div>';
      html+='</div>';

      // Seats
      html+='<div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:0.8rem 0;">';
      for(var s=0;s<5;s++){
        var pl=pk_plrs.find(function(p){return p.seat===s;});
        var isMe=pl&&pl.wallet===myW;var isTurn=t.action_seat===s&&isPlay;var folded=pl&&pl.folded;
        var cls='pk_seat'+(pl?' occ':'')+(isTurn?' turn':'')+(folded?' fold':'');
        html+='<div class="'+cls+'">';
        if(pl){
          var hole=[];try{hole=JSON.parse(pl.hole_cards||'[]');}catch(e){}
          var dn=pl.username||(pl.wallet.slice(0,4)+'‚Ä¶');
          var isDealer=t.dealer_seat===s;
          html+='<div style="font-weight:700;font-size:0.7rem;color:'+(isMe?'#00d4ff':'#e0e0ff')+';margin-bottom:3px;">'+(isDealer?'<span style="background:#ffd700;color:#000;padding:1px 4px;border-radius:3px;font-size:0.5rem;margin-right:3px;">D</span>':'')+escapeHtml(dn)+(isMe?' (you)':'')+'</div>';
          html+='<div style="display:flex;justify-content:center;gap:2px;margin:3px 0;">';
          if(hole.length===2&&(isMe||t.phase==='showdown'))html+=pk_rc(hole[0],false)+pk_rc(hole[1],false);
          else if(isPlay&&!folded)html+=pk_rc(null,true)+pk_rc(null,true);
          html+='</div>';
          html+='<div style="font-size:0.62rem;color:'+chipCol+';">'+pl.chips.toLocaleString()+' '+sym+'</div>';
          if(pl.current_bet>0)html+='<div style="font-size:0.58rem;color:#ffd700;">Bet: '+pl.current_bet+' '+sym+'</div>';
          if(folded)html+='<div style="font-size:0.58rem;color:#ff3c5c;">FOLDED</div>';
          if(isTurn)html+='<div style="font-size:0.52rem;color:#ffd700;animation:g_pulse 1s infinite;">‚è≥ YOUR TURN</div>';
        }else{html+='<div style="color:#252540;font-size:0.68rem;">Empty</div><div style="font-size:0.58rem;color:#333;">Seat '+(s+1)+'</div>';}
        html+='</div>';
      }
      html+='</div>';

      // Action buttons
      html+='<div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-top:0.8rem;">';
      if(!isPlay&&t.phase!=='showdown'&&active.length>=2&&me)html+='<button class="g_btn g_btn-primary" onclick="pk_deal()">üÉè DEAL</button>';
      if(isMyTurn&&!me.folded){
        var toCall=Math.max(0,(t.current_bet||0)-(me?me.current_bet:0));
        if(toCall===0)html+='<button class="g_btn g_btn-primary" onclick="pk_act(\'check\')">CHECK</button>';
        else html+='<button class="g_btn g_btn-primary" onclick="pk_act(\'call\')">CALL '+toCall+' '+sym+'</button>';
        html+='<button class="g_btn" onclick="pk_doRaise()">RAISE</button>';
        html+='<button class="g_btn" style="border-color:rgba(255,60,92,0.3);color:#ff3c5c;" onclick="pk_act(\'fold\')">FOLD</button>';
      }
      if(t.phase==='showdown'&&me)html+='<button class="g_btn g_btn-primary" onclick="pk_deal()">NEXT HAND</button>';
      html+='</div>';
      area.innerHTML=html;
    }

    async function pk_deal(){
      if(!pk_tid)return;var sb=getSupaClient();var t=pk_tbl;
      if(t.status==='playing')return;
      var ap=pk_plrs.filter(function(p){return p.is_active;});
      if(ap.length<2)return alert('Need 2+ players.');
      ap.sort(function(a,b){return a.seat-b.seat;});
      var deck=pk_shuffle(pk_fullDeck());
      for(var i=0;i<ap.length;i++){var h=[deck.pop(),deck.pop()];await sb.from('poker_players').update({hole_cards:JSON.stringify(h),current_bet:0,total_bet:0,folded:false,all_in:false}).eq('id',ap[i].id);}
      var seatNums=ap.map(function(p){return p.seat;});
      function nextAfter(s){for(var k=0;k<seatNums.length;k++){if(seatNums[k]>s)return seatNums[k];}return seatNums[0];}
      var oldDS=t.dealer_seat;if(oldDS===undefined||oldDS===null)oldDS=-1;
      var newDS=nextAfter(oldDS);
      var sbSeat,bbSeat,actSeat;
      if(ap.length===2){sbSeat=newDS;bbSeat=nextAfter(newDS);actSeat=newDS;}
      else{sbSeat=nextAfter(newDS);bbSeat=nextAfter(sbSeat);actSeat=nextAfter(bbSeat);}
      var sbP=ap.find(function(p){return p.seat===sbSeat;});
      var bbP=ap.find(function(p){return p.seat===bbSeat;});
      var sba=Math.min(t.small_blind,sbP.chips),bba=Math.min(t.big_blind,bbP.chips);
      await sb.from('poker_players').update({current_bet:sba,total_bet:sba,chips:sbP.chips-sba}).eq('id',sbP.id);
      await sb.from('poker_players').update({current_bet:bba,total_bet:bba,chips:bbP.chips-bba}).eq('id',bbP.id);
      await sb.from('poker_tables').update({status:'playing',phase:'preflop',community:'[]',pot:sba+bba,current_bet:bba,dealer_seat:newDS,action_seat:actSeat,round_starter:actSeat,deck:JSON.stringify(deck),hand_num:(t.hand_num||0)+1,updated_at:new Date().toISOString()}).eq('id',pk_tid);
    }

    function pk_doRaise(){var cur=pk_tbl?pk_tbl.current_bet||0:0;var a=prompt('Raise to:',String(cur*2));if(!a)return;var r=parseFloat(a);if(isNaN(r)||r<=cur)return alert('Must raise above '+cur);pk_act('raise',r);}

    async function pk_act(action,raiseAmt){
      if(!pk_tid||!pk_tbl)return;var sb=getSupaClient();var w=walletPublicKey.toBase58();
      var me=pk_plrs.find(function(p){return p.wallet===w;});if(!me||pk_tbl.action_seat!==me.seat)return;
      var t=pk_tbl;var potAdd=0;
      if(action==='fold'){await sb.from('poker_players').update({folded:true}).eq('id',me.id);}
      else if(action==='check'){/* no chips moved */}
      else if(action==='call'){var tc=Math.min(Math.max(0,(t.current_bet||0)-me.current_bet),me.chips);await sb.from('poker_players').update({chips:me.chips-tc,current_bet:me.current_bet+tc,total_bet:me.total_bet+tc,all_in:me.chips-tc<=0}).eq('id',me.id);potAdd=tc;}
      else if(action==='raise'){var need=raiseAmt-me.current_bet;var act=Math.min(need,me.chips);await sb.from('poker_players').update({chips:me.chips-act,current_bet:me.current_bet+act,total_bet:me.total_bet+act,all_in:me.chips-act<=0}).eq('id',me.id);potAdd=act;await sb.from('poker_tables').update({current_bet:raiseAmt,round_starter:me.seat}).eq('id',pk_tid);}
      if(potAdd>0)await sb.from('poker_tables').update({pot:(t.pot||0)+potAdd}).eq('id',pk_tid);
      await pk_advance(me,action);
    }

    async function pk_advance(acted,action){
      var sb=getSupaClient();
      var pR=await sb.from('poker_players').select('*').eq('table_id',pk_tid).eq('is_active',true).order('seat');
      var plrs=pR.data||[];
      var nf=plrs.filter(function(p){return !p.folded;});
      if(nf.length<=1){await pk_award(nf[0]);return;}
      var tR=await sb.from('poker_tables').select('*').eq('id',pk_tid).single();var t=tR.data;
      var canAct=plrs.filter(function(p){return !p.folded&&!p.all_in;});
      if(canAct.length===0){await pk_nextPhase();return;}
      var seats=canAct.map(function(p){return p.seat;}).sort(function(a,b){return a-b;});
      // Helper: find next seat clockwise after a given seat
      function findNext(afterSeat){for(var i=0;i<seats.length;i++){if(seats[i]>afterSeat)return seats[i];}return seats[0];}
      // If only 1 can act and they've matched the bet, advance
      if(canAct.length===1&&canAct[0].current_bet>=(t.current_bet||0)){await pk_nextPhase();return;}
      var nextSeat=findNext(acted.seat);
      // Resolve effective round_starter ‚Äî must be in canAct
      var rs=t.round_starter;
      var rsChanged=false;
      if(rs===undefined||rs===null||rs<0||seats.indexOf(rs)===-1){
        rs=findNext(rs!==undefined&&rs!==null&&rs>=0?rs:- 1);
        rsChanged=true;
        await sb.from('poker_tables').update({round_starter:rs}).eq('id',pk_tid);
      }
      // Check if all bets match and we've gone full circle back to round_starter
      var allMatch=canAct.every(function(p){return p.current_bet>=(t.current_bet||0);});
      if(allMatch&&nextSeat===rs&&!rsChanged){
        await pk_nextPhase();
        return;
      }
      await sb.from('poker_tables').update({action_seat:nextSeat,updated_at:new Date().toISOString()}).eq('id',pk_tid);
    }

    async function pk_nextPhase(){
      var sb=getSupaClient();
      var tR=await sb.from('poker_tables').select('*').eq('id',pk_tid).single();var t=tR.data;
      var deck=[];try{deck=JSON.parse(t.deck||'[]');}catch(e){}
      var comm=[];try{comm=JSON.parse(t.community||'[]');}catch(e){}
      await sb.from('poker_players').update({current_bet:0}).eq('table_id',pk_tid).eq('is_active',true);
      var next='';
      if(t.phase==='preflop'){next='flop';comm.push(deck.pop(),deck.pop(),deck.pop());}
      else if(t.phase==='flop'){next='turn';comm.push(deck.pop());}
      else if(t.phase==='turn'){next='river';comm.push(deck.pop());}
      else{await pk_showdown();return;}
      var cR=await sb.from('poker_players').select('*').eq('table_id',pk_tid).eq('is_active',true).eq('folded',false).eq('all_in',false).order('seat');
      var active=cR.data||[];
      if(active.length<=1){while(comm.length<5&&deck.length>0)comm.push(deck.pop());
        await sb.from('poker_tables').update({phase:'showdown',community:JSON.stringify(comm),deck:JSON.stringify(deck),current_bet:0,action_seat:-1,round_starter:-1,updated_at:new Date().toISOString()}).eq('id',pk_tid);
        setTimeout(pk_showdown,1200);return;}
      // Post-flop: first to act is first active player AFTER the dealer
      var ds=t.dealer_seat;
      var actSeats=active.map(function(p){return p.seat;}).sort(function(a,b){return a-b;});
      var firstSeat=actSeats[0];
      for(var i=0;i<actSeats.length;i++){if(actSeats[i]>ds){firstSeat=actSeats[i];break;}}
      await sb.from('poker_tables').update({phase:next,community:JSON.stringify(comm),deck:JSON.stringify(deck),current_bet:0,action_seat:firstSeat,round_starter:firstSeat,updated_at:new Date().toISOString()}).eq('id',pk_tid);
    }

    async function pk_showdown(){
      var sb=getSupaClient();
      var tR=await sb.from('poker_tables').select('*').eq('id',pk_tid).single();var t=tR.data;
      var comm=[];try{comm=JSON.parse(t.community||'[]');}catch(e){}
      var cR=await sb.from('poker_players').select('*').eq('table_id',pk_tid).eq('is_active',true).eq('folded',false);
      var cont=cR.data||[];
      if(cont.length<=1){if(cont[0])await pk_award(cont[0]);return;}
      var best=null,bestS=-1;
      cont.forEach(function(p){var h=[];try{h=JSON.parse(p.hole_cards||'[]');}catch(e){}var all=h.concat(comm);var sc=pk_score(all);if(sc>bestS){bestS=sc;best=p;}});
      if(best)await pk_award(best);
    }

    async function pk_award(winner){
      var sb=getSupaClient();
      var tR=await sb.from('poker_tables').select('pot').eq('id',pk_tid).single();
      var pot=tR.data?tR.data.pot:0;
      // Re-read fresh chips
      var pR=await sb.from('poker_players').select('chips').eq('id',winner.id).single();
      var freshChips=pR.data?pR.data.chips:winner.chips;
      await sb.from('poker_players').update({chips:freshChips+pot}).eq('id',winner.id);
      await sb.from('poker_tables').update({status:'between_hands',phase:'showdown',pot:0,current_bet:0,action_seat:-1,updated_at:new Date().toISOString()}).eq('id',pk_tid);
    }

    // ‚îÄ‚îÄ Hand evaluator ‚îÄ‚îÄ
    function pk_cn(c){var v={'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'T':10,'J':11,'Q':12,'K':13,'A':14};return v[c[0]]||0;}
    function pk_eval5(cards){
      var vals=cards.map(pk_cn).sort(function(a,b){return b-a;});
      var suits=cards.map(function(c){return c[1];});
      var flush=suits.every(function(s){return s===suits[0];});
      var str=vals[0]-vals[1]===1&&vals[1]-vals[2]===1&&vals[2]-vals[3]===1&&vals[3]-vals[4]===1;
      if(!str&&vals[0]===14&&vals[1]===5&&vals[2]===4&&vals[3]===3&&vals[4]===2){str=true;vals=[5,4,3,2,1];}
      var ct={};vals.forEach(function(v){ct[v]=(ct[v]||0)+1;});
      var g=Object.keys(ct).map(function(k){return{v:parseInt(k),c:ct[k]};}).sort(function(a,b){return b.c-a.c||b.v-a.v;});
      if(flush&&str)return vals[0]===14?9e6:8e6+vals[0];
      if(g[0].c===4)return 7e6+g[0].v*100+(g[1]?g[1].v:0);
      if(g[0].c===3&&g.length>=2&&g[1].c===2)return 6e6+g[0].v*100+g[1].v;
      if(flush)return 5e6+vals[0]*1e4+vals[1]*1e3+vals[2]*100+vals[3]*10+vals[4];
      if(str)return 4e6+vals[0];
      if(g[0].c===3)return 3e6+g[0].v*1e4+(g[1]?g[1].v*100:0)+(g[2]?g[2].v:0);
      if(g[0].c===2&&g.length>=2&&g[1].c===2){var hp=Math.max(g[0].v,g[1].v),lp=Math.min(g[0].v,g[1].v);return 2e6+hp*1e4+lp*100+(g[2]?g[2].v:0);}
      if(g[0].c===2)return 1e6+g[0].v*1e4+(g[1]?g[1].v*100:0)+(g[2]?g[2].v*10:0)+(g[3]?g[3].v:0);
      return vals[0]*1e4+vals[1]*1e3+vals[2]*100+vals[3]*10+vals[4];
    }
    function pk_score(seven){
      if(seven.length<5)return 0;var best=0;
      for(var i=0;i<seven.length;i++)for(var j=i+1;j<seven.length;j++)for(var k=j+1;k<seven.length;k++)for(var l=k+1;l<seven.length;l++)for(var m=l+1;m<seven.length;m++){
        var sc=pk_eval5([seven[i],seven[j],seven[k],seven[l],seven[m]]);if(sc>best)best=sc;}
      return best;
    }

    /* ================================================================
       CABBAGE DROP (PLINKO)
    ================================================================ */
    var PLINKO_ROWS = 10;
    var PLINKO_MULTS = [10, 3, 2, 1.5, 1, 0.5, 0.3, 0.5, 1, 1.5, 2, 3, 10];
    var PLINKO_COLORS = ['#ff3c5c','#ff6b35','#ffa033','#ffd700','#aaa','#888','#666','#888','#aaa','#ffd700','#ffa033','#ff6b35','#ff3c5c'];
    var plinko_running = false;

    function plinko_init() {
      var cv = document.getElementById('plinko_cv');
      if (!cv) return;
      var ctx = cv.getContext('2d');
      var W = cv.width, H = cv.height;
      ctx.clearRect(0, 0, W, H);

      // Draw pegs
      for (var row = 0; row < PLINKO_ROWS; row++) {
        var pegsInRow = row + 3;
        var spacing = W / (pegsInRow + 1);
        for (var col = 0; col < pegsInRow; col++) {
          var px = spacing * (col + 1);
          var py = 30 + row * ((H - 60) / PLINKO_ROWS);
          ctx.beginPath();
          ctx.arc(px, py, 4, 0, Math.PI * 2);
          ctx.fillStyle = '#2a2a4a';
          ctx.fill();
        }
      }

      // Draw bottom slots
      var slotEl = document.getElementById('plinko_slots');
      if (slotEl) {
        var sh = '';
        PLINKO_MULTS.forEach(function(m, i) {
          var c = PLINKO_COLORS[i];
          sh += '<div style="flex:1;text-align:center;font-size:0.5rem;font-weight:700;color:' + c + ';padding:3px 0;background:rgba(0,0,0,0.3);border-radius:3px;border:1px solid ' + c + '22;">' + m + '√ó</div>';
        });
        slotEl.innerHTML = sh;
      }
    }

    async function plinko_drop() {
      if (plinko_running || g_isSpinning) return;
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;

      try {
        await g_runBet(bet, g_currency);
      } catch(e) {
        g_setResult('plinko_result', '‚ö† ' + (e.message || 'Error'), false);
        return;
      }

      plinko_running = true;
      g_disableGameBtns(true);

      var cv = document.getElementById('plinko_cv');
      if (!cv) return;
      var ctx = cv.getContext('2d');
      var W = cv.width, H = cv.height;

      // Calculate ball path through pegs
      var ballX = W / 2 + (Math.random() - 0.5) * 20;
      var ballY = 8;
      var slot = 0;
      var path = [{x: ballX, y: ballY}];

      // Simulate drops through each row
      for (var row = 0; row < PLINKO_ROWS; row++) {
        var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;
        // Slight bias toward center for house edge
        var bias = (ballX > W/2) ? -0.02 : 0.02;
        var goRight = Math.random() + bias > 0.5;
        var pegsInRow = row + 3;
        var spacing = W / (pegsInRow + 1);
        var shift = spacing * 0.48 * (goRight ? 1 : -1);
        ballX = Math.max(15, Math.min(W - 15, ballX + shift));
        ballY = 30 + row * ((H - 60) / PLINKO_ROWS);
        path.push({x: ballX, y: ballY});
      }

      // Determine which slot
      var slotWidth = W / PLINKO_MULTS.length;
      slot = Math.floor(ballX / slotWidth);
      slot = Math.max(0, Math.min(PLINKO_MULTS.length - 1, slot));
      var mult = PLINKO_MULTS[slot];

      // Final landing
      var finalX = slotWidth * slot + slotWidth / 2;
      path.push({x: finalX, y: H - 12});

      // Animate ball
      var frame = 0;
      var totalFrames = path.length;

      function drawFrame() {
        ctx.clearRect(0, 0, W, H);

        // Redraw pegs
        for (var row = 0; row < PLINKO_ROWS; row++) {
          var pegsInRow = row + 3;
          var sp = W / (pegsInRow + 1);
          for (var col = 0; col < pegsInRow; col++) {
            ctx.beginPath();
            ctx.arc(sp * (col + 1), 30 + row * ((H - 60) / PLINKO_ROWS), 4, 0, Math.PI * 2);
            ctx.fillStyle = '#2a2a4a';
            ctx.fill();
          }
        }

        // Draw trail
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(0,255,136,0.3)';
        ctx.lineWidth = 2;
        for (var t = 0; t <= frame && t < path.length; t++) {
          if (t === 0) ctx.moveTo(path[t].x, path[t].y);
          else ctx.lineTo(path[t].x, path[t].y);
        }
        ctx.stroke();

        // Draw ball at current position
        var pt = path[Math.min(frame, path.length - 1)];
        ctx.beginPath();
        ctx.arc(pt.x, pt.y, 8, 0, Math.PI * 2);
        var grd = ctx.createRadialGradient(pt.x - 2, pt.y - 2, 1, pt.x, pt.y, 8);
        grd.addColorStop(0, '#7fff7f');
        grd.addColorStop(1, '#00aa00');
        ctx.fillStyle = grd;
        ctx.fill();
        ctx.strokeStyle = '#00ff88';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Draw slot highlight on last frame
        if (frame >= path.length - 1) {
          ctx.fillStyle = PLINKO_COLORS[slot] + '33';
          ctx.fillRect(slotWidth * slot, H - 25, slotWidth, 25);
        }

        frame++;
        if (frame < path.length + 1) {
          setTimeout(drawFrame, 120);
        } else {
          finishPlinko();
        }
      }

      drawFrame();

      async function finishPlinko() {
        var cabPay = 0;
        var won = mult >= 1;
        cabPay = g_currency === 'sol' ? bet * mult * g_SOL_TO_CABBAGE : bet * mult;
        if (cabPay > 0) await g_creditCabbage(cabPay);

        if (mult >= 2) {
          g_setResult('plinko_result', 'üéâ ' + mult + '√ó ‚Äî Won ' + cabPay.toFixed(2) + ' ü•¨!', true);
        } else if (mult >= 1) {
          g_setResult('plinko_result', '‚úÖ ' + mult + '√ó ‚Äî Got ' + cabPay.toFixed(2) + ' ü•¨', true);
        } else {
          g_setResult('plinko_result', 'üíÄ ' + mult + '√ó ‚Äî Got ' + cabPay.toFixed(2) + ' ü•¨', false);
        }

        g_addHistory('ü•¨ Drop', bet, g_currency, won, cabPay);
        await g_logBet('ü•¨ Cabbage Drop', bet, g_currency, won ? 0 : bet * (1 - mult));
        await g_updatePotUI();
        await g_loadGameBalances();
        plinko_running = false;
        g_isSpinning = false;
        g_disableGameBtns(false);
      }
    }

    /* ================================================================
       CRASH
    ================================================================ */
    var crash_running = false;
    var crash_cashed = false;
    var crash_point = 1;
    var crash_current = 1;
    var crash_bet = 0;
    var crash_raf = null;
    var crash_startTime = 0;
    var crash_history = [];

    function crash_init() {
      var cv = document.getElementById('crash_cv');
      if (!cv) return;
      var ctx = cv.getContext('2d');
      crash_drawChart(ctx, cv.width, cv.height, [], 1, false);

      // Draw recent crash history
      if (crash_history.length > 0) {
        var hEl = document.getElementById('crash_multi');
        if (hEl) hEl.textContent = '1.00√ó';
      }
    }

    function crash_genPoint() {
      // House edge ~3%: E[1/crashPoint] = 0.97
      var r = Math.random();
      if (r < 0.03) return 1.00; // instant crash 3% of time
      return Math.floor(100 * (0.97 / r)) / 100;
    }

    function crash_drawChart(ctx, W, H, points, current, crashed) {
      ctx.clearRect(0, 0, W, H);

      // Background grid
      ctx.strokeStyle = 'rgba(255,255,255,0.03)';
      ctx.lineWidth = 1;
      for (var gy = 1; gy < 6; gy++) {
        var yy = H - (gy / 6) * H;
        ctx.beginPath(); ctx.moveTo(0, yy); ctx.lineTo(W, yy); ctx.stroke();
      }

      if (points.length < 2) return;

      // Scale
      var maxM = Math.max(current, 2);
      var xScale = W / points.length;
      var yScale = (H - 20) / (maxM - 1);

      // Draw line
      ctx.beginPath();
      ctx.lineWidth = 3;
      var grad = ctx.createLinearGradient(0, H, 0, 0);
      if (crashed) {
        grad.addColorStop(0, '#ff3c5c');
        grad.addColorStop(1, '#ff6b35');
      } else {
        grad.addColorStop(0, '#00ff88');
        grad.addColorStop(1, '#00d4ff');
      }
      ctx.strokeStyle = grad;

      for (var i = 0; i < points.length; i++) {
        var x = i * xScale;
        var y = H - 10 - (points[i] - 1) * yScale;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // Glow under line
      ctx.lineTo(points.length * xScale, H);
      ctx.lineTo(0, H);
      ctx.closePath();
      ctx.fillStyle = crashed ? 'rgba(255,60,92,0.08)' : 'rgba(0,255,136,0.06)';
      ctx.fill();

      // Current multiplier dot
      if (points.length > 0) {
        var lx = (points.length - 1) * xScale;
        var ly = H - 10 - (points[points.length - 1] - 1) * yScale;
        ctx.beginPath();
        ctx.arc(lx, Math.max(5, ly), 5, 0, Math.PI * 2);
        ctx.fillStyle = crashed ? '#ff3c5c' : '#00ff88';
        ctx.fill();
      }
    }

    async function crash_start() {
      if (crash_running || g_isSpinning) return;
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;

      try {
        await g_runBet(bet, g_currency);
      } catch(e) {
        g_setResult('crash_result', '‚ö† ' + (e.message || 'Error'), false);
        return;
      }

      crash_running = true;
      crash_cashed = false;
      crash_bet = bet;
      crash_current = 1.00;
      crash_point = crash_genPoint();
      crash_startTime = Date.now();
      g_disableGameBtns(true);

      var sb = document.getElementById('crash_startBtn');
      var cb = document.getElementById('crash_cashBtn');
      if (sb) sb.disabled = true;
      if (cb) cb.disabled = false;

      var rEl = document.getElementById('crash_result');
      if (rEl) rEl.style.display = 'none';

      var cv = document.getElementById('crash_cv');
      var ctx = cv ? cv.getContext('2d') : null;
      var W = cv ? cv.width : 300;
      var H = cv ? cv.height : 200;
      var points = [1];
      var mEl = document.getElementById('crash_multi');

      function tick() {
        var elapsed = (Date.now() - crash_startTime) / 1000;
        // Exponential growth: starts slow, gets fast
        crash_current = Math.pow(Math.E, elapsed * 0.15);
        crash_current = Math.floor(crash_current * 100) / 100;

        // Auto cashout
        var autoVal = parseFloat(document.getElementById('crash_auto').value);
        if (autoVal && crash_current >= autoVal && !crash_cashed) {
          crash_cashout();
          return;
        }

        if (crash_current >= crash_point && !crash_cashed) {
          // CRASHED
          crash_current = crash_point;
          points.push(crash_current);
          if (ctx) crash_drawChart(ctx, W, H, points, crash_current, true);
          if (mEl) { mEl.textContent = crash_current.toFixed(2) + '√ó'; mEl.style.color = '#ff3c5c'; }
          crash_finish(false);
          return;
        }

        points.push(crash_current);
        if (ctx) crash_drawChart(ctx, W, H, points, crash_current, false);
        if (mEl) {
          mEl.textContent = crash_current.toFixed(2) + '√ó';
          if (crash_current < 1.5) mEl.style.color = '#00ff88';
          else if (crash_current < 3) mEl.style.color = '#ffd700';
          else if (crash_current < 5) mEl.style.color = '#ff6b35';
          else mEl.style.color = '#ff3c5c';
        }

        crash_raf = setTimeout(tick, 50);
      }

      tick();
    }

    async function crash_cashout() {
      if (!crash_running || crash_cashed) return;
      crash_cashed = true;

      if (crash_raf) { clearTimeout(crash_raf); crash_raf = null; }

      var cb = document.getElementById('crash_cashBtn');
      if (cb) cb.disabled = true;

      var mult = crash_current;
      var cabPay = g_currency === 'sol' ? crash_bet * mult * g_SOL_TO_CABBAGE : crash_bet * mult;
      await g_creditCabbage(cabPay);

      g_setResult('crash_result', 'üí∞ Cashed out at ' + mult.toFixed(2) + '√ó ‚Äî Won ' + cabPay.toFixed(2) + ' ü•¨!', true);
      g_addHistory('üìà Crash', crash_bet, g_currency, true, cabPay);
      await g_logBet('üìà Crash', crash_bet, g_currency, 0);
      await g_updatePotUI();
      await g_loadGameBalances();

      // Let the animation continue to show where it would have crashed
      var cv = document.getElementById('crash_cv');
      var ctx = cv ? cv.getContext('2d') : null;
      var W = cv ? cv.width : 300;
      var H = cv ? cv.height : 200;
      var mEl = document.getElementById('crash_multi');
      var points = [1, mult];

      function coastTick() {
        var elapsed = (Date.now() - crash_startTime) / 1000;
        var val = Math.pow(Math.E, elapsed * 0.15);
        val = Math.floor(val * 100) / 100;

        if (val >= crash_point) {
          points.push(crash_point);
          if (ctx) crash_drawChart(ctx, W, H, points, crash_point, true);
          if (mEl) { mEl.textContent = 'üí∞ ' + mult.toFixed(2) + '√ó (crashed @ ' + crash_point.toFixed(2) + '√ó)'; mEl.style.color = '#00ff88'; }
          crash_running = false;
          var sb = document.getElementById('crash_startBtn'); if (sb) sb.disabled = false;
          g_disableGameBtns(false);
          crash_history.unshift(crash_point);
          if (crash_history.length > 10) crash_history.pop();
          return;
        }

        points.push(val);
        if (ctx) crash_drawChart(ctx, W, H, points, val, false);
        setTimeout(coastTick, 50);
      }
      coastTick();
    }

    async function crash_finish(won) {
      crash_running = false;
      var cb = document.getElementById('crash_cashBtn');
      var sb = document.getElementById('crash_startBtn');
      if (cb) cb.disabled = true;
      if (sb) sb.disabled = false;

      if (!won) {
        g_setResult('crash_result', 'üí• CRASHED at ' + crash_point.toFixed(2) + '√ó ‚Äî Lost ' + crash_bet.toFixed(4) + (g_currency === 'sol' ? ' ‚óé' : ' ü•¨'), false);
        g_addHistory('üìà Crash', crash_bet, g_currency, false, 0);
        await g_logBet('üìà Crash', crash_bet, g_currency, crash_bet);
        await g_updatePotUI();
        await g_loadGameBalances();
      }

      crash_history.unshift(crash_point);
      if (crash_history.length > 10) crash_history.pop();
      g_disableGameBtns(false);
    }

    /* ================================================================
       PLAYER PROGRESSION SYSTEM
    ================================================================ */
    var pp_stats = null; // cached stats
    var pp_loaded = false;

    // XP sources: 1 XP per game played, 3 XP per win, 0.5 XP per chat msg, 0.1 XP per cabbage earned, 2 XP per day held
    // Level formula: level = floor(sqrt(xp / 10))  ‚Üí level 1 at 10xp, level 10 at 1000xp, level 50 at 25000xp
    function pp_levelFromXP(xp) { return Math.max(1, Math.floor(Math.sqrt(xp / 10))); }
    function pp_xpForLevel(lvl) { return lvl * lvl * 10; }

    // Neck Length titles based on level
    var PP_NECK_TITLES = [
      { min: 1,  name: 'Hatchling',     color: '#666' },
      { min: 3,  name: 'Short Neck',    color: '#888' },
      { min: 6,  name: 'Neck',          color: '#aaa' },
      { min: 10, name: 'Long Neck',     color: '#00d4ff' },
      { min: 15, name: 'Extra Long',    color: '#7b68ee' },
      { min: 25, name: 'Mega Neck',     color: '#ffd700' },
      { min: 40, name: 'Ultra Neck',    color: '#ff8c00' },
      { min: 60, name: 'God Neck',      color: '#ff3c5c' },
      { min: 99, name: 'Infinite Neck', color: '#00ffcc' }
    ];

    // Casino titles based on total games
    var PP_CASINO_TITLES = [
      { min: 0,   name: 'Spectator' },
      { min: 5,   name: 'Dabbler' },
      { min: 25,  name: 'Regular' },
      { min: 100, name: 'Degenerate' },
      { min: 250, name: 'High Roller' },
      { min: 500, name: 'Casino Boss' },
      { min: 1000,name: 'Legend Degen' }
    ];

    // Chat titles based on messages
    var PP_CHAT_TITLES = [
      { min: 0,   name: 'Lurker' },
      { min: 10,  name: 'Chatter' },
      { min: 50,  name: 'Regular' },
      { min: 200, name: 'Motor Mouth' },
      { min: 500, name: 'Community Pillar' },
      { min: 1000,name: 'Chat Legend' }
    ];

    // Cabbage titles
    var PP_CABBAGE_TITLES = [
      { min: 0,      name: 'Broke' },
      { min: 100,    name: 'Sprout' },
      { min: 1000,   name: 'Gardener' },
      { min: 5000,   name: 'Farmer' },
      { min: 25000,  name: 'Cabbage King' },
      { min: 100000, name: 'Cabbage God' }
    ];

    function pp_getTitle(arr, val) {
      var t = arr[0];
      for (var i = arr.length - 1; i >= 0; i--) {
        if (val >= arr[i].min) { t = arr[i]; break; }
      }
      return t;
    }

    async function pp_fetchStats() {
      if (pp_loaded && pp_stats) return pp_stats;
      if (!walletPublicKey) return null;
      var sb = getSupaClient();
      var w = walletPublicKey.toBase58();
      var stats = { gamesPlayed: 0, gamesWon: 0, gamesLost: 0, totalWagered: 0, totalWon: 0, totalLost: 0, biggestWin: 0, biggestWinGame: '', chatMsgs: 0, totalCabbageEarned: 0, joinDate: null, daysHeld: 0, luckyGame: '', itemsOwned: 0, solLost: 0, solWagered: 0, winStreak: 0, maxWinStreak: 0, lossStreak: 0, maxLossStreak: 0 };

      try {
        // Casino stats from game_bets
        var gR = await sb.from('game_bets').select('bet_amount,house_profit,game,currency').eq('wallet', w);
        var bets = gR.data || [];
        var gameWins = {};
        bets.forEach(function(b) {
          stats.gamesPlayed++;
          var hp = Number(b.house_profit || 0);
          var ba = Number(b.bet_amount || 0);
          stats.totalWagered += ba;
          if (b.currency === 'sol') stats.solWagered += ba;
          if (hp <= 0) {
            stats.gamesWon++;
            stats.winStreak++; stats.lossStreak = 0;
            if (stats.winStreak > stats.maxWinStreak) stats.maxWinStreak = stats.winStreak;
            var winAmt = ba + Math.abs(hp);
            stats.totalWon += winAmt;
            if (winAmt > stats.biggestWin) { stats.biggestWin = winAmt; stats.biggestWinGame = b.game || ''; }
            if (!gameWins[b.game]) gameWins[b.game] = 0;
            gameWins[b.game]++;
          } else {
            stats.gamesLost++;
            stats.lossStreak++; stats.winStreak = 0;
            if (stats.lossStreak > stats.maxLossStreak) stats.maxLossStreak = stats.lossStreak;
            stats.totalLost += hp;
            if (b.currency === 'sol') stats.solLost += hp;
          }
        });
        // Find luckiest game
        var maxWins = 0;
        Object.keys(gameWins).forEach(function(g) {
          if (gameWins[g] > maxWins) { maxWins = gameWins[g]; stats.luckyGame = g; }
        });

        // Chat messages count
        var cR = await sb.from('chat_messages').select('id', { count: 'exact', head: true }).eq('wallet', w);
        stats.chatMsgs = cR.count || 0;

        // Cabbage account
        var caR = await sb.from('cabbage_accounts').select('balance,started_at').eq('wallet', w).maybeSingle();
        if (caR.data) {
          stats.totalCabbageEarned = Number(caR.data.balance || 0) + stats.totalWagered;
          if (caR.data.started_at) {
            stats.joinDate = caR.data.started_at;
            stats.daysHeld = Math.floor((Date.now() - new Date(caR.data.started_at).getTime()) / 86400000);
          }
        }

        // Items owned
        var iR = await sb.from('user_items').select('id', { count: 'exact', head: true }).eq('wallet', w);
        stats.itemsOwned = iR.count || 0;

      } catch(e) { console.warn('pp_fetchStats error:', e); }

      pp_stats = stats;
      pp_stats._gameWins = gameWins || {};
      pp_loaded = true;
      return stats;
    }

    function pp_computeXP(stats) {
      if (!stats) return 0;
      return Math.floor(
        (stats.gamesPlayed * 1) +
        (stats.gamesWon * 3) +
        (stats.chatMsgs * 0.5) +
        (stats.totalCabbageEarned * 0.1) +
        (stats.daysHeld * 2)
      );
    }

    function pp_renderPlayerCard(nftCount, cabbageBalance) {
      if (!pp_stats) return '';
      var stats = pp_stats;
      var xp = pp_computeXP(stats);
      var level = pp_levelFromXP(xp);
      var currentLvlXP = pp_xpForLevel(level);
      var nextLvlXP = pp_xpForLevel(level + 1);
      var xpProgress = nextLvlXP > currentLvlXP ? ((xp - currentLvlXP) / (nextLvlXP - currentLvlXP)) * 100 : 100;

      var neckTitle = pp_getTitle(PP_NECK_TITLES, level);
      var casinoTitle = pp_getTitle(PP_CASINO_TITLES, stats.gamesPlayed);
      var chatTitle = pp_getTitle(PP_CHAT_TITLES, stats.chatMsgs);
      var cabTitle = pp_getTitle(PP_CABBAGE_TITLES, stats.totalCabbageEarned);
      var winRate = stats.gamesPlayed > 0 ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) : 0;
      var joinStr = stats.joinDate ? new Date(stats.joinDate).toLocaleDateString() : 'N/A';

      var html =
        '<div style="background:linear-gradient(135deg,#0d0d20 0%,#111130 50%,#0a0a1a 100%);border:1px solid #1e1e3a;border-radius:16px;padding:1.5rem;margin-bottom:1rem;position:relative;overflow:hidden;">' +
          // Subtle pattern overlay
          '<div style="position:absolute;top:0;right:0;width:200px;height:200px;background:radial-gradient(circle at top right,rgba(0,212,255,0.04),transparent 70%);pointer-events:none;"></div>' +

          // Top: Level + XP bar
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">' +
            '<div>' +
              '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.6rem;letter-spacing:4px;color:#e0e0ff;">LEVEL <span style="color:#ffd700;">' + level + '</span></div>' +
              '<div style="font-size:0.72rem;color:' + neckTitle.color + ';font-weight:700;letter-spacing:2px;text-transform:uppercase;">' + neckTitle.name + '</div>' +
            '</div>' +
            '<div style="text-align:right;">' +
              '<div style="font-size:0.6rem;color:#444;letter-spacing:1px;margin-bottom:3px;">XP</div>' +
              '<div style="font-size:1rem;font-weight:900;color:#00d4ff;font-family:\'Space Grotesk\',sans-serif;">' + xp.toLocaleString() + '</div>' +
            '</div>' +
          '</div>' +

          // XP Progress bar
          '<div style="background:rgba(255,255,255,0.04);border-radius:6px;height:8px;margin-bottom:1.2rem;overflow:hidden;position:relative;">' +
            '<div style="position:absolute;top:0;left:0;height:100%;width:' + Math.min(xpProgress, 100) + '%;background:linear-gradient(90deg,#7b68ee,#00d4ff);border-radius:6px;transition:width 0.5s;"></div>' +
          '</div>' +
          '<div style="display:flex;justify-content:space-between;margin-top:-8px;margin-bottom:1rem;">' +
            '<span style="font-size:0.55rem;color:#333;">LVL ' + level + '</span>' +
            '<span style="font-size:0.55rem;color:#333;">' + (xp - currentLvlXP) + ' / ' + (nextLvlXP - currentLvlXP) + ' XP to LVL ' + (level + 1) + '</span>' +
          '</div>' +

          // Titles Row
          '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:1.2rem;">' +
            '<div style="background:rgba(123,104,238,0.1);border:1px solid rgba(123,104,238,0.25);border-radius:8px;padding:5px 10px;font-size:0.62rem;font-weight:700;color:#7b68ee;letter-spacing:0.8px;">üé∞ ' + casinoTitle.name + '</div>' +
            '<div style="background:rgba(0,255,136,0.06);border:1px solid rgba(0,255,136,0.2);border-radius:8px;padding:5px 10px;font-size:0.62rem;font-weight:700;color:#00ff88;letter-spacing:0.8px;">ü•¨ ' + cabTitle.name + '</div>' +
            '<div style="background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);border-radius:8px;padding:5px 10px;font-size:0.62rem;font-weight:700;color:#00d4ff;letter-spacing:0.8px;">üí¨ ' + chatTitle.name + '</div>' +
            (stats.itemsOwned > 0 ? '<div style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);border-radius:8px;padding:5px 10px;font-size:0.62rem;font-weight:700;color:#ffd700;letter-spacing:0.8px;">üõí Collector</div>' : '') +
            '<div style="background:rgba(255,140,0,0.08);border:1px solid rgba(255,140,0,0.2);border-radius:8px;padding:5px 10px;font-size:0.62rem;font-weight:700;color:#ff8c00;letter-spacing:0.8px;">üèÖ ' + ach_myBadges.length + '/' + ACH_LIST.length + '</div>' +
          '</div>' +

          // Stats Grid
          '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;">' +
            pp_statCell('üé∞ Games Played', stats.gamesPlayed.toLocaleString(), '#e0e0ff') +
            pp_statCell('üèÜ Wins', stats.gamesWon.toLocaleString(), '#00ff88') +
            pp_statCell('üíÄ Losses', stats.gamesLost.toLocaleString(), '#ff3c5c') +
            pp_statCell('üìä Win Rate', winRate + '%', winRate >= 50 ? '#00ff88' : '#ff3c5c') +
            pp_statCell('üí∞ Total Wagered', Math.floor(stats.totalWagered).toLocaleString(), '#ffd700') +
            pp_statCell('ü•¨ Total Won', Math.floor(stats.totalWon).toLocaleString(), '#00ff88') +
            pp_statCell('üí∏ Total Lost', Math.floor(stats.totalLost).toLocaleString(), '#ff3c5c') +
            pp_statCell('üéØ Biggest Win', Math.floor(stats.biggestWin).toLocaleString(), '#ffd700') +
            pp_statCell('üí¨ Messages', stats.chatMsgs.toLocaleString(), '#7b68ee') +
            pp_statCell('ü™∂ NFTs Held', nftCount.toString(), '#00d4ff') +
            pp_statCell('üìÖ Member Since', joinStr, '#888') +
            pp_statCell('‚è≥ Days Active', stats.daysHeld.toString(), '#00d4ff') +
          '</div>' +

          // Bottom: Lucky game + Store items
          (stats.luckyGame ? '<div style="margin-top:1rem;font-size:0.65rem;color:#444;text-align:center;letter-spacing:1px;">Luckiest game: <span style="color:#ffd700;font-weight:700;">' + escapeHtml(stats.luckyGame) + '</span></div>' : '') +
          (stats.biggestWinGame ? '<div style="font-size:0.6rem;color:#333;text-align:center;margin-top:4px;">Biggest win from: ' + escapeHtml(stats.biggestWinGame) + '</div>' : '') +

        '</div>';

      // Separate variable for luckiest game wins
      return html;
    }

    function pp_statCell(label, value, color) {
      return '<div style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center;">' +
        '<div style="font-size:0.58rem;color:#444;letter-spacing:1px;margin-bottom:4px;text-transform:uppercase;">' + label + '</div>' +
        '<div style="font-size:1rem;font-weight:900;color:' + color + ';font-family:\'Space Grotesk\',sans-serif;">' + value + '</div>' +
      '</div>';
    }

    /* ================================================================
       ACHIEVEMENT / BADGE SYSTEM
    ================================================================ */
    var ach_allUsers = {}; // wallet ‚Üí [achievement_ids]
    var ach_myBadges = []; // current user's unlocked achievement ids

    var ACH_LIST = [
      // Milestones
      { id: 'first_claim',    icon: 'ü•¨', name: 'First Harvest',      desc: 'Claim cabbage for the first time',        cat: 'milestone', rarity: 'common' },
      { id: 'first_win',      icon: 'üé∞', name: 'First Blood',        desc: 'Win your first casino game',              cat: 'milestone', rarity: 'common' },
      { id: 'first_chat',     icon: 'üí¨', name: 'Hello World',        desc: 'Send your first chat message',            cat: 'milestone', rarity: 'common' },
      { id: 'first_store',    icon: 'üõí', name: 'Big Spender',        desc: 'Buy your first store item',               cat: 'milestone', rarity: 'common' },

      // Casino grind
      { id: 'play_10',        icon: 'üé≤', name: 'Getting Started',    desc: 'Play 10 casino games',                    cat: 'casino', rarity: 'common' },
      { id: 'play_100',       icon: 'üÉè', name: 'Regular',            desc: 'Play 100 casino games',                   cat: 'casino', rarity: 'uncommon' },
      { id: 'play_500',       icon: 'üî•', name: 'Degen Mode',         desc: 'Play 500 casino games',                   cat: 'casino', rarity: 'rare' },
      { id: 'play_1000',      icon: 'üíÄ', name: 'No Life',            desc: 'Play 1,000 casino games',                 cat: 'casino', rarity: 'legendary' },
      { id: 'win_10',         icon: '‚úåÔ∏è', name: 'Lucky Streak',       desc: 'Win 10 casino games',                     cat: 'casino', rarity: 'common' },
      { id: 'win_100',        icon: 'üèÜ', name: 'Casino Boss',        desc: 'Win 100 casino games',                    cat: 'casino', rarity: 'rare' },
      { id: 'streak_5',       icon: '‚ö°', name: 'Hot Hands',          desc: 'Win 5 games in a row',                    cat: 'casino', rarity: 'uncommon' },
      { id: 'streak_10',      icon: 'üåü', name: 'Unstoppable',        desc: 'Win 10 games in a row',                   cat: 'casino', rarity: 'epic' },
      { id: 'big_win_1k',     icon: 'üí∞', name: 'Jackpot',            desc: 'Win 1,000+ in a single game',             cat: 'casino', rarity: 'rare' },
      { id: 'big_win_10k',    icon: 'ü§ë', name: 'Mega Jackpot',       desc: 'Win 10,000+ in a single game',            cat: 'casino', rarity: 'legendary' },

      // Pain badges (losses are flex-worthy too)
      { id: 'lost_1sol',      icon: 'üíÄ', name: 'Paper Hands',        desc: 'Lose 1 SOL total in the casino',          cat: 'pain', rarity: 'uncommon' },
      { id: 'lost_5sol',      icon: '‚ò†Ô∏è', name: 'Diamond Degen',      desc: 'Lose 5 SOL total in the casino',          cat: 'pain', rarity: 'rare' },
      { id: 'lost_10sol',     icon: 'ü™¶', name: 'Rekt Legend',        desc: 'Lose 10 SOL total in the casino',         cat: 'pain', rarity: 'epic' },
      { id: 'loss_streak_5',  icon: 'üìâ', name: 'Down Bad',           desc: 'Lose 5 games in a row',                   cat: 'pain', rarity: 'uncommon' },
      { id: 'loss_streak_10', icon: 'üï≥Ô∏è', name: 'Rock Bottom',       desc: 'Lose 10 games in a row',                  cat: 'pain', rarity: 'rare' },

      // Holder badges
      { id: 'hold_1',         icon: 'ü™∂', name: 'Neck Holder',        desc: 'Hold at least 1 LNL NFT',                 cat: 'holder', rarity: 'common' },
      { id: 'hold_5',         icon: 'ü¶¥', name: 'Collector',          desc: 'Hold 5+ LNL NFTs',                        cat: 'holder', rarity: 'uncommon' },
      { id: 'hold_10',        icon: '‚≠ê', name: 'Legend Status',      desc: 'Hold 10+ LNL NFTs',                       cat: 'holder', rarity: 'rare' },
      { id: 'hold_20',        icon: 'üëë', name: 'OG Legend',           desc: 'Hold 20+ LNL NFTs',                       cat: 'holder', rarity: 'epic' },
      { id: 'hold_50',        icon: 'üêã', name: 'Whale',              desc: 'Hold 50+ LNL NFTs',                       cat: 'holder', rarity: 'legendary' },
      { id: 'og_30d',         icon: 'üìÖ', name: 'OG Member',          desc: 'Member for 30+ days',                     cat: 'holder', rarity: 'uncommon' },
      { id: 'og_90d',         icon: 'üèõÔ∏è', name: 'Veteran',           desc: 'Member for 90+ days',                     cat: 'holder', rarity: 'rare' },
      { id: 'og_365d',        icon: 'üóø', name: 'Ancient One',        desc: 'Member for 1+ year',                      cat: 'holder', rarity: 'legendary' },

      // Social
      { id: 'chat_50',        icon: 'üó£Ô∏è', name: 'Social Butterfly',  desc: 'Send 50 chat messages',                   cat: 'social', rarity: 'common' },
      { id: 'chat_500',       icon: 'üì¢', name: 'Megaphone',          desc: 'Send 500 chat messages',                  cat: 'social', rarity: 'uncommon' },
      { id: 'chat_1000',      icon: 'üéôÔ∏è', name: 'Chat Legend',       desc: 'Send 1,000 chat messages',                cat: 'social', rarity: 'rare' },

      // Cabbage economy
      { id: 'cab_1k',         icon: 'üå±', name: 'Cabbage Sprout',     desc: 'Earn 1,000 total cabbage',                cat: 'economy', rarity: 'common' },
      { id: 'cab_10k',        icon: 'ü•¨', name: 'Cabbage Farmer',     desc: 'Earn 10,000 total cabbage',               cat: 'economy', rarity: 'uncommon' },
      { id: 'cab_100k',       icon: 'üë®‚Äçüåæ', name: 'Cabbage King',    desc: 'Earn 100,000 total cabbage',              cat: 'economy', rarity: 'rare' },
      { id: 'cab_1m',         icon: 'üè∞', name: 'Cabbage God',        desc: 'Earn 1,000,000 total cabbage',            cat: 'economy', rarity: 'legendary' },
      { id: 'wager_10k',      icon: 'üé∞', name: 'High Roller',        desc: 'Wager 10,000+ total',                     cat: 'economy', rarity: 'uncommon' },
      { id: 'wager_100k',     icon: 'üíé', name: 'Diamond Roller',     desc: 'Wager 100,000+ total',                    cat: 'economy', rarity: 'rare' },

      // Meta / special
      { id: 'level_10',       icon: 'üîü', name: 'Double Digits',      desc: 'Reach level 10',                          cat: 'meta', rarity: 'uncommon' },
      { id: 'level_25',       icon: 'üåô', name: 'Quarter Century',    desc: 'Reach level 25',                          cat: 'meta', rarity: 'rare' },
      { id: 'level_50',       icon: '‚òÄÔ∏è', name: 'Half Century',       desc: 'Reach level 50',                          cat: 'meta', rarity: 'epic' },
      { id: 'all_games',      icon: 'üß†', name: 'Jack of All Trades', desc: 'Play every casino game at least once',    cat: 'meta', rarity: 'uncommon' }
    ];

    var ACH_RARITY_COLORS = {
      common:    { bg: 'rgba(150,150,150,0.08)', border: 'rgba(150,150,150,0.2)', text: '#888' },
      uncommon:  { bg: 'rgba(0,255,136,0.06)',   border: 'rgba(0,255,136,0.2)',   text: '#00ff88' },
      rare:      { bg: 'rgba(0,212,255,0.08)',   border: 'rgba(0,212,255,0.25)',  text: '#00d4ff' },
      epic:      { bg: 'rgba(123,104,238,0.08)', border: 'rgba(123,104,238,0.3)', text: '#7b68ee' },
      legendary: { bg: 'rgba(255,215,0,0.08)',   border: 'rgba(255,215,0,0.25)',  text: '#ffd700' }
    };

    var ACH_CATS = [
      { id: 'all',       label: 'All' },
      { id: 'milestone', label: 'Milestones' },
      { id: 'casino',    label: 'Casino' },
      { id: 'pain',      label: 'Pain' },
      { id: 'holder',    label: 'Holder' },
      { id: 'social',    label: 'Social' },
      { id: 'economy',   label: 'Economy' },
      { id: 'meta',      label: 'Meta' }
    ];
    var ach_activeCat = 'all';

    function ach_check(stats, nftCount, level, gamesMap) {
      if (!stats) return [];
      var unlocked = [];
      function u(id) { unlocked.push(id); }

      // Milestones
      if (stats.joinDate) u('first_claim');
      if (stats.gamesWon >= 1) u('first_win');
      if (stats.chatMsgs >= 1) u('first_chat');
      if (stats.itemsOwned >= 1) u('first_store');

      // Casino grind
      if (stats.gamesPlayed >= 10)   u('play_10');
      if (stats.gamesPlayed >= 100)  u('play_100');
      if (stats.gamesPlayed >= 500)  u('play_500');
      if (stats.gamesPlayed >= 1000) u('play_1000');
      if (stats.gamesWon >= 10)  u('win_10');
      if (stats.gamesWon >= 100) u('win_100');
      if (stats.maxWinStreak >= 5)  u('streak_5');
      if (stats.maxWinStreak >= 10) u('streak_10');
      if (stats.biggestWin >= 1000)  u('big_win_1k');
      if (stats.biggestWin >= 10000) u('big_win_10k');

      // Pain
      if (stats.solLost >= 1)  u('lost_1sol');
      if (stats.solLost >= 5)  u('lost_5sol');
      if (stats.solLost >= 10) u('lost_10sol');
      if (stats.maxLossStreak >= 5)  u('loss_streak_5');
      if (stats.maxLossStreak >= 10) u('loss_streak_10');

      // Holder
      if (nftCount >= 1)  u('hold_1');
      if (nftCount >= 5)  u('hold_5');
      if (nftCount >= 10) u('hold_10');
      if (nftCount >= 20) u('hold_20');
      if (nftCount >= 50) u('hold_50');
      if (stats.daysHeld >= 30)  u('og_30d');
      if (stats.daysHeld >= 90)  u('og_90d');
      if (stats.daysHeld >= 365) u('og_365d');

      // Social
      if (stats.chatMsgs >= 50)   u('chat_50');
      if (stats.chatMsgs >= 500)  u('chat_500');
      if (stats.chatMsgs >= 1000) u('chat_1000');

      // Economy
      if (stats.totalCabbageEarned >= 1000)    u('cab_1k');
      if (stats.totalCabbageEarned >= 10000)   u('cab_10k');
      if (stats.totalCabbageEarned >= 100000)  u('cab_100k');
      if (stats.totalCabbageEarned >= 1000000) u('cab_1m');
      if (stats.totalWagered >= 10000)  u('wager_10k');
      if (stats.totalWagered >= 100000) u('wager_100k');

      // Meta
      if (level >= 10) u('level_10');
      if (level >= 25) u('level_25');
      if (level >= 50) u('level_50');
      // All games: check if at least 5 unique games played (coin, dice, slots, blackjack, plinko, crash, poker)
      if (gamesMap && Object.keys(gamesMap).length >= 5) u('all_games');

      return unlocked;
    }

    async function ach_save(unlocked) {
      if (!walletPublicKey || unlocked.length === 0) return;
      var sb = getSupaClient();
      var w = walletPublicKey.toBase58();
      try {
        // Upsert all achievements as user_items with ach_ prefix
        for (var i = 0; i < unlocked.length; i++) {
          await sb.from('user_items').upsert({
            wallet: w,
            item_id: 'ach_' + unlocked[i],
            data: { unlocked: true },
            bought_at: new Date().toISOString()
          }, { onConflict: 'wallet,item_id' });
        }
      } catch(e) { /* silent - non-critical */ }
    }

    // Load ALL users' achievement counts for chat display
    async function ach_loadAllUsers() {
      var sb = getSupaClient();
      try {
        var res = await sb.from('user_items').select('wallet,item_id').like('item_id', 'ach_%');
        ach_allUsers = {};
        (res.data || []).forEach(function(r) {
          if (!ach_allUsers[r.wallet]) ach_allUsers[r.wallet] = [];
          ach_allUsers[r.wallet].push(r.item_id.replace('ach_', ''));
        });
      } catch(e) { /* silent */ }
    }

    // Get top rarity badge for a wallet (for chat display)
    function ach_getTopBadge(wallet) {
      var ids = ach_allUsers[wallet];
      if (!ids || ids.length === 0) return '';
      var order = ['legendary','epic','rare','uncommon','common'];
      for (var r = 0; r < order.length; r++) {
        for (var i = 0; i < ids.length; i++) {
          var ach = ACH_LIST.find(function(a) { return a.id === ids[i]; });
          if (ach && ach.rarity === order[r]) return ach.icon;
        }
      }
      return '';
    }

    function ach_getBadgeCount(wallet) {
      var ids = ach_allUsers[wallet];
      return ids ? ids.length : 0;
    }

    function ach_renderSection(unlocked) {
      var total = ACH_LIST.length;
      var earned = unlocked.length;
      var pct = Math.round((earned / total) * 100);

      var html =
        '<div style="background:linear-gradient(135deg,#0d0d20,#0a0a1a);border:1px solid #1e1e3a;border-radius:16px;padding:1.5rem;margin-bottom:1rem;">' +
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.3rem;letter-spacing:3px;color:#e0e0ff;">üèÖ ACHIEVEMENTS</div>' +
            '<div style="font-size:0.78rem;font-weight:700;color:#ffd700;">' + earned + ' / ' + total + ' <span style="color:#444;font-weight:400;">(' + pct + '%)</span></div>' +
          '</div>' +

          // Progress bar
          '<div style="background:rgba(255,255,255,0.04);border-radius:6px;height:6px;margin-bottom:1rem;overflow:hidden;">' +
            '<div style="height:100%;width:' + pct + '%;background:linear-gradient(90deg,#ffd700,#ff8c00);border-radius:6px;transition:width 0.5s;"></div>' +
          '</div>' +

          // Category filter
          '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:1rem;" id="ach_cats"></div>' +

          // Badge grid
          '<div id="ach_grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;"></div>' +
        '</div>';

      return html;
    }

    function ach_paintGrid(unlocked) {
      var catsEl = document.getElementById('ach_cats');
      var gridEl = document.getElementById('ach_grid');
      if (!catsEl || !gridEl) return;

      // Render category tabs
      var cHTML = '';
      ACH_CATS.forEach(function(c) {
        var count = c.id === 'all' ? ACH_LIST.length : ACH_LIST.filter(function(a) { return a.cat === c.id; }).length;
        cHTML += '<div style="padding:4px 10px;border-radius:6px;border:1px solid ' + (c.id === ach_activeCat ? 'rgba(0,212,255,0.5)' : 'rgba(255,255,255,0.06)') + ';background:' + (c.id === ach_activeCat ? 'rgba(0,212,255,0.08)' : 'rgba(0,0,0,0.2)') + ';color:' + (c.id === ach_activeCat ? '#00d4ff' : '#555') + ';font-size:0.6rem;font-weight:700;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;letter-spacing:0.5px;" onclick="ach_activeCat=\'' + c.id + '\';ach_paintGrid(ach_myBadges);">' + c.label + ' (' + count + ')</div>';
      });
      catsEl.innerHTML = cHTML;

      // Render badges
      var items = ach_activeCat === 'all' ? ACH_LIST : ACH_LIST.filter(function(a) { return a.cat === ach_activeCat; });
      var gHTML = '';
      items.forEach(function(ach) {
        var earned = unlocked.indexOf(ach.id) !== -1;
        var rc = ACH_RARITY_COLORS[ach.rarity] || ACH_RARITY_COLORS.common;
        gHTML += '<div style="background:' + (earned ? rc.bg : 'rgba(0,0,0,0.3)') + ';border:1px solid ' + (earned ? rc.border : 'rgba(255,255,255,0.03)') + ';border-radius:10px;padding:10px;text-align:center;opacity:' + (earned ? '1' : '0.35') + ';transition:all 0.2s;' + (earned ? '' : 'filter:grayscale(1);') + '">' +
          '<div style="font-size:1.5rem;margin-bottom:4px;">' + ach.icon + '</div>' +
          '<div style="font-size:0.68rem;font-weight:700;color:' + (earned ? '#e0e0ff' : '#444') + ';margin-bottom:2px;">' + ach.name + '</div>' +
          '<div style="font-size:0.55rem;color:' + (earned ? '#666' : '#333') + ';line-height:1.3;margin-bottom:4px;">' + ach.desc + '</div>' +
          '<div style="font-size:0.5rem;font-weight:700;color:' + rc.text + ';letter-spacing:1px;text-transform:uppercase;">' + (earned ? '‚úÖ ' : '') + ach.rarity + '</div>' +
        '</div>';
      });
      gridEl.innerHTML = gHTML;
    }
    var shop_items = {};     // wallet ‚Üí { item_id: {data, bought_at} }
    var shop_allItems = {};  // cache of ALL user items for chat rendering
    var shop_loaded = false;
    var shop_raffleCurrent = null;
    var shop_raffleMyTickets = 0;

    var SHOP_CATALOG = [
      { id: 'badge_fire',   cat: 'chat',    icon: 'üî•', name: 'Fire Badge',       price: 50,   desc: 'üî• next to your name in chat', perm: true },
      { id: 'badge_diamond',cat: 'chat',    icon: 'üíé', name: 'Diamond Badge',    price: 50,   desc: 'üíé next to your name in chat', perm: true },
      { id: 'badge_crown',  cat: 'chat',    icon: 'üëë', name: 'Crown Badge',      price: 100,  desc: 'üëë next to your name in chat', perm: true },
      { id: 'badge_skull',  cat: 'chat',    icon: 'üíÄ', name: 'Skull Badge',      price: 50,   desc: 'üíÄ next to your name in chat', perm: true },
      { id: 'badge_rocket', cat: 'chat',    icon: 'üöÄ', name: 'Rocket Badge',     price: 75,   desc: 'üöÄ next to your name in chat', perm: true },
      { id: 'namecolor_gold',   cat: 'chat', icon: '‚ú®', name: 'Gold Name',       price: 200,  desc: 'Your name shows gold in chat', perm: true, color: '#ffd700' },
      { id: 'namecolor_cyan',   cat: 'chat', icon: 'üí†', name: 'Cyan Name',       price: 200,  desc: 'Your name shows cyan in chat', perm: true, color: '#00ffee' },
      { id: 'namecolor_purple', cat: 'chat', icon: 'üîÆ', name: 'Purple Name',     price: 200,  desc: 'Your name shows purple in chat', perm: true, color: '#bf5fff' },
      { id: 'namecolor_red',    cat: 'chat', icon: '‚ù§Ô∏è', name: 'Red Name',        price: 200,  desc: 'Your name shows red in chat', perm: true, color: '#ff3c5c' },
      { id: 'chat_glow',    cat: 'chat',    icon: 'üåü', name: 'Message Glow',    price: 300,  desc: 'Your messages have a subtle glow', perm: true },
      { id: 'vip_flair',    cat: 'chat',    icon: '‚≠ê', name: 'VIP Flair',        price: 5000, desc: '‚≠ê VIP tag next to your name', perm: true },
      { id: 'frame_gold',   cat: 'profile', icon: 'üñºÔ∏è', name: 'Gold Frame',       price: 500,  desc: 'Gold border on your profile PFP', perm: true },
      { id: 'frame_diamond',cat: 'profile', icon: 'üíé', name: 'Diamond Frame',    price: 2000, desc: 'Diamond animated border on PFP', perm: true },
      { id: 'lucky_boost',  cat: 'casino',  icon: 'üçÄ', name: 'Lucky Boost',      price: 500,  desc: 'Next 10 casino bets get +5% odds', perm: false, uses: 10 },
      { id: 'raffle_ticket',cat: 'raffle',  icon: 'üéüÔ∏è', name: 'Raffle Ticket',    price: 1000, desc: 'Enter the current NFT raffle', perm: false }
    ];

    var SHOP_CATS = [
      { id: 'chat',    label: 'üí¨ Chat Perks' },
      { id: 'profile', label: 'üñºÔ∏è Profile' },
      { id: 'casino',  label: 'üé∞ Casino' },
      { id: 'raffle',  label: 'üéüÔ∏è Raffle' }
    ];
    var shop_activeCat = 'chat';

    async function shop_loadMyItems() {
      if (!walletPublicKey) return;
      var sb = getSupaClient();
      var w = walletPublicKey.toBase58();
      try {
        var res = await sb.from('user_items').select('*').eq('wallet', w);
        shop_items = {};
        (res.data || []).forEach(function(r) {
          shop_items[r.item_id] = { data: r.data || {}, bought_at: r.bought_at, expires_at: r.expires_at };
        });
        shop_loaded = true;
      } catch(e) { console.warn('shop_loadMyItems error:', e); }
    }

    // Load ALL users' chat cosmetics for rendering
    async function shop_loadAllChatItems() {
      var sb = getSupaClient();
      try {
        var res = await sb.from('user_items').select('wallet,item_id,data')
          .in('item_id', ['badge_fire','badge_diamond','badge_crown','badge_skull','badge_rocket','namecolor_gold','namecolor_cyan','namecolor_purple','namecolor_red','chat_glow','vip_flair']);
        shop_allItems = {};
        (res.data || []).forEach(function(r) {
          if (!shop_allItems[r.wallet]) shop_allItems[r.wallet] = {};
          shop_allItems[r.wallet][r.item_id] = r.data || {};
        });
      } catch(e) { console.warn('shop_loadAllChatItems:', e); }
    }

    function shop_owns(itemId) {
      return !!shop_items[itemId];
    }

    // Get chat badge emoji for a wallet
    function shop_getBadge(wallet) {
      var items = shop_allItems[wallet];
      if (!items) return '';
      var badges = ['badge_fire','badge_diamond','badge_crown','badge_skull','badge_rocket'];
      for (var i = 0; i < badges.length; i++) {
        if (items[badges[i]]) {
          var cat = SHOP_CATALOG.find(function(c) { return c.id === badges[i]; });
          if (cat) return cat.icon;
        }
      }
      return '';
    }

    function shop_getVIP(wallet) {
      var items = shop_allItems[wallet];
      return items && items['vip_flair'] ? '‚≠ê' : '';
    }

    function shop_getNameColor(wallet) {
      var items = shop_allItems[wallet];
      if (!items) return null;
      var colors = ['namecolor_gold','namecolor_cyan','namecolor_purple','namecolor_red'];
      for (var i = 0; i < colors.length; i++) {
        if (items[colors[i]]) {
          var cat = SHOP_CATALOG.find(function(c) { return c.id === colors[i]; });
          if (cat) return cat.color;
        }
      }
      return null;
    }

    function shop_hasGlow(wallet) {
      var items = shop_allItems[wallet];
      return items && items['chat_glow'];
    }

    function shop_hasBoost() {
      var b = shop_items['lucky_boost'];
      if (!b) return false;
      var uses = b.data && b.data.uses_left !== undefined ? b.data.uses_left : 0;
      return uses > 0;
    }

    async function shop_buy(itemId) {
      if (!walletPublicKey) return alert('Connect wallet first.');
      var cat = SHOP_CATALOG.find(function(c) { return c.id === itemId; });
      if (!cat) return;

      // Already owned (permanent items)
      if (cat.perm && shop_owns(itemId)) return alert('You already own this!');

      // Confirm
      if (!confirm('Buy ' + cat.name + ' for ' + cat.price.toLocaleString() + ' ü•¨?')) return;

      try {
        // Spend cabbage
        await g_spendCabbage(cat.price);

        var sb = getSupaClient();
        var w = walletPublicKey.toBase58();
        var itemData = {};

        if (itemId === 'lucky_boost') {
          // If already have boost, add uses
          var existing = shop_items['lucky_boost'];
          var currentUses = existing && existing.data ? (existing.data.uses_left || 0) : 0;
          itemData = { uses_left: currentUses + (cat.uses || 10) };
          await sb.from('user_items').upsert({
            wallet: w, item_id: itemId, data: itemData, bought_at: new Date().toISOString()
          }, { onConflict: 'wallet,item_id' });
        } else if (itemId === 'raffle_ticket') {
          // Handle raffle entry
          if (!shop_raffleCurrent) return alert('No active raffle right now.');
          var exR = await sb.from('raffle_entries').select('id,tickets').eq('raffle_id', shop_raffleCurrent.id).eq('wallet', w).maybeSingle();
          if (exR.data) {
            await sb.from('raffle_entries').update({ tickets: exR.data.tickets + 1 }).eq('id', exR.data.id);
          } else {
            await sb.from('raffle_entries').insert({ raffle_id: shop_raffleCurrent.id, wallet: w, tickets: 1 });
          }
          shop_raffleMyTickets++;
          shop_paintStore();
          return;
        } else {
          // Permanent item
          await sb.from('user_items').upsert({
            wallet: w, item_id: itemId, data: itemData, bought_at: new Date().toISOString()
          }, { onConflict: 'wallet,item_id' });
        }

        shop_items[itemId] = { data: itemData, bought_at: new Date().toISOString() };
        // Refresh chat cosmetics cache
        await shop_loadAllChatItems();
        shop_paintStore();
        alert('‚úÖ ' + cat.name + ' purchased!');
      } catch(e) {
        alert('Purchase failed: ' + (e.message || e));
      }
    }

    async function shop_loadRaffle() {
      try {
        var sb = getSupaClient();
        var res = await sb.from('raffles').select('*').eq('status', 'open').order('created_at', { ascending: false }).limit(1).maybeSingle();
        shop_raffleCurrent = res.data || null;
        if (shop_raffleCurrent && walletPublicKey) {
          var w = walletPublicKey.toBase58();
          var eR = await sb.from('raffle_entries').select('tickets').eq('raffle_id', shop_raffleCurrent.id).eq('wallet', w).maybeSingle();
          shop_raffleMyTickets = eR.data ? eR.data.tickets : 0;
          // Total entries
          var tR = await sb.from('raffle_entries').select('tickets').eq('raffle_id', shop_raffleCurrent.id);
          shop_raffleCurrent._totalTickets = (tR.data || []).reduce(function(s, r) { return s + r.tickets; }, 0);
          shop_raffleCurrent._totalEntrants = (tR.data || []).length;
        }
      } catch(e) { console.warn('shop_loadRaffle:', e); }
    }

    async function renderStoreUI() {
      var view = document.getElementById('view-store');
      if (!view) return;

      if (!shop_loaded) await shop_loadMyItems();
      await shop_loadRaffle();

      var cabBal = 0;
      try { cabBal = await g_fetchCabbageBalance(); } catch(e) {}

      view.innerHTML =
        '<style>' +
        '.sh_cats{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:1rem;}' +
        '.sh_cat{padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.2);color:#555;font-size:0.68rem;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:"Space Grotesk",sans-serif;}' +
        '.sh_cat:hover{border-color:rgba(0,212,255,0.3);color:#888;}' +
        '.sh_cat.active{border-color:rgba(0,212,255,0.5);color:#00d4ff;background:rgba(0,212,255,0.08);}' +
        '.sh_grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}' +
        '.sh_item{background:#0a0a1a;border:1px solid #1a1a30;border-radius:12px;padding:1rem;text-align:center;transition:all 0.2s;}' +
        '.sh_item:hover{border-color:rgba(0,212,255,0.3);transform:translateY(-2px);}' +
        '.sh_item.owned{border-color:rgba(0,255,136,0.3);background:rgba(0,255,136,0.03);}' +
        '.sh_icon{font-size:2rem;margin-bottom:0.4rem;}' +
        '.sh_name{font-weight:700;font-size:0.78rem;color:#e0e0ff;margin-bottom:4px;}' +
        '.sh_desc{font-size:0.62rem;color:#444;margin-bottom:0.7rem;line-height:1.4;}' +
        '.sh_price{font-size:0.82rem;font-weight:900;color:#ffd700;margin-bottom:0.6rem;}' +
        '.sh_buy{padding:6px 16px;border-radius:7px;border:1px solid rgba(0,212,255,0.4);background:rgba(0,212,255,0.1);color:#00d4ff;font-weight:700;font-size:0.68rem;cursor:pointer;font-family:"Space Grotesk",sans-serif;letter-spacing:1px;text-transform:uppercase;transition:all 0.2s;}' +
        '.sh_buy:hover{background:rgba(0,212,255,0.2);box-shadow:0 0 12px rgba(0,212,255,0.2);}' +
        '.sh_buy.owned{border-color:rgba(0,255,136,0.3);color:#00ff88;cursor:default;}' +
        '.sh_raffle{background:#0f0f22;border:1px solid #1e1e3a;border-radius:14px;padding:1.4rem;margin-bottom:1rem;}' +
        '</style>' +

        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">üõí CABBAGE STORE</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">Spend cabbage. Flex on everyone.</div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:1rem;">' +
            '<div style="font-size:0.82rem;font-weight:700;color:#00ff88;" id="sh_balance">' + Math.floor(cabBal).toLocaleString() + ' ü•¨</div>' +
            '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
          '</div>' +
        '</div>' +

        '<div class="sh_cats" id="sh_cats"></div>' +
        '<div id="sh_body"></div>' +

        '<div style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:0.9rem 1.2rem;margin-top:1rem;font-size:0.62rem;color:#2a2a44;letter-spacing:0.8px;text-align:center;text-transform:uppercase;">' +
          'Earn ‚Üí Spend ‚Üí Flex ¬∑ Chat cosmetics show for everyone ¬∑ Boosts apply to your next games' +
        '</div>';

      // Render category tabs
      var catsEl = document.getElementById('sh_cats');
      var cHTML = '';
      SHOP_CATS.forEach(function(c) {
        cHTML += '<div class="sh_cat' + (c.id === shop_activeCat ? ' active' : '') + '" onclick="shop_switchCat(\'' + c.id + '\')">' + c.label + '</div>';
      });
      catsEl.innerHTML = cHTML;

      shop_paintStore();
    }

    function shop_switchCat(catId) {
      shop_activeCat = catId;
      var tabs = document.querySelectorAll('.sh_cat');
      tabs.forEach(function(t) { t.classList.remove('active'); });
      var idx = SHOP_CATS.findIndex(function(c) { return c.id === catId; });
      if (tabs[idx]) tabs[idx].classList.add('active');
      shop_paintStore();
    }

    function shop_paintStore() {
      var body = document.getElementById('sh_body');
      if (!body) return;
      var html = '';

      if (shop_activeCat === 'raffle') {
        // Raffle section
        if (shop_raffleCurrent) {
          var r = shop_raffleCurrent;
          var endsStr = r.ends_at ? new Date(r.ends_at).toLocaleDateString() : 'TBD';
          html += '<div class="sh_raffle">' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.2rem;letter-spacing:3px;color:#ffd700;margin-bottom:0.5rem;">üéüÔ∏è ' + escapeHtml(r.title) + '</div>' +
            '<div style="font-size:0.78rem;color:#c8c8e8;margin-bottom:0.5rem;">' + escapeHtml(r.prize_desc || 'NFT Prize') + '</div>' +
            '<div style="display:flex;gap:2rem;flex-wrap:wrap;margin:1rem 0;">' +
              '<div><div style="color:#555;font-size:0.6rem;letter-spacing:1px;">ENDS</div><div style="font-weight:700;color:#00d4ff;">' + endsStr + '</div></div>' +
              '<div><div style="color:#555;font-size:0.6rem;letter-spacing:1px;">TOTAL ENTRIES</div><div style="font-weight:700;color:#7b68ee;">' + (r._totalTickets || 0) + '</div></div>' +
              '<div><div style="color:#555;font-size:0.6rem;letter-spacing:1px;">ENTRANTS</div><div style="font-weight:700;color:#e0e0ff;">' + (r._totalEntrants || 0) + '</div></div>' +
              '<div><div style="color:#555;font-size:0.6rem;letter-spacing:1px;">YOUR TICKETS</div><div style="font-weight:700;color:#00ff88;">' + shop_raffleMyTickets + '</div></div>' +
            '</div>' +
            '<div style="display:flex;align-items:center;gap:1rem;margin-top:0.8rem;">' +
              '<button class="sh_buy" onclick="shop_buy(\'raffle_ticket\')">BUY TICKET ¬∑ 1,000 ü•¨</button>' +
              '<div style="font-size:0.6rem;color:#333;">Each ticket = 1 entry. More tickets = better odds.</div>' +
            '</div>' +
          '</div>';
        } else {
          html += '<div style="text-align:center;color:#333;padding:3rem;font-size:0.82rem;">No active raffle right now. Check back soon!</div>';
        }
      }

      // Item grid
      var items = SHOP_CATALOG.filter(function(i) { return i.cat === shop_activeCat; });
      if (shop_activeCat === 'raffle') {
        // Don't show raffle_ticket in grid ‚Äî it's in the raffle card above
        items = items.filter(function(i) { return i.id !== 'raffle_ticket'; });
      }

      if (items.length > 0) {
        html += '<div class="sh_grid">';
        items.forEach(function(item) {
          var owned = shop_owns(item.id);
          var boostInfo = '';
          if (item.id === 'lucky_boost' && owned) {
            var uses = shop_items[item.id].data ? (shop_items[item.id].data.uses_left || 0) : 0;
            boostInfo = '<div style="font-size:0.6rem;color:#00ff88;margin-bottom:4px;">' + uses + ' uses left</div>';
          }
          html += '<div class="sh_item' + (owned && item.perm ? ' owned' : '') + '">' +
            '<div class="sh_icon">' + item.icon + '</div>' +
            '<div class="sh_name">' + item.name + '</div>' +
            '<div class="sh_desc">' + item.desc + '</div>' +
            boostInfo +
            '<div class="sh_price">' + item.price.toLocaleString() + ' ü•¨</div>';
          if (owned && item.perm) {
            html += '<div class="sh_buy owned">‚úÖ OWNED</div>';
          } else {
            html += '<button class="sh_buy" onclick="shop_buy(\'' + item.id + '\')">' + (owned && !item.perm ? 'BUY MORE' : 'BUY') + '</button>';
          }
          html += '</div>';
        });
        html += '</div>';
      }

      body.innerHTML = html;
    }
    var lb_cache = {};
    var lb_cacheTime = 0;
    var lb_activeTab = 'cabbage';
    var LB_TABS = [
      { id: 'cabbage',  icon: 'ü•¨', label: 'Top Cabbage' },
      { id: 'winners',  icon: 'üé∞', label: 'Casino Wins' },
      { id: 'chatters', icon: 'üî•', label: 'Top Chatters' },
      { id: 'holders',  icon: 'ü™∂', label: 'OG Holders' },
      { id: 'bigwins',  icon: 'üí∞', label: 'Biggest Wins' }
    ];

    async function lb_fetchAll() {
      // Cache for 60s
      if (lb_cache.cabbage && Date.now() - lb_cacheTime < 60000) return lb_cache;
      var sb = getSupaClient();
      try {
        // Top Cabbage Holders
        var cR = await sb.from('cabbage_accounts').select('wallet,balance').order('balance', { ascending: false }).limit(20);
        lb_cache.cabbage = (cR.data || []).filter(function(r) { return r.balance > 0; });

        // Casino total winnings (payout from game_bets where house_profit < 0 means player won)
        var gR = await sb.from('game_bets').select('wallet,bet_amount,house_profit,game').order('played_at', { ascending: false }).limit(2000);
        var gData = gR.data || [];

        // Aggregate wins per wallet
        var winMap = {};
        var bigWins = [];
        gData.forEach(function(b) {
          if (Number(b.house_profit) <= 0) {
            // Player won ‚Äî profit is the negative of house_profit
            var profit = Math.abs(Number(b.house_profit));
            if (!winMap[b.wallet]) winMap[b.wallet] = { wallet: b.wallet, total: 0, count: 0 };
            winMap[b.wallet].total += profit;
            winMap[b.wallet].count++;
            bigWins.push({ wallet: b.wallet, amount: Number(b.bet_amount) + profit, game: b.game });
          }
        });
        lb_cache.winners = Object.values(winMap).sort(function(a, b) { return b.total - a.total; }).slice(0, 20);
        lb_cache.bigwins = bigWins.sort(function(a, b) { return b.amount - a.amount; }).slice(0, 20);

        // Most Active Chatters
        var chR = await sb.from('chat_messages').select('wallet,username').order('created_at', { ascending: false }).limit(2000);
        var chatMap = {};
        (chR.data || []).forEach(function(m) {
          if (!chatMap[m.wallet]) chatMap[m.wallet] = { wallet: m.wallet, username: m.username, count: 0 };
          chatMap[m.wallet].count++;
          if (m.username) chatMap[m.wallet].username = m.username;
        });
        lb_cache.chatters = Object.values(chatMap).sort(function(a, b) { return b.count - a.count; }).slice(0, 20);

        // OG Holders (earliest stakers)
        var hR = await sb.from('cabbage_accounts').select('wallet,started_at').not('started_at', 'is', null).order('started_at', { ascending: true }).limit(20);
        lb_cache.holders = (hR.data || []).filter(function(r) { return r.started_at; });

        lb_cacheTime = Date.now();
      } catch(e) { console.warn('lb_fetchAll error:', e); }
      return lb_cache;
    }

    function lb_shortWallet(w) {
      if (!w || w.length < 8) return w || '‚Äî';
      return w.slice(0, 4) + '‚Ä¶' + w.slice(-4);
    }

    function lb_isMe(w) {
      return walletPublicKey && walletPublicKey.toBase58() === w;
    }

    function lb_daysSince(iso) {
      if (!iso) return 0;
      return Math.floor((Date.now() - new Date(iso).getTime()) / 86400000);
    }

    async function renderLeaderboardUI() {
      var view = document.getElementById('view-leaderboard');
      if (!view) return;

      view.innerHTML =
        '<style>' +
        '.lb_tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:1rem;}' +
        '.lb_tab{padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.2);color:#555;font-size:0.68rem;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:"Space Grotesk",sans-serif;letter-spacing:0.5px;}' +
        '.lb_tab:hover{border-color:rgba(0,212,255,0.3);color:#888;}' +
        '.lb_tab.active{border-color:rgba(0,212,255,0.5);color:#00d4ff;background:rgba(0,212,255,0.08);}' +
        '.lb_table{width:100%;border-collapse:collapse;}' +
        '.lb_table th{text-align:left;font-size:0.6rem;color:#333;letter-spacing:1.5px;text-transform:uppercase;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.04);}' +
        '.lb_table td{padding:10px;font-size:0.78rem;border-bottom:1px solid rgba(255,255,255,0.02);}' +
        '.lb_rank{font-weight:900;width:32px;text-align:center;}' +
        '.lb_gold{color:#ffd700;}.lb_silver{color:#c0c0c0;}.lb_bronze{color:#cd7f32;}' +
        '.lb_me{background:rgba(0,212,255,0.06) !important;}' +
        '.lb_wallet{font-family:monospace;font-size:0.72rem;}' +
        '.lb_val{text-align:right;font-weight:700;font-family:"Space Grotesk",sans-serif;}' +
        '.lb_loading{text-align:center;color:#333;padding:3rem;font-size:0.8rem;letter-spacing:1px;}' +
        '</style>' +

        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">üèÜ LEADERBOARDS</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">See who\'s on top. Compete. Win rewards.</div>' +
          '</div>' +
          '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
        '</div>' +

        '<div class="lb_tabs" id="lb_tabs"></div>' +
        '<div style="background:#0f0f22;border:1px solid #1e1e3a;border-radius:14px;padding:1.2rem;min-height:300px;" id="lb_body">' +
          '<div class="lb_loading">Loading‚Ä¶</div>' +
        '</div>' +

        '<div style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:0.9rem 1.2rem;margin-top:1rem;font-size:0.62rem;color:#2a2a44;letter-spacing:0.8px;text-align:center;text-transform:uppercase;">' +
          'Top players earn rewards ¬∑ Free mints ¬∑ Casino credits ¬∑ Store discounts ¬∑ Special roles' +
        '</div>';

      // Render tab buttons
      var tabsEl = document.getElementById('lb_tabs');
      var tabsHTML = '';
      LB_TABS.forEach(function(t) {
        tabsHTML += '<div class="lb_tab' + (t.id === lb_activeTab ? ' active' : '') + '" onclick="lb_switchTab(\'' + t.id + '\')">' + t.icon + ' ' + t.label + '</div>';
      });
      tabsEl.innerHTML = tabsHTML;

      // Fetch and render
      await lb_fetchAll();
      lb_renderBoard();
    }

    function lb_switchTab(tabId) {
      lb_activeTab = tabId;
      // Update tab active states
      var tabs = document.querySelectorAll('.lb_tab');
      tabs.forEach(function(t) { t.classList.remove('active'); });
      var idx = LB_TABS.findIndex(function(t) { return t.id === tabId; });
      if (tabs[idx]) tabs[idx].classList.add('active');
      lb_renderBoard();
    }

    function lb_renderBoard() {
      var body = document.getElementById('lb_body');
      if (!body) return;
      var data = lb_cache[lb_activeTab] || [];
      if (data.length === 0) {
        body.innerHTML = '<div class="lb_loading">No data yet ‚Äî keep playing!</div>';
        return;
      }

      var html = '<table class="lb_table"><thead><tr><th>#</th><th>Player</th><th style="text-align:right;">';

      if (lb_activeTab === 'cabbage') html += 'Balance</th></tr></thead><tbody>';
      else if (lb_activeTab === 'winners') html += 'Total Won</th></tr></thead><tbody>';
      else if (lb_activeTab === 'chatters') html += 'Messages</th></tr></thead><tbody>';
      else if (lb_activeTab === 'holders') html += 'Holding Since</th></tr></thead><tbody>';
      else if (lb_activeTab === 'bigwins') html += 'Win Amount</th></tr></thead><tbody>';

      data.forEach(function(row, i) {
        var rank = i + 1;
        var rankClass = rank === 1 ? 'lb_gold' : rank === 2 ? 'lb_silver' : rank === 3 ? 'lb_bronze' : '';
        var medal = rank === 1 ? 'üëë' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
        var w = row.wallet || '';
        var meClass = lb_isMe(w) ? ' lb_me' : '';
        var name = row.username || lb_shortWallet(w);

        html += '<tr class="' + meClass + '">';
        html += '<td class="lb_rank ' + rankClass + '">' + medal + '</td>';
        html += '<td>';
        html += '<span style="color:' + (lb_isMe(w) ? '#00d4ff' : '#c8c8e8') + ';font-weight:' + (lb_isMe(w) ? '700' : '400') + ';">' + escapeHtml(name) + '</span>';
        if (lb_isMe(w)) html += ' <span style="font-size:0.58rem;color:#00d4ff;opacity:0.6;">(you)</span>';
        html += '<div class="lb_wallet" style="color:' + walletColor(w) + ';">' + lb_shortWallet(w) + '</div>';
        html += '</td>';
        html += '<td class="lb_val">';

        if (lb_activeTab === 'cabbage') {
          html += '<span style="color:#00ff88;">' + Math.floor(row.balance).toLocaleString() + ' ü•¨</span>';
        } else if (lb_activeTab === 'winners') {
          html += '<span style="color:#ffd700;">' + row.total.toFixed(2) + ' ü•¨</span>';
          html += '<div style="font-size:0.58rem;color:#555;">' + row.count + ' wins</div>';
        } else if (lb_activeTab === 'chatters') {
          html += '<span style="color:#7b68ee;">' + row.count.toLocaleString() + '</span>';
        } else if (lb_activeTab === 'holders') {
          var days = lb_daysSince(row.started_at);
          html += '<span style="color:#00d4ff;">' + days + ' days</span>';
          html += '<div style="font-size:0.55rem;color:#333;">' + new Date(row.started_at).toLocaleDateString() + '</div>';
        } else if (lb_activeTab === 'bigwins') {
          html += '<span style="color:#ffd700;">' + row.amount.toFixed(2) + ' ü•¨</span>';
          html += '<div style="font-size:0.58rem;color:#555;">' + (row.game || '') + '</div>';
        }

        html += '</td></tr>';
      });

      html += '</tbody></table>';

      // Find my position
      var myW = walletPublicKey ? walletPublicKey.toBase58() : '';
      if (myW) {
        var myIdx = data.findIndex(function(r) { return r.wallet === myW; });
        if (myIdx >= 0) {
          html += '<div style="text-align:center;margin-top:1rem;font-size:0.72rem;color:#00d4ff;font-weight:700;">Your rank: #' + (myIdx + 1) + '</div>';
        } else {
          html += '<div style="text-align:center;margin-top:1rem;font-size:0.68rem;color:#333;">You\'re not on this board yet ‚Äî keep going!</div>';
        }
      }

      body.innerHTML = html;
    }

    /* ================================================================
       MISSIONS / QUESTS SYSTEM
    ================================================================ */
    var MQ_DAILY = [
      { id: 'daily_login',    icon: 'üåÖ', name: 'Daily Login',          key: 'daily_login',    goal: 1,  reward: 2,  desc: 'Visit the dashboard' },
      { id: 'claim_staking',  icon: 'ü•¨', name: 'Claim Staking',       key: 'claim_staking',  goal: 1,  reward: 5,  desc: 'Claim your cabbage' },
      { id: 'casino_play_5',  icon: 'üé∞', name: 'Play 5 Casino Games', key: 'casino_play',    goal: 5,  reward: 10, desc: 'Any game counts' },
      { id: 'casino_win_1',   icon: 'üèÜ', name: 'Win a Game',          key: 'casino_win',     goal: 1,  reward: 8,  desc: 'Win any casino game' },
      { id: 'chat_msg_1',     icon: 'üí¨', name: 'Say Something',       key: 'chat_msg',       goal: 1,  reward: 3,  desc: 'Send a chat message' }
    ];
    var MQ_WEEKLY = [
      { id: 'casino_win_5w',  icon: 'üî•', name: 'Win 5 Games',         key: 'casino_win',     goal: 5,  reward: 50,  desc: 'Win 5 casino games this week' },
      { id: 'casino_play_25w',icon: 'üé≤', name: 'Play 25 Games',       key: 'casino_play',    goal: 25, reward: 75,  desc: 'Play 25 casino games this week' },
      { id: 'chat_msg_10w',   icon: 'üì£', name: 'Chat 10 Messages',    key: 'chat_msg',       goal: 10, reward: 30,  desc: 'Send 10 messages this week' },
      { id: 'claim_5w',       icon: 'üìÖ', name: 'Claim 5 Days',        key: 'claim_staking',  goal: 5,  reward: 40,  desc: 'Claim staking 5 different days' }
    ];

    var mq_data = {};  // { missionId: { progress, claimed } }
    var mq_loaded = false;

    function mq_todayKey() {
      return new Date().toISOString().slice(0, 10);
    }
    function mq_weekKey() {
      var d = new Date();
      var jan1 = new Date(d.getFullYear(), 0, 1);
      var wk = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
      return d.getFullYear() + '-W' + String(wk).padStart(2, '0');
    }

    async function mq_load() {
      if (!walletPublicKey) return;
      var sb = getSupaClient();
      var w = walletPublicKey.toBase58();
      var dk = mq_todayKey();
      var wk = mq_weekKey();
      try {
        var res = await sb.from('user_missions').select('*')
          .eq('wallet', w)
          .in('period_key', [dk, wk]);
        if (res.error) throw res.error;
        mq_data = {};
        (res.data || []).forEach(function(r) {
          mq_data[r.mission_id] = { progress: r.progress, claimed: r.claimed };
        });
        mq_loaded = true;
      } catch(e) { console.warn('mq_load error:', e); }
    }

    async function mq_track(actionKey) {
      if (!walletPublicKey) return;
      var sb = getSupaClient();
      var w = walletPublicKey.toBase58();

      // Find all missions that match this action key
      var all = MQ_DAILY.concat(MQ_WEEKLY);
      var matching = all.filter(function(m) { return m.key === actionKey; });
      if (matching.length === 0) return;

      for (var i = 0; i < matching.length; i++) {
        var m = matching[i];
        var isWeekly = MQ_WEEKLY.indexOf(m) >= 0;
        var pk = isWeekly ? mq_weekKey() : mq_todayKey();

        try {
          // Try upsert
          var existing = await sb.from('user_missions')
            .select('id, progress, claimed')
            .eq('wallet', w).eq('mission_id', m.id).eq('period_key', pk)
            .maybeSingle();

          if (existing.data) {
            if (!existing.data.claimed && existing.data.progress < m.goal) {
              await sb.from('user_missions').update({
                progress: existing.data.progress + 1,
                updated_at: new Date().toISOString()
              }).eq('id', existing.data.id);
              // Update local
              mq_data[m.id] = { progress: existing.data.progress + 1, claimed: existing.data.claimed };
            }
          } else {
            await sb.from('user_missions').insert({
              wallet: w, mission_id: m.id, progress: 1, period_key: pk, claimed: false
            });
            mq_data[m.id] = { progress: 1, claimed: false };
          }
        } catch(e) { console.warn('mq_track error:', e); }
      }
    }

    async function mq_claimReward(missionId) {
      var all = MQ_DAILY.concat(MQ_WEEKLY);
      var m = all.find(function(x) { return x.id === missionId; });
      if (!m) return;
      var d = mq_data[missionId];
      if (!d || d.progress < m.goal || d.claimed) return;

      var isWeekly = MQ_WEEKLY.indexOf(m) >= 0;
      var pk = isWeekly ? mq_weekKey() : mq_todayKey();

      try {
        var sb = getSupaClient();
        var w = walletPublicKey.toBase58();
        await sb.from('user_missions').update({ claimed: true }).eq('wallet', w).eq('mission_id', missionId).eq('period_key', pk);
        await g_creditCabbage(m.reward);
        mq_data[missionId].claimed = true;
        mq_paintMissions();
      } catch(e) { alert('Claim failed: ' + (e.message || e)); }
    }

    async function renderMissionsUI() {
      var view = document.getElementById('view-missions');
      if (!view) return;

      // Load data first
      if (!mq_loaded) await mq_load();
      // Track daily login
      await mq_track('daily_login');

      var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;

      view.innerHTML =
        '<style>' +
        '.mq_card{background:#0f0f22;border:1px solid #1e1e3a;border-radius:14px;padding:1.4rem;margin-bottom:1.2rem;}' +
        '.mq_row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.03);}' +
        '.mq_row:last-child{border-bottom:none;}' +
        '.mq_icon{font-size:1.5rem;width:36px;text-align:center;flex-shrink:0;}' +
        '.mq_info{flex:1;min-width:0;}' +
        '.mq_name{font-weight:700;font-size:0.82rem;color:#e0e0ff;margin-bottom:2px;}' +
        '.mq_desc{font-size:0.65rem;color:#444;letter-spacing:0.5px;}' +
        '.mq_bar{height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;margin-top:6px;}' +
        '.mq_fill{height:100%;border-radius:3px;transition:width 0.6s ease;}' +
        '.mq_right{text-align:right;flex-shrink:0;min-width:70px;}' +
        '.mq_reward{font-size:0.7rem;color:#ffd700;font-weight:700;}' +
        '.mq_prog{font-size:0.62rem;color:#555;margin-top:2px;}' +
        '.mq_claim{background:linear-gradient(135deg,rgba(0,255,136,0.15),rgba(0,212,255,0.15));border:1px solid rgba(0,255,136,0.4);color:#00ff88;padding:5px 12px;border-radius:6px;cursor:pointer;font-family:"Space Grotesk",sans-serif;font-weight:700;font-size:0.68rem;letter-spacing:1px;text-transform:uppercase;transition:all 0.2s;margin-top:4px;}' +
        '.mq_claim:hover{background:rgba(0,255,136,0.12);box-shadow:0 0 12px rgba(0,255,136,0.2);}' +
        '.mq_done{font-size:0.68rem;color:#555;font-weight:700;letter-spacing:1px;}' +
        '</style>' +

        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">üéØ MISSIONS</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">Complete tasks. Earn ü•¨ Cabbage. Come back daily.</div>' +
          '</div>' +
          '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
        '</div>' +

        // Summary card
        '<div class="mq_card" style="display:flex;gap:1.5rem;flex-wrap:wrap;align-items:center;padding:1rem 1.4rem;">' +
          '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;">TODAY</div><div style="font-weight:700;color:#00d4ff;font-size:1rem;" id="mq_dailyCount">0/5</div></div>' +
          '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;">THIS WEEK</div><div style="font-weight:700;color:#7b68ee;font-size:1rem;" id="mq_weeklyCount">0/4</div></div>' +
          '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;">EARNED TODAY</div><div style="font-weight:700;color:#ffd700;font-size:1rem;" id="mq_earnedToday">0 ü•¨</div></div>' +
          '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;">HOLDING</div><div style="font-weight:700;color:#00ff88;font-size:1rem;">' + nftCount + ' NFTs</div></div>' +
        '</div>' +

        // Daily
        '<div class="mq_card">' +
          '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1rem;letter-spacing:3px;color:#555;margin-bottom:0.8rem;">üìã DAILY MISSIONS <span style="font-size:0.7rem;color:#333;font-family:\'Space Grotesk\',sans-serif;letter-spacing:0;">Resets at midnight UTC</span></div>' +
          '<div id="mq_dailyList"></div>' +
        '</div>' +

        // Weekly
        '<div class="mq_card">' +
          '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1rem;letter-spacing:3px;color:#555;margin-bottom:0.8rem;">üóìÔ∏è WEEKLY MISSIONS <span style="font-size:0.7rem;color:#333;font-family:\'Space Grotesk\',sans-serif;letter-spacing:0;">Resets every Monday</span></div>' +
          '<div id="mq_weeklyList"></div>' +
        '</div>' +

        // Streak / info
        '<div style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:0.9rem 1.2rem;font-size:0.65rem;color:#2a2a44;letter-spacing:0.8px;text-align:center;text-transform:uppercase;">' +
          'Complete all daily missions for bonus rewards ¬∑ Holding NFTs unlocks future exclusive missions ¬∑ More missions coming soon' +
        '</div>';

      mq_paintMissions();
    }

    function mq_paintMissions() {
      var dEl = document.getElementById('mq_dailyList');
      var wEl = document.getElementById('mq_weeklyList');
      if (!dEl || !wEl) return;

      var dailyDone = 0, dailyEarned = 0;
      var weeklyDone = 0;

      function renderRow(m, isWeekly) {
        var d = mq_data[m.id] || { progress: 0, claimed: false };
        var prog = Math.min(d.progress, m.goal);
        var pct = Math.floor((prog / m.goal) * 100);
        var complete = prog >= m.goal;
        var claimed = d.claimed;

        if (complete && !isWeekly) dailyDone++;
        if (complete && isWeekly) weeklyDone++;
        if (claimed && !isWeekly) dailyEarned += m.reward;
        if (claimed && isWeekly) dailyEarned += m.reward;

        var fillColor = complete ? (claimed ? '#555' : 'linear-gradient(90deg,#00ff88,#00d4ff)') : 'linear-gradient(90deg,#9945ff,#00d4ff)';
        var rightHTML = '';
        if (claimed) {
          rightHTML = '<div class="mq_done">‚úÖ CLAIMED</div>';
        } else if (complete) {
          rightHTML = '<button class="mq_claim" onclick="mq_claimReward(\'' + m.id + '\')">CLAIM ' + m.reward + ' ü•¨</button>';
        } else {
          rightHTML = '<div class="mq_reward">+' + m.reward + ' ü•¨</div><div class="mq_prog">' + prog + '/' + m.goal + '</div>';
        }

        return '<div class="mq_row">' +
          '<div class="mq_icon">' + m.icon + '</div>' +
          '<div class="mq_info">' +
            '<div class="mq_name">' + m.name + '</div>' +
            '<div class="mq_desc">' + m.desc + '</div>' +
            '<div class="mq_bar"><div class="mq_fill" style="width:' + pct + '%;background:' + fillColor + ';"></div></div>' +
          '</div>' +
          '<div class="mq_right">' + rightHTML + '</div>' +
        '</div>';
      }

      var dHTML = '';
      MQ_DAILY.forEach(function(m) { dHTML += renderRow(m, false); });
      dEl.innerHTML = dHTML;

      var wHTML = '';
      MQ_WEEKLY.forEach(function(m) { wHTML += renderRow(m, true); });
      wEl.innerHTML = wHTML;

      // Update summary
      var dc = document.getElementById('mq_dailyCount');
      var wc = document.getElementById('mq_weeklyCount');
      var et = document.getElementById('mq_earnedToday');
      if (dc) dc.textContent = dailyDone + '/' + MQ_DAILY.length;
      if (wc) wc.textContent = weeklyDone + '/' + MQ_WEEKLY.length;
      if (et) et.textContent = dailyEarned + ' ü•¨';
    }

  </script>
</body>
</html>
