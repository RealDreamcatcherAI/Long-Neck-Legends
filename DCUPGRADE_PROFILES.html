<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/jpGdtHJ.jpeg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LNL Holder Dashboard | Profile</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Orbitron:wght@400;700;900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Keep banner links (like X) white */
a.plink,
a.plink:visited,
a.plink:hover,
a.plink:active {
  color: #e0e0ff;          /* your ‚Äúwhite‚Äù */
  text-decoration: none;
}
a.plink:hover{
  text-decoration: underline; /* optional */
}
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a1a;
      color: #e0e0ff;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    body.loaded { opacity: 1; }

    /* ---- TOP NAV (SITE) ---- */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 1rem 0;
      background: rgba(10,10,26,0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    nav a {
      color: #e0e0ff;
      margin: 0 1.5rem;
      text-decoration: none;
      font-weight: 600;
      position: relative;
      font-size: 0.9rem;
    }
    nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #00d4ff;
      transition: 0.3s;
    }
    nav a:hover::after { width: 100%; }

    /* ---- HERO ---- */
    .hero {
      margin-top: 60px;
      padding: 4rem 2rem 2.2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: 'HOLDER';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(120px, 20vw, 400px);
      color: rgba(0,212,255,0.03);
      pointer-events: none;
      white-space: nowrap;
      letter-spacing: 20px;
    }
    .hero h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.6rem, 4vw, 2.8rem);
      font-weight: 900;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .hero h1 span { color: #00d4ff; text-shadow: 0 0 30px rgba(0,212,255,0.4); }
    .hero-sub {
      color: #888;
      font-size: 0.95rem;
    }

    /* ---- DASH NAV (DASHBOARD-ONLY) ---- */
    .dash-nav-wrap{
      position: sticky;
      top: 60px; /* below site nav */
      z-index: 900;
      background: rgba(10,10,26,0.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: none;
    }
    .dash-nav-wrap.show { display: block; }

    .dash-nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.9rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .dash-tabs{
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .dash-tab{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: #bfc2ff;
      padding: 8px 14px;
      font-size: 0.78rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
    }
    .dash-tab:hover{
      border-color: rgba(0,212,255,0.45);
      color: #e0e0ff;
      box-shadow: 0 0 18px rgba(0,212,255,0.12);
      transform: translateY(-1px);
    }
    .dash-tab.active{
      border-color: rgba(0,212,255,0.65);
      color: #00d4ff;
      box-shadow: 0 0 22px rgba(0,212,255,0.16);
    }

    .dash-right{
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.7rem;
      flex-wrap: wrap;
    }

    /* --- DASH NAV mobile-safe polish (max width like cards) --- */
    .dash-nav{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.9rem 2rem;
    }

    .dash-tabs{ flex: 1 1 auto; min-width: 0; }
    .dash-right{ flex: 0 0 auto; }

    .wallet-chip{ max-width: 240px; }
    .wallet-addr{ overflow: hidden; text-overflow: ellipsis; }

    @media (max-width: 800px){
      .dash-nav{ padding: 0.8rem 1rem; }
      .dash-right{ gap: 0.5rem; }
      .wallet-chip{ max-width: 170px; }
    }

    @media (max-width: 420px){
      .dash-nav{ flex-wrap: wrap; row-gap: 0.6rem; }
      .dash-right{ width: 100%; justify-content: flex-end; }
      .wallet-chip{ max-width: 100%; }
    }

    .wallet-chip{
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(17,17,37,0.55);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .wallet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 8px rgba(0,255,136,0.6);
      flex: 0 0 auto;
    }
    .wallet-addr {
      color: #888;
      font-size: 0.78rem;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    .wallet-addr strong { color: #e0e0ff; }

    .disconnect-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.10);
      color: #7a7aa6;
      padding: 8px 12px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.8px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 8px;
      font-weight: 700;
    }
    .disconnect-btn:hover { border-color: #ff3c5c; color: #ff3c5c; box-shadow: 0 0 18px rgba(255,60,92,0.14); }

    @media (max-width: 700px){
      .dash-nav{ padding: 0.8rem 1rem; }
      nav a { margin: 0 0.8rem; font-size: 0.75rem; }
      .wallet-chip{ max-width: 100%; }
    }

    /* ---- CONNECT SECTION ---- */
    .connect-section {
      text-align: center;
      padding: 4rem 2rem;
    }
    .connect-btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7b68ee 100%);
      color: #000;
      border: none;
      padding: 16px 48px;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      border-radius: 4px;
      transition: all 0.3s;
      box-shadow: 0 4px 30px rgba(0,212,255,0.3);
    }
    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 40px rgba(0,212,255,0.5);
    }
    .connect-prompt {
      color: #555;
      margin-top: 1rem;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    /* ---- DASHBOARD GRID / VIEWS ---- */
    .dashboard {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.8rem 2rem 4rem;
      gap: 1.5rem;
    }
    .dashboard.show { display: block; }

    .view{ display: none; }
    .view.show{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    #view-chat.show {
      display: flex;
      flex-direction: column;
      grid-template-columns: unset;
    }
    #view-games.show {
      display: block;
      grid-template-columns: unset;
    }
    #view-store.show {
      display: block;
      grid-template-columns: unset;
    }
    @media (max-width: 800px) {
      .view.show { grid-template-columns: 1fr; }
      .dashboard{ padding: 1.4rem 1rem 3rem; }
    }

    /* ---- TIER CARD ---- */
    .tier-card {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid #1e1e3a;
      border-radius: 16px;
      padding: 2.3rem;
      display: flex;
      align-items: center;
      gap: 2.2rem;
      position: relative;
      overflow: hidden;
      min-height: 180px;
    }
    .tier-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      opacity: 0.08;
      pointer-events: none;
    }
    .tier-card.tier-neck::before { background: radial-gradient(circle, #00d4ff, transparent); }
    .tier-card.tier-longneck::before { background: radial-gradient(circle, #7b68ee, transparent); }
    .tier-card.tier-legend::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-og::before { background: radial-gradient(circle, #ffd700, transparent); }
    .tier-card.tier-sardine::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-barracuda::before { background: radial-gradient(circle, #ff3c5c, transparent); }
    .tier-card.tier-shark::before { background: radial-gradient(circle, #00ffcc, transparent); }
    .tier-card.tier-whale::before { background: radial-gradient(circle, #00ffcc, transparent); }

    @media (max-width: 600px) {
      .tier-card { flex-direction: column; text-align: center; padding: 2rem 1.5rem; }
    }

    .tier-badge {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: 1.8rem;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .tier-badge::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 2px solid;
      animation: tierPulse 2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes tierPulse {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .tier-badge img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.05) contrast(1.05);
    }

    .tier-neck .tier-badge { color: #00d4ff; }
    .tier-neck .tier-badge::after { border-color: #00d4ff; }
    .tier-longneck .tier-badge { color: #7b68ee; }
    .tier-longneck .tier-badge::after { border-color: #7b68ee; }
    .tier-legend .tier-badge { color: #ffd700; }
    .tier-legend .tier-badge::after { border-color: #ffd700; }
    .tier-og .tier-badge { color: #ffd700; }
    .tier-og .tier-badge::after { border-color: #ffd700; }
    .tier-sardine .tier-badge { color: #ff3c5c; }
    .tier-sardine .tier-badge::after { border-color: #ff3c5c; }
    .tier-barracuda .tier-badge { color: #ff3c5c; }
    .tier-barracuda .tier-badge::after { border-color: #ff3c5c; }
    .tier-shark .tier-badge { color: #00ffcc; }
    .tier-shark .tier-badge::after { border-color: #00ffcc; }
    .tier-whale .tier-badge { color: #00ffcc; }
    .tier-whale .tier-badge::after { border-color: #00ffcc; }

    .tier-info { flex: 1; min-width: 240px; }
    .tier-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 0.3rem;
    }
    .tier-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.8rem;
      letter-spacing: 4px;
      line-height: 1;
      margin-bottom: 0.3rem;
    }
    .tier-neck .tier-name { color: #00d4ff; }
    .tier-longneck .tier-name { color: #7b68ee; }
    .tier-legend .tier-name { color: #ffd700; }
    .tier-og .tier-name { color: #ffd700; }
    .tier-sardine .tier-name { color: #ff3c5c; }
    .tier-barracuda .tier-name { color: #ff3c5c; }
    .tier-shark .tier-name { color: #00ffcc; }
    .tier-whale .tier-name { color: #00ffcc; }

    .tier-nfts-held {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .tier-nfts-held strong { color: #e0e0ff; font-weight: 700; }

    .tier-progress-wrap { max-width: 320px; }
    .tier-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
      gap: 12px;
    }
    .tier-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      overflow: hidden;
    }
    .tier-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .tier-neck .tier-progress-fill { background: #00d4ff; box-shadow: 0 0 10px rgba(0,212,255,0.5); }
    .tier-longneck .tier-progress-fill { background: #7b68ee; box-shadow: 0 0 10px rgba(123,104,238,0.5); }
    .tier-legend .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-og .tier-progress-fill { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .tier-sardine .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-barracuda .tier-progress-fill { background: #ff3c5c; box-shadow: 0 0 10px rgba(255,60,92,0.5); }
    .tier-shark .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }
    .tier-whale .tier-progress-fill { background: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.5); }

/* ---- Username + Social Box (right side of tier card) ---- */
.profile-name-box{
  flex: 0 0 320px;
  max-width: 360px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;     /* right align */
  justify-content: center;
  text-align: right;
  gap: 0.5rem;
}

.profile-username{
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.4rem;
  letter-spacing: 4px;
  line-height: 1;
  text-transform: uppercase;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* username color mimics tier-name color */
.tier-neck .profile-username { color: #00d4ff; }
.tier-longneck .profile-username { color: #7b68ee; }
.tier-legend .profile-username { color: #ffd700; }
.tier-og .profile-username { color: #ffd700; }
.tier-sardine .profile-username { color: #ff3c5c; }
.tier-barracuda .profile-username { color: #ff3c5c; }
.tier-shark .profile-username { color: #00ffcc; }
.tier-whale .profile-username { color: #00ffcc; }

.profile-name-inner{
  width: 100%;
  padding: 0.7rem 0.8rem;
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.06);
}

.profile-links{
  display: flex;
  justify-content: flex-end; /* keep right aligned */
  gap: 8px;
  flex-wrap: wrap;
}

/* responsive: center it on smaller widths */
@media (max-width: 900px){
  .profile-name-box{
    flex: 1 1 auto;
    max-width: 100%;
    align-items: center;
    text-align: center;
  }
  .profile-links{ justify-content: center; }
}

    /* ---- STATS CARD ---- */
    .stats-card {
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .stats-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.3rem;
      letter-spacing: 3px;
      color: #555;
      margin-bottom: 1.2rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.7rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: #888; font-size: 0.8rem; }
    .stat-value { font-weight: 700; font-size: 1.1rem; }
    .stat-value.cyan { color: #00d4ff; }
    .stat-value.purple { color: #7b68ee; }
    .stat-value.gold { color: #ffd700; }
    .stat-value.green { color: #00ff88; }

    /* ---- POINTS DISPLAY ---- */
    .points-display { text-align: center; padding: 1.5rem 0; }
    .points-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .points-label {
      font-size: 0.7rem;
      letter-spacing: 3px;
      color: #555;
      text-transform: uppercase;
      margin-top: 0.3rem;
    }

    /* ---- PROFILE ACTIONS ---- */
    .profile-actions{
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 1.6rem 2rem;
    }
    .profile-actions.is-hidden { display: none; }
    .actions-grid{
      display: grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap: 0.8rem;
      margin-top: 0.9rem;
    }
    @media (max-width: 1100px){
      .actions-grid{ grid-template-columns: repeat(3, minmax(140px, 1fr)); }
    }
    @media (max-width: 600px){
      .actions-grid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .points-number { font-size: 2.5rem; }
    }
    .action-btn{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      color: #cfd2ff;
      padding: 12px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 800;
      font-size: 0.74rem;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      font-family: 'Space Grotesk', sans-serif;
      text-align: center;
    }
    .action-btn:hover{
      border-color: rgba(0,212,255,0.45);
      box-shadow: 0 0 22px rgba(0,212,255,0.12);
      transform: translateY(-1px);
      color: #e0e0ff;
    }
    .action-btn.danger:hover{
      border-color: rgba(255,60,92,0.6);
      box-shadow: 0 0 22px rgba(255,60,92,0.10);
      color: #ff7a90;
    }

    /* ---- PERKS CARD ---- */
    .perks-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .perks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .perk {
      background: rgba(0,0,0,0.3);
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      padding: 1.2rem;
      position: relative;
      transition: all 0.3s;
    }
    .perk.unlocked { border-color: rgba(0,212,255,0.3); background: rgba(0,212,255,0.04); }
    .perk.locked { opacity: 0.4; }
    .perk-icon { font-size: 1.8rem; margin-bottom: 0.6rem; }
    .perk-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 0.3rem; letter-spacing: 0.5px; }
    .perk-desc { color: #666; font-size: 0.72rem; line-height: 1.5; }
    .perk-req { font-size: 0.65rem; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-top: 0.6rem; }
    .perk-req.met { color: #00ff88; }
    .perk-status {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .perk-status.on { background: #00ff88; box-shadow: 0 0 8px rgba(0,255,136,0.6); }
    .perk-status.off { background: #333; }

    /* ---- NFT GALLERY ---- */
    .gallery-card {
      grid-column: 1 / -1;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
      padding: 2rem;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .nft-tile {
      background: #0a0a1a;
      border: 1px solid #1e1e3a;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
    }
    .nft-tile:hover {
      transform: translateY(-4px);
      border-color: rgba(0,212,255,0.4);
      box-shadow: 0 8px 30px rgba(0,212,255,0.15);
    }
    .nft-tile img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .nft-tile-info { padding: 0.7rem; }
    .nft-tile-name {
      font-weight: 700;
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nft-tile-id { color: #555; font-size: 0.65rem; margin-top: 2px; }

    /* ---- SHARE CARD ---- */
    .share-section { grid-column: 1 / -1; text-align: center; padding: 1rem 0; }
    .share-btn {
      background: transparent;
      border: 1px solid #1e1e3a;
      color: #888;
      padding: 10px 28px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
      transition: all 0.2s;
      border-radius: 4px;
    }
    .share-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
      box-shadow: 0 0 20px rgba(0,212,255,0.15);
    }

    /* ---- NO NFTS STATE ---- */
    .no-nfts {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem 2rem;
      background: #111125;
      border: 1px solid #1e1e3a;
      border-radius: 14px;
    }
    .no-nfts h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 3px;
      margin-bottom: 0.5rem;
    }
    .no-nfts p { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .no-nfts a {
      display: inline-block;
      background: linear-gradient(135deg, #00d4ff, #7b68ee);
      color: #000;
      text-decoration: none;
      padding: 12px 36px;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .no-nfts a:hover { box-shadow: 0 4px 30px rgba(0,212,255,0.4); transform: translateY(-2px); }

    /* ---- LOADING ---- */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0,212,255,0.15);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      color: #555;
      font-size: 0.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* ---- MODALS ---- */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1.2rem;
    }
    .modal-backdrop.show{ display: flex; }

    .modal{
      width: min(920px, 100%);
      max-height: 85vh; 
      background: linear-gradient(135deg, #111125 0%, #0d0d20 100%);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
    }
    .modal-head{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.18);
    }
    .modal-title{
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      letter-spacing: 2px;
      font-size: 0.95rem;
      color: #e0e0ff;
      text-transform: uppercase;
    }
    .modal-close{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      color: #9a9abd;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 900;
      transition: all 0.2s;
    }
    .modal-close:hover{
      border-color: rgba(255,60,92,0.55);
      color: #ff3c5c;
      box-shadow: 0 0 16px rgba(255,60,92,0.12);
    }
    .modal-body{
      padding: 1.2rem;
      max-height: min(70vh, 640px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .pfp-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.9rem;
    }
    .pfp-tile{
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.22);
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .pfp-tile:hover{
      border-color: rgba(0,212,255,0.45);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,212,255,0.10);
    }
    .pfp-tile img{
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    .pfp-tile .pfp-name{
      padding: 0.6rem 0.7rem;
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.4px;
      color: #e0e0ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pfp-selected{
      position: absolute;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.55);
      display: none;
    }
    .pfp-tile.selected .pfp-selected{ display: block; }

    .modal-note{
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 0.9rem;
      letter-spacing: 0.4px;
    }

    /* ---- FOOTER ---- */
    footer {
      text-align: center;
      padding: 3rem 2rem;
      border-top: 1px solid #1e1e3a;
      color: #333;
      font-size: 0.7rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* ---- SCROLLBAR ---- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a1a; }
    ::-webkit-scrollbar-thumb { background: #1e1e3a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #00d4ff; }

    @media (max-width: 600px) {
      .perks-grid { grid-template-columns: 1fr 1fr; }
      .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    }
  
    /* ---- TRAITS / SUBDAO ---- */
    .subdao-divider{
      margin-top: 1.2rem;
      padding-top: 1.2rem;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .subdao-grid{
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 900px){
      .subdao-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px){
      .subdao-grid{ grid-template-columns: 1fr; }
    }
    .trait-pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 0.6rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color:#bfc2ff;
      font-size:0.7rem;
      letter-spacing:0.6px;
      text-transform: uppercase;
      cursor: default;
      user-select:none;
    }
    .pill.on{
      border-color: rgba(0,255,136,0.35);
      background: rgba(0,255,136,0.06);
      color: #00ff88;
      box-shadow: 0 0 18px rgba(0,255,136,0.08);
    }
    .pill.off{ opacity: 0.45; }
    .trait-table{
      width:100%;
      border-collapse: collapse;
      margin-top: 0.8rem;
      font-size: 0.8rem;
    }
    .trait-table th, .trait-table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: left;
      vertical-align: top;
    }
    .trait-table th{
      font-family: 'Bebas Neue', sans-serif;
      letter-spacing: 2px;
      color:#777;
      font-size: 0.95rem;
    }
    .trait-muted{ color:#666; font-size:0.78rem; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>

<body>
  <nav>
    <a href="https://longnecklegends.xyz/">Home</a>
    <a href="/starternecks.html">Starter Necks</a>
    <a href="/music.html">Music</a>
    <a href="/hotsaucemint.html">Hot Sauce</a>
    <a href="/store.html">Store</a>
  </nav>

  <section class="hero">
    <h1>HOLDER <span>DASHBOARD</span></h1>
    <p class="hero-sub">Customize your profile, connect your wallet, and manage your Cabbage staking</p>
  </section>

  <!-- DASHBOARD-ONLY NAV BAR -->
  <div class="dash-nav-wrap" id="dashNavWrap">
    <div class="dash-nav">
      <div class="dash-tabs">
        <button class="dash-tab" id="tabProfile" onclick="toggleProfilePanel()">Profile</button>
        <button class="dash-tab" id="tabChat" onclick="switchView('chat')">üí¨ Chat</button>
        <button class="dash-tab" id="tabGames" onclick="switchView('games')">üé∞ Casino</button>
        <button class="dash-tab" id="tabStore" onclick="switchView('store')">ü•¨ Store</button>
      </div>

      <div class="dash-right">
        <div class="wallet-chip" id="walletChip" style="display:none;">
          <div class="wallet-dot"></div>
          <span class="wallet-addr"><strong id="walletDisplay">‚Äî</strong></span>
        </div>
        <button class="disconnect-btn" id="disconnectBtn" style="display:none;" onclick="disconnectWallet()">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- CONNECT PROMPT -->
  <div class="connect-section" id="connectSection">
    <button class="connect-btn" onclick="connectWallet()">CONNECT WALLET</button>
    <p class="connect-prompt">Phantom &bull; Solflare &bull; Magic Eden</p>
  </div>

  <!-- LOADING -->
  <div class="connect-section" id="loadingSection" style="display:none;">
    <div class="loading-spinner"></div>
    <p class="loading-text">Scanning your wallet...</p>
  </div>

  <!-- DASHBOARD WRAP -->
  <div class="dashboard" id="dashboard">
    <div class="view show" id="view-profile"></div>
    <div class="view" id="view-chat"></div>
    <div class="view" id="view-games"></div>
    <div class="view" id="view-store"></div>
  </div>

  <!-- PFP MODAL -->
  <div class="modal-backdrop" id="pfpModalBackdrop" onclick="closePfpModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Select Your LNL PFP</div>
        <button class="modal-close" onclick="hidePfpModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="modal-note">Pick one of your Long Neck Legends. This sets your Profile PFP for this wallet on this device.</div>
        <div class="pfp-grid" id="pfpGrid"></div>
      </div>
    </div>
  </div>

  <!-- SECOND WALLET MODAL -->
  <div class="modal-backdrop" id="secondWalletModalBackdrop" onclick="closeSecondWalletModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Link 2nd Wallet</div>
        <button class="modal-close" onclick="hideSecondWalletModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="modal-note">
          Connect a second wallet to combine your LNL holdings across wallets. (Main wallet stays connected.)
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('phantom')">Phantom</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('solflare')">Solflare</button>
          <button class="action-btn" style="flex:1; min-width:180px;" onclick="connectSecondWallet('magiceden')">Magic Eden</button>
        </div>

        <div id="secondWalletStatus" style="color:#666; font-size:0.82rem; line-height:1.5;">
          No second wallet linked yet.
        </div>

        <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
          <button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="unlinkSecondWallet()">Unlink</button>
          <button class="disconnect-btn" onclick="hideSecondWalletModal()">Close</button>
        </div>
      </div>
    </div>
  </div>


  <!-- TRAITS MODAL -->
  <div class="modal-backdrop" id="traitsModalBackdrop" onclick="closeTraitsModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title">Trait Data</div>
        <button class="modal-close" onclick="hideTraitsModal()">‚úï</button>
      </div>
      <div class="modal-body" id="traitsModalBody">
        <div class="modal-note">This is pulled live from your NFTs metadata. SubDAO unlocks are based on holding at least 1 matching trait.</div>
        <div id="subdaoPills" class="trait-pills"></div>
        <table class="trait-table" id="traitsTable">
          <thead>
            <tr><th>Trait</th><th>Count</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="trait-muted">Tip: If something looks missing, it usually means the NFT metadata doesn‚Äôt include that attribute field.</div>
      </div>
    </div>
  </div>


  <footer>
    <p>&copy; 2026 Long Neck Legends &bull; Diamond Hands Only</p>
  </footer>

  <script>
    window.addEventListener('load', function() { document.body.classList.add('loaded'); });

    var CONFIG = {
      COLLECTION_MINT: "8Rt3Ayqth4DAiPnW9MDFi63TiQJHmohfTWLMQFHi4KZH",
      RPC_URL: "https://mainnet.helius-rpc.com/?api-key=44cfd082-9089-430d-8de3-cd310c478b1c",
      MAGIC_EDEN_LINK: "https://magiceden.us/marketplace/long_neck_legends"
    };

    var TIERS = [
      { id: "civilian", name: "CIVILIAN", min: 0, icon: "\u{1F464}", pointsMultiplier: 0, discount: 0, raffleMultiplier: 0, cssClass: "" },
      { id: "neck", name: "NECK", min: 1, icon: "\u{1F995}", pointsMultiplier: 1, discount: 10, raffleMultiplier: 1, cssClass: "tier-neck" },
      { id: "longneck", name: "LONG NECK", min: 5, icon: "\u{1F525}", pointsMultiplier: 1.5, discount: 15, raffleMultiplier: 2, cssClass: "tier-longneck" },
      { id: "legend", name: "LEGEND", min: 10, icon: "\u{2B50}", pointsMultiplier: 2.5, discount: 20, raffleMultiplier: 3, cssClass: "tier-legend" },
      { id: "og", name: "OG LEGEND", min: 20, icon: "\u{1F451}", pointsMultiplier: 4, discount: 25, raffleMultiplier: 5, cssClass: "tier-og" },
      { id: "sardine", name: "SARDINE", min: 30, icon: "\u{1F41F}", pointsMultiplier: 6, discount: 30, raffleMultiplier: 6, cssClass: "tier-sardine" },
      { id: "barracuda", name: "BARRACUDA", min: 50, icon: "\u{1F52A}", pointsMultiplier: 7, discount: 35, raffleMultiplier: 7, cssClass: "tier-barracuda" },
      { id: "shark", name: "SHARK", min: 75, icon: "\u{1F988}", pointsMultiplier: 8, discount: 35, raffleMultiplier: 8, cssClass: "tier-shark" },
      { id: "whale", name: "WHALE", min: 100, icon: "\u{1F40B}", pointsMultiplier: 10, discount: 40, raffleMultiplier: 10, cssClass: "tier-whale" }
    ];

    var PERKS = [
      { icon: "\u{1F995}", name: "Store Discount", desc: "Get a discount on all LNL Store purchases paid in SOL.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "Raffle Entries", desc: "Earn entries into exclusive drops, giveaways, and raffles.", reqTier: "neck", dynamic: true },
      { icon: "\u{1F995}", name: "IRL Access", desc: "Entry to LNL events, listening parties, and tastings.", reqTier: "neck" },
      { icon: "\u{1F525}", name: "Exclusive Merch", desc: "Unlock holder-only merch that never hits the public store.", reqTier: "longneck" },
      { icon: "\u{2B50}", name: "Exclusive Merch", desc: "Vote on the next apparel drop. Your neck, your choice.", reqTier: "legend" },
      { icon: "\u{2B50}", name: "Flavor Voting", desc: "Vote on the next hot sauce flavor. Your taste, your choice.", reqTier: "legend" },
      { icon: "\u{1F451}", name: "Early Access", desc: "Get first dibs on new sauce flavors, merch drops, and collections.", reqTier: "og" },
      { icon: "\u{1F451}", name: "VIP IRL Access", desc: "VIP entry to LNL events, listening parties, and tastings.", reqTier: "og" },
      { icon: "\u{1F41F}", name: "Diamond Hands Club", desc: "Private group with alpha, airdrops, and direct team access.", reqTier: "sardine" },
      { icon: "\u{1F52A}", name: "Monthly Airdrop", desc: "Free products, NFTs, and surprises delivered monthly.", reqTier: "barracuda" },
      { icon: "\u{1F988}", name: "Shark Council", desc: "Direct input on project direction, partnerships, and roadmap decisions.", reqTier: "shark" },
      { icon: "\u{1F40B}", name: "Lifetime Perks", desc: "Permanent max discount, first priority on all future drops, and custom merch.", reqTier: "whale" }
    ];


    // ---- SUBDAO (Trait-based) ----
    var SUBDAOS = [
      { id:"talltoker",  name:"Tall Toker",     icon:"üö¨", reqValues:["Gold Pipe Beak","Blunt Beak"], desc:"Hold at least 1 LNL with Gold Pipe Beak or Blunt Beak." },
      { id:"jeeterbeater", name:"Jeeter Beater", icon:"ü•ä", reqValues:["Boxing Gloves"], desc:"Hold at least 1 LNL with Boxing Gloves." },
      { id:"hoodiegang", name:"Hoodie Gang",    icon:"üß•", reqValues:["Hoodie"], desc:"Hold at least 1 LNL with Hoodie." },
      { id:"headphones", name:"HeadPhones",     icon:"üéß", reqValues:["Headphones"], desc:"Hold at least 1 LNL with Headphones." },
      { id:"royalty",    name:"Royalty",        icon:"üëë", reqValues:["Golden Crown","Hippie Crown","Gold Grill Beak"], desc:"Hold at least 1 LNL with Golden Crown, Hippie Crown, or Gold Grill Beak." },
      { id:"wizzy",      name:"Wizzy",          icon:"üßô", reqValues:["Wizard Hat"], desc:"Hold at least 1 LNL with Wizard Hat." },
      { id:"bob",        name:"BoB",            icon:"üß¢", reqValues:["Beanie"], desc:"Hold at least 1 LNL with Beanie." },
      { id:"frobros",    name:"Fro Bros",       icon:"ü¶±", reqValues:["Afro"], desc:"Hold at least 1 LNL with Afro." },
      { id:"goldenticket", name:"Golden Ticket", icon:"üéüÔ∏è", reqValues:["Golden Ticket"], desc:"Hold at least 1 LNL with Golden Ticket." }
    ];

    function normStr(s){
      return String(s || "").trim().toLowerCase();
    }

    function buildTraitValueSet(nfts){
      var set = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          set[normStr(v)] = true;
        });
      });
      return set;
    }

    function getSubdaoMatches(nfts){
      var values = buildTraitValueSet(nfts);
      return SUBDAOS.map(function(d){
        var hit = "";
        for (var i=0;i<d.reqValues.length;i++){
          if (values[normStr(d.reqValues[i])]) { hit = d.reqValues[i]; break; }
        }
        return { id:d.id, name:d.name, icon:d.icon, unlocked: !!hit, hit: hit, reqValues: d.reqValues, desc: d.desc };
      });
    }

    function buildTraitCounts(nfts){
      var counts = {};
      (nfts || []).forEach(function(nft){
        var attrs = nft && nft.attributes ? nft.attributes : [];
        if (!Array.isArray(attrs)) return;
        attrs.forEach(function(a){
          if (!a) return;
          var v = a.value != null ? String(a.value) : "";
          if (!v) return;
          var key = v.trim();
          counts[key] = (counts[key] || 0) + 1;
        });
      });
      return counts;
    }


    var walletProvider = null;
    var walletPublicKey = null;

    var session = {
      loadedNFTs: [],
      profileId: null,
      profile: {
        username: "",
        pfpMint: "",
        pfpImage: "",
        x: "",
        discord: "",
        ledger: ""
      },
      secondWallet: { address: "" },
      currentView: "profile",
      profilePanelOpen: false
    };

    function getTier(count) {
      for (var i = TIERS.length - 1; i >= 0; i--) {
        if (count >= TIERS[i].min) return TIERS[i];
      }
      return TIERS[0];
    }
    function getNextTier(tier) {
      var idx = TIERS.findIndex(function(t) { return t.id === tier.id; });
      return idx < TIERS.length - 1 ? TIERS[idx + 1] : null;
    }
    function getProviderByName(name){
      if (name === "phantom") {
        if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
        if (window.solana && window.solana.isPhantom) return window.solana;
      }
      if (name === "solflare") {
        if (window.solflare && window.solflare.isSolflare) return window.solflare;
        if (window.solflare && window.solflare.solana) return window.solflare.solana;
      }
      if (name === "magiceden") {
        if (window.magicEden && window.magicEden.solana) return window.magicEden.solana;
        if (window.solana && window.solana.isMagicEden) return window.solana;
        if (window.solana && window.solana.isMagicEdenWallet) return window.solana;
      }
      return null;
    }

    function detectWalletProvider() {
      if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
      if (window.backpack && window.backpack.solana) return window.backpack.solana;
      if (window.solflare && window.solflare.isSolflare) return window.solflare;
      if (window.solflare && window.solflare.solana) return window.solflare.solana;
      if (window.solana && window.solana.isPhantom) return window.solana;
      if (window.solana) return window.solana;
      return null;
    }

    function storageKey() {
      var addr = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_profile_" + addr;
    }

    function loadProfileFromStorage() {
      try {
        var raw = localStorage.getItem(storageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && typeof data === "object") {
          session.profile.username = data.username || "";
          session.profile.pfpMint = data.pfpMint || "";
          session.profile.pfpImage = data.pfpImage || "";
          session.profile.x = data.x || "";
          session.profile.discord = data.discord || "";
          session.profile.ledger = data.ledger || "";
        }
      } catch (e) {}
    }

    function saveProfileToStorage() {
      try { localStorage.setItem(storageKey(), JSON.stringify(session.profile)); } catch (e) {}
      // Also persist to Supabase (debounced) if we have a resolved profileId
      try { queueSaveProfileToSupabase(); } catch (e) {}
    }

    function secondWalletStorageKey(){
      var primary = walletPublicKey ? walletPublicKey.toBase58() : "no_wallet";
      return "lnl_second_wallet_for_" + primary;
    }

    function loadSecondWalletFromStorage(){
      try{
        var raw = localStorage.getItem(secondWalletStorageKey());
        if (!raw) return;
        var data = JSON.parse(raw);
        if (data && data.address) session.secondWallet.address = data.address;
      }catch(e){}
    }

    function saveSecondWalletToStorage(){
      try{
        localStorage.setItem(secondWalletStorageKey(), JSON.stringify({ address: session.secondWallet.address || "" }));
      }catch(e){}
    }

    function shortAddr(addr){
      if (!addr) return "‚Äî";
      return addr.slice(0,4) + "..." + addr.slice(-4);
    }

    function sanitizeName(input){
      var s = (input || "").trim();
      s = s.replace(/\s+/g, " ");
      if (s.length > 24) s = s.slice(0, 24);
      return s;
    }

    function normalizeHandle(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/^@+/, "");
      if (s.length > 30) s = s.slice(0, 30);
      return s;
    }

    function normalizeDiscord(input){
      var s = (input || "").trim();
      if (!s) return "";
      s = s.replace(/\s+/g, "");
      if (s.length > 32) s = s.slice(0, 32);
      return s;
    }

    function buildXUrl(handle){
      var h = normalizeHandle(handle);
      if (!h) return "";
      return "https://x.com/" + encodeURIComponent(h);
    }

    async function fetchAssetsByOwner(ownerAddress){
      var res = await fetch(CONFIG.RPC_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          jsonrpc: "2.0",
          id: "lnl",
          method: "getAssetsByOwner",
          params: {
            ownerAddress: ownerAddress,
            page: 1,
            limit: 1000,
            displayOptions: { showCollectionMetadata: true }
          }
        })
      });

      var json = await res.json();
      var items = (json && json.result && json.result.items) ? json.result.items : [];

      var lnlAssets = items.filter(function(a) {
        var groups = a.grouping || [];
        var g = groups.find(function(x) { return x.group_key === "collection"; });
        return g && g.group_value === CONFIG.COLLECTION_MINT;
      });

      var picked = (lnlAssets.length > 0) ? lnlAssets : items.filter(function(a) {
        var sym = (a.content && a.content.metadata && a.content.metadata.symbol) ||
                  (a.content && a.content.json && a.content.json.symbol) || "";
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "";
        var lname = String(name || "").toLowerCase();
        return (sym === "LNL") || (lname.indexOf("long neck") !== -1);
      });

      
      return picked.map(function(a) {
        var name = (a.content && a.content.metadata && a.content.metadata.name) ||
                   (a.content && a.content.json && a.content.json.name) || "LNL";
        var image = (a.content && a.content.links && a.content.links.image) ||
                    (a.content && a.content.files && a.content.files[0] && a.content.files[0].uri) ||
                    (a.content && a.content.json && a.content.json.image) || "";
        var mint = a.id || "";

        // traits/attributes can appear in a few places depending on indexer
        var attrs =
          (a.content && a.content.metadata && a.content.metadata.attributes) ||
          (a.content && a.content.json && a.content.json.attributes) ||
          (a.content && a.content.metadata && a.content.metadata.traits) ||
          [];

        // normalize to [{trait_type, value}]
        var norm = [];
        if (Array.isArray(attrs)) {
          norm = attrs.map(function(x){
            if (!x) return null;
            if (typeof x === "string") return { trait_type: "Trait", value: x };
            var tt = x.trait_type || x.traitType || x.type || x.name || "Trait";
            var vv = x.value != null ? x.value : (x.val != null ? x.val : "");
            return { trait_type: String(tt || "Trait"), value: String(vv || "") };
          }).filter(Boolean);
        } else if (attrs && typeof attrs === "object") {
          // some formats are {trait_type: value, ...}
          Object.keys(attrs).forEach(function(k){
            norm.push({ trait_type: String(k), value: String(attrs[k]) });
          });
        }

        return { name: name, image: image, mint: mint, owner: ownerAddress, attributes: norm };
      });

    }

    function applyProfilePanelUI(){
      var btn = document.getElementById("tabProfile");
      var panel = document.getElementById("profilePanel");

      if (btn) btn.classList.toggle("active", !!session.profilePanelOpen);
      if (panel) panel.classList.toggle("is-hidden", !session.profilePanelOpen);
    }

    function toggleProfilePanel(){
      session.profilePanelOpen = !session.profilePanelOpen;
      applyProfilePanelUI();
    }

    async function connectWallet() {
      var provider = detectWalletProvider();
      if (!provider || typeof provider.connect !== "function") {
        alert("No Solana wallet found.\n\nInstall Phantom, Solflare, or Backpack and refresh the page.");
        return;
      }
      try {
        var resp = await provider.connect({ onlyIfTrusted: false });
        walletProvider = provider;
        walletPublicKey = resp.publicKey || provider.publicKey;
        if (!walletPublicKey) throw new Error("Wallet connected but no public key returned. Try unlocking your wallet first.");

        var addr = walletPublicKey.toBase58();
        document.getElementById("walletDisplay").textContent = shortAddr(addr);

        document.getElementById("dashNavWrap").classList.add("show");
        document.getElementById("walletChip").style.display = "flex";
        document.getElementById("disconnectBtn").style.display = "inline-block";

        document.getElementById("connectSection").style.display = "none";
        document.getElementById("loadingSection").style.display = "block";

        loadProfileFromStorage();
        loadSecondWalletFromStorage();

        await hydrateProfileAndWalletsFromSupabase(addr);

        session.profilePanelOpen = false;
        applyProfilePanelUI();

        await loadDashboard();
      } catch (err) {
        console.error("Connect error:", err);
        if (err.code === 4001 || (err.message && err.message.toLowerCase().includes("user rejected"))) {
          // User cancelled ‚Äî no alert needed
        } else {
          alert("Connection failed: " + (err.message || err));
        }
      }
    }

    function disconnectWallet() {
      stopChatPoll();
      try { if (walletProvider && walletProvider.disconnect) walletProvider.disconnect(); } catch (e) {}
      walletProvider = null;
      walletPublicKey = null;

      document.getElementById("dashNavWrap").classList.remove("show");
      document.getElementById("walletChip").style.display = "none";
      document.getElementById("disconnectBtn").style.display = "none";

      document.getElementById("connectSection").style.display = "block";
      document.getElementById("loadingSection").style.display = "none";
      document.getElementById("dashboard").classList.remove("show");
      document.getElementById("view-profile").classList.remove("show");
      document.getElementById("view-chat").classList.remove("show");
      document.getElementById("view-games").classList.remove("show");
      document.getElementById("view-store").classList.remove("show");

      session.profilePanelOpen = false;
      var tabProfile = document.getElementById("tabProfile");
      if (tabProfile) tabProfile.classList.remove("active");
      var tabChat = document.getElementById("tabChat");
      if (tabChat) tabChat.classList.remove("active");
      var tabGames = document.getElementById("tabGames");
      if (tabGames) tabGames.classList.remove("active");
      var tabStore = document.getElementById("tabStore");
      if (tabStore) tabStore.classList.remove("active");

      session.currentView = "profile";
    }

    function switchView(viewName){
      session.currentView = viewName;

      // Hide all views
      var vp = document.getElementById("view-profile");
      var vc = document.getElementById("view-chat");
      var vg = document.getElementById("view-games");
      var vs = document.getElementById("view-store");
      if (vp) vp.classList.remove("show");
      if (vc) vc.classList.remove("show");
      if (vg) vg.classList.remove("show");
      if (vs) vs.classList.remove("show");

      // Deactivate all tabs
      var tabProfile = document.getElementById("tabProfile");
      var tabChat    = document.getElementById("tabChat");
      var tabGames   = document.getElementById("tabGames");
      var tabStore   = document.getElementById("tabStore");
      if (tabProfile) tabProfile.classList.remove("active");
      if (tabChat)    tabChat.classList.remove("active");
      if (tabGames)   tabGames.classList.remove("active");
      if (tabStore)   tabStore.classList.remove("active");

      if (viewName === "profile") {
        stopChatPoll();
        if (vp) vp.classList.add("show");
        if (tabProfile) tabProfile.classList.toggle("active", !!session.profilePanelOpen);
      }

      if (viewName === "chat") {
        if (vc) vc.classList.add("show");
        if (tabChat) tabChat.classList.add("active");
        renderChatUI();
      }

      if (viewName === "games") {
        stopChatPoll();
        if (vg) vg.classList.add("show");
        if (tabGames) tabGames.classList.add("active");
        renderGamesUI();
      }

      if (viewName === "store") {
        stopChatPoll();
        if (vs) vs.classList.add("show");
        if (tabStore) tabStore.classList.add("active");
        renderStoreUI();
      }
    }

    async function loadDashboard() {
      try {
        var primary = walletPublicKey.toBase58();
        var owners = [primary];

        if (session.secondWallet.address) owners.push(session.secondWallet.address);

        var all = [];
        for (var i=0; i<owners.length; i++){
          var arr = await fetchAssetsByOwner(owners[i]);
          all = all.concat(arr);
        }

        var seen = {};
        var merged = [];
        for (var j=0; j<all.length; j++){
          var m = all[j].mint;
          if (!m) continue;
          if (seen[m]) continue;
          seen[m] = true;
          merged.push(all[j]);
        }

        session.loadedNFTs = merged;

        if (!session.profile.pfpMint && merged.length > 0) {
          session.profile.pfpMint = merged[0].mint;
          session.profile.pfpImage = merged[0].image || "";
          saveProfileToStorage();
        } else if (session.profile.pfpMint) {
          var found = merged.find(function(n){ return n.mint === session.profile.pfpMint; });
          if (found && found.image) {
            session.profile.pfpImage = found.image;
            saveProfileToStorage();
          }
        }

        document.getElementById("loadingSection").style.display = "none";
        renderProfileView(merged);

        document.getElementById("dashboard").classList.add("show");
        switchView("profile");

      } catch (err) {
        console.error("Dashboard error:", err);
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("connectSection").style.display = "block";
        alert("Error loading NFTs: " + (err.message || err));
      }
    }

    function renderProfileView(nfts) {
      var view = document.getElementById("view-profile");
      view.innerHTML = "";

      var count = nfts.length;

      if (count === 0) {
        view.innerHTML = `
          <div class="no-nfts">
            <h2>NO LONG NECK LEGENDS FOUND</h2>
            <p>You don't hold any LNL NFTs in this wallet. Cop one to unlock holder perks.</p>
            <a href="${CONFIG.MAGIC_EDEN_LINK}" target="_blank">BUY ON MAGIC EDEN</a>
          </div>
        `;
        applyProfilePanelUI();
        return;
      }

      var tier = getTier(count);
      var nextTier = getNextTier(tier);
      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
      var disc = session.profile.discord ? session.profile.discord : "";

      var progressHTML = "";
      if (nextTier) {
        var progress = ((count - tier.min) / (nextTier.min - tier.min)) * 100;
        progressHTML =
          '<div class="tier-progress-wrap">' +
            '<div class="tier-progress-label"><span>' + tier.name + '</span><span>' + nextTier.name + ' (' + nextTier.min + ' NFTs)</span></div>' +
            '<div class="tier-progress-bar"><div class="tier-progress-fill" style="width:' + Math.min(progress,100) + '%"></div></div>' +
          '</div>';
      } else {
        progressHTML = '<div style="color:#555;font-size:0.75rem;letter-spacing:2px;text-transform:uppercase;">MAX TIER REACHED \u{1F451}</div>';
      }

      var badgeInner = "";
      if (session.profile.pfpImage) {
        badgeInner = '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">';
      } else {
        badgeInner = tier.icon;
      }

      var linksHTML = '';
      if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
      if (disc) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + disc + '</span>';
      if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';

      view.innerHTML +=
      '<div class="tier-card ' + tier.cssClass + '">' +
        '<div class="tier-badge" id="pfpBadge">' + badgeInner + '</div>' +
        '<div class="tier-info">' +
          '<div class="tier-label">YOUR TIER</div>' +
          '<div class="tier-name">' + tier.name + '</div>' +
          '<div class="tier-nfts-held">Holding <strong>' + count + '</strong> Long Neck Legend' + (count !== 1 ? "s" : "") + '</div>' +
          progressHTML +
        '</div>' +
        '<div class="profile-name-box">' +
          '<div class="profile-username" id="bannerUsername">' + escapeHtml(displayName) + '</div>' +
          '<div class="profile-name-inner">' +
            '<div class="profile-links" id="bannerLinks">' + linksHTML + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

      view.innerHTML +=
        '<div class="profile-actions" id="profilePanel">' +
          '<div class="stats-title">PROFILE</div>' +
          '<div class="actions-grid">' +
            '<button class="action-btn" onclick="openPfpModal()">Edit PFP</button>' +
            '<button class="action-btn" onclick="editUsername()">Edit Username</button>' +
            '<button class="action-btn" onclick="connectX()">Connect X</button>' +
            '<button class="action-btn" onclick="connectDiscord()">Connect Discord</button>' +
            '<button class="action-btn" onclick="openSecondWalletModal()">Link 2nd Wallet</button>' +
          '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">CABBAGE STAKING</div>' +
          '<div class="points-display">' +
            '<div class="points-number" id="cabbageBalance">‚Äî</div>' +
            '<div class="points-label">Cabbage Balance</div>' +
          '</div>' +
          '<div style="background:rgba(0,255,136,0.04);border:1px solid rgba(0,255,136,0.12);border-radius:10px;padding:14px 16px;margin:10px 0 14px;">' +
            '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">' +
              '<span style="color:#888;font-size:0.78rem;">NFTs Earning</span>' +
              '<span style="font-weight:700;font-size:1.05rem;color:#00ff88;" id="cabbageNftCount">‚Äî</span>' +
            '</div>' +
            '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">' +
              '<span style="color:#888;font-size:0.78rem;">Rate Per NFT</span>' +
              '<span style="font-weight:700;font-size:1.05rem;color:#e0e0ff;">1 \uD83E\uDD6C / week</span>' +
            '</div>' +
            '<div style="display:flex;align-items:center;justify-content:space-between;border-top:1px solid rgba(0,255,136,0.1);padding-top:8px;">' +
              '<span style="color:#888;font-size:0.78rem;font-weight:600;">Total Weekly Earn</span>' +
              '<span style="font-weight:900;font-size:1.15rem;color:#00ff88;" id="cabbageRate">‚Äî</span>' +
            '</div>' +
          '</div>' +
          '<div class="stat-row"><span class="stat-label">Pending</span><span class="stat-value cyan" id="cabbagePending">‚Äî</span></div>' +
          '<div class="stat-row"><span class="stat-label">Started</span><span class="stat-value" id="cabbageStarted">‚Äî</span></div>' +
          '<div class="stat-row"><span class="stat-label">Last Claim</span><span class="stat-value" id="cabbageLast">‚Äî</span></div>' +
          '<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px;flex-wrap:wrap;">' +
            '<button class="disconnect-btn" style="border-color:rgba(255,255,255,0.12);" onclick="refreshCabbageUI()">Refresh</button>' +
            '<button class="disconnect-btn" id="cabbageStartBtn" style="border-color:rgba(0,255,136,0.35);color:#00ff88;" onclick="startCabbage()">Start</button>' +
            '<button class="disconnect-btn" id="cabbageClaimBtn" style="border-color:rgba(0,212,255,0.35);color:#00d4ff;" onclick="claimCabbage()">Claim</button>' +
          '</div>' +
          '<div style="margin-top:10px;color:#555;font-size:0.72rem;letter-spacing:1px;line-height:1.45;">' +
            'Soft staking: click <strong>Start</strong> once to begin earning. Each NFT in your wallet earns <strong>1 \uD83E\uDD6C cabbage per week</strong>. Claim anytime.' +
          '</div>' +
        '</div>';

      // Populate cabbage values after DOM updates
      setTimeout(function(){ try { refreshCabbageUI(); } catch(e){} }, 50);

var nextTierRow = nextTier
        ? '<div class="stat-row"><span class="stat-label">Next Tier At</span><span class="stat-value gold">' + nextTier.min + ' NFTs</span></div>'
        : '<div class="stat-row"><span class="stat-label">Status</span><span class="stat-value gold">MAXED \u{1F451}</span></div>';

      view.innerHTML +=
        '<div class="stats-card">' +
          '<div class="stats-title">HOLDER STATS</div>' +
          '<div class="stat-row"><span class="stat-label">NFTs Held</span><span class="stat-value cyan">' + count + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Current Tier</span><span class="stat-value">' + tier.name + '</span></div>' +
          '<div class="stat-row"><span class="stat-label">Store Discount</span><span class="stat-value green">' + tier.discount + '%</span></div>' +
          '<div class="stat-row"><span class="stat-label">Raffle Multiplier</span><span class="stat-value purple">' + tier.raffleMultiplier + 'x</span></div>' +
          nextTierRow +
        '</div>';

      // ---- SUBDAO STATUS (Trait-based) ----
      var subdao = getSubdaoMatches(nfts);
      var subdaoRows = subdao.map(function(s){
        var req = s.reqValues.join(' / ');
        return '<div class="stat-row">'
             + '<span class="stat-label">' + s.icon + ' ' + s.name + '</span>'
             + '<span class="stat-value ' + (s.unlocked ? 'green' : '') + '">' + (s.unlocked ? 'UNLOCKED' : 'LOCKED') + '</span>'
             + '</div>'
             + (s.unlocked ? '' : '<div style="color:#555;font-size:0.7rem;letter-spacing:1px;margin-top:-6px;margin-bottom:10px;">Requires: ' + escapeHtml(req) + '</div>');
      }).join('');

      var tierOrder = TIERS.map(function(t) { return t.id; });
      var currentTierIdx = tierOrder.indexOf(tier.id);

      var perksHTML = PERKS.map(function(perk) {
        var reqIdx = tierOrder.indexOf(perk.reqTier);
        var unlocked = currentTierIdx >= reqIdx;
        var reqTierObj = TIERS.find(function(t) { return t.id === perk.reqTier; });
        var desc = perk.desc;

        if (perk.dynamic && perk.name === "Store Discount" && unlocked) desc = tier.discount + "% off all LNL Store purchases paid in SOL";
        if (perk.dynamic && perk.name === "Raffle Entries" && unlocked) desc = tier.raffleMultiplier + "x entries into every raffle and giveaway";

        return '' +
          '<div class="perk ' + (unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + perk.icon + '</div>' +
            '<div class="perk-name">' + perk.name + '</div>' +
            '<div class="perk-desc">' + desc + '</div>' +
            '<div class="perk-req ' + (unlocked ? "met" : "") + '">' + (unlocked ? "\u2713 UNLOCKED" : "REQUIRES " + reqTierObj.name) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">HOLDER PERKS</div>' +
          '<div class="perks-grid">' + perksHTML + '</div>' +
        '</div>';


      var subdaoPerksHTML = getSubdaoMatches(nfts).map(function(s){
        var req = s.reqValues.join(" / ");
        var reqLine = s.unlocked ? ("Unlocked via: " + s.hit) : ("Requires: " + req);
        return '' +
          '<div class="perk ' + (s.unlocked ? "unlocked" : "locked") + '">' +
            '<div class="perk-status ' + (s.unlocked ? "on" : "off") + '"></div>' +
            '<div class="perk-icon">' + s.icon + '</div>' +
            '<div class="perk-name">' + escapeHtml(s.name) + '</div>' +
            '<div class="perk-desc">' + escapeHtml(s.desc) + '</div>' +
            '<div class="perk-req ' + (s.unlocked ? "met" : "") + '">' + (s.unlocked ? "\u2713 UNLOCKED" : escapeHtml(reqLine)) + '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="perks-card">' +
          '<div class="stats-title">SUBDAOs</div>' +
          '<div class="perks-grid subdao-grid">' + subdaoPerksHTML + '</div>' +
        '</div>';

      var galleryHTML = nfts.map(function(nft) {
        var img = nft.image
          ? '<img src="' + nft.image + '" alt="' + escapeHtml(nft.name) + '" loading="lazy">'
          : '<div style="aspect-ratio:1;background:#1e1e3a;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.8rem;">No Image</div>';
        var mintShort = nft.mint ? nft.mint.slice(0,4) + "..." + nft.mint.slice(-4) : "";
        return '' +
          '<div class="nft-tile" onclick="window.open(\'https://magiceden.us/item-details/' + nft.mint + '\', \'_blank\')">' +
            img +
            '<div class="nft-tile-info">' +
              '<div class="nft-tile-name">' + escapeHtml(nft.name) + '</div>' +
              '<div class="nft-tile-id">' + mintShort + '</div>' +
            '</div>' +
          '</div>';
      }).join("");

      view.innerHTML +=
        '<div class="gallery-card">' +
          '<div class="stats-title">YOUR COLLECTION</div>' +
          '<div class="gallery-grid">' + galleryHTML + '</div>' +
        '</div>';

      view.innerHTML +=
        '<div class="share-section">' +
          '<button class="share-btn" onclick="window.open(\'' + CONFIG.MAGIC_EDEN_LINK + '\', \'_blank\')">MAGIC EDEN</button>' +
        '</div>';

      // ‚úÖ always re-apply toggle state after rendering the panel
      applyProfilePanelUI();
    }

    function editUsername(){
      var current = session.profile.username || "";
      var input = prompt("Set your Profile Username (max 24 chars):", current);
      if (input === null) return;
      session.profile.username = sanitizeName(input);
      saveProfileToStorage();
      refreshBanner();
    }

    function linkLedger(){
      var current = session.profile.ledger || "";
      var input = prompt("Paste your Ledger public key / label (optional):", current);
      if (input === null) return;
      session.profile.ledger = (input || "").trim().slice(0, 42);
      saveProfileToStorage();
      refreshBanner();
    }

    function refreshBanner(){
      var bn = document.getElementById("bannerUsername");
    if (bn) {
      var displayName = session.profile.username ? session.profile.username : shortAddr(walletPublicKey.toBase58());
      bn.textContent = displayName;
    }

      var bl = document.getElementById("bannerLinks");
      if (bl) {
        var linksHTML = "";
        var xUrl = session.profile.x ? buildXUrl(session.profile.x) : "";
        if (xUrl) linksHTML += '<a class="plink" href="' + xUrl + '" target="_blank">X: @' + normalizeHandle(session.profile.x) + '</a>';
        if (session.profile.discord) linksHTML += '<span class="plink" style="cursor:default;">Discord: ' + session.profile.discord + '</span>';
        if (session.secondWallet.address) linksHTML += '<span class="plink" style="cursor:default;">2nd Wallet: ' + shortAddr(session.secondWallet.address) + '</span>';
        bl.innerHTML = linksHTML;
      }
    }

    function openPfpModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return;

      var grid = document.getElementById("pfpGrid");
      grid.innerHTML = "";

      session.loadedNFTs.forEach(function(nft){
        var selected = (session.profile.pfpMint && nft.mint === session.profile.pfpMint);

        var tile = document.createElement("div");
        tile.className = "pfp-tile" + (selected ? " selected" : "");
        tile.addEventListener("click", function(){ selectPfp(nft.mint); });

        var dot = document.createElement("div");
        dot.className = "pfp-selected";
        tile.appendChild(dot);

        if (nft.image) {
          var img = document.createElement("img");
          img.src = nft.image;
          img.alt = nft.name || "LNL";
          img.loading = "lazy";
          tile.appendChild(img);
        } else {
          var ph = document.createElement("div");
          ph.style.aspectRatio = "1";
          ph.style.background = "#1e1e3a";
          tile.appendChild(ph);
        }

        var name = document.createElement("div");
        name.className = "pfp-name";
        name.textContent = nft.name || "LNL";
        tile.appendChild(name);

        grid.appendChild(tile);
      });

      document.getElementById("pfpModalBackdrop").classList.add("show");
    }

    function hidePfpModal(){
      document.getElementById("pfpModalBackdrop").classList.remove("show");
    }

    function closePfpModal(e){
      if (e && e.target && e.target.id === "pfpModalBackdrop") hidePfpModal();
    }

    function selectPfp(mint){
      var found = session.loadedNFTs.find(function(n){ return n.mint === mint; });
      if (!found) return;

      session.profile.pfpMint = mint;
      session.profile.pfpImage = found.image || "";
      saveProfileToStorage();

      var badge = document.getElementById("pfpBadge");
      if (badge) {
        badge.innerHTML = session.profile.pfpImage
          ? '<img src="' + session.profile.pfpImage + '" alt="Selected PFP" loading="lazy">'
          : badge.innerHTML;
      }

      hidePfpModal();
    }

    function escapeHtml(str){
      return (str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function openSecondWalletModal(){
      if (!walletPublicKey) return alert("Connect main wallet first.");
      var el = document.getElementById("secondWalletStatus");
      if (el) {
        el.textContent = session.secondWallet.address
          ? ("Linked: " + shortAddr(session.secondWallet.address))
          : "No second wallet linked yet.";
      }
      document.getElementById("secondWalletModalBackdrop").classList.add("show");
    }

    function hideSecondWalletModal(){
      document.getElementById("secondWalletModalBackdrop").classList.remove("show");
    }

    function closeSecondWalletModal(e){
      if (e && e.target && e.target.id === "secondWalletModalBackdrop") hideSecondWalletModal();
    }

    async function connectSecondWallet(which){
      try{
        if (!walletPublicKey) return alert("Connect main wallet first.");
        if (!session || !session.profileId) return alert("Profile not ready yet. Disconnect and reconnect your main wallet.");

        var provider = getProviderByName(which);
        if (!provider || typeof provider.connect !== "function") {
          return alert("Wallet provider not found. Make sure " + which + " is installed & enabled.");
        }

        // 1) connect the SECOND wallet
        var resp = await provider.connect({ onlyIfTrusted: false });
        var pk = resp && resp.publicKey ? resp.publicKey : provider.publicKey;
        if (!pk) throw new Error("Connected but no publicKey returned.");

        var addr = (typeof pk.toBase58 === "function") ? pk.toBase58() : String(pk);

        if (walletPublicKey && addr === walletPublicKey.toBase58()){
          return alert("That‚Äôs your main wallet already. Pick a different wallet for the 2nd slot.");
        }

        // 2) require proof-of-ownership (sign message) so nobody can type/link wallets they don't control
        if (typeof provider.signMessage !== "function") {
          return alert("This wallet does not support message signing. Use Phantom/Solflare/Magic Eden wallet with signMessage.");
        }

        var nonce = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));
        var msg =
          "LNL Link 2nd Wallet Proof\n" +
          "Profile: " + session.profileId + "\n" +
          "Primary: " + walletPublicKey.toBase58() + "\n" +
          "Second: " + addr + "\n" +
          "Nonce: " + nonce + "\n" +
          "Time: " + new Date().toISOString();

        var msgBytes = new TextEncoder().encode(msg);
        var signed = await provider.signMessage(msgBytes, "utf8");

        // Phantom returns { signature: Uint8Array, publicKey: PublicKey }
        var sigBytes = signed && signed.signature ? signed.signature : signed;
        if (!sigBytes) throw new Error("No signature returned from wallet.");

        // Verify signature with tweetnacl (loaded in <head>)
        if (!window.nacl || !window.nacl.sign || !window.nacl.sign.detached || !window.nacl.sign.detached.verify) {
          throw new Error("Missing tweetnacl. Refresh page (script failed to load).");
        }

        var pubBytes = null;
        if (signed && signed.publicKey) {
          if (typeof signed.publicKey.toBytes === "function") pubBytes = signed.publicKey.toBytes();
          else if (signed.publicKey instanceof Uint8Array) pubBytes = signed.publicKey;
        }
        if (!pubBytes && pk) {
          if (typeof pk.toBytes === "function") pubBytes = pk.toBytes();
          else if (pk instanceof Uint8Array) pubBytes = pk;
        }
        if (!pubBytes) throw new Error("Could not read wallet public key bytes for verification.");

        var ok = window.nacl.sign.detached.verify(msgBytes, sigBytes, pubBytes);
        if (!ok) throw new Error("Signature verification failed. Not linking wallet.");

        // 3) store as second wallet (local + Supabase)
        session.secondWallet.address = addr;
        saveSecondWalletToStorage();

        await linkWalletToProfile(addr, session.profileId, false);

        var el = document.getElementById("secondWalletStatus");
        if (el) el.textContent = "Linked: " + shortAddr(addr) + " ‚Äî rescanning‚Ä¶";

        document.getElementById("loadingSection").style.display = "block";
        document.getElementById("dashboard").classList.remove("show");
        await loadDashboard();

        hideSecondWalletModal();
        alert("2nd wallet linked: " + shortAddr(addr));
        } catch (err) {
        console.error("Second wallet connect error:", err);
        alert("Failed to link 2nd wallet: " + (err.message || err));
      }
    }

    function unlinkSecondWallet(){
      var prev = session.secondWallet.address || "";
      session.secondWallet.address = "";
      saveSecondWalletToStorage();

      // Remove from Supabase so it won't be remembered (requires DELETE policy on wallet_links)
      if (prev && session && session.profileId) {
        unlinkWallet(prev).catch(function(e){
          console.warn("Failed to unlink 2nd wallet in Supabase (maybe missing DELETE policy):", e);
        });
      }

      var el = document.getElementById("secondWalletStatus");
      if (el) el.textContent = "Second wallet unlinked. Rescanning‚Ä¶";

      document.getElementById("loadingSection").style.display = "block";
      document.getElementById("dashboard").classList.remove("show");
      loadDashboard();
    }

    function openAuthPopup(url, title){
      var w = 520, h = 720;
      var y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
      var x = window.top.outerWidth  / 2 + window.top.screenX - (w / 2);
      var popup = window.open(
        url,
        title,
        'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width=' + w + ', height=' + h + ', top=' + y + ', left=' + x
      );
      if (!popup) alert("Popup blocked. Please allow popups for this site.");
      return popup;
    }

    function connectX(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/x/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      openAuthPopup(url, "Connect X");
    }

    function connectDiscord(){
      if (!walletPublicKey) return alert("Connect wallet first.");
      var url = "/api/auth/discord/start?wallet=" + encodeURIComponent(walletPublicKey.toBase58());
      openAuthPopup(url, "Connect Discord");
    }

    window.addEventListener("message", function(ev){
      if (ev.origin !== window.location.origin) return;

      var data = ev.data || {};
      if (!data || !data.type) return;

      if (data.type === "x_connected") {
        session.profile.x = data.username || "";
        saveProfileToStorage();
        refreshBanner();
        alert("X connected: @" + (data.username || "unknown"));
      }

      if (data.type === "discord_connected") {
        session.profile.discord = data.username
          ? (data.username + (data.discriminator ? ("#" + data.discriminator) : ""))
          : "";
        saveProfileToStorage();
        refreshBanner();
        alert("Discord connected: " + (session.profile.discord || "connected"));
      }

      if (data.type === "x_error" || data.type === "discord_error") {
        alert("Auth failed. Please try again.");
      }
    });
  
    function openTraitsModal(){
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return alert("No NFTs loaded yet.");
      var sub = getSubdaoMatches(session.loadedNFTs);

      var pills = document.getElementById("subdaoPills");
      if (pills){
        pills.innerHTML = sub.map(function(s){
          return '<span class="pill ' + (s.unlocked ? 'on' : 'off') + '">'
               + (s.unlocked ? '‚úì' : '‚Ä¢') + ' ' + s.icon + ' ' + escapeHtml(s.name)
               + '</span>';
        }).join("");
      }

      var counts = buildTraitCounts(session.loadedNFTs);
      var rows = Object.keys(counts).sort(function(a,b){ return counts[b]-counts[a]; }).slice(0, 80);
      var tbody = document.querySelector("#traitsTable tbody");
      if (tbody){
        tbody.innerHTML = rows.map(function(k){
          return '<tr><td>' + escapeHtml(k) + '</td><td>' + counts[k] + '</td></tr>';
        }).join("");
        if (rows.length === 0) tbody.innerHTML = '<tr><td colspan="2" class="trait-muted">No trait data found in metadata.</td></tr>';
      }

      document.getElementById("traitsModalBackdrop").classList.add("show");
    }

    function hideTraitsModal(){
      document.getElementById("traitsModalBackdrop").classList.remove("show");
    }

    function closeTraitsModal(e){
      if (e && e.target && e.target.id === "traitsModalBackdrop") hideTraitsModal();
    }

    /* ================================================================
       CHAT ‚Äî Supabase real-time
       Table: chat_messages (id, wallet, username, text, created_at)
       Messages are shared live across all connected wallets.
    ================================================================ */

    var SUPA_URL = 'https://hypqndasopdkrqvkllvc.supabase.co';
    var SUPA_KEY = 'sb_publishable_DwaaLS_hFJAOZ6M9VmYKYA_AQvyfgv1';
    var supaClient  = null;
    var chatChannel = null;   // real-time subscription
    var chatMsgs    = [];     // [{id, wallet, username, text, created_at}]

    // Auto-refresh fallback (in case real-time misses / tab sleeps)
    var chatRefreshTimer = null;
    var CHAT_REFRESH_MS  = 8000; // 8s feels "live" without spamming

    function getSupaClient() {
      if (!supaClient) {
        supaClient = supabase.createClient(SUPA_URL, SUPA_KEY);
      }
      return supaClient;
    }

    /* ===============================
       PROFILES + WALLET LINKING (Supabase)
       - Resolves a stable profile for a wallet (creates if missing)
       - Persists basic profile fields (username + avatar_url)
       - Remembers linked wallets via wallet_links
       =============================== */

    function getDb() { return getSupaClient(); }

    async function resolveProfileForWallet(wallet) {
      var db = getDb();

      // 1) check link
      var linkRes = await db
        .from("wallet_links")
        .select("profile_id")
        .eq("wallet", wallet)
        .maybeSingle();

      if (linkRes.error) throw linkRes.error;

      // 2) if link exists -> load profile
      if (linkRes.data && linkRes.data.profile_id) {
        var profRes = await db
          .from("profiles")
          .select("id, username, avatar_url, created_at")
          .eq("id", linkRes.data.profile_id)
          .single();
        if (profRes.error) throw profRes.error;
        return profRes.data;
      }

      // 3) create profile
      var newProfRes = await db
        .from("profiles")
        .insert({
          username: (session && session.profile && session.profile.username) ? session.profile.username : null,
          avatar_url: (session && session.profile && session.profile.pfpImage) ? session.profile.pfpImage : null
        })
        .select("id, username, avatar_url, created_at")
        .single();

      if (newProfRes.error) throw newProfRes.error;

      // 4) link wallet -> profile (wallet is unique)
      var upRes = await db
        .from("wallet_links")
        .upsert({ wallet: wallet, profile_id: newProfRes.data.id, is_primary: true }, { onConflict: "wallet" });

      if (upRes.error) throw upRes.error;

      // 5) re-read link (handles race)
      var finalLink = await db
        .from("wallet_links")
        .select("profile_id")
        .eq("wallet", wallet)
        .single();
      if (finalLink.error) throw finalLink.error;

      var finalProf = await db
        .from("profiles")
        .select("id, username, avatar_url, created_at")
        .eq("id", finalLink.data.profile_id)
        .single();
      if (finalProf.error) throw finalProf.error;

      return finalProf.data;
    }

    async function loadLinkedWallets(profileId) {
      var db = getDb();
      var res = await db
        .from("wallet_links")
        .select("wallet, is_primary, created_at")
        .eq("profile_id", profileId)
        .order("is_primary", { ascending: false });

      if (res.error) throw res.error;
      return res.data || [];
    }

    async function linkWalletToProfile(wallet, profileId, isPrimary) {
      var db = getDb();
      var res = await db
        .from("wallet_links")
        .upsert(
          { wallet: wallet, profile_id: profileId, is_primary: !!isPrimary },
          { onConflict: "wallet" }
        );
      if (res.error) throw res.error;
    }

    async function unlinkWallet(wallet) {
      var db = getDb();
      // If you don't have DELETE policy, this may fail ‚Äî we still clear local UI.
      var res = await db
        .from("wallet_links")
        .delete()
        .eq("wallet", wallet);
      if (res.error) throw res.error;
    }

    // Debounced profile saving (keeps your existing localStorage behavior)
    var _saveProfileTimer = null;
    function queueSaveProfileToSupabase() {
      if (!session || !session.profileId) return;
      if (_saveProfileTimer) clearTimeout(_saveProfileTimer);
      _saveProfileTimer = setTimeout(function(){
        saveProfileToSupabase().catch(function(e){ console.warn("Supabase profile save failed:", e); });
      }, 400);
    }

    async function saveProfileToSupabase() {
      if (!session || !session.profileId) return;
      var db = getDb();
      // Map existing dashboard profile fields -> DB columns that exist
      var payload = {
        username: (session.profile && session.profile.username) ? session.profile.username : null,
        avatar_url: (session.profile && session.profile.pfpImage) ? session.profile.pfpImage : null
      };
      var res = await db
        .from("profiles")
        .update(payload)
        .eq("id", session.profileId);
      if (res.error) throw res.error;
    }

    async function hydrateProfileAndWalletsFromSupabase(primaryWallet) {
      try {
        var profile = await resolveProfileForWallet(primaryWallet);
        session.profileId = profile.id;

        // Prefer Supabase values when present
        if (profile.username) session.profile.username = profile.username;
        if (profile.avatar_url) session.profile.pfpImage = profile.avatar_url;

        // Pull linked wallets and set 2nd wallet UI value (first non-primary wallet)
        var wallets = await loadLinkedWallets(profile.id);
        var second = "";
        for (var i = 0; i < wallets.length; i++) {
          if (wallets[i].wallet && wallets[i].wallet !== primaryWallet) { second = wallets[i].wallet; break; }
        }
        if (second) {
          session.secondWallet.address = second;
          saveSecondWalletToStorage(); // keep your existing local cache
        }
      } catch (e) {
        console.warn("Hydrate profile/wallets failed (Supabase):", e);
      }
    }


    /* ===============================
       CABBAGE SOFT STAKING (OFF-CHAIN)
       - Start button: sets first-time staking timestamp (one-time).
       - Claim button: credits earned cabbage since last claim.
       Requires Supabase Edge Function: /functions/v1/cabbage
       =============================== */

    function cabbageEndpoint() {
      return SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage';
    }

    function cabbageAuthHeaders() {
      // Supabase expects apikey + Authorization for Edge Functions when auth is enabled.
      return {
        'Content-Type': 'application/json',
        'apikey': SUPA_KEY,
        'Authorization': 'Bearer ' + SUPA_KEY
      };
    }

    function setBtnState(id, disabled, text) {
      var b = document.getElementById(id);
      if (!b) return;
      b.disabled = !!disabled;
      b.style.opacity = disabled ? '0.45' : '1';
      b.style.cursor = disabled ? 'not-allowed' : 'pointer';
      if (text != null) b.textContent = text;
    }

    function fmtDT(iso) {
      if (!iso) return '‚Äî';
      try {
        var d = new Date(iso);
        if (isNaN(d.getTime())) return '‚Äî';
        return d.toLocaleString();
      } catch (e) { return '‚Äî'; }
    }

    async function signCabbageMessage(action) {
      if (!walletProvider || !walletPublicKey) throw new Error('Wallet not connected');
      if (!walletProvider.signMessage) throw new Error('Wallet does not support message signing');
      var wallet = walletPublicKey.toBase58();
      var ts = new Date().toISOString();
      var msg = 'LNL Cabbage ' + action.toUpperCase() + '\nWallet: ' + wallet + '\nTime: ' + ts;
      var msgBytes = new TextEncoder().encode(msg);
      var sigBytes = await walletProvider.signMessage(msgBytes, 'utf8');
      // Phantom returns {signature: Uint8Array}; others may return Uint8Array directly.
      var raw = sigBytes && sigBytes.signature ? sigBytes.signature : sigBytes;
      var b64 = btoa(String.fromCharCode.apply(null, Array.from(raw)));
      return { wallet: wallet, message: msg, signature: b64 };
    }

    async function refreshCabbageUI() {
      try {
        if (!walletPublicKey) return;
        var wallet = walletPublicKey.toBase58();

        var balEl = document.getElementById('cabbageBalance');
        var rateEl = document.getElementById('cabbageRate');
        var pendEl = document.getElementById('cabbagePending');
        var lastEl = document.getElementById('cabbageLast');
        var startedEl = document.getElementById('cabbageStarted');
        var nftCountEl = document.getElementById('cabbageNftCount');

        if (balEl) balEl.textContent = '‚Ä¶';
        if (rateEl) rateEl.textContent = '‚Ä¶';
        if (pendEl) pendEl.textContent = '‚Ä¶';
        if (lastEl) lastEl.textContent = '‚Ä¶';
        if (startedEl) startedEl.textContent = '‚Ä¶';

        // Default UI state while loading
        setBtnState('cabbageStartBtn', true, 'Start');
        setBtnState('cabbageClaimBtn', true, 'Claim');

        var res = await fetch(cabbageEndpoint() + '?wallet=' + encodeURIComponent(wallet), {
          method: 'GET',
          headers: cabbageAuthHeaders()
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) {
          throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));
        }

        var balance = Number(data.balance || 0);
        var pending = Number(data.pending || 0);
        var rate = Number(data.rate_per_week || 0);
        var stakedCount = Number(data.staked_count || 0);

        var startedAt = data.started_at || null;
        var lastClaim = data.last_claim_at || null;

        if (balEl) balEl.textContent = (Math.floor(balance * 100) / 100).toLocaleString();
        if (rateEl) rateEl.textContent = rate.toLocaleString() + ' \uD83E\uDD6C / week';
        if (pendEl) pendEl.textContent = (Math.floor(pending * 100) / 100).toLocaleString();
        if (startedEl) startedEl.textContent = startedAt ? fmtDT(startedAt) : 'Not started';
        var claimIsReal = lastClaim && lastClaim.indexOf('1970') !== 0;
        if (lastEl) lastEl.textContent = claimIsReal ? fmtDT(lastClaim) : '‚Äî';
        if (nftCountEl) nftCountEl.textContent = stakedCount.toLocaleString();

        // Button rules:
        // - If NOT started: enable Start, disable Claim
        // - If started: disable Start, enable Claim
        var started = !!startedAt;
        setBtnState('cabbageStartBtn', started, started ? 'Started' : 'Start');
        setBtnState('cabbageClaimBtn', !started, 'Claim');

      } catch (e) {
        console.error('refreshCabbageUI error:', e);
        // Leave buttons usable for retry
        setBtnState('cabbageStartBtn', false, 'Start');
        setBtnState('cabbageClaimBtn', false, 'Claim');
      }
    }

    async function startCabbage() {
      try {
        setBtnState('cabbageStartBtn', true, 'Starting‚Ä¶');
        setBtnState('cabbageClaimBtn', true, 'Claim');
        var payload = await signCabbageMessage('start');

        var res = await fetch(cabbageEndpoint(), {
          method: 'POST',
          headers: cabbageAuthHeaders(),
          body: JSON.stringify({ action: 'start', wallet: payload.wallet, message: payload.message, signature: payload.signature })
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));

        await refreshCabbageUI();
      } catch (e) {
        console.error('startCabbage error:', e);
        alert('Start failed: ' + (e.message || e));
        setBtnState('cabbageStartBtn', false, 'Start');
      }
    }

    async function claimCabbage() {
      try {
        setBtnState('cabbageClaimBtn', true, 'Claiming‚Ä¶');
        var payload = await signCabbageMessage('claim');

        var res = await fetch(cabbageEndpoint(), {
          method: 'POST',
          headers: cabbageAuthHeaders(),
          body: JSON.stringify({ action: 'claim', wallet: payload.wallet, message: payload.message, signature: payload.signature })
        });

        var data = await res.json().catch(function(){ return {}; });
        if (!res.ok) throw new Error(data && data.error ? data.error : ('HTTP ' + res.status));

        await refreshCabbageUI();
      } catch (e) {
        console.error('claimCabbage error:', e);
        alert('Claim failed: ' + (e.message || e));
        setBtnState('cabbageClaimBtn', false, 'Claim');
      }
    }


    // Deterministic color per wallet so each user always looks the same
    function walletColor(addr) {
      var palette = ['#00d4ff','#7b68ee','#00ff88','#f5a623','#ff6b9d','#4ecdc4','#ffd93d','#ff8c42'];
      var hash = 0;
      for (var i = 0; i < (addr || '').length; i++) {
        hash = ((hash << 5) - hash) + addr.charCodeAt(i);
        hash |= 0;
      }
      return palette[Math.abs(hash) % palette.length];
    }

    // Called when leaving chat tab or disconnecting
    function stopChatPoll() {
      // stop fallback refresh timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // stop real-time subscription
      if (chatChannel) {
        try { getSupaClient().removeChannel(chatChannel); } catch(e) {}
        chatChannel = null;
      }
    }
    function renderChatUI() {
      var view = document.getElementById('view-chat');
      if (!view) return;

      view.innerHTML =
        // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">ü¶í HOLDER CHAT</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">Live ¬∑ Open to all connected wallets</div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:0.7rem;">' +
            '<div id="chatLiveDot" style="display:flex;align-items:center;gap:5px;font-size:0.7rem;color:#555;">' +
              '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶' +
            '</div>' +
            '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Messages ‚îÄ‚îÄ
        '<div id="chatBox" style="height:440px;overflow-y:auto;background:#06060f;border:1px solid #161628;border-radius:12px;padding:16px;margin-bottom:12px;scroll-behavior:smooth;">' +
          '<div id="chatInner"></div>' +
        '</div>' +

        // ‚îÄ‚îÄ Input ‚îÄ‚îÄ
        '<div style="display:flex;gap:8px;align-items:center;">' +
          '<div id="chatInputWrap" style="flex:1;display:flex;align-items:center;gap:8px;background:#0d0d1e;border:1px solid #1a1a30;border-radius:10px;padding:0 12px;transition:border-color 0.2s;">' +
            '<span id="chatWalletTag" style="font-size:0.78rem;font-weight:700;flex-shrink:0;white-space:nowrap;"></span>' +
            '<input id="chatInput" style="flex:1;background:transparent;border:none;outline:none;color:#e0e0ff;font-family:\'Space Grotesk\',sans-serif;font-size:0.88rem;padding:12px 0;" placeholder="Say something legend‚Ä¶" maxlength="400" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendChatMessage();}" />' +
            '<span id="chatCount" style="font-size:0.62rem;color:#252540;flex-shrink:0;min-width:28px;text-align:right;"></span>' +
          '</div>' +
          '<button id="chatSendBtn" onclick="sendChatMessage()" style="background:linear-gradient(135deg,rgba(0,212,255,0.18),rgba(123,104,238,0.18));border:1px solid rgba(0,212,255,0.35);color:#00d4ff;padding:12px 22px;border-radius:10px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.8rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;white-space:nowrap;">Send</button>' +
        '</div>';

      // Wallet tag
      if (walletPublicKey) {
        var addr = walletPublicKey.toBase58();
        var tag  = document.getElementById('chatWalletTag');
        tag.textContent = addr.slice(0,4) + '‚Ä¶' + addr.slice(-4);
        tag.style.color = walletColor(addr);
      }

      // Focus ring
      var wrap = document.getElementById('chatInputWrap');
      var inp  = document.getElementById('chatInput');
      inp.addEventListener('focus', function(){ wrap.style.borderColor = 'rgba(0,212,255,0.45)'; });
      inp.addEventListener('blur',  function(){ wrap.style.borderColor = '#1a1a30'; });
      inp.addEventListener('input', function(){
        var left = 400 - inp.value.length;
        var c = document.getElementById('chatCount');
        c.textContent = left < 80 ? left : '';
        c.style.color = left < 30 ? '#ff3c5c' : '#252540';
      });

      // Load history then subscribe
      chatMsgs = [];
      loadChatHistory();
    }

    
    // Pull any new messages since the newest one we have.
    // This runs on an interval as a safety net (real-time should still do the heavy lifting).
    async function refreshChatFromServer() {
      try {
        // only refresh if we're actually on the chat tab and the UI exists
        if (!session || session.currentView !== 'chat') return;
        if (!document.getElementById('chatInner')) return;

        var sb = getSupaClient();

        var last = (chatMsgs && chatMsgs.length) ? chatMsgs[chatMsgs.length - 1] : null;
        var q = sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        // Incremental fetch: only grab messages newer than what we have.
        if (last && last.created_at) {
          q = q.gt('created_at', last.created_at);
        }

        var res = await q;
        if (res.error) throw res.error;

        var incoming = res.data || [];
        if (!incoming.length) return;

        // Merge de-duped by id
        var existing = {};
        for (var i = 0; i < chatMsgs.length; i++) existing[chatMsgs[i].id] = true;

        for (var j = 0; j < incoming.length; j++) {
          if (!existing[incoming[j].id]) chatMsgs.push(incoming[j]);
        }

        // Keep sorted (in case clocks are funky)
        chatMsgs.sort(function(a,b){
          return new Date(a.created_at) - new Date(b.created_at);
        });

        paintMessages();
        scrollToBottom(false);
      } catch(e) {
        // quiet failure ‚Äî this is just a fallback
        console.warn('Chat auto-refresh error:', e && (e.message || e));
      }
    }

    function startChatAutoRefresh() {
      // reset any existing timer
      if (chatRefreshTimer) {
        try { clearInterval(chatRefreshTimer); } catch(e) {}
        chatRefreshTimer = null;
      }

      // immediate refresh in case we missed messages while tab was inactive
      refreshChatFromServer();

      chatRefreshTimer = setInterval(function(){
        refreshChatFromServer();
      }, CHAT_REFRESH_MS);

      // when user comes back to the tab, refresh immediately
      try {
        if (!window.__lnlChatVisHooked) {
          window.__lnlChatVisHooked = true;
          document.addEventListener('visibilitychange', function(){
            if (!document.hidden) refreshChatFromServer();
          });
          window.addEventListener('focus', function(){ refreshChatFromServer(); });
        }
      } catch(e) {}
    }

    async function loadChatHistory() {
      setLiveDot(false);
      try {
        var sb = getSupaClient();
        var res = await sb
          .from('chat_messages')
          .select('id, wallet, username, text, created_at')
          .order('created_at', { ascending: true })
          .limit(200);

        if (res.error) throw res.error;
        chatMsgs = res.data || [];
        paintMessages();
        scrollToBottom(true);
      } catch(e) {
        console.error('Chat history error:', e);
        document.getElementById('chatInner').innerHTML =
          '<div style="color:#ff3c5c;font-size:0.78rem;text-align:center;padding:2rem;">Could not load messages. Check Supabase config.</div>';
      }
      subscribeLive();
    }

    function subscribeLive() {
      // Tear down any existing subscription first
      stopChatPoll();

      var sb = getSupaClient();
      chatChannel = sb
        .channel('chat_messages_live')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'chat_messages'
        }, function(payload) {
          var row = payload.new;
          // Avoid duplicates (our own optimistic message already added)
          var exists = chatMsgs.some(function(m){ return m.id === row.id; });
          if (!exists) {
            chatMsgs.push(row);
            paintMessages();
            scrollToBottom(false);
          }
        })
        .subscribe(function(status) {
          setLiveDot(status === 'SUBSCRIBED');
        });

      // Safety-net refresh (keeps chat updated even if real-time drops)
      startChatAutoRefresh();
    }

    function setLiveDot(live) {
      var el = document.getElementById('chatLiveDot');
      if (!el) return;
      if (live) {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 6px rgba(0,255,136,0.7);"></div>Live';
        el.style.color = '#555';
      } else {
        el.innerHTML = '<div style="width:7px;height:7px;border-radius:50%;background:#555;"></div>Connecting‚Ä¶';
      }
    }

    function paintMessages() {
      var inner = document.getElementById('chatInner');
      if (!inner) return;

      if (chatMsgs.length === 0) {
        inner.innerHTML =
          '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:340px;gap:0.7rem;">' +
            '<div style="font-size:2.5rem;">ü¶í</div>' +
            '<div style="color:#252540;font-size:0.78rem;letter-spacing:2px;text-transform:uppercase;">No messages yet</div>' +
            '<div style="color:#1a1a30;font-size:0.7rem;">Be the first legend</div>' +
          '</div>';
        return;
      }

      var myWallet  = walletPublicKey ? walletPublicKey.toBase58() : null;
      var prevWallet = null;
      var html = '';

      chatMsgs.forEach(function(m, i) {
        var isMe  = m.wallet === myWallet;
        var color = walletColor(m.wallet);

        // Display name: use stored username if present, else shorten wallet
        var name = m.username
          ? m.username
          : (m.wallet.slice(0,4) + '‚Ä¶' + m.wallet.slice(-4));

        var newSender = m.wallet !== prevWallet;
        prevWallet = m.wallet;

        var t = new Date(m.created_at);
        var timeStr = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        if (newSender) {
          if (i > 0) html += '<div style="height:12px;"></div>';
          html +=
            '<div style="display:flex;align-items:baseline;gap:7px;margin-bottom:3px;">' +
              '<span style="font-weight:700;font-size:0.8rem;color:' + color + ';">' + escapeHtml(name) + '</span>' +
              '<span style="font-size:0.6rem;color:#252540;">' + timeStr + '</span>' +
              (isMe ? '<span style="font-size:0.55rem;letter-spacing:1px;color:#1e1e3a;text-transform:uppercase;">you</span>' : '') +
            '</div>';
        }

        html += '<div style="font-size:0.87rem;color:#c8c8e8;line-height:1.6;word-break:break-word;padding:1px 0;">' + escapeHtml(m.text) + '</div>';
      });

      inner.innerHTML = html;
    }

    function scrollToBottom(force) {
      var box = document.getElementById('chatBox');
      if (!box) return;
      var nearBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 120;
      if (force || nearBottom) box.scrollTop = box.scrollHeight;
    }

    async function sendChatMessage() {
      if (!walletPublicKey) { alert('Connect your wallet first.'); return; }
      var inp = document.getElementById('chatInput');
      var btn = document.getElementById('chatSendBtn');
      if (!inp) return;

      var text = inp.value.trim();
      if (!text) return;

      inp.value = '';
      inp.dispatchEvent(new Event('input'));
      btn.disabled = true;
      btn.textContent = '‚Ä¶';

      var wallet   = walletPublicKey.toBase58();
      var username = session.profile.username || null;

      try {
        var sb  = getSupaClient();
        var res = await sb.from('chat_messages').insert({
          wallet:   wallet,
          username: username,
          text:     text
        }).select().single();

        if (res.error) throw res.error;

        // Optimistic: add immediately so sender doesn't wait for real-time echo
        var exists = chatMsgs.some(function(m){ return m.id === res.data.id; });
        if (!exists) {
          chatMsgs.push(res.data);
          paintMessages();
          scrollToBottom(true);
        }
      } catch(e) {
        console.error('Send error:', e);
        alert('Failed to send: ' + (e.message || e));
      }

      btn.disabled = false;
      btn.textContent = 'Send';
      inp.focus();
    }


    /* ================================================================
       CASINO GAMES ‚Äî fully self-contained, no shared state with chat
       or profile. All vars prefixed g_ to avoid any collisions.
       Wallets: SOL bets ‚Üí ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc
                NFT prizes ‚Üê 3HkAeqdaPJHK46TuTmchmK789CZgmKb9vMihoXjzQmth
    ================================================================ */

    var g_SOL_TREASURY = 'ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc';
    var g_NFT_TREASURY = '3HkAeqdaPJHK46TuTmchmK789CZgmKb9vMihoXjzQmth';
    var g_NFT_POT_THRESHOLD_SOL = 50;
    var g_NFT_POT_THRESHOLD_CAB = 10000;

    // House edges: coin flip 43% win/1.80x, dice 45%/1.75x, slots as below
    var g_GAMES = {
      coin:  { winChance: 0.43, payout: 1.80 },
      dice:  { winChance: 0.45, payout: 1.75 },
      slots: {
        jackpot:    { chance: 0.008, payout: 15 },
        threeKind:  { chance: 0.04,  payout: 7  },
        twoKind:    { chance: 0.28,  payout: 1.8 }
      }
    };

    // NFT bonus: +win% based on LNL held
    function g_nftBonus(count) {
      if (count >= 20) return 0.04;
      if (count >= 10) return 0.03;
      if (count >= 5)  return 0.02;
      if (count >= 1)  return 0.01;
      return 0;
    }

    var g_currency    = 'sol';  // 'sol' or 'cabbage'
    var g_betAmount   = 0.05;
    var g_betHistory  = [];
    var g_solBalance  = null;
    var g_cabBalance  = null;
    var g_isSpinning  = false;

    // ‚îÄ‚îÄ Supabase helpers (uses the same SUPA_URL/SUPA_KEY already defined above) ‚îÄ‚îÄ
    function g_getSb() { return getSupaClient(); }

    async function g_logBet(game, betAmt, currency, houseProft) {
      try {
        if (!walletPublicKey) return;
        await g_getSb().from('game_bets').insert({
          wallet:       walletPublicKey.toBase58(),
          game:         game,
          bet_amount:   betAmt,
          currency:     currency,
          house_profit: houseProft,
          played_at:    new Date().toISOString()
        });
      } catch(e) { console.warn('g_logBet error:', e); }
    }

    async function g_fetchPotProgress() {
      try {
        var res = await g_getSb()
          .from('game_bets')
          .select('house_profit, currency')
          .gt('house_profit', 0);
        if (res.error || !res.data) return { sol: 0, cabbage: 0 };
        var sol = 0, cab = 0;
        res.data.forEach(function(r) {
          if (r.currency === 'sol') sol += Number(r.house_profit || 0);
          else cab += Number(r.house_profit || 0);
        });
        return { sol: sol, cabbage: cab };
      } catch(e) { return { sol: 0, cabbage: 0 }; }
    }

    async function g_checkAndTriggerPrize(currency, pot) {
      var threshold = currency === 'sol' ? g_NFT_POT_THRESHOLD_SOL : g_NFT_POT_THRESHOLD_CAB;
      if (pot < threshold) return;
      if (!walletPublicKey) return;
      try {
        await g_getSb().from('nft_winners').insert({
          wallet:   walletPublicKey.toBase58(),
          username: (session && session.profile && session.profile.username) || null,
          currency: currency,
          won_at:   new Date().toISOString(),
          status:   'pending_airdrop'
        });
        g_showWinnerModal();
      } catch(e) { console.warn('g_checkAndTriggerPrize error:', e); }
    }

    async function g_updatePotUI() {
      try {
        var pot = await g_fetchPotProgress();
        var solPct = Math.min(100, (pot.sol / g_NFT_POT_THRESHOLD_SOL) * 100);
        var cabPct = Math.min(100, (pot.cabbage / g_NFT_POT_THRESHOLD_CAB) * 100);
        var sb = document.getElementById('g_solPotBar');
        var cb = document.getElementById('g_cabPotBar');
        var sl = document.getElementById('g_solPotLabel');
        var cl = document.getElementById('g_cabPotLabel');
        if (sb) sb.style.width = solPct + '%';
        if (cb) cb.style.width = cabPct + '%';
        if (sl) sl.textContent = pot.sol.toFixed(2) + ' / ' + g_NFT_POT_THRESHOLD_SOL + ' ‚óé';
        if (cl) cl.textContent = Math.floor(pot.cabbage).toLocaleString() + ' / ' + g_NFT_POT_THRESHOLD_CAB.toLocaleString() + ' ü•¨';
        // Check triggers
        await g_checkAndTriggerPrize('sol', pot.sol);
        await g_checkAndTriggerPrize('cabbage', pot.cabbage);
      } catch(e) {}
    }

    function g_showWinnerModal() {
      var wallet = walletPublicKey ? walletPublicKey.toBase58() : '‚Äî';
      var modal = document.getElementById('g_winnerModal');
      if (!modal) return;
      var wa = document.getElementById('g_winnerWallet');
      if (wa) wa.textContent = wallet;
      modal.style.display = 'flex';
      g_launchConfetti();
    }

    function g_closeWinnerModal() {
      var modal = document.getElementById('g_winnerModal');
      if (modal) modal.style.display = 'none';
    }

    function g_launchConfetti() {
      var container = document.getElementById('g_confettiContainer');
      if (!container) return;
      container.innerHTML = '';
      var colors = ['#ffd700','#00d4ff','#7b68ee','#00ff88','#ff3c5c'];
      for (var i = 0; i < 80; i++) {
        var p = document.createElement('div');
        var size = 6 + Math.random() * 8;
        p.style.cssText = 'position:absolute;width:' + size + 'px;height:' + size + 'px;'
          + 'background:' + colors[Math.floor(Math.random() * colors.length)] + ';'
          + 'border-radius:' + (Math.random() > 0.5 ? '50%' : '2px') + ';'
          + 'left:' + Math.random() * 100 + '%;'
          + 'top:-20px;'
          + 'animation:g_fall ' + (1.5 + Math.random() * 2) + 's linear ' + (Math.random() * 0.8) + 's forwards;'
          + 'opacity:0.9;';
        container.appendChild(p);
      }
    }

    // ‚îÄ‚îÄ SOL balance ‚îÄ‚îÄ
    async function g_fetchSolBalance() {
      if (!walletPublicKey) return null;
      try {
        var res = await fetch(CONFIG.RPC_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getBalance', params: [walletPublicKey.toBase58()] })
        });
        var json = await res.json();
        return (json && json.result && json.result.value != null) ? json.result.value / 1e9 : null;
      } catch(e) { return null; }
    }

    async function g_fetchCabbageBalance() {
      if (!walletPublicKey) return null;
      try {
        var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage?wallet=' + encodeURIComponent(walletPublicKey.toBase58()), {
          headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
        });
        var data = await res.json();
        return Number(data.balance || 0);
      } catch(e) { return null; }
    }

    async function g_loadGameBalances() {
      var solEl = document.getElementById('g_solBal');
      var cabEl = document.getElementById('g_cabBal');
      if (solEl) solEl.textContent = '‚Ä¶';
      if (cabEl) cabEl.textContent = '‚Ä¶';
      var sol = await g_fetchSolBalance();
      var cab = await g_fetchCabbageBalance();
      g_solBalance = sol;
      g_cabBalance = cab;
      if (solEl) solEl.textContent = sol !== null ? sol.toFixed(3) + ' ‚óé' : '‚Äî';
      if (cabEl) cabEl.textContent = cab !== null ? Math.floor(cab).toLocaleString() + ' ü•¨' : '‚Äî';
    }

    // ‚îÄ‚îÄ On-chain SOL transfer ‚îÄ‚îÄ
    async function g_sendSolBet(lamports) {
      if (!walletPublicKey || !walletProvider) throw new Error('Wallet not connected');
      var res = await fetch(CONFIG.RPC_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getLatestBlockhash', params: [{ commitment: 'finalized' }] })
      });
      var bh = await res.json();
      var blockhash = bh.result.value.blockhash;
      var lastValidBlockHeight = bh.result.value.lastValidBlockHeight;

      // Build transfer instruction bytes manually
      var from = walletPublicKey.toBase58();
      var to   = g_SOL_TREASURY;

      // Use solanaWeb3 if available, else base64 raw tx approach
      if (window.solanaWeb3) {
        var tx = new solanaWeb3.Transaction();
        tx.recentBlockhash = blockhash;
        tx.feePayer = walletPublicKey;
        tx.add(solanaWeb3.SystemProgram.transfer({
          fromPubkey: walletPublicKey,
          toPubkey: new solanaWeb3.PublicKey(to),
          lamports: lamports
        }));
        var signed = await walletProvider.signTransaction(tx);
        var rawTx = signed.serialize();
        var sendRes = await fetch(CONFIG.RPC_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'sendTransaction', params: [btoa(String.fromCharCode(...rawTx)), { encoding: 'base64' }] })
        });
        var sendJson = await sendRes.json();
        if (sendJson.error) throw new Error(sendJson.error.message || 'TX failed');
        return sendJson.result;
      } else {
        // Fallback: build raw transaction bytes for system transfer
        var fromBytes = g_b58Decode(from);
        var toBytes   = g_b58Decode(to);
        var txBytes   = g_buildSystemTransferTx(fromBytes, toBytes, lamports, g_b58Decode(blockhash));
        var signed2   = await walletProvider.signTransaction({ serializeMessage: function(){ return txBytes; } });
        throw new Error('Please include @solana/web3.js for SOL transfers.');
      }
    }

    // b58 decode helper
    var g_B58_CHARS = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    function g_b58Decode(str) {
      var bytes = [0];
      for (var i = 0; i < str.length; i++) {
        var c = g_B58_CHARS.indexOf(str[i]);
        if (c < 0) throw new Error('Invalid base58');
        for (var j = 0; j < bytes.length; j++) bytes[j] *= 58;
        bytes[bytes.length - 1] += c;
        for (var k = bytes.length - 1; k > 0; k--) {
          if (bytes[k] > 255) { bytes[k-1] += Math.floor(bytes[k]/256); bytes[k] %= 256; }
        }
      }
      for (var z = 0; z < str.length && str[z] === '1'; z++) bytes.unshift(0);
      return new Uint8Array(bytes);
    }

    // ‚îÄ‚îÄ Cabbage spend ‚îÄ‚îÄ
    async function g_spendCabbage(amount) {
      if (!walletPublicKey) throw new Error('Wallet not connected');
      var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
        body: JSON.stringify({ action: 'spend', wallet: walletPublicKey.toBase58(), amount: amount })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Spend failed');
      return data;
    }

    // ‚îÄ‚îÄ SOL‚ÜíCabbage conversion: 1 SOL bet = 100 cabbage payout ‚îÄ‚îÄ
    var g_SOL_TO_CABBAGE = 100;

    async function g_creditCabbage(amount) {
      if (!walletPublicKey) throw new Error('Wallet not connected');
      var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
        body: JSON.stringify({ action: 'credit', wallet: walletPublicKey.toBase58(), amount: amount })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Credit failed');
      return data;
    }

    // ‚îÄ‚îÄ Game result helpers ‚îÄ‚îÄ
    function g_playCoin(nftCount) {
      var chance = g_GAMES.coin.winChance + g_nftBonus(nftCount);
      return Math.random() < chance;
    }

    function g_playDice(choice) {
      // choice: 'high' (4-6), 'low' (1-3), 'even', 'odd'
      var roll = Math.floor(Math.random() * 6) + 1;
      var won;
      if (choice === 'high') won = roll >= 4;
      else if (choice === 'low') won = roll <= 3;
      else if (choice === 'even') won = roll % 2 === 0;
      else won = roll % 2 !== 0;
      return { roll: roll, won: won };
    }

    function g_playSlots(nftCount) {
      var bonus = g_nftBonus(nftCount);
      var r = Math.random() - bonus * 0.5; // small bonus shifts result
      var symbols = ['ü¶í','üåø','üé≤','üíé','üî•','‚≠ê'];
      if (r < g_GAMES.slots.jackpot.chance) {
        return { reels: ['ü¶í','ü¶í','ü¶í'], result: 'jackpot', payout: g_GAMES.slots.jackpot.payout };
      }
      if (r < g_GAMES.slots.jackpot.chance + g_GAMES.slots.threeKind.chance) {
        var s = symbols[Math.floor(Math.random() * symbols.length)];
        return { reels: [s, s, s], result: 'three', payout: g_GAMES.slots.threeKind.payout };
      }
      if (r < g_GAMES.slots.jackpot.chance + g_GAMES.slots.threeKind.chance + g_GAMES.slots.twoKind.chance) {
        var s2 = symbols[Math.floor(Math.random() * symbols.length)];
        var other = symbols.filter(function(x){return x!==s2;})[Math.floor(Math.random()*5)];
        var reels = Math.random() > 0.5 ? [s2, s2, other] : [s2, other, s2];
        return { reels: reels, result: 'two', payout: g_GAMES.slots.twoKind.payout };
      }
      // Loss ‚Äî 3 different symbols
      var r1 = symbols[Math.floor(Math.random()*6)];
      var r2 = symbols.filter(function(x){return x!==r1;})[Math.floor(Math.random()*5)];
      var r3 = symbols.filter(function(x){return x!==r1&&x!==r2;})[Math.floor(Math.random()*4)];
      return { reels: [r1, r2, r3], result: 'loss', payout: 0 };
    }

    function g_addHistory(game, betAmt, currency, won, payout) {
      g_betHistory.unshift({ game: game, bet: betAmt, currency: currency, won: won, payout: payout, time: new Date() });
      if (g_betHistory.length > 20) g_betHistory.pop();
      g_renderHistory();
    }

    function g_renderHistory() {
      var el = document.getElementById('g_historyList');
      if (!el) return;
      if (!g_betHistory.length) { el.innerHTML = '<div style="color:#252540;font-size:0.75rem;text-align:center;padding:1rem;letter-spacing:1px;">No games played yet</div>'; return; }
      el.innerHTML = g_betHistory.slice(0,8).map(function(h) {
        var betSym = h.currency === 'sol' ? '‚óé' : 'ü•¨';
        var pnl = h.won ? '+' + h.payout.toFixed(2) + ' ü•¨' : '-' + h.bet.toFixed(4) + ' ' + betSym;
        var col = h.won ? '#00ff88' : '#ff3c5c';
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.75rem;">'
          + '<span style="color:#555;">' + h.game + '</span>'
          + '<span>' + h.bet + ' ' + betSym + '</span>'
          + '<span style="color:' + col + ';font-weight:700;">' + pnl + '</span>'
          + '</div>';
      }).join('');
    }

    // ‚îÄ‚îÄ Main render function ‚îÄ‚îÄ
    function renderGamesUI() {
      var view = document.getElementById('view-games');
      if (!view) return;

      var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;
      var bonus = g_nftBonus(nftCount);

      view.innerHTML =
        '<style>' +
        '@keyframes g_fall{to{top:110%;opacity:0;transform:rotate(720deg) translateX(30px)}}' +
        '@keyframes g_spin{0%{transform:translateY(0)}100%{transform:translateY(-300px)}}' +
        '@keyframes g_pulse{0%,100%{opacity:1}50%{opacity:0.6}}' +
        '.g_card{background:#0f0f22;border:1px solid #1e1e3a;border-radius:14px;padding:1.4rem;margin-bottom:1.2rem;}' +
        '.g_title{font-family:"Bebas Neue",sans-serif;font-size:1rem;letter-spacing:3px;color:#555;margin-bottom:1rem;}' +
        '.g_btn{background:transparent;border:1px solid rgba(255,255,255,0.12);color:#aaa;padding:10px 18px;border-radius:8px;cursor:pointer;font-family:"Space Grotesk",sans-serif;font-weight:700;font-size:0.75rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;}' +
        '.g_btn:hover:not(:disabled){border-color:rgba(0,212,255,0.5);color:#00d4ff;transform:translateY(-1px);}' +
        '.g_btn:disabled{opacity:0.4;cursor:not-allowed;}' +
        '.g_btn-primary{border-color:rgba(0,212,255,0.45);color:#00d4ff;}' +
        '.g_btn-primary:hover:not(:disabled){background:rgba(0,212,255,0.08);box-shadow:0 0 20px rgba(0,212,255,0.15);}' +
        '.g_result{min-height:48px;text-align:center;padding:0.8rem;border-radius:8px;background:rgba(0,0,0,0.2);margin-top:0.8rem;font-weight:700;font-size:0.9rem;transition:all 0.3s;}' +
        '.g_reel{font-size:2.2rem;background:#06060f;border:1px solid #161628;border-radius:10px;width:60px;height:60px;display:inline-flex;align-items:center;justify-content:center;}' +
        '.g_pot-bar{height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;margin-top:5px;}' +
        '.g_pot-fill{height:100%;border-radius:4px;transition:width 1s ease;}' +
        '</style>' +

        // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">üé∞ LNL CASINO</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">All wins paid in ü•¨ Cabbage ¬∑ SOL bets fill the treasury</div>' +
          '</div>' +
          '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
        '</div>' +

        // ‚îÄ‚îÄ Balance bar ‚îÄ‚îÄ
        '<div class="g_card" style="display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.4rem;">' +
          '<div style="display:flex;gap:1.5rem;flex:1;flex-wrap:wrap;">' +
            '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;">SOL Balance</div><div style="font-weight:700;color:#00d4ff;font-size:1rem;" id="g_solBal">‚Ä¶</div></div>' +
            '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;">Cabbage Balance</div><div style="font-weight:700;color:#00ff88;font-size:1rem;" id="g_cabBal">‚Ä¶</div></div>' +
            '<div><div style="color:#555;font-size:0.65rem;letter-spacing:1px;text-transform:uppercase;">LNL NFTs</div><div style="font-weight:700;color:#7b68ee;font-size:1rem;">' + nftCount + (bonus > 0 ? ' <span style="font-size:0.65rem;color:#ffd700;">+' + (bonus*100).toFixed(0) + '% boost</span>' : '') + '</div></div>' +
          '</div>' +
          '<div style="display:flex;gap:0.5rem;">' +
            '<button class="g_btn ' + (g_currency==='sol'?'g_btn-primary':'') + '" id="g_btnSol" onclick="g_setCurrency(\'sol\')">‚óé SOL</button>' +
            '<button class="g_btn ' + (g_currency==='cabbage'?'g_btn-primary':'') + '" id="g_btnCab" onclick="g_setCurrency(\'cabbage\')">ü•¨ Cabbage</button>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ NFT Prize Pot ‚îÄ‚îÄ
        '<div class="g_card">' +
          '<div class="g_title">üèÜ NFT PRIZE POT</div>' +
          '<div style="margin-bottom:0.9rem;">' +
            '<div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#555;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;"><span>‚óé SOL POT</span><span id="g_solPotLabel">Loading‚Ä¶</span></div>' +
            '<div class="g_pot-bar"><div class="g_pot-fill" id="g_solPotBar" style="width:0%;background:linear-gradient(90deg,#9945ff,#00d4ff);"></div></div>' +
          '</div>' +
          '<div>' +
            '<div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#555;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;"><span>ü•¨ CABBAGE POT</span><span id="g_cabPotLabel">Loading‚Ä¶</span></div>' +
            '<div class="g_pot-bar"><div class="g_pot-fill" id="g_cabPotBar" style="width:0%;background:linear-gradient(90deg,#00ff88,#00d4ff);"></div></div>' +
          '</div>' +
          '<div style="margin-top:0.8rem;font-size:0.65rem;color:#333;letter-spacing:0.5px;">When a pot fills, a random recent player wins an LNL NFT airdropped to their wallet automatically.</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Bet Amount ‚îÄ‚îÄ
        '<div class="g_card">' +
          '<div class="g_title">BET AMOUNT</div>' +
          '<div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">' +
            '<button class="g_btn" onclick="g_setBet(0.01)">0.01</button>' +
            '<button class="g_btn" onclick="g_setBet(0.05)">0.05</button>' +
            '<button class="g_btn" onclick="g_setBet(0.1)">0.1</button>' +
            '<button class="g_btn" onclick="g_setBet(0.25)">0.25</button>' +
            '<button class="g_btn" onclick="g_setBet(0.5)">0.5</button>' +
            '<button class="g_btn" onclick="g_setBet(1)">1</button>' +
            '<span style="color:#555;margin:0 4px;">|</span>' +
            '<input id="g_betInput" type="number" min="0.001" step="0.001" value="' + g_betAmount + '" onchange="g_betAmount=parseFloat(this.value)||0.05" style="width:80px;background:#06060f;border:1px solid #1e1e3a;color:#e0e0ff;padding:8px 10px;border-radius:8px;font-family:\'Space Grotesk\',sans-serif;font-size:0.85rem;text-align:center;" />' +
            '<span id="g_betCurrLabel" style="color:#555;font-size:0.78rem;">' + (g_currency==='sol'?'‚óé':'ü•¨') + '</span>' +
          '</div>' +
        '</div>' +

        // ‚îÄ‚îÄ Games row ‚îÄ‚îÄ
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.2rem;margin-bottom:1.2rem;">' +

          // COIN FLIP
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">ü™ô COIN FLIP</div>' +
            '<div style="text-align:center;margin:1rem 0;">' +
              '<div id="g_coinFace" style="font-size:3.5rem;line-height:1;">ü™ô</div>' +
              '<div style="color:#555;font-size:0.7rem;margin-top:6px;letter-spacing:1px;">43% WIN ¬∑ 1.80√ó PAYOUT</div>' +
            '</div>' +
            '<button class="g_btn g_btn-primary" style="width:100%;" id="g_coinBtn" onclick="g_playCoinGame()">FLIP</button>' +
            '<div class="g_result" id="g_coinResult" style="display:none;"></div>' +
          '</div>' +

          // DICE ROLL
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">üé≤ DICE ROLL</div>' +
            '<div style="text-align:center;margin:0.6rem 0 0.8rem;">' +
              '<div id="g_diceFace" style="font-size:3.5rem;line-height:1;">üé≤</div>' +
              '<div style="color:#555;font-size:0.7rem;margin-top:6px;letter-spacing:1px;">45% WIN ¬∑ 1.75√ó PAYOUT</div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">' +
              '<button class="g_btn" onclick="g_playDiceGame(\'high\')">HIGH (4-6)</button>' +
              '<button class="g_btn" onclick="g_playDiceGame(\'low\')">LOW (1-3)</button>' +
              '<button class="g_btn" onclick="g_playDiceGame(\'even\')">EVEN</button>' +
              '<button class="g_btn" onclick="g_playDiceGame(\'odd\')">ODD</button>' +
            '</div>' +
            '<div class="g_result" id="g_diceResult" style="display:none;"></div>' +
          '</div>' +

          // SLOTS
          '<div class="g_card" style="margin:0;">' +
            '<div class="g_title">üé∞ SLOTS</div>' +
            '<div style="text-align:center;margin:0.8rem 0;">' +
              '<div style="display:flex;gap:8px;justify-content:center;" id="g_slotReels">' +
                '<div class="g_reel" id="g_reel0">ü¶í</div>' +
                '<div class="g_reel" id="g_reel1">ü¶í</div>' +
                '<div class="g_reel" id="g_reel2">ü¶í</div>' +
              '</div>' +
              '<div style="color:#555;font-size:0.65rem;margin-top:8px;letter-spacing:0.5px;">ü¶íü¶íü¶í = 15√ó ¬∑ 3-kind = 7√ó ¬∑ 2-kind = 1.8√ó</div>' +
            '</div>' +
            '<button class="g_btn g_btn-primary" style="width:100%;" id="g_slotsBtn" onclick="g_playSlotsGame()">SPIN</button>' +
            '<div class="g_result" id="g_slotsResult" style="display:none;"></div>' +
          '</div>' +

        '</div>' +

        // ‚îÄ‚îÄ History ‚îÄ‚îÄ
        '<div class="g_card">' +
          '<div class="g_title">BET HISTORY</div>' +
          '<div id="g_historyList"><div style="color:#252540;font-size:0.75rem;text-align:center;padding:1rem;letter-spacing:1px;">No games played yet</div></div>' +
        '</div>' +

        // ‚îÄ‚îÄ Footer ‚îÄ‚îÄ
        '<div style="background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:0.9rem 1.2rem;font-size:0.63rem;color:#2a2a44;letter-spacing:0.8px;text-align:center;line-height:2.2;text-transform:uppercase;">' +
          '‚óé SOL Bets ‚Üí <span style="font-family:monospace;color:#333;">' + g_SOL_TREASURY + '</span><br>' +
          'üèÜ NFT Prizes From ‚Üí <span style="font-family:monospace;color:#333;">' + g_NFT_TREASURY + '</span><br>' +
          'SOL bets sent on-chain to treasury ¬∑ All wins paid in ü•¨ Cabbage (1 ‚óé = 100 ü•¨) ¬∑ House profit fills the NFT prize pot ¬∑ Play responsibly' +
        '</div>' +

        // ‚îÄ‚îÄ Winner Modal ‚îÄ‚îÄ
        '<div id="g_winnerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;padding:2rem;">' +
          '<div id="g_confettiContainer" style="position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:10000;"></div>' +
          '<div style="position:relative;z-index:10001;background:linear-gradient(135deg,#111125,#0d0d20);border:2px solid #ffd700;box-shadow:0 0 60px rgba(255,215,0,0.3);border-radius:20px;padding:2.5rem;max-width:480px;width:100%;text-align:center;">' +
            '<div style="font-size:4rem;animation:g_pulse 1.5s infinite;">ü¶í</div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:2rem;letter-spacing:4px;color:#ffd700;margin:0.5rem 0;">YOU WON AN NFT!</div>' +
            '<div style="color:#888;font-size:0.8rem;margin-bottom:1rem;">Airdropping to your wallet</div>' +
            '<div style="font-family:monospace;font-size:0.7rem;color:#555;word-break:break-all;background:rgba(0,0,0,0.3);padding:0.8rem;border-radius:8px;margin-bottom:1.5rem;" id="g_winnerWallet"></div>' +
            '<div style="color:#00ff88;font-size:0.82rem;margin-bottom:1.5rem;">Your LNL NFT will be automatically sent to this wallet. This typically happens within seconds.</div>' +
            '<button class="g_btn g_btn-primary" onclick="g_closeWinnerModal()">AWESOME!</button>' +
          '</div>' +
        '</div>';

      // Load balances and pot
      g_loadGameBalances();
      g_updatePotUI();
      g_renderHistory();
    }

    function g_setCurrency(cur) {
      g_currency = cur;
      var bs = document.getElementById('g_btnSol');
      var bc = document.getElementById('g_btnCab');
      var bl = document.getElementById('g_betCurrLabel');
      if (bs) { bs.classList.toggle('g_btn-primary', cur==='sol'); bs.style.borderColor=cur==='sol'?'rgba(0,212,255,0.45)':''; bs.style.color=cur==='sol'?'#00d4ff':''; }
      if (bc) { bc.classList.toggle('g_btn-primary', cur==='cabbage'); bc.style.borderColor=cur==='cabbage'?'rgba(0,212,255,0.45)':''; bc.style.color=cur==='cabbage'?'#00d4ff':''; }
      if (bl) bl.textContent = cur==='sol' ? '‚óé' : 'ü•¨';
    }

    function g_setBet(amt) {
      g_betAmount = amt;
      var inp = document.getElementById('g_betInput');
      if (inp) inp.value = amt;
    }

    function g_setResult(id, msg, win) {
      var el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'block';
      el.textContent = msg;
      el.style.color = win ? '#00ff88' : '#ff3c5c';
      el.style.background = win ? 'rgba(0,255,136,0.06)' : 'rgba(255,60,92,0.06)';
      el.style.border = win ? '1px solid rgba(0,255,136,0.18)' : '1px solid rgba(255,60,92,0.18)';
    }

    function g_disableGameBtns(dis) {
      ['g_coinBtn','g_slotsBtn'].forEach(function(id){
        var b = document.getElementById(id);
        if (b) b.disabled = dis;
      });
      document.querySelectorAll('[onclick^="g_playDiceGame"]').forEach(function(b){ b.disabled = dis; });
    }

    async function g_runBet(betAmt, currency) {
      // Validate
      if (currency === 'sol') {
        var solBal = await g_fetchSolBalance();
        if (solBal === null || solBal < betAmt + 0.002) throw new Error('Insufficient SOL (need ' + (betAmt+0.002).toFixed(3) + ' ‚óé incl. fee)');
        var lamports = Math.round(betAmt * 1e9);
        await g_sendSolBet(lamports);
      } else {
        var cabBal = await g_fetchCabbageBalance();
        if (cabBal === null || cabBal < betAmt) throw new Error('Insufficient Cabbage balance (' + Math.floor(cabBal||0) + ' ü•¨)');
        await g_spendCabbage(betAmt);
      }
    }

    async function g_playCoinGame() {
      if (g_isSpinning) return;
      g_isSpinning = true;
      g_disableGameBtns(true);
      var coinEl = document.getElementById('g_coinFace');
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;

      try {
        await g_runBet(bet, g_currency);

        // Animate
        if (coinEl) { coinEl.textContent = 'üåÄ'; }
        await new Promise(function(r){ setTimeout(r, 600); });

        var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;
        var won = g_playCoin(nftCount);
        var multiplier = g_GAMES.coin.payout;
        var cabbagePayout = 0;

        if (won) {
          cabbagePayout = g_currency === 'sol'
            ? bet * multiplier * g_SOL_TO_CABBAGE
            : bet * multiplier;
          await g_creditCabbage(cabbagePayout);
        }

        var houseProfit = won ? 0 : bet;
        if (coinEl) coinEl.textContent = won ? 'üòé' : 'üíÄ';

        if (won) {
          g_setResult('g_coinResult', '‚úÖ HEADS! Won ' + cabbagePayout.toFixed(2) + ' ü•¨', true);
        } else {
          g_setResult('g_coinResult', 'üíÄ TAILS! Lost ' + bet.toFixed(4) + (g_currency==='sol'?' ‚óé':' ü•¨'), false);
        }

        g_addHistory('ü™ô Coin', bet, g_currency, won, cabbagePayout);
        await g_logBet('ü™ô Coin Flip', bet, g_currency, Math.max(0, houseProfit));
        await g_updatePotUI();
        await g_loadGameBalances();
      } catch(e) {
        g_setResult('g_coinResult', '‚ö† ' + (e.message || 'Error'), false);
        if (coinEl) coinEl.textContent = 'ü™ô';
      }
      g_isSpinning = false;
      g_disableGameBtns(false);
    }

    async function g_playDiceGame(choice) {
      if (g_isSpinning) return;
      g_isSpinning = true;
      g_disableGameBtns(true);
      var diceEl = document.getElementById('g_diceFace');
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;

      try {
        await g_runBet(bet, g_currency);

        if (diceEl) { var frames = ['1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£']; var fi = 0; var anim = setInterval(function(){ diceEl.textContent = frames[fi++ % 6]; }, 100); }
        await new Promise(function(r){ setTimeout(r, 700); });
        if (typeof anim !== 'undefined') clearInterval(anim);

        var result = g_playDice(choice);
        var diceNums = ['1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£'];
        if (diceEl) diceEl.textContent = diceNums[result.roll - 1];

        var multiplier = g_GAMES.dice.payout;
        var cabbagePayout = 0;

        if (result.won) {
          cabbagePayout = g_currency === 'sol'
            ? bet * multiplier * g_SOL_TO_CABBAGE
            : bet * multiplier;
          await g_creditCabbage(cabbagePayout);
        }

        var houseProfit = result.won ? 0 : bet;

        if (result.won) {
          g_setResult('g_diceResult', '‚úÖ Rolled ' + result.roll + ' (' + choice.toUpperCase() + ')! Won ' + cabbagePayout.toFixed(2) + ' ü•¨', true);
        } else {
          g_setResult('g_diceResult', '‚ùå Rolled ' + result.roll + ' (' + choice.toUpperCase() + '). Lost ' + bet.toFixed(4) + (g_currency==='sol'?' ‚óé':' ü•¨'), false);
        }

        g_addHistory('üé≤ Dice', bet, g_currency, result.won, cabbagePayout);
        await g_logBet('üé≤ Dice Roll', bet, g_currency, Math.max(0, houseProfit));
        await g_updatePotUI();
        await g_loadGameBalances();
      } catch(e) {
        g_setResult('g_diceResult', '‚ö† ' + (e.message || 'Error'), false);
        if (diceEl) diceEl.textContent = 'üé≤';
      }
      g_isSpinning = false;
      g_disableGameBtns(false);
    }

    async function g_playSlotsGame() {
      if (g_isSpinning) return;
      g_isSpinning = true;
      g_disableGameBtns(true);
      var bet = parseFloat(document.getElementById('g_betInput').value) || g_betAmount;
      g_betAmount = bet;

      try {
        await g_runBet(bet, g_currency);

        // Spin animation
        var spinSyms = ['ü¶í','üåø','üé≤','üíé','üî•','‚≠ê'];
        var si = 0;
        var spinAnim = setInterval(function(){
          for (var i = 0; i < 3; i++) {
            var el = document.getElementById('g_reel' + i);
            if (el) el.textContent = spinSyms[(si + i) % spinSyms.length];
          }
          si++;
        }, 80);
        await new Promise(function(r){ setTimeout(r, 800); });
        clearInterval(spinAnim);

        var nftCount = session.loadedNFTs ? session.loadedNFTs.length : 0;
        var slotsResult = g_playSlots(nftCount);

        for (var i = 0; i < 3; i++) {
          var el = document.getElementById('g_reel' + i);
          if (el) el.textContent = slotsResult.reels[i];
        }

        var won = slotsResult.result !== 'loss';
        var cabbagePayout = 0;

        if (won) {
          cabbagePayout = g_currency === 'sol'
            ? bet * slotsResult.payout * g_SOL_TO_CABBAGE
            : bet * slotsResult.payout;
          await g_creditCabbage(cabbagePayout);
        }

        var houseProfit = won ? 0 : bet;

        var msg;
        if (slotsResult.result === 'jackpot') msg = 'üéâ JACKPOT! Won ' + cabbagePayout.toFixed(2) + ' ü•¨';
        else if (slotsResult.result === 'three') msg = '‚úÖ THREE OF A KIND! Won ' + cabbagePayout.toFixed(2) + ' ü•¨';
        else if (slotsResult.result === 'two') msg = '‚úÖ PAIR! Won ' + cabbagePayout.toFixed(2) + ' ü•¨';
        else msg = '‚ùå No match. Lost ' + bet.toFixed(4) + (g_currency==='sol'?' ‚óé':' ü•¨');

        g_setResult('g_slotsResult', msg, won);
        g_addHistory('üé∞ Slots', bet, g_currency, won, cabbagePayout);
        await g_logBet('üé∞ Slots', bet, g_currency, Math.max(0, houseProfit));
        await g_updatePotUI();
        await g_loadGameBalances();
      } catch(e) {
        g_setResult('g_slotsResult', '‚ö† ' + (e.message || 'Error'), false);
      }
      g_isSpinning = false;
      g_disableGameBtns(false);
    }


    /* ================================================================
       CABBAGE STORE
       - Loads items from Supabase store_items table
       - Community NFT listings from nft_listings table
       - Purchases deduct cabbage via the spend endpoint
    ================================================================ */

    var s_items = [];
    var s_listings = [];
    var s_filter = 'all';
    var s_cabBalance = null;

    async function s_fetchCabbageBalance() {
      if (!walletPublicKey) return 0;
      try {
        var res = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage?wallet=' + encodeURIComponent(walletPublicKey.toBase58()), {
          headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
        });
        var data = await res.json();
        return Number(data.balance || 0) + Number(data.pending || 0);
      } catch(e) { return 0; }
    }

    async function s_loadItems() {
      try {
        var sb = getSupaClient();
        var res = await sb
          .from('store_items')
          .select('*')
          .eq('active', true)
          .order('category', { ascending: true })
          .order('price', { ascending: true });
        if (res.error) throw res.error;
        s_items = res.data || [];
      } catch(e) {
        console.error('Store items load error:', e);
        s_items = [];
      }
    }

    async function s_loadListings() {
      try {
        var sb = getSupaClient();
        var res = await sb
          .from('nft_listings')
          .select('*')
          .eq('status', 'listed')
          .order('created_at', { ascending: false });
        if (res.error) throw res.error;
        s_listings = res.data || [];
      } catch(e) {
        console.error('NFT listings load error:', e);
        s_listings = [];
      }
    }

    async function renderStoreUI() {
      var view = document.getElementById('view-store');
      if (!view) return;

      view.innerHTML =
        '<div style="display:flex;align-items:center;justify-content:center;padding:3rem;color:#252540;font-size:0.8rem;letter-spacing:2px;">Loading store‚Ä¶</div>';

      s_cabBalance = await s_fetchCabbageBalance();
      await s_loadItems();
      await s_loadListings();

      s_paintStore();
    }

    function s_paintStore() {
      var view = document.getElementById('view-store');
      if (!view) return;

      var myWallet = walletPublicKey ? walletPublicKey.toBase58() : '';
      var html = '';

      // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
      html +=
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:0.6rem;">' +
          '<div>' +
            '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#e0e0ff;">ü•¨ CABBAGE STORE</div>' +
            '<div style="font-size:0.7rem;color:#444;letter-spacing:1px;margin-top:2px;">Spend your cabbage on merch, raffles, and NFTs</div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:0.8rem;">' +
            '<div style="background:rgba(0,255,136,0.06);border:1px solid rgba(0,255,136,0.15);border-radius:10px;padding:8px 14px;display:flex;align-items:center;gap:6px;">' +
              '<span style="font-size:1.1rem;">ü•¨</span>' +
              '<span style="font-weight:700;color:#00ff88;font-size:1rem;" id="s_balDisplay">' + Math.floor(s_cabBalance).toLocaleString() + '</span>' +
            '</div>' +
            '<button onclick="switchView(\'profile\')" style="background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888;padding:7px 14px;border-radius:7px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;" onmouseover="this.style.borderColor=\'rgba(0,212,255,0.4)\';this.style.color=\'#00d4ff\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.1)\';this.style.color=\'#888\'">‚Üê Home</button>' +
          '</div>' +
        '</div>';

      // ‚îÄ‚îÄ Filter Tabs ‚îÄ‚îÄ
      var filters = [
        { id:'all', label:'All' },
        { id:'merch', label:'üõç Merch' },
        { id:'digital', label:'‚ú® Digital' },
        { id:'raffle', label:'üéü Raffles' },
        { id:'nft', label:'üñº NFT Market' }
      ];
      html += '<div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1.4rem;">';
      filters.forEach(function(f) {
        var active = s_filter === f.id;
        html += '<button onclick="s_setFilter(\'' + f.id + '\')" style="background:' + (active ? 'rgba(0,212,255,0.08)' : 'transparent') + ';border:1px solid ' + (active ? 'rgba(0,212,255,0.5)' : 'rgba(255,255,255,0.08)') + ';color:' + (active ? '#00d4ff' : '#888') + ';padding:8px 16px;border-radius:8px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;">' + f.label + '</button>';
      });
      html += '</div>';

      // ‚îÄ‚îÄ List NFT Button ‚îÄ‚îÄ
      if (s_filter === 'nft' || s_filter === 'all') {
        html += '<div style="margin-bottom:1.2rem;">' +
          '<button onclick="s_openListNftModal()" style="background:linear-gradient(135deg,rgba(0,212,255,0.12),rgba(123,104,238,0.12));border:1px solid rgba(0,212,255,0.3);color:#00d4ff;padding:10px 22px;border-radius:10px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.75rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;">+ List My NFT For Sale</button>' +
        '</div>';
      }

      // ‚îÄ‚îÄ Items Grid ‚îÄ‚îÄ
      var visibleItems = s_filter === 'all' ? s_items : (s_filter === 'nft' ? [] : s_items.filter(function(i){ return i.category === s_filter; }));
      var visibleListings = (s_filter === 'all' || s_filter === 'nft') ? s_listings : [];

      if (visibleItems.length === 0 && visibleListings.length === 0) {
        html += '<div style="text-align:center;padding:3rem;color:#252540;font-size:0.78rem;letter-spacing:2px;">No items in this category yet</div>';
      }

      html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1.2rem;">';

      // Store items
      visibleItems.forEach(function(item) {
        var outOfStock = item.stock !== null && item.stock <= 0;
        var cantAfford = s_cabBalance < item.price;
        var stockLabel = item.stock !== null ? (item.stock + ' left') : '‚àû';
        var catBadge = item.category === 'merch' ? 'üõç' : (item.category === 'digital' ? '‚ú®' : 'üéü');

        html +=
          '<div style="background:#0f0f22;border:1px solid #1e1e3a;border-radius:14px;overflow:hidden;transition:all 0.2s;' + (outOfStock ? 'opacity:0.5;' : '') + '">' +
            (item.image_url ? '<div style="width:100%;aspect-ratio:1;background:#06060f;overflow:hidden;"><img src="' + escapeHtml(item.image_url) + '" style="width:100%;height:100%;object-fit:cover;" loading="lazy" onerror="this.style.display=\'none\'"></div>' : '<div style="width:100%;aspect-ratio:1;background:#06060f;display:flex;align-items:center;justify-content:center;font-size:3rem;">' + catBadge + '</div>') +
            '<div style="padding:1rem;">' +
              '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.4rem;">' +
                '<div style="font-weight:700;font-size:0.88rem;color:#e0e0ff;">' + escapeHtml(item.name) + '</div>' +
                '<div style="font-size:0.6rem;color:#555;letter-spacing:1px;text-transform:uppercase;flex-shrink:0;margin-left:8px;">' + catBadge + ' ' + stockLabel + '</div>' +
              '</div>' +
              '<div style="font-size:0.75rem;color:#555;margin-bottom:0.8rem;line-height:1.5;">' + escapeHtml(item.description || '') + '</div>' +
              '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                '<div style="font-weight:900;font-size:1rem;color:#00ff88;">' + item.price.toLocaleString() + ' ü•¨</div>' +
                '<button onclick="s_buyItem(' + item.id + ')" ' + (outOfStock || cantAfford ? 'disabled' : '') + ' style="background:' + (outOfStock ? '#1a1a30' : (cantAfford ? '#1a1a30' : 'linear-gradient(135deg,rgba(0,255,136,0.15),rgba(0,212,255,0.15))')) + ';border:1px solid ' + (outOfStock || cantAfford ? 'rgba(255,255,255,0.05)' : 'rgba(0,255,136,0.3)') + ';color:' + (outOfStock ? '#333' : (cantAfford ? '#555' : '#00ff88')) + ';padding:8px 16px;border-radius:8px;cursor:' + (outOfStock || cantAfford ? 'not-allowed' : 'pointer') + ';font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.7rem;letter-spacing:1.5px;text-transform:uppercase;transition:all 0.2s;">' + (outOfStock ? 'SOLD OUT' : (cantAfford ? 'NEED MORE ü•¨' : 'BUY')) + '</button>' +
              '</div>' +
            '</div>' +
          '</div>';
      });

      // NFT listings
      visibleListings.forEach(function(listing) {
        var isOwn = listing.seller_wallet === myWallet;
        var cantAfford = s_cabBalance < listing.price;
        var sellerShort = listing.seller_wallet.slice(0,4) + '‚Ä¶' + listing.seller_wallet.slice(-4);
        var sellerLabel = listing.seller_name || sellerShort;

        html +=
          '<div style="background:#0f0f22;border:1px solid ' + (isOwn ? 'rgba(123,104,238,0.3)' : '#1e1e3a') + ';border-radius:14px;overflow:hidden;transition:all 0.2s;">' +
            (listing.image_url ? '<div style="width:100%;aspect-ratio:1;background:#06060f;overflow:hidden;"><img src="' + escapeHtml(listing.image_url) + '" style="width:100%;height:100%;object-fit:cover;" loading="lazy" onerror="this.style.display=\'none\'"></div>' : '<div style="width:100%;aspect-ratio:1;background:#06060f;display:flex;align-items:center;justify-content:center;font-size:3rem;">üñº</div>') +
            '<div style="padding:1rem;">' +
              '<div style="font-weight:700;font-size:0.88rem;color:#e0e0ff;margin-bottom:0.3rem;">' + escapeHtml(listing.name) + '</div>' +
              '<div style="font-size:0.68rem;color:#555;margin-bottom:0.8rem;">Listed by <span style="color:#7b68ee;">' + escapeHtml(sellerLabel) + '</span></div>' +
              '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                '<div style="font-weight:900;font-size:1rem;color:#00ff88;">' + listing.price.toLocaleString() + ' ü•¨</div>' +
                (isOwn
                  ? '<button onclick="s_cancelListing(' + listing.id + ')" style="background:transparent;border:1px solid rgba(255,60,92,0.3);color:#ff3c5c;padding:8px 16px;border-radius:8px;cursor:pointer;font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.7rem;letter-spacing:1.5px;text-transform:uppercase;">CANCEL</button>'
                  : '<button onclick="s_buyListing(' + listing.id + ')" ' + (cantAfford ? 'disabled' : '') + ' style="background:' + (cantAfford ? '#1a1a30' : 'linear-gradient(135deg,rgba(0,255,136,0.15),rgba(0,212,255,0.15))') + ';border:1px solid ' + (cantAfford ? 'rgba(255,255,255,0.05)' : 'rgba(0,255,136,0.3)') + ';color:' + (cantAfford ? '#555' : '#00ff88') + ';padding:8px 16px;border-radius:8px;cursor:' + (cantAfford ? 'not-allowed' : 'pointer') + ';font-family:\'Space Grotesk\',sans-serif;font-weight:700;font-size:0.7rem;letter-spacing:1.5px;text-transform:uppercase;">' + (cantAfford ? 'NEED MORE ü•¨' : 'BUY NFT') + '</button>'
                ) +
              '</div>' +
            '</div>' +
          '</div>';
      });

      html += '</div>';

      html += '<div style="margin-top:2rem;text-align:center;font-size:0.63rem;color:#1e1e3a;letter-spacing:1px;text-transform:uppercase;line-height:2;">All purchases are final ¬∑ Physical items require shipping info ¬∑ NFT transfers are manual</div>';

      view.innerHTML = html;
    }

    function s_setFilter(filter) {
      s_filter = filter;
      s_paintStore();
    }

    async function s_buyItem(itemId) {
      var item = s_items.find(function(i){ return i.id === itemId; });
      if (!item) return alert('Item not found.');
      if (!walletPublicKey) return alert('Connect wallet first.');

      var confirmed = confirm('Buy "' + item.name + '" for ' + item.price.toLocaleString() + ' ü•¨?');
      if (!confirmed) return;

      // If merch, collect shipping info
      var shipping = null;
      if (item.category === 'merch') {
        var shipName = prompt('Shipping Name:');
        if (!shipName) return;
        var address = prompt('Street Address:');
        if (!address) return;
        var city = prompt('City:');
        if (!city) return;
        var state = prompt('State / Province:');
        var zip = prompt('ZIP / Postal Code:');
        var country = prompt('Country:', 'US');
        shipping = { name: shipName, address: address, city: city, state: state || '', zip: zip || '', country: country || 'US' };
      }

      try {
        await g_spendCabbage(item.price);

        var sb = getSupaClient();
        var wallet = walletPublicKey.toBase58();
        var username = (session && session.profile && session.profile.username) || null;

        var orderRes = await sb.from('store_orders').insert({
          wallet: wallet,
          username: username,
          item_id: item.id,
          item_name: item.name,
          price_paid: item.price,
          status: 'pending',
          shipping: shipping
        }).select().single();

        if (orderRes.error) throw orderRes.error;

        if (item.stock !== null) {
          await sb.from('store_items').update({ stock: Math.max(0, item.stock - 1) }).eq('id', item.id);
        }

        alert('‚úÖ Purchased "' + item.name + '" for ' + item.price.toLocaleString() + ' ü•¨!\n\n' + (item.category === 'merch' ? 'We\'ll ship it to you soon.' : (item.category === 'raffle' ? 'You\'re entered! Good luck.' : 'Order confirmed.')));

        s_cabBalance = await s_fetchCabbageBalance();
        await s_loadItems();
        s_paintStore();

      } catch(e) {
        alert('Purchase failed: ' + (e.message || e));
      }
    }

    function s_openListNftModal() {
      if (!walletPublicKey) return alert('Connect wallet first.');
      if (!session.loadedNFTs || session.loadedNFTs.length === 0) return alert('No NFTs found in your wallet.');

      var options = session.loadedNFTs.map(function(nft, idx) {
        return (idx + 1) + ') ' + nft.name + ' (' + (nft.mint ? nft.mint.slice(0,6) + '‚Ä¶' : '?') + ')';
      }).join('\n');

      var choice = prompt('Which NFT do you want to list?\n\n' + options + '\n\nEnter the number:');
      if (!choice) return;
      var idx = parseInt(choice) - 1;
      if (isNaN(idx) || idx < 0 || idx >= session.loadedNFTs.length) return alert('Invalid selection.');

      var nft = session.loadedNFTs[idx];
      var price = prompt('Set your price in ü•¨ Cabbage for "' + nft.name + '":');
      if (!price) return;
      var priceNum = parseFloat(price);
      if (isNaN(priceNum) || priceNum <= 0) return alert('Invalid price.');

      s_createListing(nft, priceNum);
    }

    async function s_createListing(nft, price) {
      try {
        var sb = getSupaClient();
        var wallet = walletPublicKey.toBase58();
        var username = (session && session.profile && session.profile.username) || null;

        var res = await sb.from('nft_listings').insert({
          seller_wallet: wallet,
          seller_name: username,
          mint_address: nft.mint,
          name: nft.name,
          image_url: nft.image || null,
          price: price,
          status: 'listed'
        }).select().single();

        if (res.error) throw res.error;

        alert('‚úÖ Listed "' + nft.name + '" for ' + price.toLocaleString() + ' ü•¨!\n\nBuyers will see it in the NFT Market tab.');

        await s_loadListings();
        s_paintStore();
      } catch(e) {
        alert('Listing failed: ' + (e.message || e));
      }
    }

    async function s_cancelListing(listingId) {
      if (!confirm('Cancel this listing?')) return;
      try {
        var sb = getSupaClient();
        var res = await sb.from('nft_listings').update({ status: 'cancelled' }).eq('id', listingId);
        if (res.error) throw res.error;

        alert('Listing cancelled.');
        await s_loadListings();
        s_paintStore();
      } catch(e) {
        alert('Cancel failed: ' + (e.message || e));
      }
    }

    async function s_buyListing(listingId) {
      var listing = s_listings.find(function(l){ return l.id === listingId; });
      if (!listing) return alert('Listing not found.');
      if (!walletPublicKey) return alert('Connect wallet first.');

      var confirmed = confirm('Buy "' + listing.name + '" for ' + listing.price.toLocaleString() + ' ü•¨?\n\nThe NFT will be transferred to your wallet by the seller.');
      if (!confirmed) return;

      try {
        await g_spendCabbage(listing.price);

        var sb = getSupaClient();
        var buyerWallet = walletPublicKey.toBase58();

        // Credit seller
        var creditRes = await fetch(SUPA_URL.replace(/\/+$/,'') + '/functions/v1/cabbage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY },
          body: JSON.stringify({ action: 'credit', wallet: listing.seller_wallet, amount: listing.price })
        });
        var creditData = await creditRes.json();
        if (!creditRes.ok) throw new Error(creditData.error || 'Credit seller failed');

        // Mark sold
        await sb.from('nft_listings').update({
          status: 'sold',
          buyer_wallet: buyerWallet,
          sold_at: new Date().toISOString()
        }).eq('id', listingId);

        alert('‚úÖ Purchased "' + listing.name + '" for ' + listing.price.toLocaleString() + ' ü•¨!\n\nThe seller has been paid and will transfer the NFT to your wallet:\n' + buyerWallet);

        s_cabBalance = await s_fetchCabbageBalance();
        await s_loadListings();
        s_paintStore();
      } catch(e) {
        alert('Purchase failed: ' + (e.message || e));
      }
    }

  </script>
</body>
</html>
