<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/jpGdtHJ.jpeg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LNL Hot Sauce Mint | Mango Habanero Ascension</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #0a0a1a;
      color: #e0e0ff;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 1s ease;
    }
    body.loaded { opacity: 1; }

    nav {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 1rem 0;
      background: rgba(10,10,26,0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      text-align: center;
    }
    nav a {
      color: #e0e0ff;
      margin: 0 1.5rem;
      text-decoration: none;
      font-weight: 600;
      position: relative;
    }
    nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #00d4ff;
      transition: 0.3s;
    }
    nav a:hover::after { width: 100%; }

    .hotsauce-banner { padding-top: 90px; text-align: center; }
    .hotsauce-banner img {
      width: 100%;
      max-width: 800px;
      display: block;
      margin: 0 auto;
    }

    .sauce-info {
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
      font-size: 1.15rem;
      padding: 1rem;
    }

    h2 {
      font-family: "Trebuchet MS", Helvetica, sans-serif;
      font-weight: bold;
      font-size: 3rem;
      text-align: center;
      margin: 2rem 0 1.5rem;
      background: linear-gradient(45deg, #00d4ff, #ff6bff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .boxstyle {
      margin: 3rem auto;
      padding: 2.5rem 2rem;
      max-width: 900px;
      background: rgba(20,20,40,0.6);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,212,255,0.25);
      text-align: center;
    }

    .btn-glow {
      display: inline-block;
      padding: 1rem 2.5rem;
      margin: 0.5rem;
      font-family: "Trebuchet MS", Helvetica, sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 50px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
      z-index: 1;
      transition: all 0.25s ease;
      cursor: pointer;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(45deg, #00d4ff, #0099cc);
      color: white;
      box-shadow: 0 0 20px rgba(0,212,255,0.45);
    }
    .btn-secondary {
      background: linear-gradient(45deg, #7b68ee, #5a4fc3);
      color: white;
      box-shadow: 0 0 20px rgba(123,104,238,0.45);
    }
    .btn-danger {
      background: linear-gradient(45deg, #ff3b3b, #c91d1d);
      color: white;
      box-shadow: 0 0 20px rgba(255,59,59,0.35);
    }
    .btn-glow:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(0,212,255,0.7);
    }
    .btn-glow:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mint-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
      margin-top: 1.5rem;
    }
    @media (min-width: 900px) {
      .mint-grid { grid-template-columns: 1fr 1fr; }
    }

    .card {
      background: rgba(10,10,26,0.55);
      border: 1px solid rgba(0,212,255,0.15);
      border-radius: 18px;
      padding: 1.25rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      text-align: left;
    }
    .statline {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.35rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .statline:last-child { border-bottom: none; }
    .k { opacity: 0.85; }
    .v { font-weight: 700; }

    .status {
      margin-top: 1rem;
      padding: 0.85rem 1rem;
      border-radius: 12px;
      background: rgba(0,212,255,0.08);
      border: 1px solid rgba(0,212,255,0.18);
      font-size: 0.95rem;
      text-align: center;
      min-height: 22px;
    }
    .status.error {
      background: rgba(255,59,59,0.12);
      border-color: rgba(255,59,59,0.25);
      color: #ff6b6b;
    }
    .status.success {
      background: rgba(72,187,120,0.12);
      border-color: rgba(72,187,120,0.25);
      color: #68d391;
    }

    .sauce-art {
      text-align: center;
      margin: 2.5rem auto 0.5rem;
    }
    .sauce-art img {
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      box-shadow: 0 0 35px rgba(0,212,255,0.25);
    }

    .wl-badge {
      display: inline-block;
      padding: 0.4rem 0.8rem;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      font-weight: 700;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #1a1a2e;
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,212,255,0.3);
      position: relative;
    }
    .modal-content h3 {
      margin: 0 0 1.5rem 0;
      color: #00d4ff;
      text-align: center;
    }
    .wallet-option {
      background: rgba(0,212,255,0.1);
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 12px;
      padding: 1rem 1.1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .wallet-option:hover:not(.disabled) {
      background: rgba(0,212,255,0.2);
      border-color: #00d4ff;
      transform: translateX(5px);
    }
    .wallet-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .wallet-option div { flex: 1; }
    .wallet-name { font-weight: 700; font-size: 1.1rem; }
    .wallet-status { font-size: 0.85rem; opacity: 0.7; }
    .wallet-status.installed { color: #48bb78; opacity: 1; }
    .close-modal {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      padding: 0;
      width: auto;
      margin: 0;
    }

    footer {
      text-align: center;
      padding: 2rem;
      background: rgba(10,10,26,0.95);
      color: #888;
      border-top: 1px solid #00d4ff;
      margin-top: 4rem;
    }

    .mint-panel {
      margin-top: 1.5rem;
      padding: 1.25rem;
      border-radius: 18px;
      background: rgba(10,10,26,0.45);
      border: 1px solid rgba(0,212,255,0.14);
      box-shadow: 0 10px 25px rgba(0,0,0,0.22);
      text-align: left;
    }
    .mint-panel h3 {
      margin: 0 0 0.75rem 0;
      color: #00d4ff;
      text-align: center;
    }
    .mint-display-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.6rem;
    }
    @media (min-width: 900px) {
      .mint-display-grid { grid-template-columns: repeat(11, 1fr); }
    }
    .mint-tile {
      border-radius: 14px;
      padding: 0.65rem 0.55rem;
      background: rgba(0,212,255,0.06);
      border: 1px solid rgba(0,212,255,0.14);
      min-height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: 800;
      letter-spacing: 0.5px;
      user-select: none;
    }
    .mint-tile.filled {
      background: rgba(123,104,238,0.14);
      border-color: rgba(123,104,238,0.35);
      box-shadow: 0 0 18px rgba(123,104,238,0.22);
    }
    .mint-tile.empty { opacity: 0.35; }

    #btnMyMints {
      background: rgba(0,212,255,0.10);
      border: 1px solid rgba(0,212,255,0.22);
      box-shadow: 0 0 18px rgba(0,212,255,0.18);
      color: #e0e0ff;
      backdrop-filter: blur(10px);
    }
    #btnMyMints:hover:not(:disabled) {
      background: rgba(0,212,255,0.16);
      border-color: rgba(0,212,255,0.35);
      transform: translateY(-3px);
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <nav>
    <a href="https://longnecklegends.xyz/">Home</a>
    <a href="https://longnecklegends.xyz/#about">About</a>
    <a href="https://longnecklegends.xyz/#team">Team</a>
    <a href="/music.html">Music</a>
    <a href="/starternecks.html">Starter Necks</a>
    <a href="#mint">Mint</a>
  </nav>

  <!-- Wallet Selection Modal -->
  <div class="modal" id="walletModal">
    <div class="modal-content">
      <button class="close-modal" id="closeWalletModal">√ó</button>
      <h3>Select Your Wallet</h3>
      <div class="wallet-option" id="optPhantom" data-wallet="phantom">
        <div>
          <div class="wallet-name">Phantom</div>
          <div class="wallet-status" id="phantomStatus">Checking...</div>
        </div>
      </div>
      <div class="wallet-option" id="optSolflare" data-wallet="solflare">
        <div>
          <div class="wallet-name">Solflare</div>
          <div class="wallet-status" id="solflareStatus">Checking...</div>
        </div>
      </div>
      <div class="wallet-option" id="optMagiceden" data-wallet="magiceden">
        <div>
          <div class="wallet-name">Magic Eden</div>
          <div class="wallet-status" id="magicedenStatus">Checking...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- My Mints Modal -->
  <div class="modal" id="myMintsModal">
    <div class="modal-content" style="max-width: 820px;">
      <button class="close-modal" id="closeMyMintsModal">√ó</button>
      <h3 style="margin-bottom:0.75rem;">My Mints</h3>
      <div style="opacity:0.8; font-size:0.95rem; text-align:center; margin-bottom: 1rem;">
        Your minted Hot Sauce NFTs from this collection.
      </div>
      <div id="myMintsGrid" class="mint-display-grid"></div>
      <div id="myMintsEmpty" style="display:none; text-align:center; opacity:0.7; padding: 1.25rem 0;">
        No mints yet. Hit <strong>Mint Hot Sauce NFT</strong> when you're ready. üî•
      </div>
      <div id="myMintsLoading" style="text-align:center; padding: 1.25rem 0; display:none;">
        <span class="loading-spinner"></span> Loading your NFTs...
      </div>
    </div>
  </div>

  <section class="hotsauce-banner">
    <img src="https://i.imgur.com/MpqfjdX.png" alt="Long Neck Hot Sauce">
  </section>

  <section class="sauce-info">
    <h2>Mango Habanero Ascension</h2>
    <p>Turn up the heat! Forged in the volcanic kitchens of the flock, our first divine creation rises.</p>
    <p>
      A legendary blend of sweet, <strong style="color:#00d4ff;">sun-kissed mango and ruthless habanero heat.</strong>
      This isn't just sauce, it's a flavor prophecy delivered straight from the longest necks in Web3.
    </p>
    <div class="sauce-art">
      <img src="https://i.imgur.com/wCOHgWL.gif" alt="Mango Habanero Sauce Art">
    </div>
  </section>

  <section id="mint" class="boxstyle">
    <h2>‚≠ê Mint to Claim</h2>
    <p>33 Solana NFT Relics redeemable for a bottle of our exclusive Mango Habanero Hot Sauce.</p>

    <div class="mint-grid">
      <div class="card">
        <h3 style="margin-top:0;">Wallet</h3>
        <div class="statline">
          <span class="k">Wallet</span>
          <span class="v" id="walletLabel">Not connected</span>
        </div>
        <div class="statline">
          <span class="k">Status</span>
          <span class="v" id="wlStatus">‚Äî</span>
        </div>
        <div class="statline">
          <span class="k">Your Mints</span>
          <span class="v" id="userMints">‚Äî</span>
        </div>
        <div class="statline">
          <span class="k">Balance</span>
          <span class="v" id="walletBalance">‚Äî</span>
        </div>

        <div style="margin-top:1rem; text-align:center;">
          <button class="btn-glow btn-primary" id="btnConnect">Connect Wallet</button>
          <button class="btn-glow btn-secondary" id="btnRefresh">Refresh</button>
          <button class="btn-glow btn-secondary" id="btnMyMints" disabled>My Mints</button>
          <button class="btn-glow btn-danger" id="btnDisconnect" style="display:none;">Disconnect</button>
        </div>

        <div class="status" id="statusBox">Status: Ready.</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Collection</h3>
        <div class="statline"><span class="k">Total Supply</span><span class="v">33</span></div>
        <div class="statline"><span class="k">Minted</span><span class="v" id="cmMinted">‚Äî</span></div>
        <div class="statline"><span class="k">Remaining</span><span class="v" id="cmRemaining">‚Äî</span></div>
        <div class="statline"><span class="k">WL Price</span><span class="v">0.355 SOL</span></div>
        <div class="statline"><span class="k">Public Price</span><span class="v">0.55 SOL</span></div>

        <div style="margin-top:1rem; text-align:center;">
          <button class="btn-glow btn-secondary" id="btnMint" disabled>Mint Hot Sauce NFT</button>
        </div>

        <p style="opacity:0.85; font-size:0.95rem; margin-top:1rem;">
          <strong>Whitelist:</strong> 2 max | <strong>Public:</strong> 1 max
        </p>
      </div>
    </div>

    <div class="mint-panel" id="liveMintPanel">
      <h3>LIVE MINTS</h3>
      <div style="display:flex; justify-content:space-between; gap:1rem; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap;">
        <div style="opacity:0.85;">On-chain progress</div>
        <div style="font-weight:800;"><span id="liveMintCount">0</span> / 33</div>
      </div>
      <div id="liveMintGrid" class="mint-display-grid"></div>
    </div>
  </section>

  <footer>
    <p>¬© 2026 Long Neck Legends ‚Ä¢ Mango Habanero Ascension</p>
  </footer>

  <script>
    window.addEventListener('load', () => document.body.classList.add('loaded'));
  </script>

  <script type="module">
    // ============================================================================
    // IMPORTS
    // ============================================================================
    import {
      Connection,
      PublicKey,
      LAMPORTS_PER_SOL
    } from "https://esm.sh/@solana/web3.js@1.95.2";

    import { Metaplex, walletAdapterIdentity as mplWalletIdentity } from "https://esm.sh/@metaplex-foundation/js@0.20.1";

    // --- MintV2 (UMI) imports (FIX for InvalidAccountVersion) ---
    import { createUmi } from "https://esm.sh/@metaplex-foundation/umi-bundle-defaults@0.9.2";
    import { walletAdapterIdentity } from "https://esm.sh/@metaplex-foundation/umi-signer-wallet-adapters@0.9.2";
    import { publicKey } from "https://esm.sh/@metaplex-foundation/umi@0.9.2";
    import {
      mplCandyMachine,
      fetchCandyMachine,
      mintV2
    } from "https://esm.sh/@metaplex-foundation/mpl-candy-machine@0.9.2";

    // ============================================================================
    // CONFIGURATION (Single source of truth)
    // ============================================================================
    const CONFIG = {
      RPC_URLS: [
        "https://mainnet.helius-rpc.com/?api-key=44cfd082-9089-430d-8de3-cd310c478b1c",
        "https://rpc.ankr.com/solana",
        "https://api.mainnet-beta.solana.com"
      ],
      TREASURY: "ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc",
      CANDY_MACHINE_ID: "9gehPSjZz8i4SMUWR2d9wPQCxhZqKU1E8xmZBaMYw1E3",
      COLLECTION_MINT: "BzpsHMryoyXobwTPEVVohsy4tuEds8tw3siBfdN1GRQm",
      COLLECTION_UPDATE_AUTHORITY: "HykDh8asNfG3f94bkxhxnFjA3wYuopEGD7SVhoVxEfyb",
      TOTAL_SUPPLY: 33,
      WL_PRICE_SOL: 0.355,
      PUBLIC_PRICE_SOL: 0.55,
      WL_LIMIT: 2,
      PUBLIC_LIMIT: 1
    };

    // Whitelist addresses
    const WHITELIST = new Set([
      "2aSJBUGpWWUZty3dafov1Z8Edw3YPA6Z1e2X3aqXu27i","CjBK1dYZpuvvHQzj1Lt4h4pGNpr2xc7hk4mijG6G27VX",
      "5xdg4SRm6SULCeMkrveX4faGPipbJUgA89UKZ5w93Lto","8AWJ8XcHyGSABgk1GRZLTDqoKzRohtwSA1Hoo1Vy8KeH",
      "9uRi3YASNUzvGeSaBb1wZ2TvVzdwWWdVDfLS5xZTgiLJ","6mF6tWX985zwNQ51LX9VwLfv8j2YYYbezihuLFvYAeSH",
      "ALrtiXXgEcrVZSH1AK88stuMppWB3SMGsc8AuhMq3GtE","CLJHwun7n3t3BmNG5EtzhJ4c2HdC8w65SnTuncK7BjzJ",
      "7A2FezC1ixuCVAVsTi9Tu7LFsVfL3dXn3csgw2JJqev7","5ZMMwpc2JrRDjXkVuYxzbsPZhi9XHKnJi7qK4MeZxfPu",
      "BeMvBqi5JpkY6QSjtjtAjNWojotC9oFeqhmrKovduzWc","7BEHp18tiszdRLcNnpEaJx77E9sXksH88BtFDrZLkSNB",
      "5kpQiFkWjLUrEJK5X5ScY4d68ubn1KNDx27Fbt8p7t5Z","Cisbj4o37BT5KfZ7pj8oqgyQmhyk9zhQmZ5QDY9iQbhy",
      "7FXbPCp8BdGpDfFkz6dNbNuKYCpVYmrzDUbb2nFZesAP","BJikn9kPE2DZRsyxVSRCouNszZtJbQEa5A5f2ZuVDsPn",
      "2H8tLB1FkuJCxd9X8zdgWNhNisP26u6p5Krhownaredz","3mV9on4V5fM8Qz7GnbhBtXNXH2YkuhHs3Uj5y7SM3q89",
      "GEf63c6j7yFquNcPhqnKHiESfAX4oVitip1aQJQVF5Wk","FnoeG9p2Wtnad4SKGoN82JER3KjiDq6Cc5dWsLhHmEg6",
      "7xy9aZ1sdvteynG5WkejgMrn4peDPoJL5fJZw94kdokr","CFJprBVcveZsKks2UZEdZn7ygLHzk4e2M3Qxef14eSBP",
      "Ghx5kVKmEQWocjLRL517MvWmimQEnALzMxU8q6hWpmwq","4duMtY6XSp2AM9dvA4GeUqT3yCktVjeYqpThTaqHVUhU",
      "EuVvXs5FUnHjMRgfFD9xZghkH4f1gRZHbStoB6DXskZQ","BSGURLgsUCsRMgSeHLWdpRFpHT48pMP9ZXogRQQuojkU",
      "6j3K5V5D2F9Awk4Yn2QVoSZkAve2Y8mqByDC85jv4kmn","5VKGxhPvVP1SDCacDxXd9XmkAEC8JJ4zKgbrDzcWB6gv",
      "9djHV9eeaUQ7ofRNvcS8Jo94LyFwSkLifPZCkBh1bRE2","7uob8wsBH23aKRMVB18PCEZY1Ttwfjj4rhdWJZdgEYDa",
      "FdfCCyvEEYKjNwvdpJdjcrGQF5oc9QMdWBDEpe4pDUPS","9KbY8cb5wtgLVGKzShnuSjaxwFgogEbhXPeviEo8cAwg",
      "GkLxRLLNLZCkfwX62U5m1u1nE5NchEwmjoVLPxu1eonh","CCNZNC5JcspTFPB8qQCbKJZfqQzn8QW8QYUh2CiXVjsZ"
    ]);

    // ============================================================================
    // STATE
    // ============================================================================
    let connection = null;
    let currentRpcUrl = null;
    let walletProvider = null;
    let walletPublicKey = null;
    let walletType = null;
    let candyMachine = null;
    let metaplex = null;
    let userCollectionNFTs = [];
    let umi = null; // <-- MintV2 signer context

    // Find a working RPC
    async function findWorkingRpc() {
      for (const rpcUrl of CONFIG.RPC_URLS) {
        try {
          console.log(`Trying RPC: ${rpcUrl.substring(0, 50)}...`);
          const testConn = new Connection(rpcUrl, "confirmed");
          await testConn.getLatestBlockhash();
          console.log(`‚úì RPC working: ${rpcUrl.substring(0, 50)}...`);
          return { connection: testConn, url: rpcUrl };
        } catch (err) {
          console.warn(`‚úó RPC failed: ${rpcUrl.substring(0, 50)}...`, err.message);
          continue;
        }
      }
      throw new Error("All RPC endpoints failed. Please try again later.");
    }

    // ============================================================================
    // UI ELEMENTS
    // ============================================================================
    const $ = (id) => document.getElementById(id);
    const walletLabel = $("walletLabel");
    const wlStatus = $("wlStatus");
    const userMints = $("userMints");
    const walletBalance = $("walletBalance");
    const statusBox = $("statusBox");
    const cmMinted = $("cmMinted");
    const cmRemaining = $("cmRemaining");
    const btnConnect = $("btnConnect");
    const btnDisconnect = $("btnDisconnect");
    const btnRefresh = $("btnRefresh");
    const btnMint = $("btnMint");
    const btnMyMints = $("btnMyMints");
    const walletModal = $("walletModal");
    const myMintsModal = $("myMintsModal");

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    function setStatus(msg, type = "normal") {
      statusBox.textContent = "Status: " + msg;
      statusBox.className = "status";
      if (type === "error") statusBox.classList.add("error");
      if (type === "success") statusBox.classList.add("success");
    }

    function short(str) {
      const s = String(str || "");
      return s.length <= 10 ? s : s.slice(0, 4) + "..." + s.slice(-4);
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    // ============================================================================
    // WALLET DETECTION
    // ============================================================================
    function detectWallets() {
      const phantomStatus = $("phantomStatus");
      const optPhantom = $("optPhantom");
      if (window.phantom?.solana?.isPhantom) {
        phantomStatus.textContent = "Installed ‚úì";
        phantomStatus.classList.add("installed");
      } else {
        phantomStatus.textContent = "Not Installed";
        optPhantom.classList.add("disabled");
      }

      const solflareStatus = $("solflareStatus");
      const optSolflare = $("optSolflare");
      const hasSolflare = window.solflare?.isSolflare ||
                          (window.solflare && typeof window.solflare.connect === "function");
      if (hasSolflare) {
        solflareStatus.textContent = "Installed ‚úì";
        solflareStatus.classList.add("installed");
      } else {
        solflareStatus.textContent = "Not Installed";
        optSolflare.classList.add("disabled");
      }

      const magicedenStatus = $("magicedenStatus");
      const optMagiceden = $("optMagiceden");
      if (window.magicEden?.solana) {
        magicedenStatus.textContent = "Installed ‚úì";
        magicedenStatus.classList.add("installed");
      } else {
        magicedenStatus.textContent = "Not Installed";
        optMagiceden.classList.add("disabled");
      }
    }

    // ============================================================================
    // MODAL HANDLERS
    // ============================================================================
    function openWalletModal() { walletModal.classList.add("active"); }
    function closeWalletModal() { walletModal.classList.remove("active"); }
    function openMyMintsModal() { myMintsModal.classList.add("active"); }
    function closeMyMintsModal() { myMintsModal.classList.remove("active"); }

    // ============================================================================
    // WALLET CONNECTION
    // ============================================================================
    async function connectWallet(type) {
      if (!connection) {
        setStatus("Still connecting to Solana... please wait", "error");
        return;
      }

      try {
        setStatus("Connecting wallet...");
        closeWalletModal();

        let provider = null;

        if (type === "phantom") {
          provider = window.phantom?.solana;
          if (!provider?.isPhantom) {
            window.open("https://phantom.app/", "_blank");
            setStatus("Please install Phantom wallet!", "error");
            return;
          }
          walletType = "Phantom";
        } else if (type === "solflare") {
          provider = window.solflare;
          if (!provider || typeof provider.connect !== "function") {
            window.open("https://solflare.com/", "_blank");
            setStatus("Please install Solflare wallet!", "error");
            return;
          }
          walletType = "Solflare";
        } else if (type === "magiceden") {
          provider = window.magicEden?.solana;
          if (!provider) {
            window.open("https://wallet.magiceden.io/", "_blank");
            setStatus("Please install Magic Eden wallet!", "error");
            return;
          }
          walletType = "Magic Eden";
        } else {
          setStatus("Unknown wallet type", "error");
          return;
        }

        // Connect
        let resp;
        try {
          resp = await provider.connect();
        } catch (err) {
          if (err.code === 4001) {
            setStatus("Connection rejected by user", "error");
            return;
          }
          try {
            resp = await provider.connect({ onlyIfTrusted: false });
          } catch {
            throw err;
          }
        }

        // Extract public key
        const pkObj = resp?.publicKey || provider.publicKey;
        if (!pkObj) throw new Error("No public key returned");

        walletProvider = provider;
        walletPublicKey = typeof pkObj === "string" ? new PublicKey(pkObj) : pkObj;

        // Metaplex JS for reads (CM state + NFTs)
        metaplex = Metaplex.make(connection).use(mplWalletIdentity({
          publicKey: walletPublicKey,
          signTransaction: (tx) => provider.signTransaction(tx),
          signAllTransactions: (txs) => provider.signAllTransactions(txs),
          signMessage: provider.signMessage ? (msg) => provider.signMessage(msg) : undefined
        }));

        // UMI for MintV2 (FIX)
        umi = createUmi(currentRpcUrl).use(mplCandyMachine());
        umi.use(walletAdapterIdentity(walletProvider));

        // Update UI
        walletLabel.textContent = `${walletType}: ${short(walletPublicKey.toBase58())}`;
        btnDisconnect.style.display = "inline-block";
        btnMyMints.disabled = false;
        btnMint.disabled = false;

        setStatus(`${walletType} connected!`, "success");

        await refreshAll();

        if (provider.on) {
          provider.on("disconnect", () => disconnectWallet());
          provider.on("accountChanged", async (newPk) => {
            if (newPk) {
              walletPublicKey = newPk;
              walletLabel.textContent = `${walletType}: ${short(walletPublicKey.toBase58())}`;
              await refreshAll();
            } else {
              await disconnectWallet();
            }
          });
        }

      } catch (err) {
        console.error("Wallet connection error:", err);
        setStatus(`Connection failed: ${err?.message || "Unknown error"}`, "error");
      }
    }

    async function disconnectWallet() {
      try {
        if (walletProvider?.disconnect) await walletProvider.disconnect();
      } catch {}

      walletProvider = null;
      walletPublicKey = null;
      walletType = null;
      metaplex = null;
      umi = null;
      userCollectionNFTs = [];

      walletLabel.textContent = "Not connected";
      wlStatus.textContent = "‚Äî";
      userMints.textContent = "‚Äî";
      walletBalance.textContent = "‚Äî";
      btnDisconnect.style.display = "none";
      btnMyMints.disabled = true;
      btnMint.disabled = true;

      closeMyMintsModal();
      setStatus("Disconnected.");
    }

    // ============================================================================
    // CANDY MACHINE STATE (On-Chain)
    // ============================================================================
    async function fetchCandyMachineState() {
      if (!connection) return null;

      try {
        const tempMetaplex = metaplex || Metaplex.make(connection);
        const cmPubkey = new PublicKey(CONFIG.CANDY_MACHINE_ID);

        candyMachine = await tempMetaplex.candyMachines().findByAddress({ address: cmPubkey });

        const itemsRedeemed = candyMachine.itemsMinted?.toNumber?.() ?? candyMachine.itemsMinted ?? 0;
        const itemsAvailable = candyMachine.itemsAvailable?.toNumber?.() ?? candyMachine.itemsAvailable ?? CONFIG.TOTAL_SUPPLY;
        const remaining = Math.max(0, itemsAvailable - itemsRedeemed);

        cmMinted.textContent = itemsRedeemed;
        cmRemaining.textContent = remaining;

        renderLiveMintGrid(itemsRedeemed);

        return { itemsRedeemed, itemsAvailable, remaining };
      } catch (err) {
        console.error("Error fetching Candy Machine:", err);
        if (cmMinted.textContent === "‚Äî") {
          cmMinted.textContent = "Error";
          cmRemaining.textContent = "Error";
        }
        return null;
      }
    }

    // ============================================================================
    // LIVE MINT GRID
    // ============================================================================
    function renderLiveMintGrid(minted = 0) {
      const grid = $("liveMintGrid");
      const count = $("liveMintCount");
      if (!grid) return;
      if (count) count.textContent = minted;

      grid.innerHTML = "";
      for (let i = 0; i < CONFIG.TOTAL_SUPPLY; i++) {
        const tile = document.createElement("div");
        tile.className = "mint-tile " + (i < minted ? "filled" : "empty");
        tile.textContent = i < minted ? `#${i + 1}` : "‚Äî";
        grid.appendChild(tile);
      }
    }

    // ============================================================================
    // USER NFT FETCHING
    // ============================================================================
    async function fetchUserNFTs() {
      if (!walletPublicKey || !metaplex || !connection) {
        userCollectionNFTs = [];
        return [];
      }

      try {
        const nfts = await metaplex.nfts().findAllByOwner({ owner: walletPublicKey });

        const collectionPubkey = CONFIG.COLLECTION_MINT;
        userCollectionNFTs = nfts.filter(nft => {
          const collection = nft.collection;
          if (!collection) return false;
          const collectionAddress = collection.address?.toBase58?.() ?? collection.address;
          return collectionAddress === collectionPubkey && collection.verified;
        });

        return userCollectionNFTs;
      } catch (err) {
        console.error("Error fetching user NFTs:", err);
        userCollectionNFTs = [];
        return [];
      }
    }

    // ============================================================================
    // MY MINTS DISPLAY
    // ============================================================================
    async function renderMyMints() {
      const grid = $("myMintsGrid");
      const empty = $("myMintsEmpty");
      const loading = $("myMintsLoading");

      if (!walletPublicKey) {
        if (grid) grid.innerHTML = "";
        if (loading) loading.style.display = "none";
        if (empty) {
          empty.style.display = "block";
          empty.textContent = "Connect your wallet to view your mints.";
        }
        return;
      }

      if (loading) loading.style.display = "block";
      if (empty) empty.style.display = "none";
      if (grid) grid.innerHTML = "";

      await fetchUserNFTs();

      if (loading) loading.style.display = "none";

      if (userCollectionNFTs.length === 0) {
        if (empty) {
          empty.style.display = "block";
          empty.textContent = "No mints yet. Hit Mint when you're ready. üî•";
        }
        return;
      }

      if (empty) empty.style.display = "none";

      for (let i = 0; i < userCollectionNFTs.length; i++) {
        const tile = document.createElement("div");
        tile.className = "mint-tile filled";
        tile.textContent = `#${i + 1}`;
        const nft = userCollectionNFTs[i];
        tile.title = nft.name || short(nft.mintAddress?.toBase58?.() ?? nft.address?.toBase58?.() ?? "");
        grid.appendChild(tile);
      }
    }

    // ============================================================================
    // REFRESH ALL DATA
    // ============================================================================
    async function refreshAll() {
      if (!connection) {
        setStatus("Not connected to Solana", "error");
        return;
      }

      setStatus("Refreshing...");

      await fetchCandyMachineState();

      if (walletPublicKey) {
        try {
          const balance = await connection.getBalance(walletPublicKey);
          walletBalance.textContent = `${(balance / LAMPORTS_PER_SOL).toFixed(4)} SOL`;
        } catch {
          walletBalance.textContent = "Error";
        }

        const wallet = walletPublicKey.toBase58();
        const isWL = WHITELIST.has(wallet);
        wlStatus.innerHTML = isWL
          ? 'Whitelist <span class="wl-badge">WL</span>'
          : "Public";

        await fetchUserNFTs();
        const mintCount = userCollectionNFTs.length;
        const limit = isWL ? CONFIG.WL_LIMIT : CONFIG.PUBLIC_LIMIT;
        userMints.textContent = `${mintCount} / ${limit}`;
      }

      setStatus("Ready.");
    }

    // ============================================================================
    // MINT FUNCTION (MintV2 FIX)
    // ============================================================================
    async function mintNFT() {
      if (!connection) {
        setStatus("Not connected to Solana", "error");
        return;
      }
      if (!walletPublicKey || !walletProvider) {
        setStatus("Connect your wallet first!", "error");
        return;
      }
      if (!umi) {
        setStatus("Wallet not properly connected (UMI not ready)", "error");
        return;
      }

      try {
        btnMint.disabled = true;
        setStatus("Preparing mint...");

        const wallet = walletPublicKey.toBase58();
        const isWL = WHITELIST.has(wallet);

        // Check user limits
        await fetchUserNFTs();
        const currentMints = userCollectionNFTs.length;
        const limit = isWL ? CONFIG.WL_LIMIT : CONFIG.PUBLIC_LIMIT;
        if (currentMints >= limit) {
          setStatus(`You've reached your limit (${limit} max)`, "error");
          return;
        }

        // Check sold out
        const cmState = await fetchCandyMachineState();
        if (cmState && cmState.remaining <= 0) {
          setStatus("SOLD OUT! üî•", "error");
          return;
        }

        // Check balance
        const price = isWL ? CONFIG.WL_PRICE_SOL : CONFIG.PUBLIC_PRICE_SOL;
        const balance = await connection.getBalance(walletPublicKey);
        const required = (price + 0.02) * LAMPORTS_PER_SOL;
        if (balance < required) {
          setStatus(`Insufficient balance. Need ~${(price + 0.02).toFixed(3)} SOL`, "error");
          return;
        }

        setStatus(`Minting for ${price} SOL... approve in wallet üî•`);

        // Determine guard group label from your existing logic (if you use groups)
        let group = undefined;
        if (isWL) group = "WL"; // adjust if your group label is "wl"
        // else group could be "public" if your on-chain guard uses a public group label

        // Fetch CM via UMI and mint using MintV2 (fixes InvalidAccountVersion)
        const cmPk = publicKey(CONFIG.CANDY_MACHINE_ID);
        const umiCm = await fetchCandyMachine(umi, cmPk);

        // If your guard requires args (mintLimit id, allowList proof, etc.), set mintArgs here.
        // Example for mintLimit (ONLY if your guard uses it and your config expects an id):
        // const mintArgs = { mintLimit: { id: 1 } };
        const mintArgs = undefined;

        setStatus("Sending mint transaction... approve in wallet üî•");

        const res = await mintV2(umi, {
          candyMachine: umiCm.publicKey,
          collectionMint: umiCm.collectionMint,
          group,
          mintArgs
        }).sendAndConfirm(umi);

        console.log("MintV2 signature:", res.signature);
        setStatus(`‚úÖ Minted! Tx: ${short(res.signature)}`, "success");

        await sleep(2000);
        await refreshAll();

      } catch (err) {
        console.error("Mint error:", err);

        if (err?.message?.includes("rejected") || err?.code === 4001) {
          setStatus("Transaction cancelled by user", "error");
        } else if (err?.message?.includes("insufficient")) {
          setStatus("Insufficient SOL balance", "error");
        } else {
          setStatus(`Mint failed: ${err?.message || "Unknown error"}`, "error");
        }
      } finally {
        btnMint.disabled = !walletPublicKey;
      }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    btnConnect.addEventListener("click", openWalletModal);
    $("closeWalletModal").addEventListener("click", closeWalletModal);
    $("closeMyMintsModal").addEventListener("click", closeMyMintsModal);

    $("optPhantom").addEventListener("click", () => {
      if (!$("optPhantom").classList.contains("disabled")) connectWallet("phantom");
    });
    $("optSolflare").addEventListener("click", () => {
      if (!$("optSolflare").classList.contains("disabled")) connectWallet("solflare");
    });
    $("optMagiceden").addEventListener("click", () => {
      if (!$("optMagiceden").classList.contains("disabled")) connectWallet("magiceden");
    });

    btnDisconnect.addEventListener("click", disconnectWallet);
    btnRefresh.addEventListener("click", refreshAll);
    btnMint.addEventListener("click", mintNFT);
    btnMyMints.addEventListener("click", () => {
      renderMyMints();
      openMyMintsModal();
    });

    walletModal.addEventListener("click", (e) => {
      if (e.target === walletModal) closeWalletModal();
    });
    myMintsModal.addEventListener("click", (e) => {
      if (e.target === myMintsModal) closeMyMintsModal();
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    async function init() {
      setStatus("Connecting to Solana...");

      try {
        const result = await findWorkingRpc();
        connection = result.connection;
        currentRpcUrl = result.url;
        console.log("Using RPC:", currentRpcUrl);
      } catch (err) {
        console.error("RPC error:", err);
        setStatus("Failed to connect to Solana. Please refresh.", "error");
        return;
      }

      setTimeout(detectWallets, 300);

      const tempMetaplex = Metaplex.make(connection);
      try {
        const cmPubkey = new PublicKey(CONFIG.CANDY_MACHINE_ID);
        candyMachine = await tempMetaplex.candyMachines().findByAddress({ address: cmPubkey });

        const itemsRedeemed = candyMachine.itemsMinted?.toNumber?.() ?? candyMachine.itemsMinted ?? 0;
        cmMinted.textContent = itemsRedeemed;
        cmRemaining.textContent = Math.max(0, CONFIG.TOTAL_SUPPLY - itemsRedeemed);
        renderLiveMintGrid(itemsRedeemed);
        setStatus("Ready.");
      } catch (err) {
        console.error("Initial CM fetch error:", err);
        setStatus("Ready. (Could not fetch CM state)", "error");
        renderLiveMintGrid(0);
      }
    }

    init();
  </script>
</body>
</html>
