<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/jpGdtHJ.jpeg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LNL Hot Sauce Mint | Mango Habanero Ascension</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #0a0a1a;
      color: #e0e0ff;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 1s ease;
    }
    body.loaded { opacity: 1; }

    nav {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 1rem 0;
      background: rgba(10,10,26,0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      text-align: center;
    }
    nav a {
      color: #e0e0ff;
      margin: 0 1.5rem;
      text-decoration: none;
      font-weight: 600;
      position: relative;
    }
    nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #00d4ff;
      transition: 0.3s;
    }
    nav a:hover::after { width: 100%; }

    .hotsauce-banner { padding-top: 90px; text-align: center; }
    .hotsauce-banner img {
      width: 100%;
      max-width: 800px;
      display: block;
      margin: 0 auto;
    }

    .sauce-info {
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
      font-size: 1.15rem;
      padding: 1rem;
    }

    h2 {
      font-family: "Trebuchet MS", Helvetica, sans-serif;
      font-weight: bold;
      font-size: 3rem;
      text-align: center;
      margin: 2rem 0 1.5rem;
      background: linear-gradient(45deg, #00d4ff, #ff6bff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .boxstyle {
      margin: 3rem auto;
      padding: 2.5rem 2rem;
      max-width: 900px;
      background: rgba(20,20,40,0.6);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,212,255,0.25);
      text-align: center;
    }

    .btn-glow {
      display: inline-block;
      padding: 1rem 2.5rem;
      margin: 0.5rem;
      font-family: "Trebuchet MS", Helvetica, sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 50px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
      z-index: 1;
      transition: all 0.25s ease;
      cursor: pointer;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(45deg, #00d4ff, #0099cc);
      color: white;
      box-shadow: 0 0 20px rgba(0,212,255,0.45);
    }
    .btn-secondary {
      background: linear-gradient(45deg, #7b68ee, #5a4fc3);
      color: white;
      box-shadow: 0 0 20px rgba(123,104,238,0.45);
    }
    .btn-danger {
      background: linear-gradient(45deg, #ff3b3b, #c91d1d);
      color: white;
      box-shadow: 0 0 20px rgba(255,59,59,0.35);
    }
    .btn-glow:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 0 30px rgba(0,212,255,0.7);
    }
    .btn-glow:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mint-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
      margin-top: 1.5rem;
    }
    @media (min-width: 900px) {
      .mint-grid { grid-template-columns: 1fr 1fr; }
    }

    .card {
      background: rgba(10,10,26,0.55);
      border: 1px solid rgba(0,212,255,0.15);
      border-radius: 18px;
      padding: 1.25rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      text-align: left;
    }
    .statline {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.35rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .statline:last-child { border-bottom: none; }
    .k { opacity: 0.85; }
    .v { font-weight: 700; }

    .status {
      margin-top: 1rem;
      padding: 0.85rem 1rem;
      border-radius: 12px;
      background: rgba(0,212,255,0.08);
      border: 1px solid rgba(0,212,255,0.18);
      font-size: 0.95rem;
      text-align: center;
      min-height: 22px;
    }
    .status.error {
      background: rgba(255,59,59,0.12);
      border-color: rgba(255,59,59,0.25);
      color: #ff6b6b;
    }
    .status.success {
      background: rgba(72,187,120,0.12);
      border-color: rgba(72,187,120,0.25);
      color: #68d391;
    }

    .sauce-art {
      text-align: center;
      margin: 2.5rem auto 0.5rem;
    }
    .sauce-art img {
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      box-shadow: 0 0 35px rgba(0,212,255,0.25);
    }

    .wl-badge {
      display: inline-block;
      padding: 0.4rem 0.8rem;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      font-weight: 700;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #1a1a2e;
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,212,255,0.3);
      position: relative;
    }
    .modal-content h3 {
      margin: 0 0 1.5rem 0;
      color: #00d4ff;
      text-align: center;
    }
    .wallet-option {
      background: rgba(0,212,255,0.1);
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 12px;
      padding: 1rem 1.1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .wallet-option:hover:not(.disabled) {
      background: rgba(0,212,255,0.2);
      border-color: #00d4ff;
      transform: translateX(5px);
    }
    .wallet-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .wallet-option div { flex: 1; }
    .wallet-name { font-weight: 700; font-size: 1.1rem; }
    .wallet-status { font-size: 0.85rem; opacity: 0.7; }
    .wallet-status.installed { color: #48bb78; opacity: 1; }
    .close-modal {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      padding: 0;
      width: auto;
      margin: 0;
    }

    footer {
      text-align: center;
      padding: 2rem;
      background: rgba(10,10,26,0.95);
      color: #888;
      border-top: 1px solid #00d4ff;
      margin-top: 4rem;
    }

    .mint-panel {
      margin-top: 1.5rem;
      padding: 1.25rem;
      border-radius: 18px;
      background: rgba(10,10,26,0.45);
      border: 1px solid rgba(0,212,255,0.14);
      box-shadow: 0 10px 25px rgba(0,0,0,0.22);
      text-align: left;
    }
    .mint-panel h3 {
      margin: 0 0 0.75rem 0;
      color: #00d4ff;
      text-align: center;
    }
    .mint-display-grid{
      display: grid;
      gap: 0.6rem;
      grid-template-columns: repeat(auto-fit, minmax(62px, 1fr));
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .mint-tile {
      border-radius: 14px;
      padding: 0.65rem 0.55rem;
      background: rgba(0,212,255,0.06);
      border: 1px solid rgba(0,212,255,0.14);
      min-height: 54px;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: 800;
      letter-spacing: 0.5px;
      user-select: none;
    }
    .mint-tile.filled {
      background: rgba(123,104,238,0.14);
      border-color: rgba(123,104,238,0.35);
      box-shadow: 0 0 18px rgba(123,104,238,0.22);
    }
    .mint-tile.empty { opacity: 0.35; }

    #btnMyMints {
      background: rgba(0,212,255,0.10);
      border: 1px solid rgba(0,212,255,0.22);
      box-shadow: 0 0 18px rgba(0,212,255,0.18);
      color: #e0e0ff;
      backdrop-filter: blur(10px);
    }
    #btnMyMints:hover:not(:disabled) {
      background: rgba(0,212,255,0.16);
      border-color: rgba(0,212,255,0.35);
      transform: translateY(-3px);
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <nav>
    <a href="https://longnecklegends.xyz">Home</a>
    <a href="/starternecks.html">Starter Necks</a>
    <a href="/music.html">Music</a>
    <a href="/store.html">Store</a>
    <a href="/dashboard.html">Dashboard</a>
  </nav>

  <!-- Wallet Selection Modal -->
  <div class="modal" id="walletModal">
    <div class="modal-content">
      <button class="close-modal" id="closeWalletModal">√ó</button>
      <h3>Select Your Wallet</h3>
      <div class="wallet-option" id="optPhantom" data-wallet="phantom">
        <div>
          <div class="wallet-name">Phantom</div>
          <div class="wallet-status" id="phantomStatus">Checking...</div>
        </div>
      </div>
      <div class="wallet-option" id="optSolflare" data-wallet="solflare">
        <div>
          <div class="wallet-name">Solflare</div>
          <div class="wallet-status" id="solflareStatus">Checking...</div>
        </div>
      </div>
      <div class="wallet-option" id="optMagiceden" data-wallet="magiceden">
        <div>
          <div class="wallet-name">Magic Eden</div>
          <div class="wallet-status" id="magicedenStatus">Checking...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- My Mints Modal -->
  <div class="modal" id="myMintsModal">
    <div class="modal-content" style="max-width: 820px;">
      <button class="close-modal" id="closeMyMintsModal">√ó</button>
      <h3 style="margin-bottom:0.75rem;">My Mints</h3>
      <div style="opacity:0.8; font-size:0.95rem; text-align:center; margin-bottom: 1rem;">
        Your minted Hot Sauce NFTs from this collection.
      </div>
      <div id="myMintsGrid" class="mint-display-grid"></div>
      <div id="myMintsEmpty" style="display:none; text-align:center; opacity:0.7; padding: 1.25rem 0;">
        No mints yet. Hit <strong>Mint Hot Sauce NFT</strong> when you're ready. üî•
      </div>
      <div id="myMintsLoading" style="text-align:center; padding: 1.25rem 0; display:none;">
        <span class="loading-spinner"></span> Loading your NFTs...
      </div>
    </div>
  </div>

  <section class="hotsauce-banner">
    <img src="https://i.imgur.com/MpqfjdX.png" alt="Long Neck Hot Sauce">
  </section>

  <section class="sauce-info">
    <h2>Mango Habanero Ascension</h2>
    <p>Turn up the heat! Forged in the volcanic kitchens of the flock, our first divine creation rises.</p>
    <p>
      A legendary blend of sweet, <strong style="color:#00d4ff;">sun-kissed mango and ruthless habanero heat.</strong>
      This isn't just sauce, it's a flavor prophecy delivered straight from the longest necks in Web3.
    </p>
    <div class="sauce-art">
      <img src="https://i.imgur.com/wCOHgWL.gif" alt="Mango Habanero Sauce Art">
    </div>
  </section>

  <section id="mint" class="boxstyle">
    <h2>‚≠ê Mint to Claim</h2>
    <p>33 Solana NFT Relics redeemable for a bottle of our exclusive Mango Habanero Hot Sauce.</p>

    <div class="mint-grid">
      <div class="card">
        <h3 style="margin-top:0;">Wallet</h3>
        <div class="statline">
          <span class="k">Wallet</span>
          <span class="v" id="walletLabel">Not connected</span>
        </div>
        <div class="statline">
          <span class="k">Status</span>
          <span class="v" id="wlStatus">‚Äî</span>
        </div>
        <div class="statline">
          <span class="k">Your Mints</span>
          <span class="v" id="userMints">‚Äî</span>
        </div>
        <div class="statline">
          <span class="k">Balance</span>
          <span class="v" id="walletBalance">‚Äî</span>
        </div>

        <div style="margin-top:1rem; text-align:center;">
          <button class="btn-glow btn-primary" id="btnConnect">Connect Wallet</button>
          <button class="btn-glow btn-secondary" id="btnRefresh">Refresh</button>
          <button class="btn-glow btn-secondary" id="btnMyMints" disabled>My Mints</button>
          <button class="btn-glow btn-danger" id="btnDisconnect" style="display:none;">Disconnect</button>
        </div>

        <div class="status" id="statusBox">Status: Ready.</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Collection</h3>
        <div class="statline"><span class="k">Total Supply</span><span class="v">33</span></div>
        <div class="statline"><span class="k">Minted</span><span class="v" id="cmMinted">‚Äî</span></div>
        <div class="statline"><span class="k">Remaining</span><span class="v" id="cmRemaining">‚Äî</span></div>
        <div class="statline"><span class="k">WL Price</span><span class="v">0.355 SOL</span></div>
        <div class="statline"><span class="k">Public Price</span><span class="v">0.55 SOL</span></div>

        <div style="margin-top:1rem; text-align:center;">
          <button class="btn-glow btn-secondary" id="btnMint" disabled>Mint Hot Sauce NFT</button>
        </div>

        <p style="opacity:0.85; font-size:0.95rem; margin-top:1rem;">
          <strong>Whitelist:</strong> 2 max | <strong>Public:</strong> 1 max
        </p>
      </div>
    </div>

    <div class="mint-panel" id="liveMintPanel">
      <h3>LIVE MINTS</h3>
      <div style="display:flex; justify-content:space-between; gap:1rem; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap;">
        <div style="opacity:0.85;">On-chain progress</div>
        <div style="font-weight:800;"><span id="liveMintCount">0</span> / 33</div>
      </div>
      <div id="liveMintGrid" class="mint-display-grid"></div>
    </div>
  </section>

  <footer>
    <p>¬© 2026 Long Neck Legends ‚Ä¢ Mango Habanero Ascension</p>
  </footer>

  <script>
    window.addEventListener('load', () => document.body.classList.add('loaded'));
  </script>

  <script type="module">
    // ============================================================================
    // IMPORTS
    // ============================================================================
    import {
      Connection,
      PublicKey,
      LAMPORTS_PER_SOL
    } from "https://esm.sh/@solana/web3.js@1.95.2";

    import { Metaplex, walletAdapterIdentity as mplWalletIdentity } from "https://esm.sh/@metaplex-foundation/js@0.20.1";

    // --- MintV2 (UMI) imports ‚Äî pinned to match local node versions for merkle compatibility ---
    import { createUmi } from "https://esm.sh/@metaplex-foundation/umi-bundle-defaults@0.8.10";
    import { walletAdapterIdentity } from "https://esm.sh/@metaplex-foundation/umi-signer-wallet-adapters@0.8.10";
    import { publicKey, some, none, generateSigner, transactionBuilder } from "https://esm.sh/@metaplex-foundation/umi@0.8.10";
    import {
      mplCandyMachine,
      fetchCandyMachine,
      fetchCandyGuard,
      mintV2,
      route,
      getMerkleProof,
      getMerkleRoot
    } from "https://esm.sh/@metaplex-foundation/mpl-candy-machine@6.1.0";
    import { mplTokenMetadata } from "https://esm.sh/@metaplex-foundation/mpl-token-metadata@3.0.0-alpha.27";
    import { setComputeUnitLimit } from "https://esm.sh/@metaplex-foundation/mpl-toolbox@0.10.0";

    // ============================================================================
    // CONFIGURATION (Single source of truth)
    // ============================================================================
    const CONFIG = {
      RPC_URLS: [
        "https://mainnet.helius-rpc.com/?api-key=44cfd082-9089-430d-8de3-cd310c478b1c",
        "https://rpc.ankr.com/solana",
        "https://api.mainnet-beta.solana.com"
      ],
      HELIUS_API_KEY: "44cfd082-9089-430d-8de3-cd310c478b1c",
      TREASURY: "ChnzFpK4ty2vpzM48HUrtDVY7tWD8StmYaNxQcKSBuyc",
      CANDY_MACHINE_ID: "9gehPSjZz8i4SMUWR2d9wPQCxhZqKU1E8xmZBaMYw1E3",
      COLLECTION_MINT: "BzpsHMryoyXobwTPEVVohsy4tuEds8tw3siBfdN1GRQm",
      COLLECTION_UPDATE_AUTHORITY: "HykDh8asNfG3f94bkxhxnFjA3wYuopEGD7SVhoVxEfyb",
      TOTAL_SUPPLY: 33,
      WL_PRICE_SOL: 0.355,
      PUBLIC_PRICE_SOL: 0.55,
      WL_LIMIT: 2,
      PUBLIC_LIMIT: 1
    };

    // Whitelist addresses
    const WHITELIST = new Set([
      "2aSJBUGpWWUZty3dafov1Z8Edw3YPA6Z1e2X3aqXu27i","CjBK1dYZpuvvHQzj1Lt4h4pGNpr2xc7hk4mijG6G27VX",
      "5xdg4SRm6SULCeMkrveX4faGPipbJUgA89UKZ5w93Lto","8AWJ8XcHyGSABgk1GRZLTDqoKzRohtwSA1Hoo1Vy8KeH",
      "9uRi3YASNUzvGeSaBb1wZ2TvVzdwWWdVDfLS5xZTgiLJ","6mF6tWX985zwNQ51LX9VwLfv8j2YYYbezihuLFvYAeSH",
      "5ZMMwpc2JrRDjXkVuYxzbsPZhi9XHKnJi7qK4MeZxfPu","CLJHwun7n3t3BmNG5EtzhJ4c2HdC8w65SnTuncK7BjzJ",
      "ALrtiXXgEcrVZSH1AK88stuMppWB3SMGsc8AuhMq3GtE","7A2FezC1ixuCVAVsTi9Tu7LFsVfL3dXn3csgw2JJqev7",
      "BeMvBqi5JpkY6QSjtjtAjNWojotC9oFeqhmrKovduzWc","7BEHp18tiszdRLcNnpEaJx77E9sXksH88BtFDrZLkSNB",
      "BJikn9kPE2DZRsyxVSRCouNszZtJbQEa5A5f2ZuVDsPn","5kpQiFkWjLUrEJK5X5ScY4d68ubn1KNDx27Fbt8p7t5Z",
      "Cisbj4o37BT5KfZ7pj8oqgyQmhyk9zhQmZ5QDY9iQbhy","7FXbPCp8BdGpDfFkz6dNbNuKYCpVYmrzDUbb2nFZesAP",
      "4duMtY6XSp2AM9dvA4GeUqT3yCktVjeYqpThTaqHVUhU","2H8tLB1FkuJCxd9X8zdgWNhNisP26u6p5Krhownaredz",
      "3mV9on4V5fM8Qz7GnbhBtXNXH2YkuhHs3Uj5y7SM3q89","GEf63c6j7yFquNcPhqnKHiESfAX4oVitip1aQJQVF5Wk",
      "EuVvXs5FUnHjMRgfFD9xZghkH4f1gRZHbStoB6DXskZQ","HUMRWmxxZL9Kr6vKTrtuQpSH9WShkcPv96nqhJD49xX9",
      "7xy9aZ1sdvteynG5WkejgMrn4peDPoJL5fJZw94kdokr","CFJprBVcveZsKks2UZEdZn7ygLHzk4e2M3Qxef14eSBP",
      "6j3K5V5D2F9Awk4Yn2QVoSZkAve2Y8mqByDC85jv4kmn","FnoeG9p2Wtnad4SKGoN82JER3KjiDq6Cc5dWsLhHmEg6",
      "Ghx5kVKmEQWocjLRL517MvWmimQEnALzMxU8q6hWpmwq","BSGURLgsUCsRMgSeHLWdpRFpHT48pMP9ZXogRQQuojkU",
      "7uob8wsBH23aKRMVB18PCEZY1Ttwfjj4rhdWJZdgEYDa","5VKGxhPvVP1SDCacDxXd9XmkAEC8JJ4zKgbrDzcWB6gv",
      "9djHV9eeaUQ7ofRNvcS8Jo94LyFwSkLifPZCkBh1bRE2","CCNZNC5JcspTFPB8qQCbKJZfqQzn8QW8QYUh2CiXVjsZ",
      "8R6ZK2s8JuQ8yYPkZN1N2rFAuFKe7UngWwWpXjCe49Gk","9KbY8cb5wtgLVGKzShnuSjaxwFgogEbhXPeviEo8cAwg",
      "GX4eehZnEDcct41dBV3qRNrqRzWUZb48gND1ja2931FD","DavmQ7EqY46eND6V6TgE1L6CsQgTt6MmhT9KWep34AS6",
      "21tisg7oDosxBGDzoBKRTtmD4e5EQLUjYMdcYYvZkwoj","4AJqnx9GnRvZcAzjKsuJrsmo5oM64ExtLx3Xs6LVtgAR",
      "Ba3cSSAajoZ538Y6msdUYTc8tE4YCHaoTWms9fiPmgg6","2n9UY2g6thBLCzEL1V5PBXaLMQFxbWi2PJ4MhrDmhJtA",
      "64zRDbC8fqBark9D86sGxQtcf2cBn3Cy7woUF7LvMCBk","ERQrBMUuRMR2qb8VRDuDcaqjnMZjC6UUsKrqFXhiHSQD",
      "FKvv6D9LkHoLJsdxK8FG9QKSxHzPcoBi9uv8qAimYS65","Dc2WeThQn6zAEEaMZBvj39T38YU1dNW9hJAAJHmGUu26",
      "9CuBeMAzjo3qtd56uaFJ9dfNd48QmWfWpjpqxKpdUg4q","CGksN7f2DJMU2mWpT1FVfAEdVWVCqaV4oNinGVPWqRCq",
      "AA4e637PNPZxnZWDGiRC9cy8WkBcs9tr3exUA55pbEom","bwA6AePrh49WMSw54TTRSWz1sArh7gAij4KdcBN44SX",
      "7smChPFGdqTBtEBiiawAhhoyGiSmLHZ2NikBgQpVUhP8","EXvu9TWjR7hFawiyBzGHnxft5QVUTSvHmw7miYqYPEoJ",
      "AbJgyc4aGWrsD9814aLAD1B58y91cNHhzU3nfohcj7t1","KMKAAAAhb6a395es6UdHfuxeMQ6YbDjBuMBEKkwkgnu",
      "D5n6JYyEDv9bwMU4vr2EowumhzPJoyHcxq5wiU1wYjX2","B1RhZhdWECUUSAKDaatvik4dpwJzVk4yQedBpJDWDYQz",
      "A5XQNuKQmJpsRRrTEJB1bGgjoU6LGgHYS8KTRcuMhH4U","8FugD5gLw1RnaiZxUMWYPXiqVUwNrZ3FYs5GFnK9YzqS",
      "BcpGeg1uwnmiSuH54ieMkEhv74DgoyNBCbp7mdFf6H4E","7wKj9KSUbmpZznoMUfaBc1ZwEz9Gkpw7Eays9RdsqRgg",
      "FqUAMYxeUGZmPii3srzLscqzecC19RHzu4jrNPksM5cc","9eUzi2S8V8Zc4epFAESZxR1kGBrQzdb84AeDcdfeyCkv",
      "3nNHqKpPQR84iqmTHqSZ1msBq7qQo2sdS5uNB8Y7RqHH","3X4KkurRWiLecg7Pa2YgYu8mQ9iZXFLtvwHPgWzfhJTq",
      "33yd8szd2poDpzkToDmqEU7G9ugw139qYPQwM4pobQSr","G1Hr5mCgudt6WecncgW56pPrTTDDTr7yzsDGEzQBzgaP",
      "Dh3G8tSHq9AEDbNXgp5R9RUxsuz5tJHFrcSLeWxmUY6L","GBWGs5asBAbAe7iMX91jXBfM6dUB7bLt7pmdgqBUVDYy",
      "HwLorX3mezcp5d8R2N287eF2DvZTj5NPWSXh6wnXWJkP","GkLxRLLNLZCkfwX62U5m1u1nE5NchEwmjoVLPxu1eonh",
      "5skdTuDJfrtT5fSSbZiW56S16qucCUU8GzDnbM5iUnv8","DDgAXsTt2ybas2U2BZC6dEzWb5uA6U5bnA8ggtzvcmsf",
      "9hc6eMUiueUH7ZXjDxLwqynZwfw4sYELRxyRidVp96HH","DEFBdDNKgoGvu2gZWu8TT3UXZxPHBuSYs9AP5jT9V1W3",
      "4Wti8Dn48ko11Ea8y6KfUAVVmj9wobr9CUNnf9tBkfJV","d2j8ADaT4hgKwsJGF3HsqoPeeDb4zft4rdLxz4AzXUn",
      "GPPoDGBQXxuhZ5UCe9XSTnFR7Hu6JSwyaFJ24GemjfLM","YXWkcPEu7XeZDhwAnc357Pzr8Ck3Up7tqN6odX69ZRW",
      "F5WxRVpDB4EQ9XTZpSNEgwESJnfebw6PAZWqRJnPdFkS","F8rHowt1B5GBNQwLzAgUj3qTUUaavrc2FFzkdXoyKu5q",
      "HKt89ub6rUgc7gAJEat4JpBwSqAupDP3Epu2fzrkmsXF","CDvtS4DNJuB5bLLoF7JcXCkMVjPhfudpWi3Xwnog6YKp",
      "6S6NTbDLSYCAJc6SuUwHJ9P9trtZVeXrGqYRWqddd8oV","Dg968DWnniVHKNA6vwSbTTViBCPfMrfbytDngiDncqxX",
      "EnMyQuRRHD9fXsPqbQntzHdXuRr9tERAMxhX2yWxkCW7","AKXSm6HEWA9Dhjsw6HTZBfsQELwgkbzdE245uvhRT9Yw",
      "3bD1CCmHPW6Hw2CjevucJbaqxSkdQXD1t4APs3wgSwgf","BnF3Na775p993CMXWmQd4ZF11pnj2gyubR3NZze8HYx8",
      "Be6pak5uRmFDcWNGYs7cGqQrExNrvviTVhB3pthAw6WQ","3xjaUjsKEJaaEWmGaZbZaA4psWCrN92QHSXhK5BxDCoK",
      "DLxEBF6Fi7nJi2KaqnPFAw1P7b5D91KQFZkbP93h6wSL","3HFFxHovw53BxrPeEiJG8pBSrxYtCks41KHKxdQLsFXo",
      "J43wJp2heb7o66BM23hzisJ61DW9Cms2Vorqs29GBj24","CQn9fPZ2i3JhtTcCKkUpBg35gmHChHyrq1DECZ13wLb8",
      "4RQByEJEkkedDEirw3bC9UAmD9EeGyzQAL9XqdMQwrKV","9s2UgmtgttHPbkrmvE8uQTw7fCHJmgMTT2w7HGfaS9fh",
      "E8cm452Csjs17F18fpiTqwWhi35mKv8L5A23LsNUpfmj","7GN6ri47nxiicVAFMmmw8cfRLjSRZoVRwavsQM1mHB2N",
      "CHaknhhicZ5mAM9yBkDdZdrAp3taCSF1tDhFBwtdTXcL","HeZ4B1GCX9Qv7XAfWtJzd6RYBw57N3NZdX3u3Sk2xvnn",
      "EmAV9CBfaPLTMsBSFY5tSJtxL2EmU81S1KCsFwgaGov7","FKzspMzAowAsz5JdihnKJNx1bRUuxGaAWh19ZNCLzLVk",
      "CsU6g4xPK57bKqWmm5aDax9G97GKdCutkkyyPcoPAthn","9GDAY2pzWZPGAB9jLBUwUFC4TDf4VXiRtdG4NBZLEfR8",
      "8C6ZC8yMUgNXSXkQQgSNkGXbpj3m3VjXoU4QxJKm42gS","Dsv5uRXSTRwEfmNEuaAbozyXeZMkZQ7zW21VCy6gVaHG",
      "A4T6Cg2oSgH5uc9FDTsAngCU9qmtgwjjL2xdSQ3TDpPE","CWZ1obqDNA55S8ZibfWEkidLAg22VNFQT9mJ235t9KGn",
      "5niy7uGdD2r31dRUk2SbD3pv7qRpigwGoekho6T8GRxg","DoQPWhjpfY3eCheNri6RGLn3oKLWK6WuYDZSNZhgYUhA",
      "16XjzqfthHnDQvE8nfK1vCXVbtD5hTkJnbEk1vUBoTo","DbpsCmL843gmjZyJeJSJSpFvrUAnFn4na1CmSD9SyqRJ",
      "25VSFGcKuHy4rYkpv54ZVU4rdPyhv6EEXyTRNEFBSmjf","His2SEGbjrxWuh2vC3aerbMDQ6MgbWE6S8XwpmDRvnfr",
      "EQ2Z8XJkDRHXsXp4E9BiDzrrFcTtdHTGZSHzgv3dmSYD","D6eLQJhPiH7ZpWM6gkAYp66X7PMyt9Yjo5cRgcFgURtE",
      "2wwaLuuFXrCqL9ht6TTmX3ixRaext4kj3GnAQNuis4UE","AQCNmAr3ULVKG71pZTsiobzHbk7uxS4NZbRP86EKmfbX",
      "3seMZ5icrfQDgAQN5SWxEUJSzYyM7Gq5zRoCUtjHj9yJ","FGqmGHXti7DWELRGUV3sZr6ZPEub8ziJtaXhuT1WNuP4",
      "8n9bKZ92Uk9SHe4fZNqG3rXrtbq7TGB3rrueZ5bBR7ot","VhJU54wnuwWVvS9RKkJ8pDifvQwGfNsutTXw8YH72D6",
      "7fdS8htXSFknqViqWyJ5pyu7xt2HcKiH3UgStwMWHZuG","8EcjvjWRx1FULUSYRD7okjJj1ntUS6p8dLtGkVK31H4U",
      "7wFgY4wMPBV5t4Z4NnR1j4JfBkg5pRPQs6ZGRxS951VF","4WqC11Z3x8EydCxc9xvemijs6ZDWXYHTpWNmS2r1pnmP",
      "D2MKWaTwkG7wa28C684wYi9BpgLvrZV4NPdDHaHbMY6K","AVXfKU6YczGJYpk8GFTRrGdKGsX6PqudRcxmytwd6EZi",
      "GGP8bjmURy16jM7YKnjsPxWZXKytez17F13tmuSSsqqX","GttmPfJjmhdehNuTE2sRHRQZ1PCpKrrjyrV4znaj9iTP",
      "4JaeLwNFs6gXpwS8n9qNrV3hVQ8fUngpWc2RDXt45KJL","64dHQimPRPDyd6FMWaTpriDwXhLzHPaYq9YokbvqZVNd",
      "8NZYuQCbGrEmv63m8sk7LTicsmA7jCeGKhKZtUk8Bgcp","E8BAZ8qUeK5p5DgWEW8NYmWxUZdLTx2sQbdThDS9bpHY",
      "HKjSEH77U5Ukg9k2V4BhoxCMH85KK18QV3hK7WQDYZJV","DKYjose2URsPUBewPtaNvkmMWsatuT7Cwcvw2tqL9VSz",
      "GGUSusKaoCNpY4Nediz3pV8PX98H7oesqPKazzxEHTCg","3i71TencFR13h4YYhP9Ky3peKAiRCr5zKtyHyiERjRvT",
      "CPGzSCvY3wn5wfbRGJ2FrADp96aKuqCL3ZjvERo7W3rM","8ncCPDXKwG1Foqq2xLDv5q2b29KXxALxWEf4cwSY6kPj",
      "6GKQFTzFLrzEZohMytz6WubJLm38SrThAi4EreakrU6n","3z1BuqTQ1qwNVZtZRuJHANbGGQUA7YQe87duwd6bgZxg",
      "41hM3Qf7ciwXyM7Y5m7Lp9iSFBEekgvbfcerf4QyVPn3","DJJ8KZUUzANveeTqb6uEu4h4KsyjJg6QUtSped5x4Pw8",
      "32KTTCeZu858jTw3sWTYnAwMH5VKekW8y2GemirKR2sF","AdjDJtgHW6V2nLymzjwg9EdmqusVu2S29Gry99rHqnse",
      "HX4gvp29Rys5JpNHeigLkhMRkV9rTX5QtzYLZuoAY3rn","6Fp9EnXQFfJSmutJWdHYMW8SpZsJDbKv12YREEGGVuTm",
      "FdcpugP99BvNJwPscwXqjZMXYP94vPooxmAhKNFas8v5","HPyECwJ4si2Pn5oXPi7rk6i8vMt9oLeVpXnQDEmUp27M",
      "BruhrvyoAHY1MmS1zf1a3oaq55Qa5s7NBxiDdexjjF5H","Hmd1AUEJYex5qjjw42j9MJ6NcQ4eB1HNktK6FUfy9qUx",
      "4A1ax5Lc3bzjKrZjRJenreDbn8YCGzHiA1Q1DGQZ15Ev","3APQXFUiDuUMHcLdycBprvobjtQc6ug4M92ALKTXMTsm",
      "3hChjfyncxKnQdeUCZkdVL1sMGHuJ1oAB9fQ5z8GrPCb","3KP3N9BaW284vTDZqVM1aESZyTTwxfXDNqRETm48Bimq",
      "HsXTGFgSUCdDKbXiT4GRkhyMzZxCu9Qu7yKNUnQc564g","Fby7TB9kS84MUoUvPerGNMXhLjHszcA23aqh54wk7cnG",
      "GdpiCh48NZbYTCj2ygqJqudgRfaetzfDT6btRkTBDbUV","BPg8WoptybW1eZRyVmaNh2cZ8B3Yt2sfqeQywW5zhJEG",
      "4ZDEzRYDV9ZGrY47Wvk8JYGN9aZgEgkJqmL6sYmS2w2R","7sK5zzjmUc4DDQMeF9X5qNgKsvXcLCvgbeG3r3jKwzKi",
      "8bDLBzmqWMX5tVjmagzZkd7dCQTgTtEuAdLELNPFqLFF","54Yk9e5CUrex2YskvEJir5TQkZuNkBdMBYHPXKBGi9o2",
      "DeJKhvRikwNpteFCvkCDXXNPmKPkEbHR5MpKFCrEfrRR","5MsZVaqBqsLD8pzAPeJVsvjKX6N4wBE1qYfoB9RQTRB5",
      "ApfTr1LvTdi1G1KjPfjsCrBqhva7y8vPPHDr9T7DzxXh","B2m6UUH34YTLeHvTAHGnPMoEY97th37MBiUhuKaDkkgD",
      "3QKmAcswefZQ7p9k5L75QJ8rLbKpwQcC4MkuaoXKdECG","AkkgBiabHKsj68vjAuU7RPB456au87dQfH5AV8fDc5KC",
      "3hSEDiguj2LyYuZTjuMmDJ64tcaBg2eK5SDp8NqNbhC4","EgAVYoNjEUK6CqMM77D2XbFbh6iGWeH89VNYY7nmC221",
      "8sDPYB6UfYxixDU9xP9amycmXJoGEtiyZqceyjU2GiCR","HZaAqBxiY6eiFNjtkXKG4ZHP9a5rCdHScGoAazFAkT7r",
      "F5rU8Y1RFqxt7YwDSL2uxeVPBE9J9xU6itA5sPuzWoV8","5KwzpCWrPDJsgdieUfGWzfPAsYfZHzdW4G7Y43DQavNU",
      "8QgkfmL4GsP37DekLQxzVf5k3yfDJySCp8UAeFoSVQdg","G2HtsHmrVe8617wgW9gGks72oZAsWjC5tz9YhWLwpnvj",
      "AYHfMMpbo9AC3quePJdBAHpj5q3W8AduVv7ABhMpepMc","2fnZpzoLPdCQJDmZsAX7Tv6DbdnUtEA2QHzcangZdhGP",
      "7jTa6W9eHhMJRC6RL9HUGBH233uuV2hzHkFB8rGVoYJq","2mHGQ79boBzrQuo52kHa9Tzxr3xQtJYHHa8Z186kQUfv",
      "46Swotp8pz8qGuGeHzEVciosUS8yYMxi3MveMD3RySvp","G4ZDoWyy6HhEAB6WeaJGDimdMNerV1GTfHVrzSNomNJz",
      "25KJgdsjTVoZzJWHWmymJkvWAF1qyWhrSQpTbqc1dorG","7txHUYcN8poffxXZ3ESJcN5sX4aRbNp53EVEzF7vjuKX",
      "9aMXaNvfBzQFxJ9NyotSZbLbahFK4eXL9PYQbT8pxNB6","EMWqrejk7M4qPsZcYAnHjfdy6CFZToxVPVBUUopSfdWz",
      "EJXTV87mv34BAAqATW3NgrFXEpEjPbMsCw27bf5oaLtZ","FVvjbZVg24dzpNS9DQvJecsSdHTD6Zqf7c962zLZDAqc",
      "EBf9wB9ZjRoBJ1xdJvNCxhscLD9V7jvgt7nzQuLvwSMo","DvzCPnAhYpqSqvGE5UMKSMLW2nL4rNHqNRPZPhLGQu59",
      "3yZScWEgt9WLVhnLxa3ErZLo41BwsHoJXeHQRhywemUR","72XahPL4WTfQ7nEbBF3MSngCquwRsm5Gf2Ue5P8h32qS",
      "3XZUmhQMgq9cMwKe96hp4VwiqA7beTpzqcShETLSDmsY","BhCgpLyk76x7TQiKAsjdSAtcyJZPZwpbP5oWj9R9fbvu",
      "J2NEAur3pA5fkx7ZxvJKaw7zY18BFA1nWBSFAipWCpZm","95bVAzVNQsCYSf4Ae595QBD7e9zow4R6ccqbDRD8oh8M",
      "BjvYaEAiMWk56t2MqUoJgdgWWmSTAK9EwBpjAZrB3qTv","CuP3Rt5XhsF9CDe1bqc4keeupyXyWXXMh6uDKVXPXMsH",
      "A4gpuFxKZ6ZFmHa2dzA6rAfyFwvpbs518oHAV4Xc9STX","639CbFjQK5gCyBCZfBiCtCW41eYRrWSzXdtjBuUNNnpz",
      "13AMMJ539vDeuAxrdgZk9LJTxo9EpwWaUCeDMZeGRsiB","Eoav1RFu4GgC8B9qiFTondyVHxERnvAhy8XTRkuNdkHa",
      "45ur6DK55uKhyXuBf32AYVVMg9DwGHXLcVT9HwM3e8Tc","4bC7teuYL5fJmpPckRaQyoxyr8fa9NU2PwynUaGvNRFR",
      "BMScW2jAeKpL4kHJNXKGK4fPcaVziXtN5RbXWvfvkZ3g","Ck3dPBUnMsMqwAxFFi2G4hsebqTqT85MoK2r7594z7Co",
      "EomVxkVGkfox7x7UCgwfRfQETKxGj5ob814B3tLbYT89","GLernrvuWjCFiBkhQ6rGcgj27KTDK4nRi3ahaFnyJ6cw",
      "2BcsWwnZw7mN6TM4oKkH869j5AWkx6nJ2UEy1bd89Q66","CjABhDG2oXueF6EwfwrBn8iuTsYBt8FSCKRbAWYXXn1P",
      "2tGAwDkmGtRKLptjRzSTtbyJSdsVu1LBE9y757u3x5oF","BejNAujYVcttZCAMbH1ni6Ho3FC6pTBBSrEkSeKAvnLA",
      "H2cEkagHCmBSESDCy2pkZfAT2AxwwUpM7qAxhr1AJZ7s","FKaiEdD96SRm6PPyrjKvvm6vBebSrm74E9GckEaL1qMo",
      "J5uAypvTmLhg8kjwBvTF6BEF1RRzEbovhCKPieGcc9Sc","GXrWWKm6xSEs7N1Lor2mzvKiJCW57ruoN4nYnTc6eRGW",
      "GvnR21UjXnXbMbo3Y9fnkiKNPBAUhMdpoZuAuVCe1Fha","h6VG3SKVfCjFavPC8r5ztnSCJFFPhm6yDmzbZF8fEQP",
      "82UVnQ9jFSkCvzhaAU1CCU6Vkuvda8J55yvzH9afnNCp","7nkLm2eHHuBf2ssLerMYeFXA9WzMHceAAeFnuv669rhx",
      "CcQkzZfzC14x4QNDnVtu3zBV1GfkaajUxjBFRVc4Uinc","E9S7P2DBwpJSvJFju4FJ7KWvxp2LivqE8M6ubPUmKQzm",
      "AzEWDa4gQ6aQVX1iSWNxxQwkVEhnHZmbvL6c8J55HjAx","9aW4CQ7xbTKfqFMCbz7HNiDZpSpDYmXEb8mUZqsGng4o",
      "3RDhvoFwUBjiEPW4ZRxiE9KUrkrhXHo7b22Vfr6gE7e5","7XuHNTdLhs5C8Tz79RSJiSYjrKgZvHtdZwLA68VgYWrn",
      "CbHhXeSfKmBpYBxUkMtqsLcTXRp8D9Q1XjMJjUoLj1yA","6wQXg4QPPhV6DpBksWvo8jkSVyJN4PTNsme8CMq2X6He",
      "8TJFr3oKFqYku1RtaDa69zsF3A8m5pi4k7M1hnTfNvoJ","C2r4gy1wJJVCpNd9otniE9PYmqEHRfWE9EuKFNVp5X7Z",
      "4mXCNejoTrbDjrT4ZK8YU3Eu7E9X93Us8xRLAqzsKXLW","25eLZUdr24geCBy3H7q8Hk7muFBSr4Dinxp83Dc1nwR8",
      "FCwWXUVJ82m14h6iJxAzrfpTQYRSiNsqLKvhb3Wfn5iy","3K9GauByQicRX7Tn7hW92R8RXoJog2kWfCQRRtVSKsGG",
      "6FxzvyPGR4VKde2D7i2Hkv51QSSUWoQwRUk4Rd8xGuSM","6YaetH3aavbvA3CRk8P87zYzibWwdPXGAXYDHcKBD8Vp",
      "ATAZQsFf6LVFyJ6eZYqCgUFCZMR6BZp5PYTaT7mvxFoe","3nUJXwz29t9YPM36fYvNxEM58fQM88kUK2KntXwpKHMn",
      "AjvTRk59JnUir6VNU6T9Q7L1amSqFrsP62JAQdNjeR7g","Gf39Gu72Gmfxrfo6NJSGMfaE8KMeJovy8GWKvnRXsrAu",
      "EbAfD2CySQSa52o2pDfppSXb7ysbu6TDySbzVc14L9oT","9oLWZJexk6Fn7jpLdwmLmbFnKHUHUB3dAU32eiP3BLvH",
      "D6MjCAePrYHumkTA3cQQgCeQJqfDCv67hAK6pqkz1PHX","QgxTguwgFYKCorZUaGNuQxrM5XYuvzzxJVN12LjUfSh",
      "7GRi1fb2tdwr66wELC5HeDc7jGvT3VnoH6tXLYwQN5kV","Hyk2t7R4kydMzsWxCpA4yqcehaUiaKi3aqqCbmwnUgrP",
      "6PbGkeu9VABQSNDRgPgHidPw77tAf6rG5uKERwMkEf7s","GbW2bRrytakMCzVFJCCr5tEhks3vNyfVvXUuMY1zQUnE",
      "AL1udq3TSJm6o8h4dMFo3te9MuhAQ9g8iMzJSRqcF3yY","AAfh33i6FxFaZmMqtDKS5isKuX3wU85vwjJ1FBdo4NYv",
      "6h9z5VmDjMCZnUQTCTQS2LuaAKu168G4LKYshhPm7ts2","DDGfyDB1YUxFFFpA7zpjjJcWBXKF5pQsT6QnMMqXveoH",
      "Fkr7XyCqA9bJwqJgLgDCbcy28VJQFJYhxNDNvtqbZ7ff","Do9Me3pDVdMWnkYfzCkitTGWVRK8iy3c35rubEDnNYJk",
      "A2J9qPKRRD7wbzdSi6oGHyAW6vcQLJZDbp7MbB7sXcRd","97VugYHMfBvd335SQTWve6DfF8sduwHV9tPevvhQQ9xX",
      "yvoW6JcfXyQqe3LpZ9ugFigyMZNWroiiP9y4ahDkNBV","3FZHAv65tKAwPE72aoWaA5WaQfUSkCjnNHpV4LfMMx8K",
      "4wDgtVs38T6pcWN4N5USSCa2VGFSLPDBT8kdCYjHLsy4","Ap2JEduk4bkXjt9tiuMKCGbYRz6LDJ7WPKWTfpAVp6no",
      "3XPronZdt9MMg1yatgWvkdqdHXcPVDspYXMVQbit5fN6","DMyPdJP67d1YBQD1V9h8RBs6MAmE7ownBLUtqAKFLRyx",
      "8d2za8WCG81Gh557KXEX3L4aNGyFLkHSw1Rkje5zeYpN","CwhvVqVFSdfoc5X3mPAvES4smBXYctRbY8cr7TDmVNP6"
    ]);

    // Sorted array for merkle proof (must match on-chain merkle root)
    const ALLOWLIST_SORTED = [...WHITELIST].sort();

    // === AUTO DEBUG: compute and log merkle root on load ===
    const _debugRoot = getMerkleRoot(ALLOWLIST_SORTED);
    const _debugRootHex = Array.from(_debugRoot).map(b => b.toString(16).padStart(2, "0")).join("");
    console.log("=== MERKLE DEBUG (auto) ===");
    console.log("Browser computed merkle root:", _debugRootHex);
    console.log("Expected on-chain root:      ", "15f5eecd4c41bac35fbba205b5057347d93b862de2492d1fa72624118a494732");
    console.log("Roots match:", _debugRootHex === "15f5eecd4c41bac35fbba205b5057347d93b862de2492d1fa72624118a494732");
    console.log("ALLOWLIST size:", ALLOWLIST_SORTED.length);
    console.log("First 3 sorted:", ALLOWLIST_SORTED.slice(0, 3));
    console.log("===========================");

    // Expose on window so console debugging works
    window._WHITELIST = WHITELIST;
    window._ALLOWLIST_SORTED = ALLOWLIST_SORTED;
    window._getMerkleRoot = getMerkleRoot;
    window._getMerkleProof = getMerkleProof;
    window._debugRootHex = _debugRootHex;

    // ============================================================================
    // STATE
    // ============================================================================
    let connection = null;
    let currentRpcUrl = null;
    let walletProvider = null;
    let walletPublicKey = null;
    let walletType = null;
    let candyMachine = null;
    let metaplex = null;
    let userCollectionNFTs = [];
    let umi = null; // <-- MintV2 signer context

    let _liveMintCache = {
      mintedCount: 0,
      mints: [],          // [{ mint, image, name }]
      byMint: new Map()   // mint -> { mint, image, name }
    };

    // Find a working RPC
    async function findWorkingRpc() {
      for (const rpcUrl of CONFIG.RPC_URLS) {
        try {
          console.log(`Trying RPC: ${rpcUrl.substring(0, 50)}...`);
          const testConn = new Connection(rpcUrl, "confirmed");
          await testConn.getLatestBlockhash();
          console.log(`‚úì RPC working: ${rpcUrl.substring(0, 50)}...`);
          return { connection: testConn, url: rpcUrl };
        } catch (err) {
          console.warn(`‚úó RPC failed: ${rpcUrl.substring(0, 50)}...`, err.message);
          continue;
        }
      }
      throw new Error("All RPC endpoints failed. Please try again later.");
    }

    // ============================================================================
    // UI ELEMENTS
    // ============================================================================
    const $ = (id) => document.getElementById(id);
    const walletLabel = $("walletLabel");
    const wlStatus = $("wlStatus");
    const userMints = $("userMints");
    const walletBalance = $("walletBalance");
    const statusBox = $("statusBox");
    const cmMinted = $("cmMinted");
    const cmRemaining = $("cmRemaining");
    const btnConnect = $("btnConnect");
    const btnDisconnect = $("btnDisconnect");
    const btnRefresh = $("btnRefresh");
    const btnMint = $("btnMint");
    const btnMyMints = $("btnMyMints");
    const walletModal = $("walletModal");
    const myMintsModal = $("myMintsModal");

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    function setStatus(msg, type = "normal") {
      statusBox.textContent = "Status: " + msg;
      statusBox.className = "status";
      if (type === "error") statusBox.classList.add("error");
      if (type === "success") statusBox.classList.add("success");
    }

    function short(str) {
      const s = String(str || "");
      return s.length <= 10 ? s : s.slice(0, 4) + "..." + s.slice(-4);
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    // ============================================================================
    // WALLET DETECTION
    // ============================================================================
    function detectWallets() {
      const phantomStatus = $("phantomStatus");
      const optPhantom = $("optPhantom");
      if (window.phantom?.solana?.isPhantom) {
        phantomStatus.textContent = "Installed ‚úì";
        phantomStatus.classList.add("installed");
      } else {
        phantomStatus.textContent = "Not Installed";
        optPhantom.classList.add("disabled");
      }

      const solflareStatus = $("solflareStatus");
      const optSolflare = $("optSolflare");
      const hasSolflare = window.solflare?.isSolflare ||
                          (window.solflare && typeof window.solflare.connect === "function");
      if (hasSolflare) {
        solflareStatus.textContent = "Installed ‚úì";
        solflareStatus.classList.add("installed");
      } else {
        solflareStatus.textContent = "Not Installed";
        optSolflare.classList.add("disabled");
      }

      const magicedenStatus = $("magicedenStatus");
      const optMagiceden = $("optMagiceden");
      if (window.magicEden?.solana) {
        magicedenStatus.textContent = "Installed ‚úì";
        magicedenStatus.classList.add("installed");
      } else {
        magicedenStatus.textContent = "Not Installed";
        optMagiceden.classList.add("disabled");
      }
    }

    // ============================================================================
    // MODAL HANDLERS
    // ============================================================================
    function openWalletModal() { walletModal.classList.add("active"); }
    function closeWalletModal() { walletModal.classList.remove("active"); }
    function openMyMintsModal() { myMintsModal.classList.add("active"); }
    function closeMyMintsModal() { myMintsModal.classList.remove("active"); }

    // ============================================================================
    // WALLET CONNECTION
    // ============================================================================
    async function connectWallet(type) {
      if (!connection) {
        setStatus("Still connecting to Solana... please wait", "error");
        return;
      }

      try {
        setStatus("Connecting wallet...");
        closeWalletModal();

        let provider = null;

        if (type === "phantom") {
          provider = window.phantom?.solana;
          if (!provider?.isPhantom) {
            window.open("https://phantom.app/", "_blank");
            setStatus("Please install Phantom wallet!", "error");
            return;
          }
          walletType = "Phantom";
        } else if (type === "solflare") {
          provider = window.solflare;
          if (!provider || typeof provider.connect !== "function") {
            window.open("https://solflare.com/", "_blank");
            setStatus("Please install Solflare wallet!", "error");
            return;
          }
          walletType = "Solflare";
        } else if (type === "magiceden") {
          provider = window.magicEden?.solana;
          if (!provider) {
            window.open("https://wallet.magiceden.io/", "_blank");
            setStatus("Please install Magic Eden wallet!", "error");
            return;
          }
          walletType = "Magic Eden";
        } else {
          setStatus("Unknown wallet type", "error");
          return;
        }

        // Connect
        let resp;
        try {
          resp = await provider.connect();
        } catch (err) {
          if (err.code === 4001) {
            setStatus("Connection rejected by user", "error");
            return;
          }
          try {
            resp = await provider.connect({ onlyIfTrusted: false });
          } catch {
            throw err;
          }
        }

        // Extract public key
        const pkObj = resp?.publicKey || provider.publicKey;
        if (!pkObj) throw new Error("No public key returned");

        walletProvider = provider;
        walletPublicKey = typeof pkObj === "string" ? new PublicKey(pkObj) : pkObj;

        // Metaplex JS for reads (CM state + NFTs)
        metaplex = Metaplex.make(connection).use(mplWalletIdentity({
          publicKey: walletPublicKey,
          signTransaction: (tx) => provider.signTransaction(tx),
          signAllTransactions: (txs) => provider.signAllTransactions(txs),
          signMessage: provider.signMessage ? (msg) => provider.signMessage(msg) : undefined
        }));

        // UMI for MintV2 (FIX)
        umi = createUmi(currentRpcUrl).use(mplCandyMachine()).use(mplTokenMetadata());
        umi.use(walletAdapterIdentity(walletProvider));

        // === ON-CHAIN GUARD DEBUG ===
        try {
          const cmPk = publicKey(CONFIG.CANDY_MACHINE_ID);
          const umiCm = await fetchCandyMachine(umi, cmPk);
          const guard = await fetchCandyGuard(umi, umiCm.mintAuthority);
          console.log("=== ON-CHAIN GUARD DEBUG ===");
          console.log("Groups found:", guard.groups?.map(g => g.label) || "NONE");
          
          // Check default guard allowList
          if (guard.guards?.allowList?.__option === "Some") {
            const defRoot = guard.guards.allowList.value.merkleRoot;
            const defRootHex = Array.from(defRoot).map(b => b.toString(16).padStart(2, "0")).join("");
            console.log("DEFAULT allowList root:", defRootHex);
          } else {
            console.log("DEFAULT allowList: NONE");
          }
          
          // Check group allowList roots
          for (const g of (guard.groups || [])) {
            if (g.guards?.allowList?.__option === "Some") {
              const gRoot = g.guards.allowList.value.merkleRoot;
              const gRootHex = Array.from(gRoot).map(b => b.toString(16).padStart(2, "0")).join("");
              console.log(`Group "${g.label}" allowList root:`, gRootHex);
              console.log(`Group "${g.label}" root matches browser:`, gRootHex === _debugRootHex);
            } else {
              console.log(`Group "${g.label}" allowList: NONE`);
            }
          }
          
          // Dump full guard structure for inspection
          console.log("Full guard object:", JSON.stringify(guard, (k, v) => typeof v === 'bigint' ? v.toString() : v, 2));
          console.log("============================");
        } catch (dbgErr) {
          console.warn("Guard debug failed:", dbgErr.message);
        }

        // Update UI
        walletLabel.textContent = `${walletType}: ${short(walletPublicKey.toBase58())}`;
        btnDisconnect.style.display = "inline-block";
        btnMyMints.disabled = false;
        btnMint.disabled = false;

        setStatus(`${walletType} connected!`, "success");

        await refreshAll();

        if (provider.on) {
          provider.on("disconnect", () => disconnectWallet());
          provider.on("accountChanged", async (newPk) => {
            if (newPk) {
              walletPublicKey = newPk;
              walletLabel.textContent = `${walletType}: ${short(walletPublicKey.toBase58())}`;
              await refreshAll();
            } else {
              await disconnectWallet();
            }
          });
        }

      } catch (err) {
        console.error("Wallet connection error:", err);
        setStatus(`Connection failed: ${err?.message || "Unknown error"}`, "error");
      }
    }

    async function disconnectWallet() {
      try {
        if (walletProvider?.disconnect) await walletProvider.disconnect();
      } catch {}

      walletProvider = null;
      walletPublicKey = null;
      walletType = null;
      metaplex = null;
      umi = null;
      userCollectionNFTs = [];

      walletLabel.textContent = "Not connected";
      wlStatus.textContent = "‚Äî";
      userMints.textContent = "‚Äî";
      walletBalance.textContent = "‚Äî";
      btnDisconnect.style.display = "none";
      btnMyMints.disabled = true;
      btnMint.disabled = true;

      closeMyMintsModal();
      setStatus("Disconnected.");
    }

    // ============================================================================
    // CANDY MACHINE STATE (On-Chain)
    // ============================================================================
    async function fetchCandyMachineState() {
      if (!connection) return null;

      try {
        const tempMetaplex = metaplex || Metaplex.make(connection);
        const cmPubkey = new PublicKey(CONFIG.CANDY_MACHINE_ID);

        candyMachine = await tempMetaplex.candyMachines().findByAddress({ address: cmPubkey });

        const itemsRedeemed = candyMachine.itemsMinted?.toNumber?.() ?? candyMachine.itemsMinted ?? 0;
        const itemsAvailable = candyMachine.itemsAvailable?.toNumber?.() ?? candyMachine.itemsAvailable ?? CONFIG.TOTAL_SUPPLY;
        const remaining = Math.max(0, itemsAvailable - itemsRedeemed);

        cmMinted.textContent = itemsRedeemed;
        cmRemaining.textContent = remaining;

        await refreshLiveMintImages(itemsRedeemed);
        renderLiveMintGrid(itemsRedeemed);

        return { itemsRedeemed, itemsAvailable, remaining };
      } catch (err) {
        console.error("Error fetching Candy Machine:", err);
        if (cmMinted.textContent === "‚Äî") {
          cmMinted.textContent = "Error";
          cmRemaining.textContent = "Error";
        }
        return null;
      }
    }

    // ============================================================================
    // LIVE MINT GRID
    // ============================================================================
    async function fetchMintedMintsFromHelius(limit = 20) {
  try {
    // Candy Machine address tx feed (newest first)
    const url =
      `https://api.helius.xyz/v0/addresses/${CONFIG.COLLECTION_MINT}/transactions` +
      `?api-key=${CONFIG.HELIUS_API_KEY}&limit=${Math.max(10, limit)}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`Helius HTTP ${res.status}`);
    const txs = await res.json();

    const seen = new Set();
    const mintsNewestFirst = [];

    for (const tx of txs) {
      // Best-effort: find the NFT mint in tokenTransfers
      const transfers = tx?.tokenTransfers || [];
      const mintTransfer = transfers.find(t => {
      if (!t?.mint) return false;
      // Accept common shapes (tokenAmount may be number/string/object)
      const amt = (typeof t.tokenAmount === "number" || typeof t.tokenAmount === "string")
        ? Number(t.tokenAmount)
        : (t.tokenAmount?.amount ? Number(t.tokenAmount.amount) : NaN);

      const dec = (t.decimals != null) ? Number(t.decimals)
        : (t.tokenAmount?.decimals != null ? Number(t.tokenAmount.decimals) : null);

      // NFTs are typically 1 with 0 decimals
      if (Number.isFinite(amt) && amt === 1 && (dec === 0 || dec === null)) return true;

      // Fallback: if it‚Äôs a mint transfer and looks like an NFT mint, accept it
      return false;
    });

      const mint = mintTransfer?.mint;
      if (mint && !seen.has(mint)) {
        seen.add(mint);
        mintsNewestFirst.push(mint);
      }
    }

    // We want oldest -> newest for ‚Äúmint order‚Äù
    return mintsNewestFirst.reverse().slice(-limit);
  } catch (e) {
    console.warn("Helius mint fetch failed:", e?.message || e);
    return null;
  }
}

async function resolveMintImage(mintStr) {
  if (_liveMintCache.byMint.has(mintStr)) return _liveMintCache.byMint.get(mintStr);

  try {
    const mx = metaplex || (connection ? Metaplex.make(connection) : null);
    if (!mx) throw new Error("Metaplex not ready");

    const mintPk = new PublicKey(mintStr);
    const nft = await mx.nfts().findByMint({ mintAddress: mintPk });

    // Try loaded json first
    let image = nft?.json?.image || null;
    let name = nft?.name || null;

    // Otherwise fetch uri json
    if (!image && nft?.uri) {
      const r = await fetch(nft.uri);
      const j = await r.json();
      image = j?.image || null;
      name = name || j?.name || null;
    }

    const obj = { mint: mintStr, image, name };
    _liveMintCache.byMint.set(mintStr, obj);
    return obj;
  } catch (e) {
    const obj = { mint: mintStr, image: null, name: null };
    _liveMintCache.byMint.set(mintStr, obj);
    return obj;
  }
}

async function refreshLiveMintImages(mintedCount) {
  // Only refetch if count changed (or cache empty)
  if (mintedCount <= 0) {
    _liveMintCache.mintedCount = 0;
    _liveMintCache.mints = [];
    return;
  }

  if (_liveMintCache.mintedCount === mintedCount && _liveMintCache.mints.length === mintedCount) return;

  // Pull minted mints from chain (Helius)
  const mintList = await fetchMintedMintsFromHelius(Math.min(CONFIG.TOTAL_SUPPLY, mintedCount + 8));
  if (!mintList || mintList.length === 0) {
    // Keep old cache if we have it, otherwise clear
    if (_liveMintCache.mints.length === 0) _liveMintCache.mintedCount = mintedCount;
    return;
  }

  // Keep the oldest->newest, last N = mintedCount
  const ordered = mintList.slice(-mintedCount);

  // Resolve images (small counts = fast; you‚Äôre at 2 right now)
  const resolved = [];
  for (const m of ordered) {
    resolved.push(await resolveMintImage(m));
  }

  _liveMintCache.mintedCount = mintedCount;
  _liveMintCache.mints = resolved;
}

function renderLiveMintGrid(minted = 0) {
  const grid = $("liveMintGrid");
  const count = $("liveMintCount");
  if (!grid) return;
  if (count) count.textContent = minted;

  grid.innerHTML = "";

  for (let i = 0; i < CONFIG.TOTAL_SUPPLY; i++) {
    const tile = document.createElement("div");
    const isFilled = i < minted;
    tile.className = "mint-tile " + (isFilled ? "filled" : "empty");

    if (!isFilled) {
      tile.textContent = "‚Äî";
      grid.appendChild(tile);
      continue;
    }

    // Filled tile: use cached on-chain mint order image
    const entry = _liveMintCache.mints[i];

    tile.style.padding = "0";
    tile.style.overflow = "hidden";
    tile.style.position = "relative";

    const placeholder = document.createElement("span");
    placeholder.textContent = `#${i + 1}`;
    placeholder.style.cssText =
      "position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900;opacity:0.9;z-index:2;";
    tile.appendChild(placeholder);

    if (entry?.image) {
      const img = document.createElement("img");
      img.alt = entry?.name || `Mint #${i + 1}`;
      img.loading = "lazy";
      img.src = entry.image;
      img.style.cssText = "width:100%;height:100%;object-fit:cover;border-radius:13px;display:block;min-height:54px;";
      img.onload = () => { if (placeholder.parentNode) placeholder.remove(); };
      tile.appendChild(img);
      tile.title = `${entry?.name || "Mint"} ‚Ä¢ ${short(entry?.mint || "")}`;
    } else {
      // If we don‚Äôt have image yet, keep placeholder
      tile.title = entry?.mint ? short(entry.mint) : `Mint #${i + 1}`;
    }

    grid.appendChild(tile);
  }
}

    // ============================================================================
    // USER NFT FETCHING
    // ============================================================================
    async function fetchUserNFTs() {
      if (!walletPublicKey || !metaplex || !connection) {
        userCollectionNFTs = [];
        return [];
      }

      try {
        const nfts = await metaplex.nfts().findAllByOwner({ owner: walletPublicKey });

        const collectionPubkey = CONFIG.COLLECTION_MINT;
        userCollectionNFTs = nfts.filter(nft => {
          const collection = nft.collection;
          if (!collection) return false;
          const collectionAddress = collection.address?.toBase58?.() ?? collection.address;
          return collectionAddress === collectionPubkey && collection.verified;
        });

        return userCollectionNFTs;
      } catch (err) {
        console.error("Error fetching user NFTs:", err);
        userCollectionNFTs = [];
        return [];
      }
    }

    // ============================================================================
    // MY MINTS DISPLAY
    // ============================================================================
    async function renderMyMints() {
      const grid = $("myMintsGrid");
      const empty = $("myMintsEmpty");
      const loading = $("myMintsLoading");

      if (!walletPublicKey) {
        if (grid) grid.innerHTML = "";
        if (loading) loading.style.display = "none";
        if (empty) {
          empty.style.display = "block";
          empty.textContent = "Connect your wallet to view your mints.";
        }
        return;
      }

      if (loading) loading.style.display = "block";
      if (empty) empty.style.display = "none";
      if (grid) grid.innerHTML = "";

      await fetchUserNFTs();

      if (loading) loading.style.display = "none";

      if (userCollectionNFTs.length === 0) {
        if (empty) {
          empty.style.display = "block";
          empty.textContent = "No mints yet. Hit Mint when you're ready. üî•";
        }
        return;
      }

      if (empty) empty.style.display = "none";

      for (let i = 0; i < userCollectionNFTs.length; i++) {
        const tile = document.createElement("div");
        tile.className = "mint-tile filled";
        tile.textContent = `#${i + 1}`;
        const nft = userCollectionNFTs[i];
        tile.title = nft.name || short(nft.mintAddress?.toBase58?.() ?? nft.address?.toBase58?.() ?? "");
        grid.appendChild(tile);
      }
    }

    // ============================================================================
    // REFRESH ALL DATA
    // ============================================================================
    async function refreshAll() {
      if (!connection) {
        setStatus("Not connected to Solana", "error");
        return;
      }

      setStatus("Refreshing...");

      await fetchCandyMachineState();

      if (walletPublicKey) {
        try {
          const balance = await connection.getBalance(walletPublicKey);
          walletBalance.textContent = `${(balance / LAMPORTS_PER_SOL).toFixed(4)} SOL`;
        } catch {
          walletBalance.textContent = "Error";
        }

        const wallet = walletPublicKey.toBase58();
        const isWL = WHITELIST.has(wallet);
        wlStatus.innerHTML = isWL
          ? 'Whitelist <span class="wl-badge">WL</span>'
          : "Public";

        await fetchUserNFTs();
        const mintCount = userCollectionNFTs.length;
        const limit = isWL ? CONFIG.WL_LIMIT : CONFIG.PUBLIC_LIMIT;
        userMints.textContent = `${mintCount} / ${limit}`;
      }

      setStatus("Ready.");
    }

    // ============================================================================
    // MINT FUNCTION (MintV2 FIX)
    // ============================================================================
    async function mintNFT() {
      if (!connection) {
        setStatus("Not connected to Solana", "error");
        return;
      }
      if (!walletPublicKey || !walletProvider) {
        setStatus("Connect your wallet first!", "error");
        return;
      }
      if (!umi) {
        setStatus("Wallet not properly connected (UMI not ready)", "error");
        return;
      }

      try {
        btnMint.disabled = true;
        setStatus("Preparing mint...");

        const wallet = walletPublicKey.toBase58();
        const isWL = WHITELIST.has(wallet);

        // Check user limits
        await fetchUserNFTs();
        const currentMints = userCollectionNFTs.length;
        const limit = isWL ? CONFIG.WL_LIMIT : CONFIG.PUBLIC_LIMIT;
        if (currentMints >= limit) {
          setStatus(`You've reached your limit (${limit} max)`, "error");
          return;
        }

        // Check sold out
        const cmState = await fetchCandyMachineState();
        if (cmState && cmState.remaining <= 0) {
          setStatus("SOLD OUT! üî•", "error");
          return;
        }

        // Check balance
        const price = isWL ? CONFIG.WL_PRICE_SOL : CONFIG.PUBLIC_PRICE_SOL;
        const balance = await connection.getBalance(walletPublicKey);
        const required = (price + 0.02) * LAMPORTS_PER_SOL;
        if (balance < required) {
          setStatus(`Insufficient balance. Need ~${(price + 0.02).toFixed(3)} SOL`, "error");
          return;
        }

        setStatus(`Minting for ${price} SOL... approve in wallet üî•`);

        // Fetch CM and Guard via UMI
        const cmPk = publicKey(CONFIG.CANDY_MACHINE_ID);
        const umiCm = await fetchCandyMachine(umi, cmPk);
        const umiGuard = await fetchCandyGuard(umi, umiCm.mintAuthority);

        // Detect on-chain guard config (groups vs default-only)
        const hasGroups = umiGuard.groups && umiGuard.groups.length > 0;
        const wlGroup = hasGroups ? umiGuard.groups.find(g => g.label === "wl") : null;
        const publicGroup = hasGroups ? umiGuard.groups.find(g => g.label === "public") : null;

        console.log("Guard config:", {
          hasGroups,
          groupLabels: umiGuard.groups?.map(g => g.label),
          hasDefault: !!umiGuard.guards,
          wlGroup: !!wlGroup,
          publicGroup: !!publicGroup
        });

        // Build mint parameters based on what's actually on-chain
        let group = none();
        let mintArgs = {
          solPayment: some({ destination: publicKey(CONFIG.TREASURY) })
        };

        if (hasGroups && isWL && wlGroup) {
          // WL group exists on-chain ‚Äî use it with allowList proof
          group = some("wl");

          // Debug: log computed merkle root vs on-chain
          const computedRoot = getMerkleRoot(ALLOWLIST_SORTED);
          const rootHex = Array.from(computedRoot).map(b => b.toString(16).padStart(2, "0")).join("");
          console.log("Computed merkle root:", rootHex);
          console.log("Wallet address:", wallet);
          console.log("Wallet in ALLOWLIST_SORTED:", ALLOWLIST_SORTED.includes(wallet));

          setStatus("Validating whitelist proof...");
          try {
            await route(umi, {
              candyMachine: umiCm.publicKey,
              candyGuard: umiCm.mintAuthority,
              guard: "allowList",
              group: some("wl"),
              routeArgs: {
                path: "proof",
                merkleRoot: computedRoot,
                merkleProof: getMerkleProof(ALLOWLIST_SORTED, wallet)
              }
            }).sendAndConfirm(umi);
            console.log("WL proof validated successfully");
          } catch (routeErr) {
            // If proof receipt already exists, that's fine ‚Äî continue to mint
            if (routeErr?.message?.includes("already in use")) {
              console.log("Proof receipt already exists, proceeding to mint");
            } else {
              // WL proof failed ‚Äî fall back to public mint
              console.warn("WL proof failed, falling back to public mint:", routeErr?.message);
              if (publicGroup) {
                group = some("public");
                mintArgs = { solPayment: some({ destination: publicKey(CONFIG.TREASURY) }) };
                setStatus("WL proof failed ‚Äî minting at public price instead...");
              } else {
                throw routeErr;
              }
            }
          }

          // CRITICAL: include allowList in mintArgs so SDK adds proof receipt PDA
          if (group.__option === "Some" && group.value === "wl") {
            mintArgs = {
              solPayment: some({ destination: publicKey(CONFIG.TREASURY) }),
              allowList: some({ merkleRoot: computedRoot })
            };
          }

        } else if (hasGroups && publicGroup) {
          // Public group exists on-chain
          group = some("public");

        } else {
          // No groups ‚Äî use default guard
          console.log("No groups found on-chain, using default guard");
          group = none();
        }

        setStatus("Sending mint transaction... approve in wallet üî•");

        const nftMint = generateSigner(umi);
        console.log("Generated nftMint:", nftMint.publicKey);
        console.log("Candy machine tokenStandard:", umiCm.tokenStandard);
        console.log("Candy machine authority:", umiCm.authority);
        console.log("Collection mint:", umiCm.collectionMint);
        console.log("Mint group:", group);
        console.log("Mint args:", JSON.stringify(mintArgs, (k,v) => typeof v === 'bigint' ? v.toString() : v));

        const res = await transactionBuilder()
          .add(setComputeUnitLimit(umi, { units: 800_000 }))
          .add(mintV2(umi, {
            candyMachine: umiCm.publicKey,
            candyGuard: umiCm.mintAuthority,
            nftMint,
            collectionMint: umiCm.collectionMint,
            collectionUpdateAuthority: umiCm.authority,
            tokenStandard: umiCm.tokenStandard,
            group,
            mintArgs
          }))
          .sendAndConfirm(umi);

        console.log("MintV2 signature:", res.signature);
        setStatus(`‚úÖ Minted! Tx: ${short(res.signature)}`, "success");

        await sleep(2000);
        await refreshAll();

      } catch (err) {
        console.error("Mint error:", err);
        console.error("Full error details:", JSON.stringify(err, null, 2));

        if (err?.message?.includes("rejected") || err?.code === 4001) {
          setStatus("Transaction cancelled by user", "error");
        } else if (err?.message?.includes("insufficient")) {
          setStatus("Insufficient SOL balance", "error");
        } else if (err?.message?.includes("6005") || err?.message?.includes("not initialized")) {
          setStatus("Mint failed: Guard account not initialized. Check browser console (F12) for guard config details.", "error");
        } else {
          setStatus(`Mint failed: ${err?.message || "Unknown error"}. Check console (F12) for details.`, "error");
        }
      } finally {
        btnMint.disabled = !walletPublicKey;
      }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    btnConnect.addEventListener("click", openWalletModal);
    $("closeWalletModal").addEventListener("click", closeWalletModal);
    $("closeMyMintsModal").addEventListener("click", closeMyMintsModal);

    $("optPhantom").addEventListener("click", () => {
      if (!$("optPhantom").classList.contains("disabled")) connectWallet("phantom");
    });
    $("optSolflare").addEventListener("click", () => {
      if (!$("optSolflare").classList.contains("disabled")) connectWallet("solflare");
    });
    $("optMagiceden").addEventListener("click", () => {
      if (!$("optMagiceden").classList.contains("disabled")) connectWallet("magiceden");
    });

    btnDisconnect.addEventListener("click", disconnectWallet);
    btnRefresh.addEventListener("click", refreshAll);
    btnMint.addEventListener("click", mintNFT);
    btnMyMints.addEventListener("click", () => {
      renderMyMints();
      openMyMintsModal();
    });

    walletModal.addEventListener("click", (e) => {
      if (e.target === walletModal) closeWalletModal();
    });
    myMintsModal.addEventListener("click", (e) => {
      if (e.target === myMintsModal) closeMyMintsModal();
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    async function init() {
      setStatus("Connecting to Solana...");

      try {
        const result = await findWorkingRpc();
        connection = result.connection;
        currentRpcUrl = result.url;
        console.log("Using RPC:", currentRpcUrl);
      } catch (err) {
        console.error("RPC error:", err);
        setStatus("Failed to connect to Solana. Please refresh.", "error");
        return;
      }

      setTimeout(detectWallets, 300);

      const tempMetaplex = Metaplex.make(connection);
      try {
        const cmPubkey = new PublicKey(CONFIG.CANDY_MACHINE_ID);
        candyMachine = await tempMetaplex.candyMachines().findByAddress({ address: cmPubkey });

        const itemsRedeemed = candyMachine.itemsMinted?.toNumber?.() ?? candyMachine.itemsMinted ?? 0;
        cmMinted.textContent = itemsRedeemed;
        cmRemaining.textContent = Math.max(0, CONFIG.TOTAL_SUPPLY - itemsRedeemed);
        await refreshLiveMintImages(itemsRedeemed);
        renderLiveMintGrid(itemsRedeemed);
        setStatus("Ready.");
      } catch (err) {
        console.error("Initial CM fetch error:", err);
        setStatus("Ready. (Could not fetch CM state)", "error");
        renderLiveMintGrid(0);
      }
    }

    init();
  </script>
</body>
</html>
